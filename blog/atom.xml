<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://jachen99.github.io/blog</id>
    <title>软件一班季同学的世界 Blog</title>
    <updated>2025-02-16T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://jachen99.github.io/blog"/>
    <subtitle>软件一班季同学的世界 Blog</subtitle>
    <icon>https://jachen99.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[不花钱，给技术博客做点简单的SEO]]></title>
        <id>https://jachen99.github.io/blog/simple-seo-for-tech-blog</id>
        <link href="https://jachen99.github.io/blog/simple-seo-for-tech-blog"/>
        <updated>2025-02-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[一篇写给开发者的极简SEO指南。本文分享了如何通过优化关键词、元数据和内部链接等简单技术，让你的个人博客在Google等搜索引擎上更容易被发现，内容实在，拒绝空谈。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>作为开发者，我们都喜欢在博客上分享自己踩过的坑、总结出的经验。但很多时候，一篇自认为写得还不错的文章发出去后，除了朋友圈里的几个点赞，几乎无人问津。问题出在哪？内容不够好吗？不一定。更多时候，只是因为"需要它的人找不到它"。</p>
<p>这就是SEO（搜索引擎优化）要解决的问题。一提到SEO，很多人会联想到各种复杂的黑话和技巧，但对于我们技术博客来说，事情可以简单得多。它不是什么黑魔法，而是一系列逻辑清晰的、让搜索引擎（比如Google）更容易理解我们网站内容的步骤。</p>
<p>最近我给自己的博客做了点优化，效果还不错，这里就跟大家分享一下我做了哪些事。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术层面先让google认识你">技术层面：先让Google认识你<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#%E6%8A%80%E6%9C%AF%E5%B1%82%E9%9D%A2%E5%85%88%E8%AE%A9google%E8%AE%A4%E8%AF%86%E4%BD%A0" class="hash-link" aria-label="技术层面：先让Google认识你的直接链接" title="技术层面：先让Google认识你的直接链接">​</a></h2>
<p>这部分是基础，好在像Docusaurus这样的现代博客框架，已经帮我们做了大部分工作。我们只需要检查并确认几件事。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-网站地图-sitemapxml">1. 网站地图 (<code>sitemap.xml</code>)<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#1-%E7%BD%91%E7%AB%99%E5%9C%B0%E5%9B%BE-sitemapxml" class="hash-link" aria-label="1-网站地图-sitemapxml的直接链接" title="1-网站地图-sitemapxml的直接链接">​</a></h3>
<p>这东西相当于你主动递给Google的一张网站"导览图"，上面列出了你所有的页面。有了它，Google就不会在你的网站里"迷路"，能更快、更全面地收录你的文章。</p>
<p>在Docusaurus里，你几乎不用管它，默认就是开启的。只要保证你的 <code>docusaurus.config.js</code> 里有正确的网站URL配置就行：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// docusaurus.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">url</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'https://jachen99.github.io'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 你的网站域名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-元数据-meta-tags">2. 元数据 (Meta Tags)<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#2-%E5%85%83%E6%95%B0%E6%8D%AE-meta-tags" class="hash-link" aria-label="2. 元数据 (Meta Tags)的直接链接" title="2. 元数据 (Meta Tags)的直接链接">​</a></h3>
<p>元数据是藏在HTML <code>&lt;head&gt;</code> 标签里，专门给搜索引擎看的信息。最重要的有两个：</p>
<ul>
<li><strong>全局关键词 (<code>keywords</code>)</strong>: 用几个词概括你的整个博客是关于什么的。比如"Java, Spring, 后端, 技术博客"。</li>
<li><strong>页面描述 (<code>description</code>)</strong>: 用一两句话总结<strong>当前页面</strong>的核心内容。</li>
</ul>
<p>全局关键词可以在 <code>docusaurus.config.js</code> 里配置，一次搞定。而页面描述，我强烈建议为你认为重要的每一篇文章都手动加上。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="内容层面让你的文章发光">内容层面：让你的文章"发光"<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#%E5%86%85%E5%AE%B9%E5%B1%82%E9%9D%A2%E8%AE%A9%E4%BD%A0%E7%9A%84%E6%96%87%E7%AB%A0%E5%8F%91%E5%85%89" class="hash-link" aria-label="内容层面：让你的文章&quot;发光&quot;的直接链接" title="内容层面：让你的文章&quot;发光&quot;的直接链接">​</a></h2>
<p>技术搞定后，重头戏来了。这部分工作的核心思想只有一个：<strong>站在搜索者的角度思考</strong>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-关键词用户会搜什么">1. 关键词：用户会搜什么？<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#1-%E5%85%B3%E9%94%AE%E8%AF%8D%E7%94%A8%E6%88%B7%E4%BC%9A%E6%90%9C%E4%BB%80%E4%B9%88" class="hash-link" aria-label="1. 关键词：用户会搜什么？的直接链接" title="1. 关键词：用户会搜什么？的直接链接">​</a></h3>
<p>动笔前，想一个简单的问题："如果我遇到了这篇文章要解决的问题，我会在Google里输入什么？"</p>
<ul>
<li>要写JWT登出后失效？用户可能会搜："JWT 退出登录"、"jwt token blacklist"、"jwt 黑名单"。</li>
<li>要写Nginx平滑重启？用户可能会搜："nginx reload"、"nginx 优雅重启"、"nginx -s reload 过程"。</li>
</ul>
<p>想出这些词后，试着把它们自然地、不堆砌地安插在你的<strong>文章大标题</strong>和<strong>各个小标题 (<code>##</code>, <code>###</code>)</strong> 里。这不仅能帮到SEO，也能让你的文章结构更清晰。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-那个重要的-description">2. 那个重要的 <code>description</code><a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#2-%E9%82%A3%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84-description" class="hash-link" aria-label="2-那个重要的-description的直接链接" title="2-那个重要的-description的直接链接">​</a></h3>
<p>还记得上面说的页面描述吗？它至关重要，因为<strong>它很可能会直接显示在Google的搜索结果里</strong>，成为用户决定是否点击你网站的"门面"。</p>
<p>一篇没有<code>description</code>的文章，Google可能会随便从你文章里抓一段文字显示，效果通常不理想。</p>
<p>看看区别：</p>
<p><strong>（优化前，Google可能抓取的样子）</strong></p>
<blockquote>
<p>...JWT是一种轻量级的身份验证方式。然而，一旦用户退出系统，之前的令牌理论上仍然是有效的，这可能导致一些...</p>
</blockquote>
<p><strong>（优化后，我们自己写的样子）</strong></p>
<blockquote>
<p>教程：如何解决JWT在用户登出后依然有效带来的安全风险。本文讲解通过Redis构建JWT黑名单，在用户退出时立即让令牌失效的双层安全机制...</p>
</blockquote>
<p>哪个更吸引你点击？答案不言而喻。所以，在每篇重要文章的头部加上这个字段，花一分钟写好它。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token front-matter-block punctuation" style="color:rgb(248, 248, 242)">---</span><span class="token front-matter-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token front-matter-block"></span><span class="token front-matter-block front-matter yaml language-yaml key atrule">title</span><span class="token front-matter-block front-matter yaml language-yaml punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token front-matter-block front-matter yaml language-yaml"> </span><span class="token front-matter-block front-matter yaml language-yaml string" style="color:rgb(255, 121, 198)">"安全功能之系统退出后JWT令牌失效"</span><span class="token front-matter-block front-matter yaml language-yaml"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token front-matter-block front-matter yaml language-yaml"></span><span class="token front-matter-block front-matter yaml language-yaml key atrule">description</span><span class="token front-matter-block front-matter yaml language-yaml punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token front-matter-block front-matter yaml language-yaml"> </span><span class="token front-matter-block front-matter yaml language-yaml string" style="color:rgb(255, 121, 198)">"教程：如何解决JWT在用户登出后依然有效带来的安全风险。本文讲解通过Redis构建JWT黑名单..."</span><span class="token front-matter-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token front-matter-block"></span><span class="token front-matter-block punctuation" style="color:rgb(248, 248, 242)">---</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-内部链接把知识串成网">3. 内部链接：把知识串成网<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#3-%E5%86%85%E9%83%A8%E9%93%BE%E6%8E%A5%E6%8A%8A%E7%9F%A5%E8%AF%86%E4%B8%B2%E6%88%90%E7%BD%91" class="hash-link" aria-label="3. 内部链接：把知识串成网的直接链接" title="3. 内部链接：把知识串成网的直接链接">​</a></h3>
<p>在写新文章时，如果提到了一个你之前文章详细讲过的概念，别犹豫，给它一个链接指过去。</p>
<ul>
<li>比如，在写零拷贝时，提到了它是RocketMQ高性能的原因之一，就可以链接到你之前写的RocketMQ相关的文章。</li>
<li>在讲JWT黑名单时，用到了Redis，就可以链接到你的Redis持久化文章。</li>
</ul>
<p>这么做有两个好处：</p>
<ol>
<li>方便读者深入学习，提升阅读体验。</li>
<li>帮助Google理解你网站内各个页面之间的关系，它会认为被链接越多的文章通常越重要，从而可能给予更高的权重。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/simple-seo-for-tech-blog#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接��链接" title="总结的直接链接">​</a></h2>
<p>你看，给技术博客做SEO，其实并没有那么复杂。总结一下就三件事：</p>
<ol>
<li><strong>想好关键词</strong>，并把它们用在标题里。</li>
<li>为重要文章<strong>写好<code>description</code></strong>。</li>
<li>在文章间<strong>多做内部链接</strong>。</li>
</ol>
<p>做这些事，不是为了取悦算法，而是为了更好地服务读者——那些和我们一样，在遇到问题时，打开Google寻找答案的开发者们。你把路修好了，他们自然就来了。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="博客" term="博客"/>
        <category label="SEO" term="SEO"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Elasticsearch的高阶语法与分片策略：从概念到实战]]></title>
        <id>https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy</id>
        <link href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy"/>
        <updated>2025-02-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[从bool查询与filter的性能差异，到聚合分析，再到函数得分自定义排序，深入讲解ES高阶语法。同时探讨主分片与副本的核心策略、自定义路由等，助你从根源上解决ES性能问题。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>作为后端开发者，我们对 Elasticsearch（后文简称 ES）绝不陌生。它是一个强大的分布式搜索引擎，我们常常用它来做日志分析、全文检索等。但很多时候，我们可能只是停留在"会用"的层面：创建索引、插入数据、用 <code>match</code> 查询。当数据量和服务规模上来后，各种问题便接踵而至："为什么我的查询这么慢？"、"为什么集群CPU突然就满了？"、"分片数到底设多少合适？"</p>
<p>如果你也遇到过这些问题，那么这篇文章就是为你准备的。我们将深入探讨那些能让你的 ES 使用水平提升一个台阶的核心知识：高阶查询语法与分片策略。这不仅仅是"知其然"，更是"知其所以然"的过程，帮助你从根源上理解并解决性能问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="拒绝慢查询高阶语法精讲">拒绝"慢查询"：高阶语法精讲<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#%E6%8B%92%E7%BB%9D%E6%85%A2%E6%9F%A5%E8%AF%A2%E9%AB%98%E9%98%B6%E8%AF%AD%E6%B3%95%E7%B2%BE%E8%AE%B2" class="hash-link" aria-label="拒绝&quot;慢查询&quot;：高阶语法精讲的直接链接" title="拒绝&quot;慢查询&quot;：高阶语法精讲的直接链接">​</a></h2>
<p>ES 的查询 DSL (Domain Specific Language) 功能极其丰富，远不止 <code>match</code> 和 <code>term</code>。掌握更高阶的语法，是写出高效、精准查询的第一步。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-bool-查询must-vs-filter-的小剧场">1. <code>bool</code> 查询：<code>must</code> vs <code>filter</code> 的小剧场<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#1-bool-%E6%9F%A5%E8%AF%A2must-vs-filter-%E7%9A%84%E5%B0%8F%E5%89%A7%E5%9C%BA" class="hash-link" aria-label="1-bool-查询must-vs-filter-的小剧场的直接链接" title="1-bool-查询must-vs-filter-的小剧场的直接链接">​</a></h3>
<p>我们都用过 <code>bool</code> 查询来组合多个条件，但 <code>must</code> 和 <code>filter</code> 的区别你真的清楚吗？</p>
<ul>
<li><strong><code>must</code></strong>: 条件必须匹配，并且 <strong>会计算相关性得分 <code>_score</code></strong>。它会问："这个文档有多符合条件？"</li>
<li><strong><code>filter</code></strong>: 条件必须匹配，但它处于"过滤器上下文(filter context)"中，<strong>不会计算得分</strong>，并且会利用缓存。它只回答："是"或"不是"。</li>
</ul>
<p><strong>实战场景</strong>：假设我们在电商网站搜索"华为手机"，要求必须是"5G"并且"8GB内存以上"的。</p>
<p>一个<strong>不够优化</strong>的查询可能是：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"query"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"bool"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"must"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"match"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"title"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"华为手机"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"term"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"network_type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"5G"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"range"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"memory"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"gte"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">8</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里，ES 不仅要找"5G"和"8GB内存"的手机，还要煞有介事地为"5G"和"8GB内存"这两个条件计算相关性得分，这完全是多余的计算。</p>
<p><strong>更优的查询</strong>应该是：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"query"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"bool"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"must"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"match"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"title"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"华为手机"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"filter"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"term"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"network_type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"5G"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"range"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"memory"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"gte"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">8</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>【划重点】</strong>：将所有不需要计算相关性得分的精确匹配、范围查询等条件，统统放进 <code>filter</code> 子句。这能让 ES 大胆地使用缓存，性能提升非常显著。这是 ES 查询优化的第一黄金法则。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-聚合aggregations不只是搜索更是分析">2. 聚合（Aggregations）：不只是搜索，更是分析<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#2-%E8%81%9A%E5%90%88aggregations%E4%B8%8D%E5%8F%AA%E6%98%AF%E6%90%9C%E7%B4%A2%E6%9B%B4%E6%98%AF%E5%88%86%E6%9E%90" class="hash-link" aria-label="2. 聚合（Aggregations）：不只是搜索，更是分析的直接链接" title="2. 聚合（Aggregations）：不只是搜索，更是分析的直接链接">​</a></h3>
<p>很多人以为 ES 只是一个"搜索框"，但它强大的聚合能力让它拥有了轻量级数据分析的能力。</p>
<p><strong>实战场景</strong>：我们想知道网站上每个品牌的手机平均售价是多少。</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"size"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 我不关心搜索结果，只关心聚合数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"aggs"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"brands"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 给这个聚合起个名字叫 "brands"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"terms"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"brand.keyword"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 按品牌进行分组（桶聚合）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"aggs"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"avg_price"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 在每个品牌的分组下，再进行子聚合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token property">"avg"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"field"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"price"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 计算价格的平均值（度量聚合）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个查询会返回类似这样的结果：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token property">"aggregations"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"brands"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"buckets"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"key"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"华为"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"doc_count"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">150</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"avg_price"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"value"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4999.50</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"key"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"小米"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"doc_count"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">"avg_price"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">"value"</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2999.00</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你看，我们没有写一行后端代码，就完成了一个简单的统计分析。聚合是 ES 的精髓之一，善用它可以极大地减轻后端服务的压力。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="集群的根基分片策略">集群的根基：分片策略<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#%E9%9B%86%E7%BE%A4%E7%9A%84%E6%A0%B9%E5%9F%BA%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5" class="hash-link" aria-label="集群的根基：分片策略的直接链接" title="集群的根基：分片策略的直接链接">​</a></h2>
<p>如果说查询语法是"术"，那么分片策略就是"道"。错误的策略会给整个集群带来灾难性的、且难以挽回的后果。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-什么是分片和副本">1. 什么是分片和副本？<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC" class="hash-link" aria-label="1. 什么是分片和副本？的直接链接" title="1. 什么是分片和副本？的直接链接">​</a></h3>
<ul>
<li><strong>主分片 (Primary Shard)</strong>: 每个索引被分成一个或多个"部分"，这就是主分片。每个主分片都是一个功能完备的 Lucene 索引。<strong>一个索引的主分片数量在创建时设定，后续无法修改！</strong></li>
<li><strong>副本分片 (Replica Shard)</strong>: 它是主分片的一个完整拷贝。它的作用有两个：<!-- -->
<ol>
<li><strong>高可用</strong>：当主分片所在的节点宕机，副本分片可以被提升为新的主分片，保证数据不丢失。</li>
<li><strong>提升读性能</strong>：搜索请求可以同时在主分片和副本分片上执行，提升并发查询能力。</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-主分片数该如何设定">2. 主分片数，该如何设定？<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#2-%E4%B8%BB%E5%88%86%E7%89%87%E6%95%B0%E8%AF%A5%E5%A6%82%E4%BD%95%E8%AE%BE%E5%AE%9A" class="hash-link" aria-label="2. 主分片数，该如何设定？的直接链接" title="2. 主分片数，该如何设定？的直接链接">​</a></h3>
<p>这是个经典问题，也是最重要的问题。设多了，每个分片都很小，会造成元数据管理的开销和查询时的额外协调成本；设少了，单个分片过大，会导致数据迁移困难、恢复缓慢。</p>
<p><strong>【经验法则】</strong>: 官方和社区的普遍建议是，<strong>让单个分片的大小保持在 10GB 到 50GB 之间</strong>。</p>
<p>所以，你可以这样规划：</p>
<ol>
<li>估算你一个索引未来一到两年内可能增长到的总数据量（例如，500GB）。</li>
<li>选择一个合适的目标分片大小（例如，30GB）。</li>
<li>计算所需主分片数：<code>500GB / 30GB/shard ≈ 17 shards</code>。</li>
</ol>
<p>所以，你可以在创建索引时将主分片数设为 17。当然，这只是一个起点，你还需要根据你的业务场景（读写比例、数据增长速度）进行微调。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-自定义路由-custom-routing">3. 自定义路由 (Custom Routing)<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1-custom-routing" class="hash-link" aria-label="3. 自定义路由 (Custom Routing)的直接链接" title="3. 自定义路由 (Custom Routing)的直接链接">​</a></h3>
<p>默认情况下，ES 使用文档的 <code>_id</code> 来决定它应该被存到哪个分片。但在某些场景下，我们可以手动控制。</p>
<p><strong>实战场景</strong>：一个多租户的 SaaS 应用，每个用户的数据都存在同一个索引里。当一个用户查询自己的数据时，ES 不得不查询所有分片，然后过滤出属于该用户的数据，效率很低。</p>
<p>这时，我们可以用 <code>user_id</code> 作为路由键：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">PUT /my-index/_doc/1?routing=user_A</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "user_id": "user_A",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "message": "some message"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在查询时，也带上同样的 <code>routing</code> 参数：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">GET /my-index/_search?routing=user_A</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "query": {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    "match": { "message": "some" }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样，ES 就能精准地只去 <code>user_A</code> 的数据所在的那一个分片上执行查询，避免了不必要的跨分片搜索，性能会得到质的飞跃。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/es-advanced-syntax-and-sharding-strategy#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>我们今天聊的，都是 ES 从"能用"到"好用"乃至"卓越"的关键。</p>
<ul>
<li><strong>语法层面</strong>：永远记得把非相关性的查询放进 <code>filter</code> 上下文，善用 <code>aggregations</code> 为你的系统赋能。</li>
<li><strong>架构层面</strong>：谨慎规划你的主分片数量，把它当成一次数据库的 <code>CREATE TABLE</code> 操作来对待。并根据场景，考虑是否需要自定义路由来打破性能瓶颈。</li>
</ul>
<p>当然，ES 的世界远不止于此，但掌握了这些，你已经超越了 80% 的使用者。剩下的，就是在实践中不断监控、测试、调优，真正成为驾驭数据的专家。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Elasticsearch" term="Elasticsearch"/>
        <category label="后端" term="后端"/>
        <category label="数据库" term="数据库"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[BI可视化平台集成OSS]]></title>
        <id>https://jachen99.github.io/blog/product-docs-oss-integration</id>
        <link href="https://jachen99.github.io/blog/product-docs-oss-integration"/>
        <updated>2024-12-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[BI可视化平台集成OSS]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bi可视化平台集成oss">BI可视化平台集成OSS<a href="https://jachen99.github.io/blog/product-docs-oss-integration#bi%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B9%B3%E5%8F%B0%E9%9B%86%E6%88%90oss" class="hash-link" aria-label="BI可视化平台集成OSS的直接链接" title="BI可视化平台集成OSS的直接链接">​</a></h2>
<p>本技术文档基于开源项目 <a href="https://github.com/gcpaas/DataRoom" target="_blank" rel="noopener noreferrer">DataRoom</a> 进行修改和扩展。该项目提供了基础的文件管理功能，并集成了阿里云OSS（对象存储服务）。在此基础上，我们为 BI 可视化平台提供了文件上传、下载、删除、复制等操作的实现，并进行了相关的性能优化。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-技术实现">1. 技术实现<a href="https://jachen99.github.io/blog/product-docs-oss-integration#1-%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="1. 技术实现的直接链接" title="1. 技术实现的直接链接">​</a></h3>
<p>本系统通过集成阿里云OSS（对象存储服务）实现文件的上传、下载、删除、复制等操作。系统通过在配置文件中配置相关参数，完成与OSS的对接。以下是实现的主要功能：</p>
<ul>
<li><strong>文件上传</strong>：支持文件上传至阿里云OSS，文件支持自动重命名或保留原文件名。</li>
<li><strong>文件下载</strong>：支持下载OSS存储的文件，采用流式处理避免大文件内存溢出。</li>
<li><strong>文件删除</strong>：支持从OSS中删除指定文件。</li>
<li><strong>文件复制</strong>：支持复制文件到OSS中指定路径。</li>
<li><strong>文件权限设置</strong>：支持文件设置为公共可读，并设置过期时间。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-集成步骤">2. 集成步骤<a href="https://jachen99.github.io/blog/product-docs-oss-integration#2-%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4" class="hash-link" aria-label="2. 集成步骤的直接链接" title="2. 集成步骤的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="21-配置阿里云oss参数">2.1 配置阿里云OSS参数<a href="https://jachen99.github.io/blog/product-docs-oss-integration#21-%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91oss%E5%8F%82%E6%95%B0" class="hash-link" aria-label="2.1 配置阿里云OSS参数的直接链接" title="2.1 配置阿里云OSS参数的直接链接">​</a></h4>
<p>首先，确保已在阿里云控制台创建了OSS Bucket，并获取了 <code>AccessKeyId</code> 和 <code>AccessKeySecret</code>。然后，在项目的 <code>application.yml</code> 或 <code>application.properties</code> 中配置OSS相关参数。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置示例">配置示例：<a href="https://jachen99.github.io/blog/product-docs-oss-integration#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B" class="hash-link" aria-label="配置示例：的直接链接" title="配置示例：的直接链接">​</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">gc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">starter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">urlPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//oss</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">beijing.aliyuncs.com</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oss</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">oss</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">endpoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//oss</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">beijing.aliyuncs.com</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">accessKeyId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">***</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 请替换为您的实际 AccessKeyId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">accessKeySecret</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">***</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 请替换为您的实际 AccessKeySecret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">pathPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//</span><span class="token important">***.oss-cn-beijing.aliyuncs.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">bucketName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">***</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">filePathPrefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">***/bigScreen</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注意事项：</strong></p>
<ul>
<li><code>pathPrefix</code> 由 <code>endpoint</code> 和 <code>bucketName</code> 组成，这是OSS默认的路径构建规则。</li>
<li>请确保 <code>accessKeyId</code> 和 <code>accessKeySecret</code> 不暴露在公共仓库中。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-创建文件管理服务">2.2 创建文件管理服务<a href="https://jachen99.github.io/blog/product-docs-oss-integration#22-%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1" class="hash-link" aria-label="2.2 创建文件管理服务的直接链接" title="2.2 创建文件管理服务的直接链接">​</a></h4>
<p>在项目中创建一个文件管理服务，负责与OSS进行交互，处理文件的上传、下载、删除、复制等操作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="核心代码">核心代码：<a href="https://jachen99.github.io/blog/product-docs-oss-integration#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="核心代码：的直接链接" title="核心代码：的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.gccloud.dataroom.core.module.file.service;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.gccloud.dataroom.core.module.file.entity.DataRoomFileEntity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.web.multipart.MultipartFile;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.InputStream;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 文件管理服务接口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public interface IDataRoomOssService {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 上传文件，文件名重新生成</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param file 文件对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param entity 文件实体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response HTTP响应对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request HTTP请求对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 上传后的文件实体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DataRoomFileEntity upload(MultipartFile file, DataRoomFileEntity entity, HttpServletResponse response, HttpServletRequest request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 上传文件，保留原文件名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param inputStream 文件输入流</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param fileName 文件名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param size 文件大小</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param entity 文件实体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 上传后的文件实体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DataRoomFileEntity upload(InputStream inputStream, String fileName, long size, DataRoomFileEntity entity);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 下载文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param fileId 文件ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response HTTP响应对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request HTTP请求对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    void download(String fileId, HttpServletResponse response, HttpServletRequest request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 删除文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param fileId 文件ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    void delete(String fileId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 复制文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param sourcePath 源路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param targetPath 目标路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 复制后的文件路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String copy(String sourcePath, String targetPath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取文件输入流</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param newName 文件名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 文件输入流</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    InputStream getInputStream(String newName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 检测URL是否可访问</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param urlString URL地址</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return true: 可访问，false: 不可访问</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    boolean isUrlAccessible(String urlString);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 设置文件为公共读，并设置过期时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param objectName 文件名</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param expireTimeInSeconds 过期时间（秒）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 文件的访问地址</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String setOssFilePublicReadWithExpiry(String objectName, int expireTimeInSeconds);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-文件下载和流处理优化">2.3 文件下载和流处理优化<a href="https://jachen99.github.io/blog/product-docs-oss-integration#23-%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%92%8C%E6%B5%81%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96" class="hash-link" aria-label="2.3 文件下载和流处理优化的直接链接" title="2.3 文件下载和流处理优化的直接链接">​</a></h4>
<p>为了避免暴露OSS文件的URL并优化性能，这里对文件下载部分进行了改进。通过使用并发批量下载文件，减少与OSS服务器的连接次数。下载时，文件内容将转换为Base64编码后返回前端，前端可以解码并展示。</p>
<p>以下是优化后的文件下载实现：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.gccloud.dataroom.core.utils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.gccloud.dataroom.core.module.file.entity.DataRoomFileEntity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.gccloud.dataroom.core.module.file.service.IDataRoomOssService;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.google.common.collect.Lists;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.commons.lang3.StringUtils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.*;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.net.URL;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.concurrent.*;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 批量文件下载器</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class FileDownloader {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static final int THREAD_POOL_SIZE = 10;  // 设置线程池大小</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 批量下载文件，阻塞方式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param ossFileService OSS文件服务对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param fileEntities 文件实体列表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 包含文件内容的字节数组列表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static List&lt;byte[]&gt; downloadFileInParallel(IDataRoomOssService ossFileService, List&lt;DataRoomFileEntity&gt; fileEntities) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ExecutorService executorService = Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;Future&lt;byte[]&gt;&gt; futures = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 提交任务到线程池</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (DataRoomFileEntity fileEntity : fileEntities) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            futures.add(executorService.submit(() -&gt; downloadFile(ossFileService, fileEntity)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 等待所有任务完成并收集文件内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;byte[]&gt; fileContents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Future&lt;byte[]&gt; future : futures) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                fileContents.add(future.get());  // 阻塞，等待文件下载完成</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } catch (InterruptedException | ExecutionException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                log.error("下载文件失败", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                fileContents.add(new byte[0]);  // 如果下载失败，返回空字节数组</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        executorService.shutdown();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return fileContents;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 下载单个文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param ossFileService OSS文件服务对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param fileEntity 文件实体</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 文件内容的字节数组</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] downloadFile(IDataRoomOssService ossFileService, DataRoomFileEntity fileEntity) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String fileUrl = fileEntity.getUrl();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (StringUtils.isBlank(fileUrl) || !ossFileService.isUrlAccessible(fileUrl)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            fileUrl = ossFileService.setOssFilePublicReadWithExpiry(fileEntity.getPath(), 3600);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try (InputStream inputStream = new URL(fileUrl).openStream();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            byte[] buffer = new byte[8192];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            int bytesRead;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            while ((bytesRead = inputStream.read(buffer)) != -1) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                outputStream.write(buffer, 0, bytesRead);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return outputStream.toByteArray();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log.error("文件下载失败: {}", fileUrl, e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return new byte[0];  // 下载失败时返回空字节数组</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="24-线程池工具类">2.4 线程池工具类<a href="https://jachen99.github.io/blog/product-docs-oss-integration#24-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B7%A5%E5%85%B7%E7%B1%BB" class="hash-link" aria-label="2.4 线程池工具类的直接链接" title="2.4 线程池工具类的直接链接">​</a></h4>
<p>为提高系统性能，尤其是在处理文件上传、下载、复制等大量IO密集型操作时，合理地使用线程池能够有效减少系统的阻塞时间和响应时间。以下是线程池工具类的实现，提供了创建和管理线程池的功能。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.gccloud.dataroom.core.utils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.jetbrains.annotations.NotNull;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.concurrent.*;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.concurrent.atomic.AtomicInteger;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 线程池工具类</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class ThreadPoolUtils {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 计算机核心数，设置线程池的默认参数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final int POOL_SIZE = Runtime.getRuntime().availableProcessors() + 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final int POOL_SIZE_MAX = (Runtime.getRuntime().availableProcessors() + 2) * 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static final int AWAIT_TERMINATION_TIMEOUT = 10;  // 等待线程池关闭的最大时间（秒）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取默认线程池（核心线程数8，最大线程数16）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static ThreadPoolExecutor getDefaultThreadPoolExecutor() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return createThreadPoolExecutor(8, 16, 1000L, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取线程池实例，允许自定义核心线程数和最大线程数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param corePoolSize 核心线程数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param maximumPoolSize 最大线程数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param keepAliveTime 线程空闲存活时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param unit 时间单位</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return ThreadPoolExecutor 线程池</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static ThreadPoolExecutor createThreadPoolExecutor(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ThreadFactory threadFactory = new ThreadFactory() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            private final AtomicInteger threadNumber = new AtomicInteger(1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            private final String namePrefix = "pool-thread-";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            private final ThreadGroup group = Thread.currentThread().getThreadGroup();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            public Thread newThread(@NotNull Runnable r) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Thread thread = new Thread(group, r, namePrefix + threadNumber.getAndIncrement(), 0);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                thread.setDaemon(false);  // 设置为非守护线程</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return thread;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, unit,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new LinkedBlockingQueue&lt;&gt;(), threadFactory, new ThreadPoolExecutor.CallerRunsPolicy());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 创建自适应线程池，核心线程数 = CPU 核心数 + 2，最大线程数 = 核心线程数 * 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static ThreadPoolExecutor createFitThreadPoolExecutor() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return createThreadPoolExecutor(POOL_SIZE, POOL_SIZE_MAX, 1000L, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 初始化线程池，提供名称格式自定义</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param nameFormat 线程名称格式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 线程池实例</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static ExecutorService initPool(String nameFormat) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ThreadFactory threadFactory = new ThreadFactory() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            private final AtomicInteger threadNumber = new AtomicInteger(1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            private final String namePrefix = nameFormat;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            public Thread newThread(@NotNull Runnable r) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Thread thread = new Thread(r, namePrefix + threadNumber.getAndIncrement());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                thread.setDaemon(false);  // 设置为非守护线程</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return thread;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new ThreadPoolExecutor(POOL_SIZE, POOL_SIZE, 0L, TimeUnit.MILLISECONDS,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new LinkedBlockingQueue&lt;&gt;(Integer.MAX_VALUE), threadFactory, new ThreadPoolExecutor.CallerRunsPolicy());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 优雅关闭线程池</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param pool 线程池实例</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void shutdownPool(ExecutorService pool) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            pool.shutdown(); // 启动关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (!pool.awaitTermination(AWAIT_TERMINATION_TIMEOUT, TimeUnit.SECONDS)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                log.warn("线程池关闭超时，强制关闭");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                pool.shutdownNow(); // 强制关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log.info("线程池成功关闭");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log.error("线程池关闭中断: {}", e.getMessage());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            pool.shutdownNow(); // 如果等待中断则强制关闭线程池</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取线程池的监控信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param executor 线程池实例</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return 线程池的监控信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String getThreadPoolStats(ThreadPoolExecutor executor) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        StringBuilder stats = new StringBuilder();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        stats.append("线程池状态：\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("核心线程数: ").append(executor.getCorePoolSize()).append("\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("最大线程数: ").append(executor.getMaximumPoolSize()).append("\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("活跃线程数: ").append(executor.getActiveCount()).append("\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("当前线程数: ").append(executor.getPoolSize()).append("\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("已完成任务数: ").append(executor.getCompletedTaskCount()).append("\n")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .append("当前排队任务数: ").append(executor.getQueue().size()).append("\n");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return stats.toString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-总结">3. 总结<a href="https://jachen99.github.io/blog/product-docs-oss-integration#3-%E6%80%BB%E7%BB%93" class="hash-link" aria-label="3. 总结的直接链接" title="3. 总结的直接链接">​</a></h3>
<p>以上内容涵盖了在BI平台中集成OSS服务的相关功能，包括文件上传、下载、删除、复制以及使用线程池优化并发操作的实现。通过合理配置线程池和OSS参数，您可以有效提高系统的吞吐量并降低文件操作的延迟。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="OSS" term="OSS"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[使用Java8新特性构建树形结构：灵活的父子节点关系处理]]></title>
        <id>https://jachen99.github.io/blog/product-tree-structure-construction</id>
        <link href="https://jachen99.github.io/blog/product-tree-structure-construction"/>
        <updated>2024-12-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[学习如何利用Java 8的Stream API、Lambda、Function及BiConsumer等新特性，将扁平列表数据优雅地转换为树形结构。本文提供完整代码示例，详解从节点定义到递归构建的通用解决方案。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>在实际开发中，树形结构广泛应用于组织和表示层级化数据，如文件目录、菜单导航、组织架构等。Java 8 的流式 API 和函数式编程特性为处理这类问题提供了极大的便利。下面将分享如何使用 Java 8 中的 <code>Function</code> 和 <code>BiConsumer</code> 等新特性，构建树形结构并处理父子节点关系。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="项目背景">项目背景<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF" class="hash-link" aria-label="项目背景的直接链接" title="项目背景的直接链接">​</a></h3>
<p>在许多业务场景中，我们经常需要根据节点的父子关系来构建一个树形结构。例如，一个简单的交易信息模型可能包含多个交易节点，节点之间有父子关系。通过这种方式，我们可以快速实现层级结构，并对数据进行灵活操作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="项目需求">项目需求<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E9%A1%B9%E7%9B%AE%E9%9C%80%E6%B1%82" class="hash-link" aria-label="项目需求的直接链接" title="项目需求的直接链接">​</a></h3>
<p>我们需要实现一个方法，将一组数据根据父子关系构建成树形结构。在树形结构中，父节点将包含所有子节点。我们使用 Java 8 提供的流式操作来实现这一功能，同时利用函数式接口，如 <code>Function</code> 和 <code>BiConsumer</code>，来提高代码的灵活性和可复用性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="关键技术">关键技术<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="关键技术的直接链接" title="关键技术的直接链接">​</a></h3>
<ol>
<li><strong>BiConsumer</strong>：接受两个参数并返回 <code>void</code>，我们用它来处理节点之间的父子关系，例如为父节点设置子节点。</li>
<li><strong>Function</strong>：接受一个输入参数并返回一个结果，用于从节点中获取 ID 和父 ID。</li>
<li><strong>Stream API</strong>：通过流式操作对数据进行过滤和处理，避免了传统的嵌套循环方式。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码实现">代码实现<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="代码实现的直接链接" title="代码实现的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Arrays;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.function.BiConsumer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.function.Function;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.stream.Collectors;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 功能描述: </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 该类用于构建树形结构，基于给定的数据列表，将父子节点关系组织成层级化的树形结构。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 通过使用 Java 8 新特性，如 Function 和 BiConsumer，灵活地处理节点间的父子关系。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * -</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 创建人: 季冠臣</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 创建时间: 2024/12/2 15:38</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class TreeStructureTest {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 模拟的节点类</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static class TradeInfo {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private String tradeID;  // 当前节点ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private String parentID; // 父节点ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private List&lt;TradeInfo&gt; children;  // 子节点列表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public TradeInfo(String tradeID, String parentID) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.tradeID = tradeID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.parentID = parentID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.children = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Getter 和 Setter 方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public String getTradeID() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return tradeID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public void setTradeID(String tradeID) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.tradeID = tradeID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public String getParentID() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return parentID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public void setParentID(String parentID) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.parentID = parentID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public List&lt;TradeInfo&gt; getChildren() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return children;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public void setChildren(List&lt;TradeInfo&gt; children) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.children = children;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public String toString() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return "TradeInfo{" +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    "tradeID='" + tradeID + '\'' +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ", parentID='" + parentID + '\'' +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ", children=" + children +</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    '}';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 构建树形结构</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static &lt;T, R&gt; List&lt;T&gt; buildTree(List&lt;T&gt; dataList, BiConsumer&lt;T, List&lt;T&gt;&gt; setChildF, Function&lt;T, R&gt; getIdF,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                            Function&lt;T, R&gt; getParentIdF, R rootParentId) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (dataList != null &amp;&amp; !dataList.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            setChildCall(dataList, setChildF, getIdF, getParentIdF, rootParentId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            dataList = dataList.stream()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    .filter(t -&gt; (rootParentId != null &amp;&amp; rootParentId.equals(getParentIdF.apply(t)))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            || (rootParentId == null &amp;&amp; getParentIdF.apply(t) == null))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return dataList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 将子集放入父级</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static &lt;T, R&gt; List&lt;T&gt; setChildCall(List&lt;T&gt; dataList, BiConsumer&lt;T, List&lt;T&gt;&gt; setChildF, Function&lt;T, R&gt; getIdF,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                               Function&lt;T, R&gt; getParentIdF, R parentId) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (dataList == null || dataList.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return dataList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;T&gt; parentChild = dataList.stream()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .filter(t -&gt; parentId == null || (getParentIdF.apply(t) != null &amp;&amp; getParentIdF.apply(t).equals(parentId)))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (T t : parentChild) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            setChildF.accept(t, setChildCall(dataList, setChildF, getIdF, getParentIdF, getIdF.apply(t)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return parentChild;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建示例数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;TradeInfo&gt; dataList = Arrays.asList(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new TradeInfo("1", null),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new TradeInfo("2", "1"),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new TradeInfo("3", "1"),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new TradeInfo("4", "2"),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new TradeInfo("5", "2")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 定义如何获取ID和父ID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Function&lt;TradeInfo, String&gt; getIdF = TradeInfo::getTradeID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Function&lt;TradeInfo, String&gt; getParentIdF = TradeInfo::getParentID;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 定义如何设置子节点</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BiConsumer&lt;TradeInfo, List&lt;TradeInfo&gt;&gt; setChildF = TradeInfo::setChildren;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 构建树结构</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;TradeInfo&gt; tree = buildTree(dataList, setChildF, getIdF, getParentIdF, null);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 输出结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("构建后的树形结构:");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        tree.forEach(System.out::println);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码解析">代码解析<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90" class="hash-link" aria-label="代码解析的直接链接" title="代码解析的直接链接">​</a></h3>
<ol>
<li><strong>TradeInfo 类</strong>：定义了一个简单的节点类，包含 <code>tradeID</code> 和 <code>parentID</code>，并通过 <code>children</code> 列表存储子节点。</li>
<li><strong>buildTree 方法</strong>：这是树形结构构建的核心方法。它通过递归将子节点设置到父节点，并根据父节点 ID 筛选出该层级的节点。</li>
<li><strong>setChildCall 方法</strong>：该方法实现了递归的核心逻辑，通过 <code>BiConsumer</code> 将子节点设置到父节点，构建树形结构。</li>
<li><strong>函数式接口</strong>：通过 <code>Function</code> 接口获取节点的 ID 和父 ID，通过 <code>BiConsumer</code> 设置子节点，实现了灵活的节点关系操作。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="输出结果">输出结果<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C" class="hash-link" aria-label="输出结果的直接链接" title="输出结果的直接链接">​</a></h3>
<p>运行以上代码后，输出的树形结构将展示如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">构建后的树形结构:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TradeInfo{tradeID='1', parentID='null', children=[TradeInfo{tradeID='2', parentID='1', children=[TradeInfo{tradeID='4', parentID='2', children=[]}, TradeInfo{tradeID='5', parentID='2', children=[]}]}, TradeInfo{tradeID='3', parentID='1', children=[]}]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如上所示，我们成功地将交易信息列表组织成了树形结构。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结<a href="https://jachen99.github.io/blog/product-tree-structure-construction#%E5%B0%8F%E7%BB%93" class="hash-link" aria-label="小结的直接链接" title="小结的直接链接">​</a></h3>
<p>通过 Java 8 的函数式编程特性，我们可以更加简洁、灵活地处理复杂的父子节点关系。这种方法不仅适用于树形结构的构建，还能够广泛应用于其他需要层级关系的数据处理场景。例如，在处理文件目录、组织架构、菜单层级等问题时，采用类似的方法将大大提高代码的可读性和可维护性。</p>
<blockquote>
<p>当然，在实际应用中，树形结构可能会更加复杂，涉及更多的业务逻辑。你可以根据自己的需求进行扩展和调整。希望本文能为你的开发工作提供一些启发！🚀</p>
</blockquote>
<hr><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Java" term="Java"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SpringBoot集成Jasypt实现Nacos配置加密与解密]]></title>
        <id>https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption</id>
        <link href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption"/>
        <updated>2024-11-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[教程：如何在SpringBoot项目中集成Jasypt，通过自定义加密器实现Nacos配置中心敏感信息（如数据库密码）的国密SM4加解密。保障生产环境配置安全。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>本文介绍如何在Nacos中使用国密SM4算法对敏感信息进行加密，并在Spring Boot项目中解密这些配置项。使用Jasypt来集成加密库，并编写一个自定义的加密器，以实现配置项的加密和解密功能。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-集成jasypt加密库">1. 集成Jasypt加密库<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#1-%E9%9B%86%E6%88%90jasypt%E5%8A%A0%E5%AF%86%E5%BA%93" class="hash-link" aria-label="1. 集成Jasypt加密库的直接链接" title="1. 集成Jasypt加密库的直接链接">​</a></h2>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="11将jasypt加密库集成到spring-boot项目中在pomxml文件中添加以下依赖">1.1、将Jasypt加密库集成到Spring Boot项目中。在pom.xml文件中添加以下依赖：<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#11%E5%B0%86jasypt%E5%8A%A0%E5%AF%86%E5%BA%93%E9%9B%86%E6%88%90%E5%88%B0spring-boot%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%9C%A8pomxml%E6%96%87%E4%BB%B6%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A5%E4%B8%8B%E4%BE%9D%E8%B5%96" class="hash-link" aria-label="1.1、将Jasypt加密库集成到Spring Boot项目中。在pom.xml文件中添加以下依赖：的直接链接" title="1.1、将Jasypt加密库集成到Spring Boot项目中。在pom.xml文件中添加以下依赖：的直接链接">​</a></h5>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">com.github.ulisesbocchio</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">jasypt-spring-boot</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">3.0.4</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>注：需要引用高版本的3.0.4，避免影响系统性能，参考 <a href="https://www.jianshu.com/p/c02276987d46" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/c02276987d46</a></em></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="12在启动类上添加注解-enableencryptableproperties">1.2、在启动类上添加注解 @EnableEncryptableProperties<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#12%E5%9C%A8%E5%90%AF%E5%8A%A8%E7%B1%BB%E4%B8%8A%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3-enableencryptableproperties" class="hash-link" aria-label="1.2、在启动类上添加注解 @EnableEncryptableProperties的直接链接" title="1.2、在启动类上添加注解 @EnableEncryptableProperties的直接链接">​</a></h5>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-创建国密sm4加密工具类">2. 创建国密SM4加密工具类<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#2-%E5%88%9B%E5%BB%BA%E5%9B%BD%E5%AF%86sm4%E5%8A%A0%E5%AF%86%E5%B7%A5%E5%85%B7%E7%B1%BB" class="hash-link" aria-label="2. 创建国密SM4加密工具类的直接链接" title="2. 创建国密SM4加密工具类的直接链接">​</a></h2>
<p>创建国密SM4加密工具类，它将负责实际的加密和解密操作。已有工具所在目录 com.space.jiguanchen.utils.Sm4Utils ：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.space.jiguanchen.utils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bouncycastle.jce.provider.BouncyCastleProvider;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bouncycastle.pqc.math.linearalgebra.ByteUtils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.crypto.Cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.crypto.KeyGenerator;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.crypto.spec.SecretKeySpec;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.security.Key;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.security.SecureRandom;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.security.Security;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Arrays;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author jiguanchen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Sm4Utils {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ENCODING = "UTF-8";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORIGTHM_NAME = "SM4";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME_ECB_PADDING = "SM4/ECB/PKCS7Padding";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final int DEFAULT_KEY_SIZE = 128;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String key="dhjashdasa26kl223jkwqe2ejwejwq";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public Sm4Utils() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Security.addProvider(new BouncyCastleProvider());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:生成ecb暗号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Cipher generateEcbCipher(String algorithmName, int mode, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = Cipher.getInstance(algorithmName,BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Key sm4Key = new SecretKeySpec(key, ALGORIGTHM_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.init(mode, sm4Key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:自动生成密钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] generateKey() throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return generateKey(DEFAULT_KEY_SIZE);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] generateKey(int keySize) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        KeyGenerator kg = KeyGenerator.getInstance(ALGORIGTHM_NAME, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kg.init(keySize, new SecureRandom());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return kg.generateKey().getEncoded();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encryptEcb(String hexKey, String paramStr, String charset) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String cipherText = "";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (null != paramStr &amp;&amp; !"".equals(paramStr)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            byte[] keyData = ByteUtils.fromHexString(hexKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            charset = charset.trim();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (charset.length() &lt;= 0) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                charset = ENCODING;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            byte[] srcData = paramStr.getBytes(charset);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            byte[] cipherArray = encrypt_Ecb_Padding(keyData, srcData);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            cipherText = ByteUtils.toHexString(cipherArray);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipherText;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:加密模式之ecb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] encrypt_Ecb_Padding(byte[] key, byte[] data) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateEcbCipher(ALGORITHM_NAME_ECB_PADDING, Cipher.ENCRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] bs = cipher.doFinal(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return bs;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:sm4解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptEcb(String hexKey, String cipherText, String charset) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String decryptStr = "";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] keyData = ByteUtils.fromHexString(hexKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherData = ByteUtils.fromHexString(cipherText);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] srcData = decrypt_Ecb_Padding(keyData, cipherData);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        charset = charset.trim();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (charset.length() &lt;= 0) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            charset = ENCODING;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        decryptStr = new String(srcData, charset);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return decryptStr;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt_Ecb_Padding(byte[] key, byte[] cipherText) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateEcbCipher(ALGORITHM_NAME_ECB_PADDING, Cipher.DECRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher.doFinal(cipherText);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:密码校验</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static boolean verifyEcb(String hexKey,String cipherText,String paramStr) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        boolean flag = false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] keyData = ByteUtils.fromHexString(hexKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherData = ByteUtils.fromHexString(cipherText);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] decryptData = decrypt_Ecb_Padding(keyData,cipherData);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] srcData = paramStr.getBytes(ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        flag = Arrays.equals(decryptData,srcData);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return flag;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *  @Description:测试类</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 自定义的32位16进制密钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String key = "dhjashdasa26kl223jkwqe2ejwejwq";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String url = Sm4Utils.encryptEcb(key, "jdbc:mysql://127.0.0.1:3306/demo?serverTimezone=GMT%2B8",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String username = Sm4Utils.encryptEcb(key, "root",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String password = Sm4Utils.encryptEcb(key, "root",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(username);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(password);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Sm4Utils</code>类包含了国密SM4算法的加密和解密方法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-创建自定义的jasypt加密器">3. 创建自定义的Jasypt加密器<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#3-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84jasypt%E5%8A%A0%E5%AF%86%E5%99%A8" class="hash-link" aria-label="3. 创建自定义的Jasypt加密器的直接链接" title="3. 创建自定义的Jasypt加密器的直接链接">​</a></h2>
<p>为了让Nacos使用我们自己的加密工具进行配置解密，我们需要创建一个自定义的Jasypt加密器。在项目中新建一个名为<code>JasyptStringEncryptor</code>的类，并让它实现jasypt提供的<code>StringEncryptor</code>接口，如下所示：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.space.jiguanchen.auth.config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.space.jiguanchen.utils.Sm4Utils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.jasypt.encryption.StringEncryptor;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author jiguanchen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class JasyptStringEncryptor implements StringEncryptor {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${my.jasyptEncryptor.enable:false}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private boolean enable;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public String encrypt(String message) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        final String exMsg = String.format("encrypt method is not implemented, original message: '%s'.", message);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log.error(exMsg);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        throw new UnsupportedOperationException(exMsg);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public String decrypt(String message) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String decryptedMessage = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (enable){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                decryptedMessage = Sm4Utils.decryptEcb(Sm4Utils.key,message,Sm4Utils.ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                decryptedMessage=message;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log.debug("---------------------------------------解密了: {} -----------------------------------",decryptedMessage);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            log.error("decrypt failed:"+message+"-"+ e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return decryptedMessage;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在<code>JasyptStringEncryptor</code>中，我们注入了一个名为<code>enable</code>的属性，该属性用于控制加密功能是否启用。当<code>enable</code>为<code>true</code>时，我们使用我们自己的国密SM4工具对配置信息进行解密；当<code>enable</code>为<code>false</code>时，我们直接返回原始配置信息，即不进行解密操作。</p>
<p><em>注：如果自定义类名不是JasyptStringEncryptor，则需要在nacos上面添加配置：</em></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">jasypt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">encryptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">## 实现jasypt加加密解密的类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">bean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> JasyptStringEncryptorDemo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-配置nacos使用自定义加密器">4. 配置Nacos使用自定义加密器<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#4-%E9%85%8D%E7%BD%AEnacos%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A0%E5%AF%86%E5%99%A8" class="hash-link" aria-label="4. 配置Nacos使用自定义加密器的直接链接" title="4. 配置Nacos使用自定义加密器的直接链接">​</a></h2>
<p>最后，我们需要在Nacos配置文件中指定使用自定义的加密器。在<code>bootstrap.properties</code>或<code>bootstrap.yml</code>文件中添加以下配置：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 启用自定义加密器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">jasyptEncryptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">enable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的<code>my.jasyptEncryptor.enable</code>属性的值设置为<code>true</code>，表示启用我们自己编写的加密逻辑，即使用国密SM4进行解密。如果要禁用加密功能，将其设置为<code>false</code>。</p>
<p>完成了以上步骤后，Nacos会在启动时自动加载并使用我们的自定义加密器，从而实现数据库配置的解密操作。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-加密配置项并放入nacos">5. 加密配置项并放入Nacos<a href="https://jachen99.github.io/blog/springboot-jasypt-nacos-config-encryption#5-%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%B9%B6%E6%94%BE%E5%85%A5nacos" class="hash-link" aria-label="5. 加密配置项并放入Nacos的直接链接" title="5. 加密配置项并放入Nacos的直接链接">​</a></h2>
<p>使用国密SM4加密工具类<code>Sm4Utils</code>来加密敏感配置项，例如数据库连接的url、username和password。在Sm4Utils的<code>main</code>方法中进行加密操作，得到加密后的配置项：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 自定义的32位16进制密钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String key = "dhjashdasa26kl223jkwqe2ejwejwq";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String url = Sm4Utils.encryptEcb(key, "jdbc:mysql://127.0.0.1:3306/demo?serverTimezone=GMT%2B8",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String username = Sm4Utils.encryptEcb(key, "root",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String password = Sm4Utils.encryptEcb(key, "root",ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(username);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(password);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>得到加密后的密文配置项，将它们作为值存放到Nacos中的配置项中：</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">url=ENC(opkdai32klsamnxa97b678f092c50e042f756371ef644de9dc4aa6318afa8a304a20b327ce84eb573ade0fb7336be9827cec08cd149f0c5380af4926f5219b7829edde1b4026d4229d30a86702851948164bc23af18a4797bae23f7833c2239ab3fd654dc234be37b2b3f31cbeae9e09eaf519a04a623d3c5795d23fa8fa3ce1c59eaf87c0af</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">username=ENC(dasjkdljasdjad23342mkljjlk)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">password=ENC(0298hsdajd328783jdsakjd212)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重启服务，在Nacos启动时会被正确地解密并加载到Spring Boot项目中。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="安全" term="安全"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[探究零拷贝技术]]></title>
        <id>https://jachen99.github.io/blog/product-introduction-of-zero-copy-technology</id>
        <link href="https://jachen99.github.io/blog/product-introduction-of-zero-copy-technology"/>
        <updated>2024-10-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[深入解析零拷贝(Zero-Copy)技术如何优化性能。本文从传统IO的4次拷贝与上下文切换问题入手，讲解mmap与sendfile两种零拷贝实现方式的原理与区别，并介绍其在Kafka、RocketMQ等中间件中的应用。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>RocketMQ是阿里团队研发并开源的消息中间件，它延续了kafka的很多优点，例如高性能，为了研究RocketMQ究竟是如何做到高性能的呢？零拷贝技术就是一个重要的原因。</em></p>
<p>高效原因：</p>
<ul>
<li>
<p>CommitLog顺序写, 存储了MessagBody、message key、tag等信息</p>
</li>
<li>
<p>ConsumeQueue随机读 + 操作系统的PageCache + 零拷贝技术ZeroCopy</p>
<ul>
<li>
<p>零拷贝技术</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">read(file, tmp_buf, len);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">write(socket, tmp_buf, len);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>例子：将一个File读取并发送出去（Linux有两个上下文，内核态，用户态）</p>
<ul>
<li>File文件的经历了4次copy<!-- -->
<ul>
<li>调用read,将文件拷贝到了kernel内核态</li>
<li>CPU控制 kernel态的数据copy到用户态</li>
<li>调用write时，user态下的内容会copy到内核态的socket的buffer中</li>
<li>最后将内核态socket buffer的数据copy到网卡设备中传送</li>
</ul>
</li>
<li>缺点：增加了上下文切换、浪费了2次无效拷贝(即步骤2和3)</li>
</ul>
</li>
<li>
<p>ZeroCopy：</p>
<ul>
<li>请求kernel直接把disk的data传输给socket，而不是通过应用程序传输。Zero copy大大提高了应用程序的性能，减少不必要的内核缓冲区跟用户缓冲区间的拷贝，从而减少CPU的开销和减少了kernel和user模式的上下文切换，达到性能的提升</li>
<li>对应零拷贝技术有mmap及sendfile<!-- -->
<ul>
<li>mmap:小文件传输快<!-- -->
<ul>
<li>RocketMQ 选择这种方式，mmap+write 方式，小块数据传输，效果会比 sendfile 更好</li>
</ul>
</li>
<li>sendfile:大文件传输比mmap快</li>
</ul>
</li>
<li>Java中的TransferTo()实现了Zero-Copy</li>
<li>应用：Kafka、Netty、RocketMQ等都采用了零拷贝技术</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>原始的拷贝技术：</p>
<p><img decoding="async" loading="lazy" alt="image-20230128234721451" src="https://jachen99.github.io/assets/images/image-20230128234721451-dd4af67b7a2fa7c9784cf766e100dfae.png" width="805" height="562" class="img_ev3q"></p>
<p>零拷贝技术：</p>
<p><img decoding="async" loading="lazy" alt="image-20230128234745085" src="https://jachen99.github.io/assets/images/image-20230128234745085-207f8aae1e516506317e609e36e7f1d5.png" width="761" height="492" class="img_ev3q"></p>
<p>参考文章： <a href="https://github.com/0voice/linux_kernel_wiki/blob/main/%E6%96%87%E7%AB%A0/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%EF%BC%8C%E5%BD%BB%E5%BA%95%E4%BA%86%E8%A7%A3%EF%BC%8C%E9%9B%B6%E6%8B%B7%E8%B4%9DZero-Copy%E6%8A%80%E6%9C%AF.md" target="_blank" rel="noopener noreferrer">https://github.com/0voice/linux_kernel_wiki/blob/main/%E6%96%87%E7%AB%A0/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%EF%BC%8C%E5%BD%BB%E5%BA%95%E4%BA%86%E8%A7%A3%EF%BC%8C%E9%9B%B6%E6%8B%B7%E8%B4%9DZero-Copy%E6%8A%80%E6%9C%AF.md</a></p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="RocketMQ" term="RocketMQ"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[探究Nginx优雅reload的细节]]></title>
        <id>https://jachen99.github.io/blog/product-nginx-reload</id>
        <link href="https://jachen99.github.io/blog/product-nginx-reload"/>
        <updated>2024-10-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[深入解析Nginx `reload` 命令背后的优雅重启流程。本文讲解master与worker进程如何协作，处理SIGHUP信号，启动新进程并优雅关闭旧进程（graceful shutdown），确保服务不中断地平滑更新配置。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>我们知道在Ngnix的conf配置文件之后,不能kill掉matser重新启动Ngnix服务器，而是需要执行 nginx -s reload命令，在 不停止服务始终在处理新的请求的同时把 nginx 的配置文件平滑的把旧的 nginx.conf 配置更新为新的 nginx.conf 配置。那么这是为什么呢？</em></p>
<p>这样一个功能对于 nginx 非常有必要，但是有时候我们会发现在执行 <code>nginx -s reload</code> 命令后，worker 子进程的数量会变多了，这是因为老的配置运行的 worker 进程长时间没有退出，当使用 stream 做四层反向代理的时候，可能这种场景会更多。</p>
<p>那么下面我们通过分析 nginx 的 reload 流程，来探究下 nginx 到底做了些什么？所谓优雅的退出和立即退出有什么区别？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reload流程">reload流程<a href="https://jachen99.github.io/blog/product-nginx-reload#reload%E6%B5%81%E7%A8%8B" class="hash-link" aria-label="reload流程的直接链接" title="reload流程的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20230129234025673" src="https://jachen99.github.io/assets/images/image-20230129234025673-408e9591c6b983445a857dc17ae854f4.png" width="867" height="594" class="img_ev3q"></p>
<p>第一步在修改好 nginx 的配置文件 nginx.conf 后，向 master 进程发送 HUP 信号，这实际上和我们在命令行执行 <code>nginx -s reload</code> 命令效果是一样的。</p>
<p>那么 master 进程在收到 HUP 信号以后，会在第二步检查我们的配置文件语法是否正确，也就是说我们并不一定非要在 nginx -s reload 前执行 nginx -t 检验下语法是否正确，因为在第二步 nginx 的 master 进程一定会执行这个步骤。</p>
<p>在 nginx 的配置语法全部正确以后，master 进程会打开新的监听端口，为什么要在 master 进程中打开新的监听端口？因为我们可能在 nginx.conf 中会引入新的例如 443 或者之前我们没有打开的的监听端口，而所有 worker 进程是 master 进程 的子进程，子进程会继承父进程所有已经打开的端口，这是 linux 操作系统定义的，所以第三步，我们 master 进程打开了可能引入的新的监听端口。</p>
<p>接下来 mster 进程会用新的 nginx.conf 配置文件来启动新的 worker 子进程，那么老的 worker 子进程会怎么样呢？</p>
<p>我们会在第五步在启动新的 worker 子进程以后，由 master 进程再向老 worker 子进程发送 QUIT 信号，QUIT 信号和 TERM，INT 信号是不一样的，QUIT 信号是请优雅地关闭子进程，这时候需要关注顺序，因为 nginx 需要保证平滑，所以要先启动新的 worker 子进程，再向老的 worker 子进程发送 QUIT 信号。</p>
<p>那么老的 master 子进程收到 QUIT 信号后，首先关闭监听句柄，也就是说这个时候新的连接只会到新的 worker 子进程，所以虽然他们之间有时间差，但是时间是非常快速的，那么关闭监听句柄后，处理完当前连接后就结束进程。</p>
<p>下面看 reload 不停机载入新配置的图示。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reload-不停机载入新配置">reload 不停机载入新配置<a href="https://jachen99.github.io/blog/product-nginx-reload#reload-%E4%B8%8D%E5%81%9C%E6%9C%BA%E8%BD%BD%E5%85%A5%E6%96%B0%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="reload 不停机载入新配置的直接链接" title="reload 不停机载入新配置的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1356806-20191216111255642-526956790" src="https://jachen99.github.io/assets/images/1356806-20191216111255642-526956790-c3d6cf140a54e7b57d0e02248be04cb7.png" width="2016" height="1020" class="img_ev3q"></p>
<p>master 进程上原先有四个绿色的 worker 子进程，它们使用了老的配置，当我们更改了 nginx.conf 配置文件后，向 master 发送 SIGHUP 信号或者执行 reload 命令， 然后 master 会用新的配置文件启动四个新的黄色 worker 子进程，此时是四个老的绿色 worker 子进程和四个新的黄色的 worker 子进程是并存的。那么老的 worker 子进程在正常的情况下会在处理已经建立好的连接上的请求之后关闭这个连接，哪怕这个连接是 keeplive 请求也会正常关闭。</p>
<p>但是异常情况，如果有一些请求出现问题，客户端长时间无法处理，那么就会导致这个请求长时间停留在这个 worker 子进程当中，那么这个 worker 子进程会长时间存在，因为新的连接已经跑在黄色的 worker 子进程中，所以影响并不会很大，唯一会影响的就是绿色的 worker 子进程会长时间存在，但也只影响已存在的连接，不会影响新的连接。</p>
<p>我们有什么办法处理呢？在新版本中提供了一个新的配置 worker_shutdown_timeout，也就是说最长等待多长时间，这样 master 进程启动新的黄色 worker 进程之后，如果老的 worker 进程一直没有退出，时间到了之后会强制把老的 worker 进程退出掉。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/product-nginx-reload#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>本文主要讲解了 Nginx 平滑升级新的配置文件的流程，在我们了解了优雅关闭 worker 子进程和启动新配置的 worker 子进程流程间的关系后，我们可以更好地处理罕见的异常场景。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Nginx" term="Nginx"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[EasyExcel中的数据第一行获取问题及解决方案详解]]></title>
        <id>https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel</id>
        <link href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel"/>
        <updated>2024-07-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[详解如何解决EasyExcel读取Excel时第一行数据被误当成表头的问题。本文提供两种解决方案：通过`headRowNumber`指定数据起始行，以及利用`CellWriteHandler`在写操作中单独处理首行数据。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="easyexcel中的数据第一行获取问题及解决方案详解">EasyExcel中的数据第一行获取问题及解决方案详解<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#easyexcel%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%AC%AC%E4%B8%80%E8%A1%8C%E8%8E%B7%E5%8F%96%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E8%AF%A6%E8%A7%A3" class="hash-link" aria-label="EasyExcel中的数据第一行获取问题及解决方案详解的直接链接" title="EasyExcel中的数据第一行获取问题及解决方案详解的直接链接">​</a></h2>
<p>在Java开发中，处理Excel文件是一个常见的需求。EasyExcel作为一个流行的Excel操作库，提供了方便而高效的API来读写Excel文件。然而，有时会遇到数据第一行被误读为表头的问题，特别是在Excel文件的第一行不是标准表头而是实际数据时，这一问题显得尤为突出。本文将详细讨论这一问题的根本原因，并提供一种有效的解决方案。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-easyexcel简介">1. EasyExcel简介<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#1-easyexcel%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="1. EasyExcel简介的直接链接" title="1. EasyExcel简介的直接链接">​</a></h3>
<p>EasyExcel是阿里巴巴开源的一款Java操作Excel的工具库，它提供了强大的功能，支持大数据量的读写操作，并且提供了丰富的样式和格式处理功能，适用于各种场景下的Excel文件处理需求。你可以访问 EasyExcel 的官方 GitHub 页面获取更多的资料和下载： <a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/easyexcel</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-问题描述">2. 问题描述<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#2-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0" class="hash-link" aria-label="2. 问题描述的直接链接" title="2. 问题描述的直接链接">​</a></h3>
<p>在使用EasyExcel读取Excel文件时，经常会出现第一行数据被错误地识别为表头的情况。这一问题的根本原因在于EasyExcel在某些情况下无法正确识别Excel文件中数据行和表头行的区分，特别是当Excel文件结构比较复杂或者存在特定格式时，EasyExcel的默认解析逻辑可能会出现偏差。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-解决方案详解">3. 解决方案详解<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E8%AF%A6%E8%A7%A3" class="hash-link" aria-label="3. 解决方案详解的直接链接" title="3. 解决方案详解的直接链接">​</a></h3>
<p>为了解决数据第一行获取问题，我们可以采取以下步骤来调整和优化EasyExcel的读取操作，确保能够正确获取实际数据行而非表头行：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="方案1手动指定数据起始行">方案1：手动指定数据起始行<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#%E6%96%B9%E6%A1%881%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E8%B5%B7%E5%A7%8B%E8%A1%8C" class="hash-link" aria-label="方案1：手动指定数据起始行的直接链接" title="方案1：手动指定数据起始行的直接链接">​</a></h5>
<p>在读取Excel文件时，手动指定数据的起始行，而不依赖EasyExcel的自动识别。这可以通过设置<code>headRowNumber</code>来实现，明确告知EasyExcel从第几行开始读取数据。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ExcelReaderBuilder readBuilder = EasyExcel.read(inputStream, ExcelData.class, new ExcelDataListener())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .sheet().headRowNumber(2) // 指定从第3行开始读取数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .doRead();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述代码中，通过<code>headRowNumber(2)</code>指定从第3行开始读取数据，避免将第一行误读为表头。</p>
<p><strong>数据处理逻辑中排除表头行</strong></p>
<p>在实际数据处理逻辑中，可以通过逻辑判断排除表头行，确保只处理实际的数据行。例如，在<code>invoke</code>方法中可以添加逻辑判断：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Override </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public void invoke(ExcelData data, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if (context.readRowHolder().getRowIndex() &gt; 0) { // 跳过表头行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 处理实际数据逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过<code>context.readRowHolder().getRowIndex() &gt; 0</code>判断当前行索引大于0时才处理数据，跳过表头行的处理。</p>
<p><strong>使用后处理器进行二次处理</strong></p>
<p>EasyExcel提供了后处理器（Handler）机制，在数据读取完成后可以进行二次处理。可以在<code>doAfterAllAnalysed</code>方法中对数据进行进一步处理或过滤，确保最终数据的准确性和完整性。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Override </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public void doAfterAllAnalysed(AnalysisContext context) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 数据处理完成后的逻辑 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    processData(dataList);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述代码中，可以在<code>doAfterAllAnalysed</code>方法中调用<code>processData</code>方法，对数据进行进一步的处理或者存储操作。</p>
<p><strong>示例代码</strong></p>
<p>以下是一个完整的示例代码，展示了如何使用EasyExcel读取Excel文件并处理数据，同时避免数据第一行被误读为表头的问题：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.alibaba.excel.EasyExcel;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.alibaba.excel.context.AnalysisContext;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.alibaba.excel.event.AnalysisEventListener;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.alibaba.excel.read.builder.ExcelReaderBuilder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.FileInputStream;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.InputStream;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class ExcelReaderExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String fileName = "path/to/your/excel/file.xlsx";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        InputStream inputStream = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            inputStream = new FileInputStream(fileName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ExcelReaderBuilder readBuilder = EasyExcel.read(inputStream, ExcelData.class, new ExcelDataListener());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            readBuilder.sheet().headRowNumber(2); // 指定从第3行开始读取数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            readBuilder.doRead();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (inputStream != null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    inputStream.close();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static class ExcelDataListener extends AnalysisEventListener&lt;ExcelData&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private List&lt;ExcelData&gt; dataList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public void invoke(ExcelData data, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (context.readRowHolder().getRowIndex() &gt; 0) { // 跳过表头行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 处理实际数据逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                dataList.add(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public void doAfterAllAnalysed(AnalysisContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 数据处理完成后的逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            processData(dataList);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private void processData(List&lt;ExcelData&gt; dataList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 处理数据的具体逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            for (ExcelData data : dataList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                System.out.println(data.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static class ExcelData {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Excel中的数据字段对应的Java属性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private String column1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        private String column2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 省略getter和setter方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="方案2第一行数据读在表头单独处理">方案2：第一行数据读在表头单独处理<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#%E6%96%B9%E6%A1%882%E7%AC%AC%E4%B8%80%E8%A1%8C%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%9C%A8%E8%A1%A8%E5%A4%B4%E5%8D%95%E7%8B%AC%E5%A4%84%E7%90%86" class="hash-link" aria-label="方案2：第一行数据读在表头单独处理的直接链接" title="方案2：第一行数据读在表头单独处理的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@SneakyThrows</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public byte[] exportExcel(List&lt;String&gt; sheet1Ids, List&lt;String&gt; sheet2Ids, List&lt;String&gt; sheet3Ids, String startDate, String endDate) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    byte[] result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 读取模版</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         InputStream inputStream = templateFileService.getTemplateInputStreamByPath(dataComparisonFileResource.getPath())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ExcelWriter excelWriter = EasyExcel.write(outputStream)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .withTemplate(inputStream)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .autoCloseStream(true)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .registerWriteHandler(new CustomSheet1CellWriteHandler())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 写入表1 数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;LfDispatchDataComparisonGridOperationVo&gt; sheet1Data = getGridOperationData(sheet1Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.writerSheet1(excelWriter, sheet1Data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 写入表2 数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;LfDispatchDataComparisonGwEnergyVo&gt; sheet2Data = getGwEnergyData(sheet2Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.writerSheet2(excelWriter, sheet2Data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 写入表3 数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;LfDispatchDataComparisonNewEnergyOperationVo&gt; sheet3Data = getNewEnergyOperationData(sheet3Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.writerSheet3(excelWriter, sheet3Data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 生成excel</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        excelWriter.finish();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 确保所有内容都写入输出流中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result = outputStream.toByteArray();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 自定义sheet1的cell样式 用于标记 负荷占比、电量占比 大于1的单元格</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static class CustomSheet1CellWriteHandler implements WorkbookWriteHandler, CellWriteHandler {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 处理第一行数据 (easyExcel工具的bug 会将第一行数据读在表头)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param context 上下文</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void afterCellDispose(CellWriteHandlerContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (context.getRowIndex() == 2 &amp;&amp; (context.getColumnIndex() == 14 || context.getColumnIndex() == 15)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 处理第第一个sheet</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Sheet sheet = context.getRow().getSheet().getWorkbook().getSheetAt(0);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Row row = sheet.getRow(2);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Cell cell14 = row.getCell(14);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Cell cell15 = row.getCell(15);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 应用红色样式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            applyRedStyleToCells(cell14, cell15);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 处理除了第一行以外的其他数据行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param context 上下文</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void afterWorkbookDispose(WorkbookWriteHandlerContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Workbook workbook = context.getWriteWorkbookHolder().getWorkbook();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 只处理 sheet1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Sheet sheet = workbook.getSheetAt(0);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        applyRedStyleToSheet(sheet);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 按列标记红色</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param sheet 工作表</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private void applyRedStyleToSheet(Sheet sheet) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Row row : sheet) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            applyRedStyleToCells(row.getCell(14), row.getCell(15));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 对指定的单元格应用红色字体样式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param cells 需要应用红色样式的单元格</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private void applyRedStyleToCells(Cell... cells) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Cell cell : cells) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (cell != null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Workbook workbook = cell.getSheet().getWorkbook();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                CellStyle redStyle = workbook.createCellStyle();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Font redFont = workbook.createFont();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                redFont.setColor(IndexedColors.RED.getIndex());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                redStyle.setFont(redFont);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                cell.setCellStyle(redStyle);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-结论">5. 结论<a href="https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel#5-%E7%BB%93%E8%AE%BA" class="hash-link" aria-label="5. 结论的直接链接" title="5. 结论的直接链接">​</a></h3>
<p>我总结：建议不再使用EasyExcel工具。</p>
<hr><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="EasyExcel" term="EasyExcel"/>
        <category label="数据处理" term="数据处理"/>
        <category label="我的Bug" term="我的Bug"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Redis消息队列消费者端断连重试机制实现]]></title>
        <id>https://jachen99.github.io/blog/product-design-and-optimization</id>
        <link href="https://jachen99.github.io/blog/product-design-and-optimization"/>
        <updated>2024-05-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[教程：如何为基于Redis消息队列的消费者实现健壮的断线重连与自动重试机制。本文提供了使用Jedis、AtomicBoolean和线程池的完整Java代码示例，确保系统在网络波动或服务重启时消息不丢失。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis消息队列消费者端断连重试机制实现">Redis消息队列消费者端断连重试机制实现<a href="https://jachen99.github.io/blog/product-design-and-optimization#redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E6%96%AD%E8%BF%9E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="Redis消息队列消费者端断连重试机制实现的直接链接" title="Redis消息队列消费者端断连重试机制实现的直接链接">​</a></h3>
<p>在分布式系统中，Redis作为消息队列使用时，经常会面临连接中断的风险，这可能由于网络波动、Redis服务崩溃或其他外部因素导致。为了保证系统的高可用性和消息的可靠性，我们需要实现一个自动重试机制，在Redis连接断开时能够自动重连，并保证消息的消费不中断或丢失。本文将重点介绍如何在Redis队列的消费者端实现连接断开后的重连机制。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-问题描述">1. 问题描述<a href="https://jachen99.github.io/blog/product-design-and-optimization#1-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0" class="hash-link" aria-label="1. 问题描述的直接链接" title="1. 问题描述的直接链接">​</a></h2>
<p>在我们的架构中，消费者从Redis队列中拉取并处理消息，通常使用<code>Jedis</code>作为客户端与Redis交互。然而，在生产环境中，由于网络延迟、Redis服务重启或Redis连接池被耗尽等原因，Redis连接可能会出现断开。当连接断开时，消费者无法继续拉取消息，导致消息处理中断。</p>
<p>为了解决这个问题，我们需要设计一个重连机制：</p>
<ul>
<li><strong>自动检测连接状态</strong>：当消费者检测到连接断开时，能够自动重试并恢复连接。</li>
<li><strong>保证消息不丢失</strong>：在重连期间，如果Redis服务恢复，消息能够继续被消费，不会丢失。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-解决方案">2. 解决方案<a href="https://jachen99.github.io/blog/product-design-and-optimization#2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="2. 解决方案的直接链接" title="2. 解决方案的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-消费者类的重试机制设计">2.1 消费者类的重试机制设计<a href="https://jachen99.github.io/blog/product-design-and-optimization#21-%E6%B6%88%E8%B4%B9%E8%80%85%E7%B1%BB%E7%9A%84%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="2.1 消费者类的重试机制设计的直接链接" title="2.1 消费者类的重试机制设计的直接链接">​</a></h3>
<p>消费者类通过定时检查连接状态，并在Redis连接出现问题时尝试重连。我们通过引入一个标志位<code>isDown</code>来表示当前消费者是否处于断线状态。在连接恢复后，消费者能够自动恢复消息消费。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="关键代码实现">关键代码实现：<a href="https://jachen99.github.io/blog/product-design-and-optimization#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="关键代码实现：的直接链接" title="关键代码实现：的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.example.redisQueue.consumer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.concurrent.Executors;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.concurrent.atomic.AtomicBoolean;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * Redis消息队列消费者断连重试机制实现</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class RedisQueueConsumerListenerRunner implements Runnable {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private MyAbstractRedisQueueConsumer&lt;?&gt; consumer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 是否宕机标志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 通过static保证全局共享该标志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static AtomicBoolean isDown = new AtomicBoolean(false);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log.info("消费者启动，开始监听Redis队列...");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 启动消息消费线程</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Executors.newSingleThreadExecutor().submit(() -&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                consumer.consume();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                log.error("消费过程中发生异常", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                isDown.set(true); // 设置断开标志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 启动断线重试机制</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        startRetryMechanism();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 启动断连重试机制</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void startRetryMechanism() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        new Thread(() -&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            while (true) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    Thread.sleep(30 * 1000L);  // 每30秒检查一次连接状态</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    if (isDown.get()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        log.warn("Redis连接断开，正在尝试重连...");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        Thread.sleep(3000L);  // 延迟3秒后重试</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        // 执行重连操作</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        consumer.reconnect();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        isDown.set(false);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        log.info("Redis连接恢复，重试成功");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    log.error("重试线程被中断", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    Thread.currentThread().interrupt();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }).start();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-消费者类的重连方法">2.2 消费者类的重连方法<a href="https://jachen99.github.io/blog/product-design-and-optimization#22-%E6%B6%88%E8%B4%B9%E8%80%85%E7%B1%BB%E7%9A%84%E9%87%8D%E8%BF%9E%E6%96%B9%E6%B3%95" class="hash-link" aria-label="2.2 消费者类的重连方法的直接链接" title="2.2 消费者类的重连方法的直接链接">​</a></h3>
<p>消费者类需要提供一个<code>reconnect</code>方法，用于在连接断开时重新初始化连接，恢复消费任务。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="关键代码实现-1">关键代码实现：<a href="https://jachen99.github.io/blog/product-design-and-optimization#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1" class="hash-link" aria-label="关键代码实现：的直接链接" title="关键代码实现：的直接链接">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package com.example.redisQueue.consumer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import redis.clients.jedis.Jedis;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import redis.clients.jedis.JedisPool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * Redis消息队列消费者基类</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public abstract class MyAbstractRedisQueueConsumer&lt;T&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private JedisPool jedisPool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String queueName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public MyAbstractRedisQueueConsumer(String queueName) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.queueName = queueName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 重连方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 用于连接断开后恢复连接</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void reconnect() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try (Jedis jedis = jedisPool.getResource()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (jedis.isConnected()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                logger.info("Redis连接已恢复，消费者已重新连接到队列");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                logger.error("无法恢复Redis连接，正在尝试重新初始化");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 这里可以进一步增加对Redis连接池或Jedis的重初始化逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger.error("Redis重连失败", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 消费消息的抽象方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public abstract void doConsume(T message);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 消费消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void consume() throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try (Jedis jedis = jedisPool.getResource()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            while (true) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 从Redis队列中拉取消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                List&lt;String&gt; message = jedis.blpop(0, queueName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if (message != null &amp;&amp; message.size() &gt; 1) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    doConsume(message.get(1));  // 处理消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger.error("消费过程中发生异常", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-线程池和重试机制的启动">2.3 线程池和重试机制的启动<a href="https://jachen99.github.io/blog/product-design-and-optimization#23-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E7%9A%84%E5%90%AF%E5%8A%A8" class="hash-link" aria-label="2.3 线程池和重试机制的启动的直接链接" title="2.3 线程池和重试机制的启动的直接链接">​</a></h3>
<p>通过<code>Executors.newSingleThreadExecutor()</code>我们为消费者启动了独立的线程来消费消息，并在消费者检测到连接断开时启动重试机制。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Executors.newSingleThreadExecutor().submit(() -&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.consume();  // 启动消费</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log.error("消费过程中发生异常", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        isDown.set(true);  // 设置断开标志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-重试机制的检查和延迟">2.4 重试机制的检查和延迟<a href="https://jachen99.github.io/blog/product-design-and-optimization#24-%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A3%80%E6%9F%A5%E5%92%8C%E5%BB%B6%E8%BF%9F" class="hash-link" aria-label="2.4 重试机制的检查和延迟的直接链接" title="2.4 重试机制的检查和延迟的直接链接">​</a></h3>
<p>在重试机制中，我们每30秒检查一次<code>isDown</code>标志，如果发现连接已经断开，就延迟3秒后尝试重新连接。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (isDown.get()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    log.warn("Redis连接断开，正在尝试重连...");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Thread.sleep(3000L);  // 延迟3秒后重试</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    consumer.reconnect();  // 执行重连操作</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    isDown.set(false);     // 重连后清除断开标志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    log.info("Redis连接恢复，重试成功");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-技术方案对比static-atomicboolean与替代方案">3. 技术方案对比：<code>static AtomicBoolean</code>与替代方案<a href="https://jachen99.github.io/blog/product-design-and-optimization#3-%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94static-atomicboolean%E4%B8%8E%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="3-技术方案对比static-atomicboolean与替代方案的直接链接" title="3-技术方案对比static-atomicboolean与替代方案的直接链接">​</a></h2>
<p>虽然<code>AtomicBoolean</code>是一种简单且有效的实现方式，但我们也可以考虑其他方案，以下是几种常见的替代方案对比。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="技术对比方案">技术对比方案<a href="https://jachen99.github.io/blog/product-design-and-optimization#%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94%E6%96%B9%E6%A1%88" class="hash-link" aria-label="技术对比方案的直接链接" title="技术对比方案的直接链接">​</a></h3>
<table><thead><tr><th>技术方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong><code>static AtomicBoolean</code></strong></td><td>- 简单易用，线程安全&lt;br&gt;- 适用于单一线程或少数线程的全局状态控制</td><td>- 随着系统复杂度增加，可能变得不够灵活&lt;br&gt;- 共享全局状态可能导致问题</td><td>适合小型系统或少量线程的全局状态管理</td></tr><tr><td><strong><code>CountDownLatch</code></strong></td><td>- 可以灵活地控制多个线程同步&lt;br&gt;- 适合等待多个线程完成操作</td><td>- 一次性触发，无法重复使用</td><td>适合一次性控制多线程完成后进行重试操作</td></tr><tr><td><strong><code>ScheduledExecutorService</code></strong></td><td>- 定时检查，易于控制&lt;br&gt;- 支持定期任务</td><td>- 适合周期性任务，不适用于即时响应需求</td><td>适合定期检查重试的场景</td></tr><tr><td><strong><code>EventBus</code>（消息机制）</strong></td><td>- 松耦合，适合分布式环境&lt;br&gt;- 可以广播事件通知其他模块</td><td>- 增加了系统复杂性，依赖额外的库</td><td>适合分布式或微服务架构的消息广播机制</td></tr><tr><td><strong><code>RetryTemplate</code></strong></td><td>- 灵活控制重试策略，如重试次数、间隔时间等&lt;br&gt;- 简化重试逻辑</td><td>- 引入外部依赖&lt;br&gt;- 配置和使用稍显复杂</td><td>适合需要复杂重试逻辑的场景</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/product-design-and-optimization#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3>
<ul>
<li><strong><code>static AtomicBoolean</code></strong>：适合小型系统，能够简单地控制全局状态。缺点是随着系统的复杂度增加，可能变得不够灵活，且状态管理可能存在问题。</li>
<li><strong><code>CountDownLatch</code></strong>：适合等待多个线程完成任务后进行统一操作，但无法多次触发，因此不适合需要持续重连的场景。</li>
<li><strong><code>ScheduledExecutorService</code></strong>：适合定期检查连接状态并进行重试的场景。简单易用，但适合周期性任务，不适合即时响应。</li>
<li><strong><code>EventBus</code></strong>：适合分布式系统中的事件驱动场景，可以实现松耦</li>
</ul>
<p>合的异步通知机制，但会引入额外的复杂性。</p>
<ul>
<li><strong><code>RetryTemplate</code></strong>：适合需要复杂重试策略的场景，能够灵活配置重试次数和间隔时间，但相对复杂。</li>
</ul>
<p>根据实际需求选择合适的方案，可以有效地提升系统的稳定性和可用性。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Redis" term="Redis"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[安全功能之系统退出后JWT令牌失效]]></title>
        <id>https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid</id>
        <link href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid"/>
        <updated>2024-04-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[在现代Web应用中，用户退出系统是一个基本功能，然而，如何确保退出后的令牌不再有效，是系统安全性的一个关键问题。本文将介绍如何通过在用户退出时将JWT令牌加入黑名单，以及在后续请求中验证令牌的有效性，构建系统的双层安全机制，有效应对令牌滥用的风险。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><em>在现代Web应用中，用户退出系统是一个基本功能，然而，如何确保退出后的令牌不再有效，是系统安全性的一个关键问题。本文将介绍如何通过在用户退出时将JWT令牌加入黑名单，以及在后续请求中验证令牌的有效性，构建系统的双层安全机制，有效应对令牌滥用的风险。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E8%83%8C%E6%99%AF" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2>
<p>Web应用中的用户认证一般依赖于JWT令牌，它是一种轻量级的身份验证方式。然而，一旦用户退出系统，之前的令牌理论上仍然是有效的，这可能导致一些潜在的安全问题。因此，我们需要一种机制来确保退出后的令牌不再被接受，提升系统的整体安全性。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="需求">需求<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E9%9C%80%E6%B1%82" class="hash-link" aria-label="需求的直接链接" title="需求的直接链接">​</a></h2>
<p>实现用户安全退出功能。
使退出后的JWT令牌失效，防止滥用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析与设计">分析与设计<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="分析与设计的直接链接" title="分析与设计的直接链接">​</a></h2>
<p>为了满足上述需求，我们将采用以下方案：</p>
<p><strong>1、将JWT令牌加入黑名单：</strong>
在用户退出系统时，获取JWT令牌的ID。
将令牌ID存储到Redis中，构建黑名单。
设置与JWT令牌相同的失效时间，保证黑名单中的令牌会在一定时间后自动清理。</p>
<p><strong>2、验证JWT令牌的有效性：</strong>
在每次请求中，获取JWT令牌的Claims。
检查用户对象、Claims对象以及令牌ID是否不为空。
构建黑名单中的key，通过Redis验证令牌是否在黑名单中。
如果在黑名单中，拒绝请求处理。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心代码">核心代码<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="核心代码的直接链接" title="核心代码的直接链接">​</a></h2>
<p>将JWT令牌加入黑名单</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 新增将JWT令牌加入黑名单操作，并设置相同的失效时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Claims claims = SecureUtil.getClaims(Objects.requireNonNull(request));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (ObjectUtil.isNotEmpty(claims)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Date expiration = claims.getExpiration();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DateTime now = DateTime.now();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    long seconds = cn.hutool.core.date.DateUtil.between(now, expiration, DateUnit.SECOND);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String id = claims.getId();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String ExpIdKey = TokenConstant.EXP_ID + ":" + userId + ":" + id;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    redisTemplate.opsForValue().set(ExpIdKey, id);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    redisTemplate.expire(ExpIdKey, seconds, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>验证JWT令牌是否有效</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 拦截器中 校验黑名单</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Claims claims = SecureUtil.getClaims(request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (user != null &amp;&amp; claims != null &amp;&amp; StringUtil.isNotEmpty(claims.getId())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String key = TokenConstant.EXP_ID + ":" + user.getUserId() + ":" + claims.getId();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String jit = redisTemplate.opsForValue().get(key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if (claims.getId().equals(jit)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log.debug("令牌已失效");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        failBack(resp);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="扩展">扩展<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%89%A9%E5%B1%95" class="hash-link" aria-label="扩展的直接链接" title="扩展的直接链接">​</a></h2>
<p>通过这种双层安全机制，我们可以进一步扩展系统的安全性：</p>
<ul>
<li>定时任务清理过期令牌： 使用定时任务定期清理黑名单中的过期令牌，确保黑名单不会无限增长。</li>
<li>基于角色或权限的失效策略： 根据用户的角色或权限，实现更精细化的令牌失效策略。</li>
<li>结合双因素认证： 在令牌验证前加入双因素认证，提升系统的身份验证层级。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>通过构建系统的双层安全机制，我们有效地应对了用户退出后令牌的滥用风险。这种机制简单而强大，为Web应用提供了额外的安全保障，使用户退出更具安全性。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="安全" term="安全"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[安全功能之系统退出后JWT令牌失效]]></title>
        <id>https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid</id>
        <link href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid"/>
        <updated>2024-04-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[教程：如何解决JWT(JSON Web Token)在用户登出后依然有效带来的安全风险。本文讲解通过Redis构建JWT黑名单，在用户退出时立即让令牌失效的双层安全机制，并提供Java核心代码示例。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><em>在现代Web应用中，用户退出系统是一个基本功能，然而，如何确保退出后的令牌不再有效，是系统安全性的一个关键问题。本文将介绍如何通过在用户退出时将JWT令牌加入黑名单，以及在后续请求中验证令牌的有效性，构建系统的双层安全机制，有效应对令牌滥用的风险。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E8%83%8C%E6%99%AF" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2>
<p>Web应用中的用户认证一般依赖于JWT令牌，它是一种轻量级的身份验证方式。然而，一旦用户退出系统，之前的令牌理论上仍然是有效的，这可能导致一些潜在的安全问题。因此，我们需要一种机制来确保退出后的令牌不再被接受，提升系统的整体安全性。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="需求">需求<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E9%9C%80%E6%B1%82" class="hash-link" aria-label="需求的直接链接" title="需求的直接链接">​</a></h2>
<p>实现用户安全退出功能。
使退出后的JWT令牌失效，防止滥用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析与设计">分析与设计<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="分析与设计的直接链接" title="分析与设计的直接链接">​</a></h2>
<p>为了满足上述需求，我们将采用以下方案：</p>
<p><strong>1、将JWT令牌加入黑名单：</strong>
在用户退出系统时，获取JWT令牌的ID。
将令牌ID存储到Redis中，构建黑名单。
设置与JWT令牌相同的失效时间，保证黑名单中的令牌会在一定时间后自动清理。</p>
<p><strong>2、验证JWT令牌的有效性：</strong>
在每次请求中，获取JWT令牌的Claims。
检查用户对象、Claims对象以及令牌ID是否不为空。
构建黑名单中的key，通过Redis验证令牌是否在黑名单中。
如果在黑名单中，拒绝请求处理。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心代码">核心代码<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="核心代码的直接链接" title="核心代码的直接链接">​</a></h2>
<p>将JWT令牌加入黑名单</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 新增将JWT令牌加入黑名单操作，并设置相同的失效时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Claims claims = SecureUtil.getClaims(Objects.requireNonNull(request));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (ObjectUtil.isNotEmpty(claims)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Date expiration = claims.getExpiration();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DateTime now = DateTime.now();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    long seconds = cn.hutool.core.date.DateUtil.between(now, expiration, DateUnit.SECOND);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String id = claims.getId();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String ExpIdKey = TokenConstant.EXP_ID + ":" + userId + ":" + id;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    redisTemplate.opsForValue().set(ExpIdKey, id);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    redisTemplate.expire(ExpIdKey, seconds, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>验证JWT令牌是否有效</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 拦截器中 校验黑名单</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Claims claims = SecureUtil.getClaims(request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (user != null &amp;&amp; claims != null &amp;&amp; StringUtil.isNotEmpty(claims.getId())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String key = TokenConstant.EXP_ID + ":" + user.getUserId() + ":" + claims.getId();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String jit = redisTemplate.opsForValue().get(key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    if (claims.getId().equals(jit)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log.debug("令牌已失效");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        failBack(resp);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="扩展">扩展<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%89%A9%E5%B1%95" class="hash-link" aria-label="扩展的直接链接" title="扩展的直接链接">​</a></h2>
<p>通过这种双层安全机制，我们可以进一步扩展系统的安全性：</p>
<ul>
<li>定时任务清理过期令牌： 使用定时任务定期清理黑名单中的过期令牌，确保黑名单不会无限增长。</li>
<li>基于角色或权限的失效策略： 根据用户的角色或权限，实现更精细化的令牌失效策略。</li>
<li>结合双因素认证： 在令牌验证前加入双因素认证，提升系统的身份验证层级。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>通过构建系统的双层安全机制，我们有效地应对了用户退出后令牌的滥用风险。这种机制简单而强大，为Web应用提供了额外的安全保障，使用户退出更具安全性。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="安全" term="安全"/>
        <category label="Java" term="Java"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[第三方测试-系统安全测试问题之数据加密]]></title>
        <id>https://jachen99.github.io/blog/product-security-testing-problems</id>
        <link href="https://jachen99.github.io/blog/product-security-testing-problems"/>
        <updated>2024-03-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[现在国内越来越重视系统安全，最近我们公司在做第三方测试过程中对系统安全、系统性能等做出了严格的要求，并进行了很大的整改，就从这篇文章开始总结一下最近三个月以及以后还会继续整改的涉及系统安全的相关测试漏洞的修改方案，相信这些问题会帮助到大家，尤其是比较大型的政府项目，对系统安全更加注重。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>现在国内越来越重视系统安全，最近我们公司在做第三方测试过程中对系统安全、系统性能等做出了严格的要求，并进行了很大的整改，就从这篇文章开始总结一下最近三个月以及以后还会继续整改的涉及系统安全的相关测试漏洞的修改方案，相信这些问题会帮助到大家，尤其是比较大型的政府项目，对系统安全更加注重。</p>
<p><em>在互联网和新兴技术高速发展的今天，数据信息充斥在各行各业中，并发挥着重要的作用。然而，在享受信息化时代带来便利的同时，数据安全问题也成为大家关注的焦点。无论是从toG、toB、toC的各业务场景来看，还是从网络安全（CyberSecurity）的架构来看，数据安全（DataSecurity）都是一个主要的组成部分，而且在新兴技术日新月异的数据时代变得越来越重要，范围也越来越大。</em>
------- <em>引自 《数据安全架构设计与实战》</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安全架构5a方法论"><strong>安全架构5A方法论</strong><a href="https://jachen99.github.io/blog/product-security-testing-problems#%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%845a%E6%96%B9%E6%B3%95%E8%AE%BA" class="hash-link" aria-label="安全架构5a方法论的直接链接" title="安全架构5a方法论的直接链接">​</a></h2>
<p>无论是进行产品的安全架构设计或评估，还是规划安全技术体系架构的时候，都有几个需要重点关注的逻辑模块，它们可以在逻辑上视为安全架构的核心元素。
以应用/产品为例，核心元素包括：
■ 身份认证（Authentication）：用户主体是谁？
■ 授权（Authorization）：授予某些用户主体允许或拒绝访问客体的权限。
■ 访问控制（Access Control）：控制措施以及是否放行的执行者。
■ 可审计（Auditable）：形成可供追溯的操作日志。
■ 资产保护（Asset Protection）：资产的保密性、完整性、可用性保障</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于数据安全方面"><strong>关于数据安全方面</strong><a href="https://jachen99.github.io/blog/product-security-testing-problems#%E5%85%B3%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E6%96%B9%E9%9D%A2" class="hash-link" aria-label="关于数据安全方面的直接链接" title="关于数据安全方面的直接链接">​</a></h2>
<p>我们在测试过程中涉及到了对数据传输加密、数据存储加密、对称加密、非对称加密、SM2、SM3、SM4国密加密，CA证书等等</p>
<p><em><strong>什么是非对称加密呢？</strong></em></p>
<p>非对称加密是一种密码学技术，与传统的对称加密不同，它使用一对密钥来进行加密和解密操作，这对密钥分别称为公钥和私钥。这两个密钥是数学上相关联的，但却不能通过已知一个密钥来轻松地推导出另一个密钥。</p>
<p>我们可以想象一下，就像你有一把锁和一把钥匙，任何人都可以得到这把锁，但只有你有这把唯一的钥匙。任何人都可以使用这把锁将信息锁住，但只有你能够使用你的独特的钥匙来解锁这个信息。</p>
<ul>
<li>公钥： 就像是一个开放的锁，任何人都可以获得。它用于加密信息，只有拥有与之相关的私钥的人才能解密。</li>
<li>私钥： 这是与公钥相关联的唯一的解锁密钥，只有密钥的拥有者才能解密用公钥加密的信息。</li>
</ul>
<p>举例来说，考虑用户密码的存储问题。通过非对称加密的方式，可以将用户密码加密后写入数据库。当用户再次登录时，系统将客户端输入的明文密码使用相同的非对称加密方式加密，然后与数据库中的密文进行比对。这样的设计大大提高了安全性，即使数据库被攻击，攻击者也无法轻松获取用户的明文密码。
国密SM2加密方式就是非对称加密的。下面是国密SM2加密工具的源码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/*椭圆曲线非对称加密算法*/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class SM2Util {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String key_pubk= "pub";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String key_prik= "pri";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static SM2 sm2 = SM2.instance();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	private static final String DEFAULT_PRIVATE_KEY = "27cd96b1500f8330fc523e7c47ef02a";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	private static final String DEFAULT_PUBLIC_KEY = "047ec86bb18f57714e6c5c72383c5b122";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 * 生成公私钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static Map&lt;String,String&gt; generateKeyPair() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Map&lt;String,String&gt; result = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        AsymmetricCipherKeyPair key = sm2.eccKeyPairGenerator.generateKeyPair();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BigInteger privateKey = ((ECPrivateKeyParameters)key.getPrivate()).getD();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ECPoint publicKey = ((ECPublicKeyParameters)key.getPublic()).getQ();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String pubk = new String(Hex.encode(publicKey.getEncoded(false)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String prik = new String(Hex.encode(privateKey.toByteArray()), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result.put(key_pubk, pubk);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result.put(key_prik, prik);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取默认公钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String getDefaultPublicKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return DEFAULT_PUBLIC_KEY;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取默认私钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String getDefaultPrivateKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return DEFAULT_PRIVATE_KEY;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encrypt(String data, byte[] publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	if (StringUtils.isBlank(data)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    		return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	SM2Cipher cipher = new SM2Cipher();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	// C1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	byte[] c1Bytes = new byte[65];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	ECPoint c1 = cipher.encryptInit(sm2, sm2.eccCurve.decodePoint(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	c1Bytes = c1.getEncoded(false);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c2Bytes = data.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.encrypt(c2Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c3Bytes = new byte[32];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.doFinal(c3Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] encryptData = new byte[c1Bytes.length + c2Bytes.length + c3Bytes.length];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c1Bytes, 0, encryptData, 0, c1Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c2Bytes, 0, encryptData, c1Bytes.length, c2Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c3Bytes, 0, encryptData, c1Bytes.length + c2Bytes.length, c3Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encryptData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] encrypt(String data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return encrypt(data, HexUtil.hexToByte(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] encrypt(byte[] data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return encrypt(new String(data, StandardCharsets.UTF_8), HexUtil.hexToByte(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encryptToHexString(String data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return HexUtil.byteToHex(encrypt(data, HexUtil.hexToByte(publicKey)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encryptToHexString(byte[] data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return HexUtil.byteToHex(encrypt(new String(data, StandardCharsets.UTF_8), HexUtil.hexToByte(publicKey)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] decrypt(byte[] encryptedData, byte[] privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	if (ArrayUtils.isEmpty(encryptedData)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    		return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	SM2Cipher cipher = new SM2Cipher();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c1Bytes = new byte[65];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, 0, c1Bytes, 0, c1Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ECPoint c1 = sm2.eccCurve.decodePoint(c1Bytes).normalize();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c3Bytes = new byte[32];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, encryptedData.length - 32, c3Bytes, 0, 32);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        int c2Len = encryptedData.length - 65 - 32;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c2Bytes = new byte[c2Len];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, 65, c2Bytes, 0, c2Len);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.decryptInit(new BigInteger(1, privateKey), c1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.decrypt(c2Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.doFinal(c3Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return c2Bytes;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(byte[] encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return decrypt(encryptedData, HexUtil.hexToByte(privateKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(byte[] encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return new String(decrypt(encryptedData, HexUtil.hexToByte(privateKey)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return new String(decrypt(Hex.decode(encryptedData), HexUtil.hexToByte(privateKey)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此外，CA（Certificate Authority，证书颁发机构）机构通常也使用非对称加密的方式来确保数字证书的安全性。CA机构在数字证书颁发过程中起到了信任的中介角色，其操作基于公钥基础设施（PKI）。</p>
<p>下面是CA机构使用非对称加密的一般流程：</p>
<ol>
<li>证书请求： 实体（通常是个人或组织）向CA机构提交证书请求，请求包括实体的公钥和一些身份信息。</li>
<li>验证身份： CA机构对证书请求中的身份信息进行验证，确保请求者确实拥有所声明的身份。这可以通过一系列验证步骤来完成。</li>
<li>颁发数字证书： 验证通过后，CA机构使用自己的私钥对实体的公钥和身份信息进行签名，生成数字证书。这个签名过程就是使用非对称加密，其中CA的私钥用于签署证书信息。</li>
<li>证书分发： CA机构将生成的数字证书发送给请求者，同时可以将证书公开发布到公共目录中，以便其他人可以验证证书的真实性。</li>
<li>证书验证： 在通信过程中，当其他人需要验证实体的身份时，他们可以使用CA机构公开的公钥来验证数字证书的签名。如果验证通过，就可以信任该数字证书所附的公钥。</li>
</ol>
<p>非对称加密的优势在于它提供了更高的安全性。即使在公共环境下传输公钥，也无法通过公钥轻松计算出私钥。这使得非对称加密在安全地实现身份验证、数字签名和加密通信等场景中发挥重要作用。</p>
<p><em><strong>相对的，什么是对称加密呢？</strong></em></p>
<p>对称加密是一种加密算法，它使用相同的密钥同时进行数据的加密和解密。这意味着在对称加密中，使用加密和解密操作的相同密钥。对称加密算法在加密和解密的过程中都使用相同的密钥，因此密钥的保管和分发变得至关重要。
我们了解的国密SM4就是采用的对称加密的方式实现的，源码工具如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * （分组密码算法）国密对称加密算法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public abstract class SM4Util {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	static {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Security.addProvider(new BouncyCastleProvider());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static final Charset ENCODING = StandardCharsets.UTF_8;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME = "SM4";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 加密算法/分组加密模式/分组填充方式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME_ECB_PADDING = "SM4/ECB/PKCS5Padding";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME_CBC_PADDING = "SM4/CBC/PKCS5Padding";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 128-32位16进制；256-64位16进制</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final int DEFAULT_KEY_SIZE = 128;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String DEFAULT_KEY = "86C63180C2806ED1F47B859DE501215B";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String DEFAULT_IV = "8F5CB6272B594B53AD1A2197361378DC";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Cipher generateCipherECB(String algorithmName, int mode, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = Cipher.getInstance(algorithmName, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.init(mode, new SecretKeySpec(key, ALGORITHM_NAME));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Cipher generateCipherCBC(String algorithmName, int mode, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = Cipher.getInstance(algorithmName, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.init(mode, new SecretKeySpec(key, ALGORITHM_NAME), new IvParameterSpec(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String generateKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return HexUtil.byteToHex(generateKey(DEFAULT_KEY_SIZE));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] generateKey(int keySize) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        KeyGenerator kg = KeyGenerator.getInstance(ALGORITHM_NAME, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kg.init(keySize, new SecureRandom());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return kg.generateKey().getEncoded();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encryptECBPadding(byte[] data, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateCipherECB(ALGORITHM_NAME_ECB_PADDING, Cipher.ENCRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher.doFinal(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	protected static byte[] decryptECBPadding(byte[] encrypted, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    Cipher cipher = generateCipherECB(ALGORITHM_NAME_ECB_PADDING, Cipher.DECRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    return cipher.doFinal(encrypted);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encryptCBCPadding(byte[] data, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateCipherCBC(ALGORITHM_NAME_CBC_PADDING, Cipher.ENCRYPT_MODE, key, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher.doFinal(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	protected static byte[] decryptCBCPadding(byte[] encrypted, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    Cipher cipher = generateCipherCBC(ALGORITHM_NAME_CBC_PADDING, Cipher.DECRYPT_MODE, key, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    return cipher.doFinal(encrypted);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source.getBytes(ENCODING), hexKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherArray;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			cipherArray = encryptECBPadding(source, ByteUtils.fromHexString(hexKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return ByteUtils.toHexString(cipherArray);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return decrypt(encrypted, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return decryptToString(encrypted, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return new String(decrypt(encrypted, hexKey), ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return decryptECBPadding(ByteUtils.fromHexString(encrypted), ByteUtils.fromHexString(hexKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return encrypted.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source.getBytes(ENCODING), hexKey, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherArray;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			cipherArray = encryptCBCPadding(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							source</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							, ByteUtils.fromHexString(hexKey)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							, ByteUtils.fromHexString(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return ByteUtils.toHexString(cipherArray);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			throw new RuntimeException("数据加密失败", e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return new String(decrypt(encrypted, hexKey, iv), ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			if (StringUtils.isBlank(encrypted)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				return new byte[] {};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return decryptCBCPadding(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				 	ByteUtils.fromHexString(encrypted)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">					, ByteUtils.fromHexString(hexKey)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">					, ByteUtils.fromHexString(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return encrypted.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em><strong>相信你也一定听过国密SM3算法，它是对称加密还是非对称加密呢？</strong></em>
其实SM3是一种密码杂凑算法，用于生成消息的哈希值，主要用于数据完整性验证、数字签名等场景，而不是进行加密和解密操作。所以它既不是对称加密也不是非对称加密，它常常与SM2与SM4组合一起使用，可以把它看成一个随机数。
<em>例如：</em>
系统数据存储加密应采用SM3+SM4的实现方式。
系统数据传输加密应采用SM2+SM3的实现方式。</p>
<p><strong>总结</strong>
在系统安全测试中，我们通过采用多层加密算法、合理的安全架构设计以及严格的数据安全措施，提高了系统在身份认证、授权、访问控制、审计和资产保护等方面的安全性。这有助于在互联网和新兴技术时代中更好地处理数据安全问题，特别适用于大型政府项目等对安全性要求较高的场景。数据安全相关的知识属于另一个领域了，知识点真是深不可测，还需要平时多学习，积累更多的知识储备才行。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="安全" term="安全"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[第三方测试-系统安全测试问题之数据加密]]></title>
        <id>https://jachen99.github.io/blog/data-encryption-in-security-testing</id>
        <link href="https://jachen99.github.io/blog/data-encryption-in-security-testing"/>
        <updated>2024-03-01T00:00:00.000Z</updated>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="安全" term="安全"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[xxl-job分布式调度实践]]></title>
        <id>https://jachen99.github.io/blog/product-xxl-job</id>
        <link href="https://jachen99.github.io/blog/product-xxl-job"/>
        <updated>2024-02-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[起因：传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>起因</strong>：<em>传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="https://jachen99.github.io/blog/product-xxl-job#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官方文档">官方文档<a href="https://jachen99.github.io/blog/product-xxl-job#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" class="hash-link" aria-label="官方文档的直接链接" title="官方文档的直接链接">​</a></h3>
<p>xxl-job：<a href="https://github.com/xuxueli/xxl-job" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job</a></p>
<p>elastic-job：<a href="https://shardingsphere.apache.org/elasticjob/" target="_blank" rel="noopener noreferrer">https://shardingsphere.apache.org/elasticjob/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job-与--elastic-job对比图">XXL-JOB 与  elastic-job对比图<a href="https://jachen99.github.io/blog/product-xxl-job#xxl-job-%E4%B8%8E--elastic-job%E5%AF%B9%E6%AF%94%E5%9B%BE" class="hash-link" aria-label="XXL-JOB 与  elastic-job对比图的直接链接" title="XXL-JOB 与  elastic-job对比图的直接链接">​</a></h3>
<table><thead><tr><th>对比项</th><th>XXL-JOB</th><th>elastic-job</th></tr></thead><tbody><tr><td>并行调度</td><td>调度系统多线程并行</td><td>任务分片的方式并行</td></tr><tr><td>弹性扩容</td><td>使用Quartz基于数据库分布式功能</td><td>通过zookeeper保证</td></tr><tr><td>高可用</td><td>通过DB锁保证</td><td>通过zookeeper保证</td></tr><tr><td>阻塞策略</td><td>单机串行/丢弃后续的调度/覆盖之前的调度</td><td>执行超过zookeeper的session timeout时间的话，会被清除，重新进行分片</td></tr><tr><td>动态分片策略</td><td>以执行器为维度进行分片、支持动态的扩容</td><td>平均分配/作业名hash分配/自定义策略</td></tr><tr><td>失败处理策略</td><td>失败告警/失败重试</td><td>执行完毕后主动获取未分配分片任务 服务器下线后主动寻找可以用的服务器执行任务</td></tr><tr><td>监控</td><td>支持</td><td>支持</td></tr><tr><td>日志</td><td>支持</td><td>支持</td></tr></tbody></table>
<ul>
<li>XXL-Job和Elastic-Job都具有广泛的用户基础和完善的技术文档，都可以满足定时任务的基本功能需求</li>
<li>xxl-job侧重在业务实现简单和管理方便，容易学习，失败与路由策略丰富, 推荐使用在用户基数相对较少，服务器的数量在一定的范围内的场景下使用</li>
<li>elastic-job关注的点在数据，添加了弹性扩容和数据分片的思路，更方便利用分布式服务器的资源, 但是学习难度较大，推荐在数据量庞大，服务器数量多的时候使用</li>
</ul>
<p><em>综合考虑，最后我们选择了xxl-job这一解决方法，下面是一个小demo，用于整合xxl-job到spring微服务项目中得以应用的最佳实践。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="https://jachen99.github.io/blog/product-xxl-job#%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是xxl-job">什么是XXL-Job<a href="https://jachen99.github.io/blog/product-xxl-job#%E4%BB%80%E4%B9%88%E6%98%AFxxl-job" class="hash-link" aria-label="什么是XXL-Job的直接链接" title="什么是XXL-Job的直接链接">​</a></h3>
<ul>
<li>XXL-JOB<!-- -->
<ul>
<li>大众点评的员工徐雪里在15年发布的分布式任务调度平台，是轻量级的分布式任务调度框架，目标是开发迅速、简单、清理、易扩展; 老版本是依赖quartz的定时任务触发，在v2.1.0版本开始 移除quartz依赖</li>
<li>官网地址：<a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener noreferrer">https://www.xuxueli.com/xxl-job/</a></li>
<li>GitHub地址：<a href="https://github.com/xuxueli/xxl-job/" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job/</a></li>
</ul>
</li>
<li>xxl-job的设计思想<!-- -->
<ul>
<li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li>
<li>将任务抽象成分散的JobHandler，交由“执行器”统一管理</li>
<li>“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li>
<li>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官网架构图">官网架构图<a href="https://jachen99.github.io/blog/product-xxl-job#%E5%AE%98%E7%BD%91%E6%9E%B6%E6%9E%84%E5%9B%BE" class="hash-link" aria-label="官网架构图的直接链接" title="官网架构图的直接链接">​</a></h3>
<ul>
<li>调度中心<!-- -->
<ul>
<li>负责管理调度的信息，按照调度的配置来发出调度请求</li>
<li>支持可视化、简单的动态管理调度信息，包括新建、删除、更新等，这些操作都会实时生效，同时也支持监控调度结果以及执行日志。</li>
</ul>
</li>
<li>执行器<!-- -->
<ul>
<li>负责接收请求并且执行任务的逻辑。任务模块专注于任务的执行操作等等，使得开发和维护更加的简单与高效</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://file.xdclass.net/note/2022/81-XXL-JOB/img/image-20220519181542821.png" alt="image-20220519181542821" class="img_ev3q"></p>
<ul>
<li>XXL-Job具有哪些特性<!-- -->
<ul>
<li>调度中心HA（中心式）：调度采用了中心式进行设计，“调度中心”支持集群部署，可保证调度中心HA</li>
<li>执行器HA（分布式）：任务分布式的执行，任务执行器支持集群部署，可保证任务执行HA</li>
<li>触发策略：有Cron触发、固定间隔触发、固定延时触发、API事件触发、人工触发、父子任务触发</li>
<li>路由策略：执行器在集群部署的时候提供了丰富的路由策略，如：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用LFU、最久未使用LRU、故障转移等等</li>
<li>故障转移：如果执行器集群的一台机器发生故障，会自动切换到一台正常的执行器发送任务调度</li>
<li>Rolling实时日志的监控：支持rolling方式查看输入的完整执行日志</li>
<li>脚本任务：支持GLUE模式开发和运行脚本任务，包括Shell、python、node.js、php等等类型脚本</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速部署">快速部署<a href="https://jachen99.github.io/blog/product-xxl-job#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2" class="hash-link" aria-label="快速部署的直接链接" title="快速部署的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="流程图">流程图：<a href="https://jachen99.github.io/blog/product-xxl-job#%E6%B5%81%E7%A8%8B%E5%9B%BE" class="hash-link" aria-label="流程图：的直接链接" title="流程图：的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214195315186" src="https://jachen99.github.io/assets/images/image-20230214195315186-428690aea674f569b2ab260bae532441.png" width="838" height="707" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境">环境：<a href="https://jachen99.github.io/blog/product-xxl-job#%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="环境：的直接链接" title="环境：的直接链接">​</a></h3>
<p>Maven3+、jdk1.8+、mysql5.7+</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载链接">下载链接：<a href="https://jachen99.github.io/blog/product-xxl-job#%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5" class="hash-link" aria-label="下载链接：的直接链接" title="下载链接：的直接链接">​</a></h3>
<p><a href="https://github.com/xuxueli/xxl-job.git" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job.git</a>  版本：2.3.0</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="运行数据库脚本">运行数据库脚本<a href="https://jachen99.github.io/blog/product-xxl-job#%E8%BF%90%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%84%9A%E6%9C%AC" class="hash-link" aria-label="运行数据库脚本的直接链接" title="运行数据库脚本的直接链接">​</a></h3>
<p><code>/xxl-job/doc/db/tables_xxl_job.sql</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调度中心">调度中心<a href="https://jachen99.github.io/blog/product-xxl-job#%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83" class="hash-link" aria-label="调度中心的直接链接" title="调度中心的直接链接">​</a></h3>
<p><code>调度中心项目：xxl-job-admin</code> 修改该模块下的配置文件并启动server</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">### web</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server.port=8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server.servlet.context-path=/xxl-job-admin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### xxl-job, datasource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.username=root</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.password=123456</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### xxl-job, access token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">xxl.job.accessToken=jiguanchen.space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ui界面">UI界面<a href="https://jachen99.github.io/blog/product-xxl-job#ui%E7%95%8C%E9%9D%A2" class="hash-link" aria-label="UI界面的直接链接" title="UI界面的直接链接">​</a></h3>
<ul>
<li>运行报表<!-- -->
<ul>
<li>以图形化来展示了整体的任务执行情况<!-- -->
<ul>
<li>任务数量：能够看到调度中心运行的任务数量</li>
<li>调度次数：调度中心所触发的调度次数</li>
<li>执行器数量：在整个调度中心中，在线的执行器数量有多少</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214195933783" src="https://jachen99.github.io/assets/images/image-20230214195933783-ffa529f61bf3bd47ceee76cee3a5f845.png" width="1920" height="991" class="img_ev3q"></p>
<ul>
<li>任务管理（配置执行任务）<!-- -->
<ul>
<li>示例执行器：所用到的执行器</li>
<li>任务描述：概述该任务是做什么的</li>
<li>路由策略：<!-- -->
<ul>
<li>第一个：选择第一个机器</li>
<li>最后一个：选择最后一个机器</li>
<li>轮询：依次选择执行</li>
<li>随机：随机选择在线的机器</li>
<li>一致性HASH：每个任务按照Hash算法固定选择某一台机器，并且所有的任务均匀散列在不同的机器上</li>
<li>最不经常使用：使用频率最低的机器优先被使用</li>
<li>最近最久未使用：最久未使用的机器优先被选举</li>
<li>故障转移：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标的执行器并且会发起任务调度</li>
<li>忙碌转移：按照顺序来依次进行空闲检测，第一个空闲检测成功的机器会被选定为目标群机器，并且会发起任务调度</li>
<li>分片广播：广播触发对于集群中的所有机器执行任务，同时会系统会自动传递分片的参数</li>
</ul>
</li>
<li>Cron：执行规则</li>
<li>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等</li>
<li>JobHandler：定义执行器的名字</li>
<li>阻塞处理策略：<!-- -->
<ul>
<li>单机串行：新的调度任务在进入到执行器之后，该调度任务进入FIFO队列，并以串行的方式去进行</li>
<li>丢弃后续调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，本次的调度任务请求就会被丢弃掉，并且标记为失败</li>
<li>覆盖之前的调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，就会终止掉当前正在运行的调度任务，并且清空队列，运行新的调度任务。</li>
</ul>
</li>
<li>子任务ID：输入子任务的任务id，可填写多个</li>
<li>任务超时时间：添加任务超时的时候，单位s，设置时间大于0的时候就会生效</li>
<li>失败重试次数：设置失败重试的次数，设置时间大于0的时候就会生效</li>
<li>负责人：填写该任务调度的负责人</li>
<li>报警邮件：出现报警，则发送邮件</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214200224214" src="https://jachen99.github.io/assets/images/image-20230214200224214-886206b0dd0a466984fc0206dfe6f442.png" width="1603" height="484" class="img_ev3q"></p>
<p>创建任务：</p>
<p><img decoding="async" loading="lazy" alt="image-20230214200338357" src="https://jachen99.github.io/assets/images/image-20230214200338357-198452a996e4e5e0853b5b555a1bdabd.png" width="1207" height="874" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后台服务整合xxl-job">后台服务整合xxl-job<a href="https://jachen99.github.io/blog/product-xxl-job#%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88xxl-job" class="hash-link" aria-label="后台服务整合xxl-job的直接链接" title="后台服务整合xxl-job的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="yml配置">yml配置<a href="https://jachen99.github.io/blog/product-xxl-job#yml%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="yml配置的直接链接" title="yml配置的直接链接">​</a></h3>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#  xxl-job任务调度配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">addresses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin  </span><span class="token comment" style="color:rgb(98, 114, 164)">#调度中心部署地址,多个配置逗号分隔 "http://address01,http://address02"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">accessToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> jiguanchen.space  </span><span class="token comment" style="color:rgb(98, 114, 164)">#执行器token，非空时启用 xxl-job, access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">executor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">appname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yygh</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">order  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器app名称,和控制台那边配置一样的名称，不然注册不上去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">6666</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">logpath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./data/logs/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job/executor  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器日志文件存储路径，需要对该路径拥有读写权限；为空则使用默认路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">logretentiondays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器日志保存天数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># [选填]执行器IP ：默认为空表示自动获取IP（即springboot容器的ip和端口，可以自动获取，也可以指定），</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># 多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># [选填]执行器注册：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加pom文件">添加pom文件<a href="https://jachen99.github.io/blog/product-xxl-job#%E6%B7%BB%E5%8A%A0pom%E6%96%87%E4%BB%B6" class="hash-link" aria-label="添加pom文件的直接链接" title="添加pom文件的直接链接">​</a></h3>
<div class="language-pom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-pom codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;!-- xxl_job分布式调度 --&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;version&gt;2.3.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加config配置类">添加config配置类<a href="https://jachen99.github.io/blog/product-xxl-job#%E6%B7%BB%E5%8A%A0config%E9%85%8D%E7%BD%AE%E7%B1%BB" class="hash-link" aria-label="添加config配置类的直接链接" title="添加config配置类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2023/2/14 15:46</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class XxlJobConfig {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.admin.addresses}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String adminAddresses;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.executor.appname}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String appName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.executor.ip}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String ip;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.executor.port}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int port;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.accessToken}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String accessToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.executor.logpath}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String logPath;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value("${xxl.job.executor.logretentiondays}")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int logRetentionDays;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public XxlJobSpringExecutor xxlJobExecutor() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAppname(appName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setIp(ip);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setPort(port);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setLogPath(logPath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return xxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>添加hander处理器</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.handler;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2024/2/14 15:53</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MyJobHandler {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RabbitService rabbitService;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private OrderInfoMapper orderInfoMapper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 就诊提醒的handler方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param param  null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return  ReturnT&lt;String&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @XxlJob(value = "demoJobHandler1",init = "init",destroy = "destroy")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public ReturnT&lt;String&gt; execute(String param){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("execute方法执行了 ====》 ");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取查询的时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        DateTime dateTime = new DateTime().plusDays(1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String dateString = dateTime.toString("yyyy-MM-dd");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Date date = new DateTime(dateString).toDate();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = new LambdaQueryWrapper&lt;OrderInfo&gt;(){{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            eq(OrderInfo::getReserveDate,date);  // 查询就诊日期</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ne(OrderInfo::getOrderStatus, OrderStatusEnum.CANCLE.getStatus());  // 查询没有取消的订单</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;OrderInfo&gt; orderInfoList = orderInfoMapper.selectList(queryWrapper);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for(OrderInfo orderInfo : orderInfoList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 短信提示</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            MsmVo msmVo = new MsmVo();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            msmVo.setPhone(orderInfo.getPatientPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 结合mq快速响应其他模块 发送消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_MSM, MqConst.ROUTING_MSM_ITEM, msmVo);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return ReturnT.SUCCESS;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private void init(){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("MyJobHandler init &gt;&gt;&gt;&gt;&gt; " + true);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String jobParam = XxlJobHelper.getJobParam();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("jobParam = " + jobParam);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="效果图">效果图<a href="https://jachen99.github.io/blog/product-xxl-job#%E6%95%88%E6%9E%9C%E5%9B%BE" class="hash-link" aria-label="效果图的直接链接" title="效果图的直接链接">​</a></h3>
<p>完成规则内的定时任务，到指定时间向就诊人发送消息</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201137647" src="https://jachen99.github.io/assets/images/image-20230214201137647-78853315d90bec43fb641d44f62ae203.png" width="1498" height="329" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20230214201148157" src="https://jachen99.github.io/assets/images/image-20230214201148157-e16f4946aad02ccb28495a972fde1805.png" width="1485" height="258" class="img_ev3q"></p>
<p>调度日志</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201947305" src="https://jachen99.github.io/assets/images/image-20230214201947305-25fa330099f9149f279b07395476a6ec.png" width="1601" height="807" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job集群部署和高可用案例配置">XXL-Job集群部署和高可用案例配置<a href="https://jachen99.github.io/blog/product-xxl-job#xxl-job%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%E6%A1%88%E4%BE%8B%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="XXL-Job集群部署和高可用案例配置的直接链接" title="XXL-Job集群部署和高可用案例配置的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群架构图">集群架构图<a href="https://jachen99.github.io/blog/product-xxl-job#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%9B%BE" class="hash-link" aria-label="集群架构图的直接链接" title="集群架构图的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203111017" src="https://jachen99.github.io/assets/images/image-20230214203111017-a88e2f9bec270b41851edadd8e1016ee.png" width="1408" height="733" class="img_ev3q"></p>
<p>执行器配置调度中心集群</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#调度中心部署地址,多个配置逗号分隔 "http://address01,http://address02"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">addresses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8081/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job处理海量数据-分片任务实操">XXL-Job处理海量数据-分片任务实操<a href="https://jachen99.github.io/blog/product-xxl-job#xxl-job%E5%A4%84%E7%90%86%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE-%E5%88%86%E7%89%87%E4%BB%BB%E5%8A%A1%E5%AE%9E%E6%93%8D" class="hash-link" aria-label="XXL-Job处理海量数据-分片任务实操的直接链接" title="XXL-Job处理海量数据-分片任务实操的直接链接">​</a></h2>
<p>我们的需求：</p>
<ul>
<li>有一个任务需要处理100W条数据，每条数据的业务逻辑处理要0.1s</li>
<li>对于普通任务来说，只有一个线程来处理 可能需要10万秒才能处理完，业务则严重受影响</li>
<li>案例：双十一大促，给1000万用户发营销短信</li>
</ul>
<p>解决思路：</p>
<ul>
<li>如果将100W数据均匀分给集群里的10台机器同时处理，</li>
<li>每台机器耗时，1万秒即可，耗时会大大缩短，也能充分利用集群资源</li>
<li>在xxl-job里，可以配置执行器集群有10个机器，那么分片总数是10，分片序号0~9 分别对应那10台机器。</li>
<li>分片方式<!-- -->
<ul>
<li>id % 分片总数 余数是0 的，在第1个执行器上执行</li>
<li>id % 分片总数 余数是1 的，在第2个执行器上执行</li>
<li>id % 分片总数 余数是2 的，在第3个执行器上执行</li>
<li>...</li>
<li>id % 分片总数 余数是9 的，在第10个执行器上执行</li>
</ul>
</li>
</ul>
<p>其他解决方式</p>
<ul>
<li>也可以启动多个job，使用同个jobHandler,通过命令行参数控制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="选用分片广播的路由策略实操">选用分片广播的路由策略实操<a href="https://jachen99.github.io/blog/product-xxl-job#%E9%80%89%E7%94%A8%E5%88%86%E7%89%87%E5%B9%BF%E6%92%AD%E7%9A%84%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E5%AE%9E%E6%93%8D" class="hash-link" aria-label="选用分片广播的路由策略实操的直接链接" title="选用分片广播的路由策略实操的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203833637" src="https://jachen99.github.io/assets/images/image-20230214203833637-06704b31c35de3df3a903312bd7add3b.png" width="969" height="297" class="img_ev3q"></p>
<p>主要参数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 分片广播任务	    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 当前分片数，从0开始，即执行器的序号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int shardIndex = XxlJobHelper.getShardIndex();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//总分片数，执行器集群总机器数量</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int shardTotal = XxlJobHelper.getShardTotal();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 业务逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Xxl-Job" term="Xxl-Job"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[时间范围分表策略的实现与优化]]></title>
        <id>https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy</id>
        <link href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy"/>
        <updated>2023-10-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[详解如何使用Sharding-JDBC实现按时间范围（年月）的数据库分表策略。本文提供基于`RangeShardingAlgorithm`的完整Java分片算法代码，解决大数据量下的查询性能与数据管理难题。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p>在处理大量数据时，如何高效地存储和查询是我们常面临的挑战。特别是在需要按时间进行统计、分析和展示的数据场景下，数据量往往随着时间的积累而迅速膨胀。为了应对这些挑战，<strong>分表技术</strong>成为了优化查询性能和管理大规模数据的关键手段。</p>
<p>在实际的开发过程中，针对具有时间维度的大数据表，我们通常会采用按时间进行分表的策略。本文将总结如何实现一个基于时间范围的分表策略，并通过具体的技术实现来展示这一策略在实际系统中的应用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分表技术概述">分表技术概述<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#%E5%88%86%E8%A1%A8%E6%8A%80%E6%9C%AF%E6%A6%82%E8%BF%B0" class="hash-link" aria-label="分表技术概述的直接链接" title="分表技术概述的直接链接">​</a></h2>
<p>分表技术是将一个大表拆分成多个小表，以此来提升查询性能和系统的扩展性。常见的分表策略有：</p>
<ul>
<li><strong>水平分表</strong>：根据某个字段（如用户ID、时间等）将数据分散到多个表中。</li>
<li><strong>垂直分表</strong>：将表中的不同字段拆分到多个表中。</li>
</ul>
<p>在水平分表中，时间字段（如年、月、日）是一个常见的分片维度。根据业务需求，数据会被拆分成多个按时间命名的表，查询时通过时间范围来确定要查询的具体分表。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基于时间范围的分表策略">基于时间范围的分表策略<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E8%8C%83%E5%9B%B4%E7%9A%84%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5" class="hash-link" aria-label="基于时间范围的分表策略的直接链接" title="基于时间范围的分表策略的直接链接">​</a></h2>
<p>以某个数据表（比如"电力消耗数据"）为例，我们希望根据时间来进行分表，将每个月的数据存储到不同的表中。这种策略不仅可以帮助我们高效地管理大规模的数据，还能在查询时避免对整个表的全表扫描，从而提高性能。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-分表规则设计">1. 分表规则设计<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#1-%E5%88%86%E8%A1%A8%E8%A7%84%E5%88%99%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="1. 分表规则设计的直接链接" title="1. 分表规则设计的直接链接">​</a></h3>
<p>假设我们的表名为 <code>electricity_usage_data</code>，我们决定根据月份进行分表。分表规则如下：</p>
<ul>
<li>按月进行分表，表名格式为 <code>electricity_usage_data_yyyyMM</code>，例如：<code>electricity_usage_data_202301</code>、<code>electricity_usage_data_202302</code> 等。</li>
<li>在查询时，依据时间字段（如查询某月的电力数据），动态选择涉及的分表。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-分片算法的实现">2. 分片算法的实现<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#2-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0" class="hash-link" aria-label="2. 分片算法的实现的直接链接" title="2. 分片算法的实现的直接链接">​</a></h3>
<p>为了实现按时间范围的分表，我们需要实现一个分片算法，这个算法的主要作用是根据查询的时间范围，计算出需要访问的分表。通常，这个算法会根据一个起始时间和结束时间，确定哪些表需要被查询。</p>
<p>例如，假设查询的时间范围是从 <code>2023年01月</code> 到 <code>2023年03月</code>，那么分片算法会返回 <code>electricity_usage_data_202301</code>、<code>electricity_usage_data_202302</code> 和 <code>electricity_usage_data_202303</code> 这三个表。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-实现代码">3. 实现代码<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#3-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="3. 实现代码的直接链接" title="3. 实现代码的直接链接">​</a></h3>
<p>下面是一个基于时间范围的分表算法实现示例。我们使用了Sharding-JDBC来实现这一分片策略，具体代码如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MonthRangeShardingAlgorithm implements RangeShardingAlgorithm&lt;String&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public Collection&lt;String&gt; doSharding(Collection&lt;String&gt; collection, RangeShardingValue&lt;String&gt; rangeShardingValue) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Collection&lt;String&gt; result = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; rangeList = getRangeList(rangeShardingValue);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (String tableName : rangeList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (collection.contains(tableName.toLowerCase()) || collection.contains(tableName.toUpperCase())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                result.add(tableName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (result.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new UnsupportedOperationException("没有匹配到分片表");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private List&lt;String&gt; getRangeList(RangeShardingValue&lt;String&gt; rangeShardingValue) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; rangeList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String logicTableName = rangeShardingValue.getLogicTableName();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        SimpleDateFormat format = new SimpleDateFormat("yyyyMMdd");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Range&lt;String&gt; valueRange = rangeShardingValue.getValueRange();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Object start = valueRange.lowerEndpoint();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Object end = valueRange.upperEndpoint();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Date startDate = format.parse(start.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Date endDate = format.parse(end.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            DateTime startDateTime = DateUtil.beginOfMonth(startDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            DateTime endDateTime = DateUtil.beginOfMonth(endDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            do {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                String time = DateUtil.format(startDateTime, "yyyyMM");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                String tableName = logicTableName.concat("_").concat(time);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                rangeList.add(tableName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                startDateTime = DateUtil.offset(startDateTime, DateField.MONTH, 1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } while (startDateTime.compareTo(endDateTime) &lt;= 0);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (ParseException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return rangeList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-分表策略解析">4. 分表策略解析<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#4-%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5%E8%A7%A3%E6%9E%90" class="hash-link" aria-label="4. 分表策略解析的直接链接" title="4. 分表策略解析的直接链接">​</a></h3>
<ul>
<li><strong><code>doSharding</code>方法</strong>：该方法根据输入的时间范围，计算出涉及的所有分表。通过对比表名，筛选出实际需要查询的分表。</li>
<li><strong><code>getRangeList</code>方法</strong>：将查询的起始时间和结束时间进行处理，计算出涉及的所有月份，并生成对应的表名。</li>
<li><strong>时间格式化和处理</strong>：我们使用 <code>SimpleDateFormat</code> 和 <code>DateUtil</code> 进行时间的格式化和月份的处理。通过 <code>DateUtil.beginOfMonth</code> 获取每个月的第一天，以便统一处理时间范围。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="优化与应用">优化与应用<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#%E4%BC%98%E5%8C%96%E4%B8%8E%E5%BA%94%E7%94%A8" class="hash-link" aria-label="优化与应用的直接链接" title="优化与应用的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-动态扩展性">1. 动态扩展性<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#1-%E5%8A%A8%E6%80%81%E6%89%A9%E5%B1%95%E6%80%A7" class="hash-link" aria-label="1. 动态扩展性的直接链接" title="1. 动态扩展性的直接链接">​</a></h3>
<p>该方案的优势在于其<strong>动态扩展性</strong>。随着数据量的不断增长，新的分表会根据时间自动创建，且查询时会根据实际的时间范围动态计算所需的表，避免了手动干预。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-负载均衡">2. 负载均衡<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#2-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" class="hash-link" aria-label="2. 负载均衡的直接链接" title="2. 负载均衡的直接链接">​</a></h3>
<p>通过将数据分散到多个表中，系统能够更好地进行负载均衡。当某一月份的数据量增大时，可以通过水平扩展（例如增加新的分表）来应对性能瓶颈，而无需对整个表进行迁移或改造。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-查询优化">3. 查询优化<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#3-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96" class="hash-link" aria-label="3. 查询优化的直接链接" title="3. 查询优化的直接链接">​</a></h3>
<p>按时间范围分表的最大优势在于查询效率的提升。当查询某一时间段的数据时，只需要访问相关的分表，而不是对整个数据表进行扫描，从而大大提升了查询速度。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>基于时间范围的分表策略在大数据量场景下尤其重要，尤其是在电力等需要处理大量历史数据的行业。通过合理的分表设计，我们可以有效地提升系统性能，优化查询响应时间，确保系统的高可用性和扩展性。这个方案不仅适用于电力行业，也可以广泛应用于任何具有时间维度的大数据场景中。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Sharding-JDBC" term="Sharding-JDBC"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[MongoDB实现逻辑删除]]></title>
        <id>https://jachen99.github.io/blog/product-logic-delete</id>
        <link href="https://jachen99.github.io/blog/product-logic-delete"/>
        <updated>2023-06-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景：我们对MongoDB采用的逻辑删除的方案，与MySQL完全不同。 得益于MongoDB擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若MySQL采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>我们对<code>MongoDB</code>采用的逻辑删除的方案，与<code>MySQL</code>完全不同。 得益于<code>MongoDB</code>擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若<code>MySQL</code>采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。</em></p>
<p>举个小demo</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如果改变表字段">如果改变表字段：<a href="https://jachen99.github.io/blog/product-logic-delete#%E5%A6%82%E6%9E%9C%E6%94%B9%E5%8F%98%E8%A1%A8%E5%AD%97%E6%AE%B5" class="hash-link" aria-label="如果改变表字段：的直接链接" title="如果改变表字段：的直接链接">​</a></h2>
<p>​		首先导入了 MongoDB 驱动，然后创建了一个 MongoDB 客户端（<code>MongoClient</code>），并连接到了本地的 MongoDB 服务器（"mongodb://localhost:27017"）。通过客户端获取了数据库 "test" 中的集合 "collection"。在逻辑删除代码中，首先通过 ObjectId 创建了一个 ObjectId 对象，其值为 "5f36f47a06c5a722497f37b5"。然后，通过调用 <code>updateOne</code> 方法对该文档进行了逻辑删除操作，即在该文档中添加/更新了一个 "deleted" 字段，该字段的值为 true。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.mongodb</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">mongodb-driver-sync</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">4.0.5</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Updates;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MongoDBLogicDeleteExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = MongoClients.create("mongodb://localhost:27017");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase("test").getCollection("collection");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ObjectId id = new ObjectId("5f36f47a06c5a722497f37b5");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.updateOne(Filters.eq("_id", id), Updates.set("deleted", true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​		然后在查询代码中，通过调用 <code>find</code> 方法查询 "deleted" 字段不等于 true 的文档，即查询未被逻辑删除的文档。然后，将查询结果存入 <code>documents</code> 集合中。最后，通过循环打印出了查询结果中的每一个文档。最后，关闭了 MongoDB 客户端。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MongoDBQueryExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = MongoClients.create("mongodb://localhost:27017");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase("test").getCollection("collection");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.find(Filters.ne("deleted", true)).into(documents);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="不改变表字段">不改变表字段<a href="https://jachen99.github.io/blog/product-logic-delete#%E4%B8%8D%E6%94%B9%E5%8F%98%E8%A1%A8%E5%AD%97%E6%AE%B5" class="hash-link" aria-label="不改变表字段的直接链接" title="不改变表字段的直接链接">​</a></h2>
<p>如果不想添加字段，可以使用 MongoDB 的另一种实现逻辑删除的方法，即使用软删除。软删除的思想是将文档移动到另一个集合中，而不是真正删除文档。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoDatabase;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class LogicalDeletionExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = new MongoClient("mongodb://localhost:27017");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoDatabase database = mongoClient.getDatabase("test");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取原始集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = database.getCollection("collection");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取新集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; deletedCollection = database.getCollection("deleted_collection");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ObjectId id = new ObjectId("5f36f47a06c5a722497f37b5");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Document deletedDocument = collection.find(new Document("_id", id)).first();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        deletedCollection.insertOne(deletedDocument);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.deleteOne(new Document("_id", id));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.find().into(documents);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码通过将文档移动到新集合中，实现了 MongoDB 的逻辑删除，并且不添加字段。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="数据库" term="数据库"/>
        <category label="MongoDB" term="MongoDB"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[实用框架EasyExcel]]></title>
        <id>https://jachen99.github.io/blog/product-easyexcel</id>
        <link href="https://jachen99.github.io/blog/product-easyexcel"/>
        <updated>2023-04-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景：EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1easyexcel介绍">1、EasyExcel介绍<a href="https://jachen99.github.io/blog/product-easyexcel#1easyexcel%E4%BB%8B%E7%BB%8D" class="hash-link" aria-label="1、EasyExcel介绍的直接链接" title="1、EasyExcel介绍的直接链接">​</a></h2>
<ul>
<li>Java领域解析、生成Excel比较有名的框架有Apache poi、jxl等。但他们都存在一个严重的问题就是非常的耗内存。如果你的系统并发量不大的话可能还行，但是一旦并发上来后一定会OOM或者JVM频繁的full gc。</li>
<li>EasyExcel是阿里巴巴开源的一个excel处理框架，<strong>以使用简单、节省内存著称</strong>。EasyExcel能大大减少占用内存的主要原因是在解析Excel时没有将文件数据一次性全部加载到内存中，而是从磁盘上一行行读取数据，逐个解析。</li>
<li>EasyExcel采用一行一行的解析模式，并将一行的解析结果以观察者的模式通知处理（AnalysisEventListener）</li>
</ul>
<p>文档地址：<a href="https://easyexcel.opensource.alibaba.com/" target="_blank" rel="noopener noreferrer">https://easyexcel.opensource.alibaba.com</a></p>
<p>github地址：<a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/easyexcel</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2easyexcel写操作">2、EasyExcel写操作<a href="https://jachen99.github.io/blog/product-easyexcel#2easyexcel%E5%86%99%E6%93%8D%E4%BD%9C" class="hash-link" aria-label="2、EasyExcel写操作的直接链接" title="2、EasyExcel写操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21创建项目">2.1、创建项目<a href="https://jachen99.github.io/blog/product-easyexcel#21%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE" class="hash-link" aria-label="2.1、创建项目的直接链接" title="2.1、创建项目的直接链接">​</a></h3>
<p><strong>pom中引入xml相关依赖</strong></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependencies</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">easyexcel</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependencies</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当引入该依赖之后，会发现在项目的依赖文件中同时多出了poi的类库。也就是说，EasyExcel是基于poi来进行实现的，间接地引入了如下依赖：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">poi-ooxml</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22创建实体类">2.2、创建实体类<a href="https://jachen99.github.io/blog/product-easyexcel#22%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB" class="hash-link" aria-label="2.2、创建实体类的直接链接" title="2.2、创建实体类的直接链接">​</a></h3>
<p><strong>设置表头和添加的数据字段</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty("学生编号")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty("学生姓名")</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>@ExcelProperty：用于设置Excel表头，其中index用户表头的编号，从0开始；value为表头对应的内容。</li>
<li>@DateTimeFormat：用于日期的格式化</li>
</ul>
<p>完成上述功能准备工作之后，我们就可以来生成一个Excel了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-实现写操作">2.3 、实现写操作<a href="https://jachen99.github.io/blog/product-easyexcel#23-%E5%AE%9E%E7%8E%B0%E5%86%99%E6%93%8D%E4%BD%9C" class="hash-link" aria-label="2.3 、实现写操作的直接链接" title="2.3 、实现写操作的直接链接">​</a></h3>
<p><strong>（1）创建方法循环设置要添加到Excel的数据</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">//循环设置要添加的数据，最终封装到list集合中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">private static List&lt;Stu&gt; data() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Stu data = new Stu();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data.setSno(i);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data.setSname("张三"+i);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list.add(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return list;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>（2）实现最终的添加操作</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String fileName = "E:\\11.xlsx";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 如果这里想使用03 则 传入excelType参数即可</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    EasyExcel.write(fileName, Stu.class).sheet("写入方法一").doWrite(data());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么我们如何解析Excel呢？接着看....</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3easyexcel读操作">3、EasyExcel读操作<a href="https://jachen99.github.io/blog/product-easyexcel#3easyexcel%E8%AF%BB%E6%93%8D%E4%BD%9C" class="hash-link" aria-label="3、EasyExcel读操作的直接链接" title="3、EasyExcel读操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31创建实体类">3.1、创建实体类<a href="https://jachen99.github.io/blog/product-easyexcel#31%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB" class="hash-link" aria-label="3.1、创建实体类的直接链接" title="3.1、创建实体类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(value = "学生编号",index = 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(value = "学生姓名",index = 1)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先创建一个监听器ExcelListener，集成EasyExcel提供AnalysisEventListener类：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32创建读取操作监听器">3.2、创建读取操作监听器<a href="https://jachen99.github.io/blog/product-easyexcel#32%E5%88%9B%E5%BB%BA%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C%E7%9B%91%E5%90%AC%E5%99%A8" class="hash-link" aria-label="3.2、创建读取操作监听器的直接链接" title="3.2、创建读取操作监听器的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class ExcelListener extends AnalysisEventListener&lt;Stu&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //创建list集合封装最终的数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //一行一行去读取excle内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void invoke(Stu user, AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("***"+user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list.add(user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //读取excel表头信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void invokeHeadMap(Map&lt;Integer, String&gt; headMap, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("表头信息："+headMap);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //读取完成后执行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void doAfterAllAnalysed(AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println("list = " + list);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在该监听器中，通过重写AnalysisEventListener的方法来获得解析的数据、表头信息，以及解析完毕之后执行的操作信息。</p>
<p>同样写Excel一样，通过EasyExcel类的静态方法来执行读操作：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33调用方法实现读取">3.3、调用方法实现读取<a href="https://jachen99.github.io/blog/product-easyexcel#33%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%8F%96" class="hash-link" aria-label="3.3、调用方法实现读取的直接链接" title="3.3、调用方法实现读取的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String fileName = "E:\\11.xlsx";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 这里 需要指定调用哪个class去读，然后读取第一个sheet 文件流会自动关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    EasyExcel.read(fileName, Stu.class, new ExcelListener()).sheet().doRead();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的@DateTimeFormat注解可转换日期格式，还有其他类似功能的注解和自定义转换器。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="EasyExcel" term="EasyExcel"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[spring-security整合微服务实践]]></title>
        <id>https://jachen99.github.io/blog/product-spring-security-microservices</id>
        <link href="https://jachen99.github.io/blog/product-spring-security-microservices"/>
        <updated>2023-03-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[起因：随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>起因</strong>：<em>随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<table><thead><tr><th></th><th>Spring Security</th><th>Apache Shiro</th><th>Apache Knox</th><th>Keycloak</th><th>Stormpath</th></tr></thead><tbody><tr><td>概述</td><td>Spring Security 是一个非常流行的 Java 应用程序安全框架，提供了完整的身份验证、授权和会话管理功能。它具有良好的可扩展性和灵活性，能够与 Spring 生态系统中的其他框架和库无缝集成</td><td>Apache Shiro 是一个轻量级的安全框架，提供了身份验证、授权、加密和会话管理等功能。它易于使用和集成，能够与任何应用程序框架一起使用，支持多种数据源，如 LDAP、JDBC 和 Active Directory</td><td>Apache Knox 是一个开源网关，提供了 REST API 的认证、授权和审计功能。它可以保护 Hadoop 集群的 REST API，提供了单点登录和 OAuth2 支持</td><td>Keycloak 是一个开源的身份认证和访问管理解决方案，基于 OpenID Connect 和 OAuth2 协议。它提供了可扩展的身份验证和授权功能，包括单点登录、多因素身份验证和基于角色的访问控制等</td><td>Stormpath 是一个云身份认证和访问管理服务，提供了完整的身份验证、授权和用户管理功能。它可以与任何应用程序框架一起使用，包括 Java、Node.js 和 .NET</td></tr><tr><td>优点</td><td>完整的安全特性、与 Spring 框架无缝集成、丰富的插件和扩展、良好的文档和社区支持</td><td>括轻量级、易于使用和集成、支持多种数据源、优秀的文档</td><td>保护 Hadoop 集群的 REST API、支持单点登录和 OAuth2、易于配置和使用</td><td>可扩展的身份验证和授权功能、多种身份验证方式、基于角色的访问控制、易于使用和部署</td><td>云身份认证和访问管理服务、易于使用和集成、提供完整的身份验证、授权和用户管理功能</td></tr><tr><td>缺点</td><td>配置复杂、上手较难</td><td>与 Spring 框架的深度集成、不够完整的安全特性</td><td>仅适用于保护 Hadoop 集群的 REST API</td><td>配置复杂、性能较差</td><td>需要使用云服务、需要支付服务费用，成本高</td></tr><tr><td>适用场景</td><td>适用于基于 Spring 框架构建的应用程序</td><td>适用于不依赖于 Spring 框架的应用程序</td><td>适用于需要保护 Hadoop 集群的 REST API 的场景</td><td>适用于需要单独部署一个身份认证和访问管理系统的场景</td><td>适用于需要使用云身份认证和访问管理服务的场景。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结：<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E5%B0%8F%E7%BB%93" class="hash-link" aria-label="小结：的直接链接" title="小结：的直接链接">​</a></h3>
<p>国内目前非常流行的就是Spring Security和Apache Shiro 。</p>
<p>Spring Security出现的时间较早，在springboot没火起来之前一直都是Shiro 的天下，但目前最能和spring全家桶整合起来的就是Spring Security，Spring Security 是最为完整、可扩展和灵活的安全框架，而且与 Spring 框架的深度集成使得使用和配置变得简单方便。Spring Security 提供了全面的身份验证、授权和会话管理特性，并且可以轻松地扩展到支持自定义的安全策略和特性。而且社区也是十分活跃的。所以此篇文章主要从实践流程出发，实现与spring项目整合的快速搭建解决方案。</p>
<p>相对于 Shiro，在 SSM 中整合 Spring Security 都是比较麻烦的操作，所以，Spring Security 虽然功能比 Shiro 强大，但是使用反而没有 Shiro 多（Shiro 虽然功能没有Spring Security 多，但是对于大部分项目而言，Shiro 也够用了）。自从有了 Spring Boot 之后，Spring Boot 对于 Spring Security 提供了自动化配置方案，可以使用更少的配置来使用 Spring Security。</p>
<p>因此，一般来说，常见的安全管理技术栈的组合是这样的：
• SSM + Shiro
• Spring Boot/Spring Cloud + Spring Security</p>
<p>如果还想了解shiro这一框架，我也在github开源了一个小demo，用于整合SpringBoot与shiro，实现快速上手，仓库地址：<a href="https://github.com/Jachen99/rbac_shiro" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/rbac_shiro</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E4%BB%8B%E7%BB%8D" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security简介">Spring Security简介<a href="https://jachen99.github.io/blog/product-spring-security-microservices#spring-security%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="Spring Security简介的直接链接" title="Spring Security简介的直接链接">​</a></h3>
<p>Spring 是非常流行和成功的 Java 应用开发框架，Spring Security 正是 Spring 家族中的成员。Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案。</p>
<p>正如你可能知道的关于安全方面的两个核心功能是“<strong>认证</strong>”和“<strong>授权</strong>”，一般来说，Web 应用的安全性包括**用户认证（Authentication）和用户授权（Authorization）**两个部分，这两点也是 SpringSecurity 重要核心功能。</p>
<p>（1）用户认证指的是：验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程。</p>
<p><strong>通俗点说就是系统认为用户是否能登录</strong></p>
<p>（2）用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。</p>
<p><strong>通俗点讲就是系统判断用户是否有权限去做某些事情。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="历史">历史<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E5%8E%86%E5%8F%B2" class="hash-link" aria-label="历史的直接链接" title="历史的直接链接">​</a></h3>
<p>“Spring Security 开始于 2003 年年底,““spring 的 acegi 安全系统”。 起因是 Spring开发者邮件列表中的一个问题,有人提问是否考虑提供一个基于 spring 的安全实现。</p>
<p>Spring Security 以“The Acegi Secutity System for Spring” 的名字始于 2013 年晚些时候。一个问题提交到 Spring 开发者的邮件列表，询问是否已经有考虑一个基于Spring 的安全性社区实现。那时候 Spring 的社区相对较小（相对现在）。实际上 Spring 自己在2013 年只是一个存在于 ScourseForge 的项目，这个问题的回答是一个值得研究的领域，虽然目前时间的缺乏组织了我们对它的探索。</p>
<p>考虑到这一点，一个简单的安全实现建成但是并没有发布。几周后，Spring 社区的其他成员询问了安全性，这次这个代码被发送给他们。其他几个请求也跟随而来。到 2014 年一月大约有 20 万人使用了这个代码。这些创业者的人提出一个 SourceForge 项目加入是为了，这是在 2004 三月正式成立。</p>
<p>在早些时候，这个项目没有任何自己的验证模块，身份验证过程依赖于容器管理的安全性和 Acegi 安全性。而不是专注于授权。开始的时候这很适合，但是越来越多的用户请求额外的容器支持。容器特定的认证领域接口的基本限制变得清晰。还有一个相关的问题增加新的容器的路径，这是最终用户的困惑和错误配置的常见问题。</p>
<p>Acegi 安全特定的认证服务介绍。大约一年后，Acegi 安全正式成为了 Spring 框架的子项目。1.0.0 最终版本是出版于 2006 -在超过两年半的大量生产的软件项目和数以百计的改进和积极利用社区的贡献。</p>
<p>Acegi 安全 2007 年底正式成为了 Spring 组合项目，更名为"Spring Security"。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="流程介绍">流程介绍<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D" class="hash-link" aria-label="流程介绍的直接链接" title="流程介绍的直接链接">​</a></h2>
<p>要对Web资源进行保护，最好的办法莫过于Filter
要想对方法调用进行保护，最好的办法莫过于<a href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">AOP</a>。</p>
<p>Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。</p>
<p><img decoding="async" loading="lazy" src="https://img-blog.csdnimg.cn/20201231155747261.png" alt="img" class="img_ev3q"></p>
<p>如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。经过一系列拦截最终访问到我们的API。</p>
<p>这里面我们只需要重点关注两个过滤器即可：<code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<code>FilterSecurityInterceptor</code>负责权限授权。</p>
<p>说明：<strong>Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速实践">快速实践<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E5%BF%AB%E9%80%9F%E5%AE%9E%E8%B7%B5" class="hash-link" aria-label="快速实践的直接链接" title="快速实践的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="搭建权限框架基本骨架">搭建权限框架基本骨架<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E6%90%AD%E5%BB%BA%E6%9D%83%E9%99%90%E6%A1%86%E6%9E%B6%E5%9F%BA%E6%9C%AC%E9%AA%A8%E6%9E%B6" class="hash-link" aria-label="搭建权限框架基本骨架的直接链接" title="搭建权限框架基本骨架的直接链接">​</a></h3>
<p>1、给spring-security创建单独的公共模块</p>
<p>2、导入相关jar包，如果是maven工程，直接引入</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Spring Security依赖 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">spring-boot-starter-security</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：依赖包（spring-boot-starter-security）导入后，Spring Security就默认提供了许多功能将整个应用给保护了起来：</p>
<ul>
<li>要求经过身份验证的用户才能与应用程序进行交互</li>
<li>创建好了默认登录表单</li>
<li>生成用户名为<code>user</code>的随机密码并打印在控制台上</li>
<li><code>CSRF</code>攻击防护、<code>Session Fixation</code>攻击防护</li>
</ul>
<p>3、在需要使用权限框架的模块导入依赖</p>
<p>这里以医院预约挂号系统的order模块为例，仓库地址：<a href="https://github.com/Jachen99/yygh_parent" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/yygh_parent</a></p>
<p>导入依赖到service-order模块</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">space.jachen</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">spring-security</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">1.0.1</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4、启动该order模块，会发现控制台显示Using generated security password</p>
<p><img decoding="async" loading="lazy" alt="image-20230216104643176" src="https://jachen99.github.io/assets/images/image-20230216104643176-f4f96f5b1dc242b1cd0a8cbec3971064.png" width="1054" height="248" class="img_ev3q"></p>
<p>说明该模块已经被spring security保护。</p>
<p>5、此时我们通过浏览器去访问该模块下的api路径，会进入框架自带的登录页面：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216112805097" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWQAAACjCAIAAAAy4/PPAAAZL0lEQVR4nO3de3gU533o8d87l53dnd3Zm3ZXWt0FEkjcwZi7wfEFEztxbezYjnNqOyVx/LhPmpzTJmmaPs1pkrZ+0hwnJ23SNHFxk9g5DmlqE0PAGF9ABmzuF4EAgVbS6rIrae/Xubzv+QOSAKbPTihkwfv7PA9/gEajd8Xsd9+ZnZkl8XgcEEKoHK7SA0AI3RgwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFThEoP4EaQj544HQ6Ppn7zd84TaJja2ljjkQEAgAKkP/v0FwbE2Z//9IOruoIVG2c5jBaGwuH+0cyMBTf7rECuwU8YHzjdPzQuBprndTRc/dWjisJYmJCNbHnlpe0HBn7zd2K1OdyBpjX3rb1t6Wy3BQBoNBobllLZglbBYZaVGTy06YV/fz0szdUav7ii1sJf5VwwQ3/rjc0vbdnbuuCWeV948uquHFUcxsIEvZhJTSZKZMbS1cta7Ewvne3Zv7f3yI/XFwzyyQdXTrsGL9HXhGB3BYKhYI7rDNq4azFoQvyBQKg2WB+qvwZrRxWGsTDL6grMuPX+x5b7mKGNnJ2rP/tP2471dL/d/cAt08gNUgtbTfuq+z49K5VvanPz1+BoFeGEBYs/1Nq1BOy+q792VGkYi98b4cX69vmtXdPIwVOZxCBl7P2v0pQa6UQik8upmg6cYLXJisvltIkAAFTL5nKZTK5YVHVKOV6QHYrH5ZQsAgAYup5NJzO5XEnVKXCi1aG4XF6HBQCAqslkOpP9zTrtssfns/LkcnMEmstk05lMoVgyKOMFwRsIOawib6gCoaIk5TWQJAAAqpeymUwqnStqBi+IiturpRMltSS73f4aHzW0THQwXiS+QA1hNJ1MF0o6J4iKx+d2WIXL9IYVKa9RZqd5AAUAMrGhRF6zKy67VUolkrlCifCC0+VxOWVJ5K/qfwu65jAWV4RRYAyA8OQyL9DU0NPx0Z//+4+7DxwajqWI1Tmlc/6aex/6yLKpPAEoRHds+fVrb+8/3R9J5oqC3Tn/5js++dgDXS0BjhnpiaGXf/bijv2HB6IpDUT/1IVrH3n80VuagdF8rO8XL728Y8/BSCzJSa7WmfMfXvfk0laPTbx0DFo+0b311c3bd54KR3IlJiueh774zXvnNyrJky/+6w9+eaT06Neef7QDRI4mR0//6j/+c8vO/YOTeYevYeWHH1Df+eU7vadX/Y8n/+qpj5eyide++cT3D5I//tz/qtHGNm56+3h/VFACt937+KceWB502y/NFDU2/nz9v7y4ecmtq//v1/8SgO358Ve/t+1M110fv2uO75cbNu3rCVOre/mdD37ykdUd9d4bZEKGzsNYXJFiNBkbYSA75BD3vp2QieH+55758qajxQ/dfdd90+qTkZ7uXe+t//5Aa+cPujxEnDxx9PSwtb7r/iUrSTHbu3Pju2/9wtnS9ic1d9bp/Qe2/PNzrxybtuy2j390lsJlRxNUJjoANfTJv/7C3x5I2W9ecvtHp4fiZ4+/vnXr3zx9+gc//LuulrqLR8De+cn312/cwWqn3fvwY40Be2xoyCFZGbv0QVB1/Ec/ev6VN47UNrbdt3a2TLQT7/xwYCCVv2Q5Rrf+v39rbOuctXhlS8vga1ve3vyTby1a2HqLq91q5unOjMPdWwuRUMvsxW3t0zdv3Lpz4/NtU2ob/uhWGWtxQ8FYmFXKxAeP7t6uylTL7962ufvQqYaumbf+0Ycv3QtQE6On33mzL3vL03/zxMoOv8NC9SU+r/fvn9vyjZ/s/+Gn57jcMx9bN5vnJcnCA9VKq6c++dQ/7jg+uGpFVuEmzh49QjnLh9c+tKwtIAvMoMDxFi2X7N/0zZ6R2NpPffHe2xe7JcHIzZzdrH/u2e3bTsb9wdqA7YJBMHj31NhYsnjr3YvW3nePLHC6phGrcm4f6EIDb/2s5/jxxlkLnvjMUzc3KRywwr23f/UrXx89PXLRcozZZ65+8OGPttfIpdTYXOfQN14O7zmd6JrCGhwmnu4M7HXT7nzsU4uavKCXFrqHv7Ghp+fMcCRJp3nwNJ8bCcbCLDU9vu9X6/u28YxRA/jGWUvvWfvA8q66SxYrpkYHerqT2cLJNzZ8e59k4QkAnYiNaQVt5K0T6uMzwekjqZHI8JmRsehoLDI23BfPFTLjyWwmb28ONXUtZXt2/MePvh9duvzm+bNbG4Ju2ZKJ5be9tD9XUPe8vvHsgR08ATBKhdSIYainRzLZohGwXfD/SGDxgin7z/S/9+Y2C6XLFi+YPm2aTyQ8B8ZFI2WHd/QlJ/IzV81ZNK3BLXEA4FLkjhp/7yWxINycGTNaG+vcEmdIdMZN84VfDYzFC4WSAQ4T2w/hGlu7ZrU3eWw8o1rnzQudm84ksqV0wQCMxQ0FY2GWaHe1LVi1uMkOQFz+0LSumS31AY9NAKAXLqYXc7nJIUKIolgsFp4HAsAH6xqDdVMtloAkcr0Hd2/69RvhaFp2u3nJYrfVcBwPJZXpuqQEF9z5yGMZZe+h4zt//Yv9u3fMvGnlHauWhUS9P1I0ACSBswg8AABvd/in3vahqY0hl1245OWd3HTb3Y9z8vZdRw7vfvPogd3tM+bdff/9Mxq81osWYyOxYqHI/E77uVIAABDeTrhLpyCE+JyiU+IAgPC8RfEAIapODfq+HZvLIsQpix7bucOZxKK4eV7QDWoYtMw3ousMxsIsq6d27uqPP7m8zJuCvChJTh8vJOasfuiu9hrn744+coRYZSu39dWXN++LzVu15oE75jkVp9uWOPjue+dODqXE4qntWPdkw7ITvYf2vfPaazt/vWFEBekza6bXeHkuRVesue+WedOlC95GEB0+l+3S12droOO2jwZnLVxxaP/e19/e+eqGH48ZDX/5+MrGCxdiIFkJz7NsScvpTBYIADCqJg299L4H9d+cABC4FmeLoj80nAdeZZISqJ+6kAete1e/TgWHw6E4nU7Z5rBLwTo3z+tnxlIpOdQ+Z35HW1Ot21oaOV4s6ee+V82nY5GhdAnaps+675F1a5YsZPHh4bNHrDbbLXe0SBbhTGRSBdHhcCpOp8NulwTitXPSpTMLCI+OT+aoO9j4oTX3fGbdI8DY0e29k5MXH7gkpKvT73SIfT3HjpyNJlOpVDIxOtDTFxsv/mF+U+hGgzOLq4yzB+u6bu1UXj269dnvZg7Pnt7mtnG59ERRo4/+6ec9xOKUbcKxnt2vvCjGumgmvnVvXzJXAjcAQCrSs2X9d0ZDt0+fPlWbGOzu6S3ava6aJsnpvvmJL/l3fWXbC8+N9R5eMKdDtvLZxHjk5P6nvvyPDXUXX43C6Pf++QcGb104a6pDKJ44epQXhPpF7bJiu3ik5Ka1D7WfjG7f3/2tr4+vWDRbNEoHuvdkEqmL91YQOg9jcdWR+rbOr3/3W+uf++m+o/s37O/mRVsg1DB38VIJgAC37uF7BfjPPcf2vhDu7Zi79GvPfP6vnvyzMAAA2F013lDzq9s3b92Y4yRbbUPrx9Y9cv/dq4ATeFfHs//7sy9seHXPoSMvHt7NWe2+uqY5MxeLku39A5jf5tr6Vvf6d18zmOj1hVbf89ATjy9vCsgwcdFyYs2MdY896rS/3H3o1C9fDje0zfjw018Zeum78UM9PIdTTnQpEo/HKz2G656amYgnUyrv9AYClzn+zwBoODxUIna/z+V1SACMGlp8Mp7N5TXdAMKJFkl2OHxeNwegFbLJVCqdK1DgbbIjGPREBiIqsfu9LpfE8pnkRDKvGQZwnGS1KS6X03HueAJQNZ9IpTPZvKoZwHGCKDlku9ftEoRLT4VMxCcymWxJ0xjjRNEiOxxejyLwPNNyqWQynmeuYINXAkJAK2bTqXQqV9ApSJLd5VX+/kt/sfNA5MF1T3/+idVU19LR8GSB1NTWOh0ODgCYrhcz4eFJyVPnU+x28ZI9IBaLjSdTabssN4TqACAdHUzkVLvb5/Oee+eDUTUdGUswyeVxuxQJk3QjwVhUMaan8jrP8Q6bCIzqar5nz9a/+85P4vbpTz396fuXtFV6fOj6grsh1Yux/OubNo+lNa/LLnAsGx/ftWN7htmWrlwxpwMvG0WXwlhUMUaS0XD3nmMlTec4TjVAUQKLbl/5ibtumuKTKj04dN3B3ZBqxrKJiaHI4Oh4vKSBxaG0tk6r9zvxelB0WRgLhJApeDgaIWQKxgIhZAoe4CxDpzBRFFKqyF2Tu1aiGwZjTCBUEfUam1F+6Q8ijEUZkYxYBKnOJQhX+17Y6MbCgCULNF4gGAt0eb0Jy7JWocmNpUDEa+P6J6v3KYPHLMoo6oQyLAUCABB5Yn/fHU+rR/U+coTQ7wVjgRAyBWOBEDIFY4EQMgVjgRAyBWNxJdRcWlfP39fWoCyWKpq91TVCNyyMxZUYPbbnzJnwuT6kM7n128/kirphGLquG7/Jhq7rum5QxoAxRg1KDV0//8fQdYNSBsAY03Vd13XKGABQxnSD6rquG+zc2ig9d798Ro3frg6hyqjeM0yuupHBwWg8Jbu9rW2NvK4f6TmhG3zblGa/lWaT40kDRuOSn09aBJIoaIJS09rSwGnaiWO9RUZDLS21PncymQ1H00Z+0uJt9ahjyVzeHahrqQ8YmjYZPj6YIY5QS6PfJeMV5KgScGZxlajhcI7zt0ypcdsz6fS+17dPaW2bFeJPDMYi48nhociJlHPGlJpoX29/Rqxrbc6kku8eH2dAlM72rq6WI8eHwiOpiVj05MBo55Tm07u3hHNiU617LBo7Hs3n0rHd+ZqpHe0TPQcHBkbKDwahawBnFlcJ75P0wcGI2tnoMwr5YyNZcrqPpwWVeDmDiKIQaPTYJM7Q1KBXUWTFJsSGJyahlR872jcmCGOxfF1ItTBesLltNqvbyDXVyE6fKI7n4+OpAOkzMs7ek/GsbrgM3BFBlYGxuBKyS46pRqKguUVDy4/Vh2oE3tLRXJ8cGRyOFOx+v8CLwVCtVRBCFrtcGteynOwQgFIAsAkg8jyjxChkMoMTqjM0xcVHhnPAGHA88DwBsHAgi0S0iAbhdEpBEqxOX33AHvK63B5HpR89qlK4G3Il3A3NHNVGo+PRicloLL50ht9iJHJ5w253SALhZXtno8MghCOEGCWrTeIESQQAAlbZwQsCAEgWXrZZeM6i1Dg5QnmLZLUIFoFzWEVCiM3h5HgegJME3i7bLTWNpXgGgBgGp/Hv+zR0hP4gcGZxJQRHQ0eTNZ5MpwuiXNvV5uRAdTKaius2d01treJsWrm0f2AsQWltMChJlkBjqwpACNc8c67TLQNAIFRn9+iy12YbGEpxctf0Vr/bxvOypBiEF9rmLnA5bQBCU1ODZgh2m7y0RU9l05xcIwp4K11UGXgPzjJe7nPcOlVs8VR6HOg6oBoQSRgePl3pgVQG7oYghEzBWCCETMFYIIRMwVgghEzBWJTBc0AIngeFAAAoBb2KrxjEt07LqLEaRZUraDzBG3FWvazKsiXqr9YzXTAWZcwPFE8lYTBFRAFnYVWNMqbruktQKz2QisHzLMpgAAY9tx+CUwvECIDAVemeCM4syrhg46jSTQShc3BqjRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKCOdTnMcJwj4i0LAGAMAm81W6YFUBj4Hysjlcn6/v2q3D3QhSmmhUKj0KCoGY1Ge1Wp1OPCe2ggopZRSVq0fC4fHLBBCpmAsEEKmYCwQQqZgLBBCpmAsEEKmYCyue9RgWkHF22mgSsNYXAmjmCvkc7lCIV8o5kv6tf1hWiE7fGoUgF7bH4NQGXiexZXI9h04EFMFxW2UNOIMrZzdRCllDDiOEEIYY5QyAOA4DoCef1eecIxRnuPOnwZICAAwBhyBi74XgFIGjHHcuQUYqAU9M54CCAHwFXzMqOphLK5QTW2oqX1qYWxkV/cRY1bTyZOn8yW1rq6+PujNZbMnz4QZwPSOdi09ORqL61any18bHxqb0dUIqWiKs8oeL82rI2nWXiv1nurLF0vBYG1jnT9fKPUOZyAX7ZjaxhWTw9EJVVMdOP9D1wHcDK8Qx3O8wBhn5HmZkPFQKNTZrPRHxg6dHB7rPdgwtbXTwwCMo0NppoRCXiWvFiZ69qglrfdE/1vvhSPRZDrVP1w03tv0iuF0tXc0Rc707zs6kEkl9+490NLcJPPF4wMTmjNU51OGRvKVfrgIYSyuVHJ87OiR3uHJ4pJFXXpKHQgP95wZG8+UCjqRrFzkeO+E4RR54rCwyOhYkhCfLEwN8eOaEWEeVipF+85mxibaFHowJgUVp9Pu9LulQnKCAqdKNQ7ZziUjkmwP+BRF8bR4pUo/XIQwFldKkORgsLatqb6pVhk6fEDjrAGvS6IGI4In2OJ3iCeP9GTyWnNLfXuIj44NR4uWus7ppyOjotfTFJQy46MTSd5vAQF0xoABUEIYJwDhQXICEKCGphsGZQalRfUaH0NFyASMxZXgLFaXx1Mb9HvdLgDQwQi4LVaB5ySLQCCRzEk1IavIAS0V8gWH0+m1CZomir72bKS/3itNa3TaRaLZA6IoLmyxjMXjE/HJeJb6grU8TxS7QAiAJ0QL+WhsMp5MxAq8BT+2BFUafshQGaOjo42NjU6n88J/VJNRVbBLslMkAEABsn1nJgyLgxdsNk7nCxOTJU5U6pr9/Hh0PJXJOxWlMVQLjA2cDfvramWLEc9oReIIuUUAONMfLpZUv98f8HnyJW1wotBe5+Q5kh6PTSRSRBQCXrvmCiqY9kqjlKbT6aq96hRjUcZlY4GqU5XHAl+rEEKmYCwQQqZgLBBCpmAsEEKmYCzKIATfskTnMcaq9ugm4LUhZYmiaBiGYRiVHgiqPE3TVFW1WCyVHkhl4FunZRiGUSgUCCE8j9d8VjVKqWEYHMfJslzpsVQGzizK4Hm+ajcOdAnGWDXvlmIsyqvm7QNdqMq3BDzAiRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKO/YOL8rIkwWuCq+LACBxLOuGmNhSK+xV+l2gLEooy/BfXev9Y2wOFmo6hNykMSzaT76mfnFh2eolR5LZeBuSBk/PSq9GRawFKhkkBMT/Is91fuxDBiLMo6O84kS/pYQAIBGIVWq3pcNfBqUwRh+fjlCABgLhJBJGAuEkCkYC4SQKRgLhJApGAsEAMBzoFjBSq5kg+A58FiBq953CaoFxqJKcRwIHIgciDzwHDis8InFsEQC2++5HkKgxgmfXQJu6zUZJ7p+4Bmc1UiywD2L4XNd4BBA5GDHEfjyPnCIYLmi2YHAgSziy84HH8ai6hACPjt8dR78w3Y4NgkcQKoI2QI8vwfyRSj+nmtjDGJpeHY3JErXZLTo+oGxqEYCByEZaBEGJiGpAgC47fCJZbD+bcgVYWEzrJ4KCgeaAS4HPPMmjGbh4VkQlMHrAIGHs32wYRDi5+pAQFHgK0vhq29AYzMsVYCjEPIBT+EX78GRLBTwE1c+KHDyWHUYg2QRfnoGVs+Gx2bBQj+4BHBYYc0csFvAE4CPzYWZDojnwSnDn8wHnw14DpY3w8faIVsAg8DnVkDDBZ+O4JThiXnglKC1Hu7phCVeSKrgD8KXFoCrSj+O54MJY1GNMkX4623w9gSs7IIvLYeldb/70rzpUM/g53vgmXfgmd1QYudPdicMtp2Cf+iGb++CmiC47Jdfs5aHjT3wf3bB9/bBimngxFh8gGAsqhKFYhKe3wGffQ0GRHhqye++Ms0JpQSMTQADoAC/3YcolSBdAAZQZEAJcP/FhjMxDOPDYGhQSIFgvcIjpuj6hLGoOgTALsIiBWw8DMfgRBSMC45cjRQhWAdtdUA4sNvBRgCf7+gcPMBZfQi4ZHjmERB0KAFYdHj50O++uH03rLgT/udH4JE0OOxQInjNLToPY1F1GIOJLPzZq2AhQAAKKoxmIK7Cn/8MxnOgGfCdt+DnTiAMPAr87EEAAM2Ab797/mr9fA7WvgBHY79dHcTGYc1PYTQL2YNwRIMEAGVwdhI+sgHCuco9TnS1YSyqkarD3qFL//HwIAAAR8DQIZ0HEKBeAS0NqgqUwdnU+cV0HboHLvrGfAneDgMAFOJwviEMcirsjFzLx4D+4DAW6CKEwOpOaJIBBPAr8KNdMJav9JjQ9QFjgS7CGOwOw7ALCIN0AXaPAN7THJ2DsUAXoQxOxOBErPySqNrgW6cIIVMwFmWQ838QqnYYizLavVSx4F47AgAQOHCI1bsxYCzKeLCztKhed1urdxNB51h4aHUbH2nXKj2QiiHxeLzSY7je7RkWfnVaHM1iWKuaVYDFIf2ONq3OQSs9lsrAWCCETMFXS4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCn/HzFPDRfNstOFAAAAAElFTkSuQmCC" width="356" height="163" class="img_ev3q"></p>
<p>默认用户名为user，密码为控制台输出的随机密码，认证成功后才可以登录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现用户认证功能">实现用户认证功能<a href="https://jachen99.github.io/blog/product-spring-security-microservices#%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD" class="hash-link" aria-label="实现用户认证功能的直接链接" title="实现用户认证功能的直接链接">​</a></h3>
<p><em>目前，我们已经实现了自带的登录页面的访问，用户名和密码都来自于内存。那么要访问来自于mysql、redis甚至的用户名、密码怎么办呢？</em></p>
<ul>
<li>加密器PasswordEncoder</li>
<li>用户对象UserDetails</li>
<li>业务对象UserDetailsService</li>
</ul>
<p>功能1：自带登录页面，访问真正的数据库，需要做什么？</p>
<p>1、访问基于内存的用户名和密码使用的是InMeoryUserDetailsManager（实现了UserDetailsServer），我们需要自定义UserDetailsServer的实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.security;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.user.PatientFeignClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:35</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class UserDetailsServiceImpl implements UserDetailsService {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private PatientFeignClient userInfoFeignClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public UserDetails loadUserByUsername(String phone) throws UsernameNotFoundException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        LoginVo login = userInfoFeignClient.loginSecurity(phone);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if(login == null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new UsernameNotFoundException("用户名不存在！");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 这里不比较密码 ，后面通过PasswordEncoder比较</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 返回数据、暂时不做授权</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Collection&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new CustomUser(login,authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、访问数据库的方法loadUserByUsername，返回值为Userdetails，它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，所以我们还需要自定义UserDetails实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.Getter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.Setter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.User;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 访问数据库的方法loadUserByUsername，返回值为Userdetails，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 所以我们还需要自定义UserDetails实现类。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:31</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Setter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class CustomUser extends User {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 我们自己的用户实体对象，要调取用户信息时直接获取这个实体对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private LoginVo loginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param loginVo  从数据库中查询的用户信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param authorities  从数据库中查询的权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public CustomUser(LoginVo loginVo,Collection&lt;? extends GrantedAuthority&gt; authorities) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        super(loginVo.getPhone(), loginVo.getCode(), authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.loginVo = loginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>现在数据都有了，我们需要进行密码的比较。</em></p>
<p>3、使用PasswordEncoder接口，但是不同的数据库采用的加密算法不同，这里可以使用security自带的PasswordEncoder实现类，如果不合适，就自定义一下PasswordEncoder的实现类即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.crypto.password.PasswordEncoder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 自定义密码组件 密码处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 此项目不需要md5加密处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 不需要开发者自己调用此类，SpringSecurity流程中进行密码比较时会自动调用。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:25</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component  // 必须添加到IOC ,SpringSecurity才可以使用</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class CustomPasswordEncoder implements PasswordEncoder {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private StringRedisTemplate stringRedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 如果需要加密进行加密操作后返回，这里不需要处理，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 因为本项目没有对用户密码进行加密，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 采用的是手机号+验证码的方式进行登录</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 验证码存在redis中，为了方便演示，特定此条验证码永不过期，当作密码使用，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param rawPassword  明文  用户输入的密码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return  密文</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public String encode(CharSequence rawPassword) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return rawPassword.toString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param rawPassword  用户输入的密码  即4位验证码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encodedPassword  从redis中查询出来的验证码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public boolean matches(CharSequence rawPassword, String encodedPassword) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 写死</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        encodedPassword = stringRedisTemplate.opsForValue().get("13243922402");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encodedPassword.equals(encode(encodedPassword));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先来看看整个认证的流程图：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216133620298" src="https://jachen99.github.io/assets/images/image-20230216133620298-5f63300eb8e0aa01307e67ad37ce956b.png" width="1067" height="650" class="img_ev3q"></p>
<p><em>现在，虽然已经实现了对真实数据库的访问，但是还是使用自带的登录页面，那么怎么才能通过前端项目的真实的用户登录页面访问呢？</em></p>
<p>登录成功后，每次访问其他资源都要判断一下token是否正确,如果正确才能访问，如果不正确返回异常信息。</p>
<p>4、自定义用户认证接口（过滤器1）</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 不用加Component注解 不需要加入IOC  过滤器由tomcat进行管理 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:45</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.AuthenticationManager;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.Authentication;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.AuthenticationException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 登录过滤器，继承UsernamePasswordAuthenticationFilter，对用户名密码进行登录校验</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class TokenLoginFilter extends UsernamePasswordAuthenticationFilter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public TokenLoginFilter(AuthenticationManager authenticationManager,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            RedisTemplate redisTemplate ) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //设置认证管理器</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.setAuthenticationManager(authenticationManager);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //设置登录的地址和请求方式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.setRequiresAuthenticationRequestMatcher(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new AntPathRequestMatcher("/yygh/user/loginSecurity", "POST"));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录认证</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 走这个登录认证流程 不走原先的登录接口了</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param req</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param res</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws AuthenticationException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public Authentication attemptAuthentication(HttpServletRequest req, HttpServletResponse res)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throws AuthenticationException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 获取用户名的方法  简单封装方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            LoginVo loginVo = new ObjectMapper().readValue(req.getInputStream(), LoginVo.class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String pwd = (String) redisTemplate.opsForValue().get(loginVo.getPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 将用户名和密码封装到Authentication</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Authentication authenticationToken =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    new UsernamePasswordAuthenticationToken(loginVo.getPhone(), pwd);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 调取getAuthenticationManager认证</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return this.getAuthenticationManager().authenticate(authenticationToken);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录成功 认证成功调用的方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param chain</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param auth</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,Authentication auth) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 1、通过Authentication获取认证的对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        CustomUser customUser = (CustomUser) auth.getPrincipal();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 2、通过JwtHelper生成token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String token = JwtHelper.createToken(Long.parseLong(customUser.getLoginVo().getOpenid()), customUser.getLoginVo().getPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 3、获取用户的权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Collection&lt;GrantedAuthority&gt; authorities = customUser.getAuthorities();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 4、将权限保存到Redis中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // redisTemplate.boundValueOps(customUser.getUsername()).set(authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 5、保存登录日志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // loginLogService.recordLoginLog(customUser.getUsername(), IpUtil.getIpAddress(request),1,"登录成功");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建一个Map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        map.put("token", token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 6、通过ResponseUtil工具类响应到前端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ResponseUtil.out(response, JsonData.ok(map));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录失败</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (e.getCause() instanceof RuntimeException){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null,204,e.getMessage()));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response,JsonData.build(null, ResultCodeEnum.LOGIN_MOBLE_ERROR));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 如果想在里面加入@Autowired  则需要添加配置类</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.http.SessionCreationPolicy;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.filter.TokenLoginFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:24</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@EnableWebSecurity //@EnableWebSecurity是开启SpringSecurity的默认行为</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@EnableGlobalMethodSecurity(prePostEnabled = true)//开启注解功能，默认禁用注解</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void configure(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 这是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //关闭csrf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .csrf().disable()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 开启跨域以便前端调用接口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .cors().and()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .authorizeRequests()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .antMatchers("/yygh/user/login").permitAll()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 这里意思是其它所有接口需要认证才能访问</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .anyRequest().authenticated()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .and()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//                .addFilterBefore(new TokenAuthenticationFilter(redisTemplate), UsernamePasswordAuthenticationFilter.class)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .addFilter(new TokenLoginFilter(authenticationManager(), redisTemplate));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //禁用session</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 配置哪些请求不拦截</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 排除swagger相关请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param web</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void configure(WebSecurity web) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        web.ignoring().antMatchers("/favicon.ico","/swagger-resources/**", "/webjars/**", "/v2/**", "/swagger-ui.html/**", "/doc.html");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>5、配置用户认证 （过滤器2）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 23:04</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.context.SecurityContextHolder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.util.StringUtils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.web.filter.OncePerRequestFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 认证解析token过滤器</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class TokenAuthenticationFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public TokenAuthenticationFilter(RedisTemplate redisTemplate) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger.info("认证解析token过滤器的url:"+request.getRequestURI());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //如果是登录接口，直接放行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if("/yygh/user/login".equals(request.getRequestURI())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UsernamePasswordAuthenticationToken authentication = getAuthentication(request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if(null != authentication) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            //放行请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null, ResultCodeEnum.PERMISSION));//209  没有权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private UsernamePasswordAuthenticationToken getAuthentication(HttpServletRequest request) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // token置于header里</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String token = request.getHeader("token");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger.info("token:"+token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (!StringUtils.isEmpty(token)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String username = JwtHelper.getUserName(token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger.info("username:"+username);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (!StringUtils.isEmpty(username)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //从Redis中获取权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Collection&lt;GrantedAuthority&gt; authorities = (Collection&lt;GrantedAuthority&gt;) redisTemplate.boundValueOps(username).get();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return new UsernamePasswordAuthenticationToken(username, null, authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //返回一个认证对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //return new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在就可以通过swagger测试登录了。</p><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="Spring Security" term="Spring Security"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SQL优化积累笔记]]></title>
        <id>https://jachen99.github.io/blog/product-management-system</id>
        <link href="https://jachen99.github.io/blog/product-management-system"/>
        <updated>2023-03-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景：因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去。]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去</em>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="or与union的执行效率比较">or与union的执行效率比较<a href="https://jachen99.github.io/blog/product-management-system#or%E4%B8%8Eunion%E7%9A%84%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87%E6%AF%94%E8%BE%83" class="hash-link" aria-label="or与union的执行效率比较的直接链接" title="or与union的执行效率比较的直接链接">​</a></h2>
<p>stackoverflow链接: <a href="https://leetcode.cn/link/?target=https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or%EF%BC%89" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or）</a></p>
<p>当SQL语句有多个or语句时，可以考虑使用union或者union all代替来提高速度。使用or的SQL语句往往无法进行优化，导致速度变慢。但这不是固定的，有时候使用or速度会更快些。具体情况还要经过测试为准。如果加索引的话，也可能实现速度优化。</p>
<p>实验表格如下,实际数据有2,000,000条，从里面返回大约最多1000行左右的数据。</p>
<table><thead><tr><th>X</th><th>Y</th><th>Inline</th><th>CDP</th><th>T</th></tr></thead><tbody><tr><td>12002400</td><td>5801000</td><td>300</td><td>300</td><td>3400</td></tr><tr><td>12002408</td><td>5801005</td><td>300</td><td>301</td><td>3402</td></tr><tr><td>12002416</td><td>5801010</td><td>300</td><td>302</td><td>3404</td></tr><tr><td>12002424</td><td>5801015</td><td>300</td><td>303</td><td>3406</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>or语句（部分节选）</p>
<p>SELECT * FROM tablename where (cdp= 300 and inline=301) or (cdp= 301 and inline=301) or (cdp= 302 and inline=301) or (cdp= 303 and inline=301) or (cdp= 304 and inline=301) or (cdp= 305 and inline=301) or (cdp= 306 and inline=301) or (cdp= 307 and inline=301)</p>
<p>union all语句（部分节选）</p>
<p>SELECT * FROM tablename where (inline= 300 and cdp=300) union all SELECT * FROM tablename where (inline= 301 and cdp=300) union all SELECT * FROM tablename where (inline= 302 and cdp=300) union all SELECT * FROM tablename where (inline= 303 and cdp=300)
返回不规则的900条数据，前者用了60多秒，后者用了8秒左右。</p>
<p>总结：</p>
<ol>
<li>Union：对两个结果集进行并集操作，不包括重复行，同时进行默认规则的排序； 即：去重+排序</li>
<li>Union All：对两个结果集进行并集操作，包括重复行，不进行排序； 即：不去重+不排序</li>
<li>对于单列来说，用or是没有任何问题的，但是or涉及到多个列的时候，每次select只能选取一个index，如果选择了area，population就需要进行table-scan，即全部扫描一遍，但是使用union就可以解决这个问题，分别使用area和population上面的index进行查询。 但是这里还会有一个问题就是，UNION会对结果进行排序去重，可能会降低一些performance(这有可能是方法一比方法二快的原因），所以最佳的选择应该是两种方法都进行尝试比较。</li>
</ol>
<p>2023/02/09</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shell脚本批量插入mock数据">shell脚本批量插入mock数据<a href="https://jachen99.github.io/blog/product-management-system#shell%E8%84%9A%E6%9C%AC%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5mock%E6%95%B0%E6%8D%AE" class="hash-link" aria-label="shell脚本批量插入mock数据的直接链接" title="shell脚本批量插入mock数据的直接链接">​</a></h2>
<p>shell脚本</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo "请输入字段servnumber的值："</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">read serber</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo "请输入创建sql语句的数量："</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">read number</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># char=`head /dev/urandom | tr -dc 0-9 | head -c 11`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">for (( i=0;i&lt;$number;i++ ))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pass=`head /dev/urandom | tr -dc a-z | head -c 8`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        let serber=serber+1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo "insert into test(id,username,servnumber,password,createtime) values('$i','user${i}','${serber}','$pass',now());" &gt;&gt;sql1.txt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>尽量避免使用select *from ，尽量精确到想要的结果字段。
尽量避免条件使用or。
记得加上limit 限制行数，避免数据量过大消耗性能。
使用模糊查询时，%放在前面是会使索引失效。
要小心条件字段类型的转换。</p>
<p>2023/02/11</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="线上调优-慢查询日志配置">线上调优-慢查询日志配置<a href="https://jachen99.github.io/blog/product-management-system#%E7%BA%BF%E4%B8%8A%E8%B0%83%E4%BC%98-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="线上调优-慢查询日志配置的直接链接" title="线上调优-慢查询日志配置的直接链接">​</a></h2>
<p>最好 nginxi访问日志，流量重放在测试环境中；迫不得已再线上调</p>
<ul>
<li>第一步：查看是否已经开启了慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show variables like 'slow%';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Variable_name       | Value                                |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_launch_time    | 2                                    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_query_log      | OFF                                  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_query_log_file | /data/mydata/jachen-public-slow.log |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set global slow_query_log = on ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">日志路径也可以自定义：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">set global slow_query_log_file = '路径';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看慢查询的时间临界值</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">show variables like '%long%';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：设置慢查询的时间标准</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set long_query_time=0.4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>注意：假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">永久生效的设置方法：修改配置文件 vi /etc/my.cnf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slow_query_log = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">long_query_time = 0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slow_query_log_file =/usr/local/mysql/mysql_slow.log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">最后重新连接才能生效，不必重启服务器！</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>执行耗时sql：</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM emp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM emp WHERE deptid &gt; 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询慢查询记录数：</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHOW</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">STATUS</span><span class="token plain"> </span><span class="token operator">LIKE</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'%Slow_queries%'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询日志：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim /var/lib/mysql/bogon-slow.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>mysqldumpslow分析工具：</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。退出mysql命令行，执行以下命令：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">-- 查看mysqldumpslow的帮助信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token comment" style="color:rgb(98, 114, 164)">--help</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 工作常用参考</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 1.得到返回记录集最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s r </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 2.得到访问次数最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s c </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 3.得到按照时间排序的前10条里面含有左连接的查询语句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s t </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">g </span><span class="token string" style="color:rgb(255, 121, 198)">"left join"</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 4.另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s r </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log </span><span class="token operator">|</span><span class="token plain"> more</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>-a: 将数字抽象成N，字符串抽象成S</p>
</li>
<li>
<p>-s: 是表示按照何种方式排序</p>
</li>
<li>
<ul>
<li>c: 访问次数<!-- -->
<ul>
<li>l: 锁定时间</li>
<li>r: 返回记录</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>t: 查询时间</li>
<li>al:平均锁定时间</li>
<li>ar:平均返回记录数</li>
<li>at:平均查询时间</li>
</ul>
</li>
<li>
<p>-t: 即为返回前面多少条的数据</p>
</li>
<li>
<p>-g: 后边搭配一个正则匹配模式，大小写不敏感的</p>
</li>
</ul>
<p>2023/02/15</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sql语句执行过程解析">sql语句执行过程解析<a href="https://jachen99.github.io/blog/product-management-system#sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E8%A7%A3%E6%9E%90" class="hash-link" aria-label="sql语句执行过程解析的直接链接" title="sql语句执行过程解析的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20230223160243626" src="https://jachen99.github.io/assets/images/image-20230223160243626-852c258d2994473f82bad8ae86bcd5df.png" width="1081" height="132" class="img_ev3q"></p>
<p>介绍如何开启性能详情</p>
<ul>
<li>第一步：查看性能详情是否开启</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show variables like '%profiling%';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Variable_name          | Value |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| have_profiling         | YES   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| profiling              | OFF   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| profiling_history_size | 15    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启性能记录功能</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set profiling = on ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看性能的记录</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show profiles;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Query_ID | Duration   | Query                                             |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        1 | 0.00177775 | show variables like '%profiling%'                 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        2 | 0.00037900 | select * from test where id='087878'              |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        3 | 0.34618025 | select * from test where servnumber='1367008787'  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        4 | 0.31986825 | select * from test where servnumber='13670087879' |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：查看语句的执行性能详情</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show profile for query 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Status               | Duration |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| starting             | 0.000100 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| checking permissions | 0.000010 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Opening tables       | 0.000023 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| init                 | 0.000045 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| System lock          | 0.000015 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| optimizing           | 0.000016 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| statistics           | 0.000028 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| preparing            | 0.000020 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| executing            | 0.000006 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Sending data         | 0.319489 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| end                  | 0.000037 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| query end            | 0.000012 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| closing tables       | 0.000012 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| freeing items        | 0.000040 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| cleaning up          | 0.000017 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>性能线程的详细解释官方文档链接</em>：<a href="https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html</a></p>
<p>2023/02/16</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="设计表的null值问题">设计表的NULL值问题<a href="https://jachen99.github.io/blog/product-management-system#%E8%AE%BE%E8%AE%A1%E8%A1%A8%E7%9A%84null%E5%80%BC%E9%97%AE%E9%A2%98" class="hash-link" aria-label="设计表的NULL值问题的直接链接" title="设计表的NULL值问题的直接链接">​</a></h2>
<p>1、字段不添加null  都是not null，默认值</p>
<p><img decoding="async" loading="lazy" alt="image-20230222093720407" src="https://jachen99.github.io/assets/images/image-20230222093720407-7ffbef4dda48f5ec8896c86307b97bf1.png" width="960" height="93" class="img_ev3q"></p>
<p>2、把字段都设置为not null ，添加特殊字段，把数据存储j为JSON格式  </p>
<p>2023/02/18</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关联查询优化">关联查询优化<a href="https://jachen99.github.io/blog/product-management-system#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96" class="hash-link" aria-label="关联查询优化的直接链接" title="关联查询优化的直接链接">​</a></h2>
<p>1、保证被驱动表的JOIN字段已经创建了索引
2、需要JOIN 的字段，数据类型保持绝对一致。
3、LEFT JOIN 时，选择小表作为驱动表，大表作为被驱动表 。减少外层循环的次数。
4、INNER JOIN 时，MySQL会自动将小结果集的表选为驱动表 。选择相信MySQL优化策略。
5、能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)
6、不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。
7、衍生表建不了索引</p>
<p>2023/02/19</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="子查询优化">子查询优化<a href="https://jachen99.github.io/blog/product-management-system#%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96" class="hash-link" aria-label="子查询优化的直接链接" title="子查询优化的直接链接">​</a></h2>
<p>使用连接（JOIN）查询来替代子查询。**连接查询不需要建立临时表 ，其速度比子查询 要快 ，如果查询中使用索引的话，性能就会更好.
例如：尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
<p>2023/02/22</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据库表设计">数据库表设计<a href="https://jachen99.github.io/blog/product-management-system#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1" class="hash-link" aria-label="数据库表设计的直接链接" title="数据库表设计的直接链接">​</a></h2>
<ul>
<li>字段长度：能使用int就不要使用varchar、char，能用varchar(16)就不要使用varchar(256)</li>
<li>字段选择：固定长度的类型最好使用char,能使用tinyinti就不要使用int</li>
<li>默认值：最好给每个字段个默认值，最好不能为null,即not null default</li>
<li>适当索引：为每个表创建合理的索引，如唯一索引组合索引的场景以及普通索引的场景</li>
</ul>
<p>2023/02/28</p>
<hr><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="数据库" term="数据库"/>
        <category label="MySQL" term="MySQL"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[深入探究mysql8.x去掉CachesBuffers原因]]></title>
        <id>https://jachen99.github.io/blog/mysql-CachesBuffers-reason</id>
        <link href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason"/>
        <updated>2023-02-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景：我们通常理解的mysql5.7过渡到8.0是由于查询缓存很鸡肋，要保证每次查询都是相同的sql查询语句，命中率自然会很低。但是真的只是因为这个原因吗？那么我要是在高并发下请求同一sql的场景这显然也是存在的，那为什么还要去掉这层缓存呢？]]></summary>
        <content type="html"><![CDATA[<div style="position:relative;padding-bottom:56px"><p><strong>背景</strong>：<em>我们通常理解的mysql5.7过渡到8.0是由于查询缓存很鸡肋，要保证每次查询都是相同的sql查询语句，命中率自然会很低。但是真的只是因为这个原因吗？那么我要是在高并发下请求同一sql的场景这显然也是存在的，那为什么还要去掉这层缓存呢？</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="官方描述">官方描述<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E5%AE%98%E6%96%B9%E6%8F%8F%E8%BF%B0" class="hash-link" aria-label="官方描述的直接链接" title="官方描述的直接链接">​</a></h2>
<p>MySQL 8.0 在缓存方面也进行了一些改变，以下是一些主要变化：</p>
<ol>
<li>自适应哈希索引：MySQL 8.0 引入了自适应哈希索引，用于在内存中缓存查询结果。这种索引可以根据查询的频率和模式自动调整大小，从而提高查询性能。</li>
<li>持久化内存引擎：MySQL 8.0 引入了 InnoDB 持久化内存引擎，这是一种将数据存储在内存中的引擎。与传统的内存引擎不同，持久化内存引擎可以将数据持久化到磁盘上，以避免数据丢失。</li>
<li>更好的查询缓存：MySQL 8.0 引入了更好的查询缓存机制，用于缓存查询结果。与之前的版本不同，MySQL 8.0 不再使用全局查询缓存，而是改为使用基于查询语句的缓存。</li>
<li>更好的内存管理：MySQL 8.0 改进了内存管理，使得内存使用更加高效。这包括改进了内存分配器、提供了更好的内存监控和警告功能等。</li>
</ol>
<p>其中第三点提到了 MySQL 8.0 引入了更好的查询缓存机制，用于缓存查询结果，这与之前的版本不同，MySQL 8.0 不再使用全局查询缓存，而是改为使用基于查询语句的缓存。这里我们具体展开来看看这个变化。</p>
<p>在之前的 MySQL 版本中，查询缓存是一种可用于缓存 SELECT 语句的结果集的机制。这个机制通过在内存中缓存查询结果集，以便在以后执行相同的查询时可以直接从缓存中读取结果集，而无需执行查询。这种机制可以大大提高查询性能，特别是在有大量重复查询的情况下。</p>
<p>然而，MySQL 8.0 中的查询缓存与之前版本不同，它不再使用全局查询缓存，而是改为使用基于查询语句的缓存。具体来说，每个查询都会被单独缓存，并且只有相同的查询（包括查询语句和参数）才能从缓存中获取结果集。这种机制可以避免之前版本中遇到的一些问题，比如全局查询缓存锁和内存分配问题。</p>
<p>另外，MySQL 8.0 还支持对查询缓存进行更细粒度的控制，包括可以对某些查询禁用查询缓存，可以在查询语句中指定查询结果集是否需要被缓存等。</p>
<p>虽然 MySQL 8.0 引入了基于查询语句的缓存机制，但是需要注意的是，查询缓存并不总是对性能有益。对于一些查询频率低、数据更新频繁的情况，缓存可能会浪费内存，而不是提高性能。因此，需要根据具体情况来评估是否使用查询缓存。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="探究去掉查询缓存的原因">探究去掉查询缓存的原因<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E6%8E%A2%E7%A9%B6%E5%8E%BB%E6%8E%89%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E7%9A%84%E5%8E%9F%E5%9B%A0" class="hash-link" aria-label="探究去掉查询缓存的原因的直接链接" title="探究去掉查询缓存的原因的直接链接">​</a></h2>
<p>我们先来看看mysql5.7服务端获取客户端请求的基本流程，查询缓存是在解析与优化模块的开始位置，也就意味着它是以全局查询缓存存在的，那么这样有什么弊端呢？它能否保证高并发写的读写一致呢？</p>
<p><img decoding="async" loading="lazy" alt="image-20230220191808225" src="https://jachen99.github.io/assets/images/image-20230220191808225-16977303370541-e4f464f4dacbee7a54fc6a8bfd0161ac.png" width="1597" height="1155" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="管理策略层面的缺失">管理策略层面的缺失<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5%E5%B1%82%E9%9D%A2%E7%9A%84%E7%BC%BA%E5%A4%B1" class="hash-link" aria-label="管理策略层面的缺失的直接链接" title="管理策略层面的缺失的直接链接">​</a></h3>
<p>在高并发下查询同一个sql语句select *from user where id = 1;那么存在查询缓存的确可以提高查询的效率，这是我们普遍认为的正常情况。但是在不正常的情况下是会出大问题的，如果我们已经在内存中的数据在磁盘中进行了update修改，我们就必须要使我们缓存中的数据更新，保证数据的一致性，<strong>但是在mysql5.7中，对内存是没有管理策略的，内存中数据的生效、失效、过期都没有进行标记</strong>。那么如果不能保证缓存数据的一致性就会查到脏数据，如果我们是在对数据一致性要求不高的场景下的程序，那么使用查询缓存是不影响的，总不能正在玩着游戏，你停机游戏对数据进行更新？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="底层有完善的缓存机制">底层有完善的缓存机制<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E5%BA%95%E5%B1%82%E6%9C%89%E5%AE%8C%E5%96%84%E7%9A%84%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6" class="hash-link" aria-label="底层有完善的缓存机制的直接链接" title="底层有完善的缓存机制的直接链接">​</a></h3>
<p>我们的排序，大数据量的查找，order by ，join操作等，join是左表去匹配右表，左表拿出一行数据到右表一一对比，这个比的过程是绝对不会从磁盘中一一拿出来比的，它底层会把数据加载到内存的缓冲区<strong>buffer</strong>中，再进行比较。</p>
<p>处理连接的瓶颈中并发连接数会有限制，比如500个线程，虽然它从缓存内存中取很快，但是对于select语句，只要做好优化，比如创建好索引，在磁盘中取也是不慢的，而且mysql底层的磁盘是有机的组合的，并且在高频的访问中，它也会有读buffer，甚至还存在写buffer，如果读buffer中的数据没有被修改，它每次也是在内存中读的，也不会在磁盘中读，所以就没必要再加查询缓存了。</p>
<p><img decoding="async" loading="lazy" alt="image-20230220200748912" src="https://jachen99.github.io/assets/images/image-20230220200748912-16977303462983-d6a6d16affe653b8e9f493d7d75b6282.png" width="1115" height="815" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查询缓存容量小存在瓶颈且命中率也很低">查询缓存容量小，存在瓶颈，且命中率也很低<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E5%AE%B9%E9%87%8F%E5%B0%8F%E5%AD%98%E5%9C%A8%E7%93%B6%E9%A2%88%E4%B8%94%E5%91%BD%E4%B8%AD%E7%8E%87%E4%B9%9F%E5%BE%88%E4%BD%8E" class="hash-link" aria-label="查询缓存容量小，存在瓶颈，且命中率也很低的直接链接" title="查询缓存容量小，存在瓶颈，且命中率也很低的直接链接">​</a></h3>
<p>这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等 。只有相同的SQL语句才会命中查询缓存。两个查询请求在任何字符上的不同（例如：空格、注释、大小写），都会导致缓存不会命中。在两条查询之间 有 INSERT 、 UPDATE 、 DELETE 、 TRUNCATE TABLE 、 ALTER TABLE 、 DROP TABLE 或 DROP DATABASE 语句也会导致缓存失效，所以在MySQL 8之后就抛弃了这个功能。</p>
<p>如果一张表中有8000万条数据，查询缓存显然就会力不从心，如果只存热点数据呢？即便是使用lru算法，我们也无法确定已经存在mysql的缓存数据，即便我们缓存了10w条数据，但是我们不知道是8000w条中的哪一个，就会发生缓存穿透，无法命中。加缓存集群更是无从谈起，所以mysql8.0就直接废弃了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="替代方案">替代方案<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" class="hash-link" aria-label="替代方案的直接链接" title="替代方案的直接链接">​</a></h2>
<p>应用层组织缓存，最简单的是使用redis,ehcached等</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="https://jachen99.github.io/blog/mysql-CachesBuffers-reason#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>缓存的意义在于快速查询提升系统性能，可以灵活控制缓存的一致性
8.0之前让DBA一直禁用的mysql缓存的限制：</p>
<ol>
<li>MySQL基本没有手段灵活的管理缓存失效和生效，尤其对于频繁更新的表；</li>
<li>SQL必须完全一致才会导致cache命中；</li>
<li>为了节省内存空间，太大的result set不会被cache(query_cache_limit)；</li>
<li>MySQL缓存在分库分表环境下是不起作用的；</li>
<li>执行SQL里有触发器，自定义函数时，MySQL缓存也是不起作用的；</li>
<li>在表的结构或数据发生改变时，基于该表相关cache.立即全部失效。</li>
</ol><div style="position:absolute;right:0.5em;bottom:0.5em;background:rgba(255,255,255,0.85);border-radius:16px;padding:6px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-size:0.95em;color:var(--ifm-color-primary);min-width:90px;display:flex;align-items:center;justify-content:flex-end;pointer-events:auto"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg><span style="font-size:0.95em">浏览量：<b id="busuanzi_value_page_views" style="margin-left:2px;font-weight:500;font-size:1em">加载中...</b></span></div></div>]]></content>
        <author>
            <name>季冠臣</name>
            <uri>https://github.com/jachen99</uri>
        </author>
        <category label="MySQL" term="MySQL"/>
    </entry>
</feed>
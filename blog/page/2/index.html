<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.1">
<title data-rh="true">我的个人博客 | 软件一班季同学的世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jachen99.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jachen99.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jachen99.github.io/blog/page/2"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="keywords" content="个人博客, 技术分享, Java, Spring, Redis, ES, Docusaurus"><meta data-rh="true" property="og:title" content="我的个人博客 | 软件一班季同学的世界"><meta data-rh="true" name="description" content="分享技术心得与生活记录。"><meta data-rh="true" property="og:description" content="分享技术心得与生活记录。"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jachen99.github.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://jachen99.github.io/blog/page/2" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://jachen99.github.io/blog/page/2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://R5YDTJ851V-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://jachen99.github.io/blog/page/2","mainEntityOfPage":"https://jachen99.github.io/blog/page/2","headline":"我的个人博客","description":"分享技术心得与生活记录。","blogPost":[{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid","mainEntityOfPage":"https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid","url":"https://jachen99.github.io/blog/product-security-system-exit-jwt-invalid","headline":"安全功能之系统退出后JWT令牌失效","name":"安全功能之系统退出后JWT令牌失效","description":"教程：如何解决JWT(JSON Web Token)在用户登出后依然有效带来的安全风险。本文讲解通过Redis构建JWT黑名单，在用户退出时立即让令牌失效的双层安全机制，并提供Java核心代码示例。","datePublished":"2024-04-10T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-security-testing-problems","mainEntityOfPage":"https://jachen99.github.io/blog/product-security-testing-problems","url":"https://jachen99.github.io/blog/product-security-testing-problems","headline":"第三方测试-系统安全测试问题之数据加密","name":"第三方测试-系统安全测试问题之数据加密","description":"现在国内越来越重视系统安全，最近我们公司在做第三方测试过程中对系统安全、系统性能等做出了严格的要求，并进行了很大的整改，就从这篇文章开始总结一下最近三个月以及以后还会继续整改的涉及系统安全的相关测试漏洞的修改方案，相信这些问题会帮助到大家，尤其是比较大型的政府项目，对系统安全更加注重。","datePublished":"2024-03-01T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/data-encryption-in-security-testing","mainEntityOfPage":"https://jachen99.github.io/blog/data-encryption-in-security-testing","url":"https://jachen99.github.io/blog/data-encryption-in-security-testing","headline":"第三方测试-系统安全测试问题之数据加密","name":"第三方测试-系统安全测试问题之数据加密","description":"","datePublished":"2024-03-01T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-xxl-job","mainEntityOfPage":"https://jachen99.github.io/blog/product-xxl-job","url":"https://jachen99.github.io/blog/product-xxl-job","headline":"xxl-job分布式调度实践","name":"xxl-job分布式调度实践","description":"起因：传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。","datePublished":"2024-02-14T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy","mainEntityOfPage":"https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy","url":"https://jachen99.github.io/blog/product-optimization-jdbc-time-range-sharding-strategy","headline":"时间范围分表策略的实现与优化","name":"时间范围分表策略的实现与优化","description":"详解如何使用Sharding-JDBC实现按时间范围（年月）的数据库分表策略。本文提供基于`RangeShardingAlgorithm`的完整Java分片算法代码，解决大数据量下的查询性能与数据管理难题。","datePublished":"2023-10-07T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-logic-delete","mainEntityOfPage":"https://jachen99.github.io/blog/product-logic-delete","url":"https://jachen99.github.io/blog/product-logic-delete","headline":"MongoDB实现逻辑删除","name":"MongoDB实现逻辑删除","description":"背景：我们对MongoDB采用的逻辑删除的方案，与MySQL完全不同。 得益于MongoDB擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若MySQL采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。","datePublished":"2023-06-28T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-easyexcel","mainEntityOfPage":"https://jachen99.github.io/blog/product-easyexcel","url":"https://jachen99.github.io/blog/product-easyexcel","headline":"实用框架EasyExcel","name":"实用框架EasyExcel","description":"背景：EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等","datePublished":"2023-04-20T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-spring-security-microservices","mainEntityOfPage":"https://jachen99.github.io/blog/product-spring-security-microservices","url":"https://jachen99.github.io/blog/product-spring-security-microservices","headline":"spring-security整合微服务实践","name":"spring-security整合微服务实践","description":"起因：随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。","datePublished":"2023-03-15T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-management-system","mainEntityOfPage":"https://jachen99.github.io/blog/product-management-system","url":"https://jachen99.github.io/blog/product-management-system","headline":"SQL优化积累笔记","name":"SQL优化积累笔记","description":"背景：因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去。","datePublished":"2023-03-02T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/mysql-CachesBuffers-reason","mainEntityOfPage":"https://jachen99.github.io/blog/mysql-CachesBuffers-reason","url":"https://jachen99.github.io/blog/mysql-CachesBuffers-reason","headline":"深入探究mysql8.x去掉CachesBuffers原因","name":"深入探究mysql8.x去掉CachesBuffers原因","description":"背景：我们通常理解的mysql5.7过渡到8.0是由于查询缓存很鸡肋，要保证每次查询都是相同的sql查询语句，命中率自然会很低。但是真的只是因为这个原因吗？那么我要是在高并发下请求同一sql的场景这显然也是存在的，那为什么还要去掉这层缓存呢？","datePublished":"2023-02-20T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="软件一班季同学的世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="软件一班季同学的世界 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="软件一班季同学的世界" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.02845d9e.css">
<script src="/assets/js/runtime~main.e9f1333c.js" defer="defer"></script>
<script src="/assets/js/main.44f23ff0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">我的空间</b></a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a class="navbar__item navbar__link" href="/docs/category/开源项目">随笔</a><a class="navbar__item navbar__link" href="/blog/tags">博客</a><a href="https://github.com/Jachen99/Jachen99.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_brwN thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_r4Q1 margin-bottom--md">近期文章</div><div role="group"><h3 class="yearGroupHeading_hiiw">2025</h3><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/simple-seo-for-tech-blog">不花钱，给技术博客做点简单的SEO</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/es-advanced-syntax-and-sharding-strategy">Elasticsearch的高阶语法与分片策略：从概念到实战</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_hiiw">2024</h3><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/product-docs-oss-integration">BI可视化平台集成OSS</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/product-tree-structure-construction">使用Java8新特性构建树形结构：灵活的父子节点关系处理</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/springboot-jasypt-nacos-config-encryption">SpringBoot集成Jasypt实现Nacos配置加密与解密</a></li></ul></div><div class="sidebarItemTitle_r4Q1 margin-bottom--md margin-top--md"><a href="/blog/archive">文章归档</a></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-security-system-exit-jwt-invalid">安全功能之系统退出后JWT令牌失效</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-04-10T00:00:00.000Z">2024年4月10日</time> · <!-- -->阅读需 0 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于安全相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/secure">安全</a></li><li class="tag_QGVx"><a title="关于Java相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">Java</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-security-testing-problems">第三方测试-系统安全测试问题之数据加密</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-01T00:00:00.000Z">2024年3月1日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>现在国内越来越重视系统安全，最近我们公司在做第三方测试过程中对系统安全、系统性能等做出了严格的要求，并进行了很大的整改，就从这篇文章开始总结一下最近三个月以及以后还会继续整改的涉及系统安全的相关测试漏洞的修改方案，相信这些问题会帮助到大家，尤其是比较大型的政府项目，对系统安全更加注重。</p>
<p><em>在互联网和新兴技术高速发展的今天，数据信息充斥在各行各业中，并发挥着重要的作用。然而，在享受信息化时代带来便利的同时，数据安全问题也成为大家关注的焦点。无论是从toG、toB、toC的各业务场景来看，还是从网络安全（CyberSecurity）的架构来看，数据安全（DataSecurity）都是一个主要的组成部分，而且在新兴技术日新月异的数据时代变得越来越重要，范围也越来越大。</em>
------- <em>引自 《数据安全架构设计与实战》</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="安全架构5a方法论"><strong>安全架构5A方法论</strong><a href="#安全架构5a方法论" class="hash-link" aria-label="安全架构5a方法论的直接链接" title="安全架构5a方法论的直接链接">​</a></h2>
<p>无论是进行产品的安全架构设计或评估，还是规划安全技术体系架构的时候，都有几个需要重点关注的逻辑模块，它们可以在逻辑上视为安全架构的核心元素。
以应用/产品为例，核心元素包括：
■ 身份认证（Authentication）：用户主体是谁？
■ 授权（Authorization）：授予某些用户主体允许或拒绝访问客体的权限。
■ 访问控制（Access Control）：控制措施以及是否放行的执行者。
■ 可审计（Auditable）：形成可供追溯的操作日志。
■ 资产保护（Asset Protection）：资产的保密性、完整性、可用性保障</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于数据安全方面"><strong>关于数据安全方面</strong><a href="#关于数据安全方面" class="hash-link" aria-label="关于数据安全方面的直接链接" title="关于数据安全方面的直接链接">​</a></h2>
<p>我们在测试过程中涉及到了对数据传输加密、数据存储加密、对称加密、非对称加密、SM2、SM3、SM4国密加密，CA证书等等</p>
<p><em><strong>什么是非对称加密呢？</strong></em></p>
<p>非对称加密是一种密码学技术，与传统的对称加密不同，它使用一对密钥来进行加密和解密操作，这对密钥分别称为公钥和私钥。这两个密钥是数学上相关联的，但却不能通过已知一个密钥来轻松地推导出另一个密钥。</p>
<p>我们可以想象一下，就像你有一把锁和一把钥匙，任何人都可以得到这把锁，但只有你有这把唯一的钥匙。任何人都可以使用这把锁将信息锁住，但只有你能够使用你的独特的钥匙来解锁这个信息。</p>
<ul>
<li>公钥： 就像是一个开放的锁，任何人都可以获得。它用于加密信息，只有拥有与之相关的私钥的人才能解密。</li>
<li>私钥： 这是与公钥相关联的唯一的解锁密钥，只有密钥的拥有者才能解密用公钥加密的信息。</li>
</ul>
<p>举例来说，考虑用户密码的存储问题。通过非对称加密的方式，可以将用户密码加密后写入数据库。当用户再次登录时，系统将客户端输入的明文密码使用相同的非对称加密方式加密，然后与数据库中的密文进行比对。这样的设计大大提高了安全性，即使数据库被攻击，攻击者也无法轻松获取用户的明文密码。
国密SM2加密方式就是非对称加密的。下面是国密SM2加密工具的源码：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/*椭圆曲线非对称加密算法*/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class SM2Util {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String key_pubk= &quot;pub&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String key_prik= &quot;pri&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static SM2 sm2 = SM2.instance();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	private static final String DEFAULT_PRIVATE_KEY = &quot;27cd96b1500f8330fc523e7c47ef02a&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	private static final String DEFAULT_PUBLIC_KEY = &quot;047ec86bb18f57714e6c5c72383c5b122&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 * 生成公私钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static Map&lt;String,String&gt; generateKeyPair() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Map&lt;String,String&gt; result = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        AsymmetricCipherKeyPair key = sm2.eccKeyPairGenerator.generateKeyPair();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BigInteger privateKey = ((ECPrivateKeyParameters)key.getPrivate()).getD();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ECPoint publicKey = ((ECPublicKeyParameters)key.getPublic()).getQ();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String pubk = new String(Hex.encode(publicKey.getEncoded(false)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String prik = new String(Hex.encode(privateKey.toByteArray()), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result.put(key_pubk, pubk);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result.put(key_prik, prik);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取默认公钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String getDefaultPublicKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return DEFAULT_PUBLIC_KEY;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 获取默认私钥</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String getDefaultPrivateKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return DEFAULT_PRIVATE_KEY;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encrypt(String data, byte[] publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	if (StringUtils.isBlank(data)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    		return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	SM2Cipher cipher = new SM2Cipher();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	// C1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	byte[] c1Bytes = new byte[65];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	ECPoint c1 = cipher.encryptInit(sm2, sm2.eccCurve.decodePoint(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	c1Bytes = c1.getEncoded(false);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c2Bytes = data.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.encrypt(c2Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c3Bytes = new byte[32];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.doFinal(c3Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] encryptData = new byte[c1Bytes.length + c2Bytes.length + c3Bytes.length];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c1Bytes, 0, encryptData, 0, c1Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c2Bytes, 0, encryptData, c1Bytes.length, c2Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		System.arraycopy(c3Bytes, 0, encryptData, c1Bytes.length + c2Bytes.length, c3Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encryptData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] encrypt(String data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return encrypt(data, HexUtil.hexToByte(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] encrypt(byte[] data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return encrypt(new String(data, StandardCharsets.UTF_8), HexUtil.hexToByte(publicKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encryptToHexString(String data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return HexUtil.byteToHex(encrypt(data, HexUtil.hexToByte(publicKey)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 加密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param publicKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encryptToHexString(byte[] data, String publicKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return HexUtil.byteToHex(encrypt(new String(data, StandardCharsets.UTF_8), HexUtil.hexToByte(publicKey)));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] decrypt(byte[] encryptedData, byte[] privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	if (ArrayUtils.isEmpty(encryptedData)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    		return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	SM2Cipher cipher = new SM2Cipher();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c1Bytes = new byte[65];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, 0, c1Bytes, 0, c1Bytes.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ECPoint c1 = sm2.eccCurve.decodePoint(c1Bytes).normalize();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c3Bytes = new byte[32];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, encryptedData.length - 32, c3Bytes, 0, 32);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // C2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        int c2Len = encryptedData.length - 65 - 32;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] c2Bytes = new byte[c2Len];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.arraycopy(encryptedData, 65, c2Bytes, 0, c2Len);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.decryptInit(new BigInteger(1, privateKey), c1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.decrypt(c2Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.doFinal(c3Bytes);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return c2Bytes;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(byte[] encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return decrypt(encryptedData, HexUtil.hexToByte(privateKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(byte[] encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return new String(decrypt(encryptedData, HexUtil.hexToByte(privateKey)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 解密</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encryptedData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param privateKey</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encryptedData, String privateKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    	return new String(decrypt(Hex.decode(encryptedData), HexUtil.hexToByte(privateKey)), StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此外，CA（Certificate Authority，证书颁发机构）机构通常也使用非对称加密的方式来确保数字证书的安全性。CA机构在数字证书颁发过程中起到了信任的中介角色，其操作基于公钥基础设施（PKI）。</p>
<p>下面是CA机构使用非对称加密的一般流程：</p>
<ol>
<li>证书请求： 实体（通常是个人或组织）向CA机构提交证书请求，请求包括实体的公钥和一些身份信息。</li>
<li>验证身份： CA机构对证书请求中的身份信息进行验证，确保请求者确实拥有所声明的身份。这可  以通过一系列验证步骤来完成。</li>
<li>颁发数字证书： 验证通过后，CA机构使用自己的私钥对实体的公钥和身份信息进行签名，生成数字证书。这个签名过程就是使用非对称加密，其中CA的私钥用于签署证书信息。</li>
<li>证书分发： CA机构将生成的数字证书发送给请求者，同时可以将证书公开发布到公共目录中，以便其他人可以验证证书的真实性。</li>
<li>证书验证： 在通信过程中，当其他人需要验证实体的身份时，他们可以使用CA机构公开的公钥来验证数字证书的签名。如果验证通过，就可以信任该数字证书所附的公钥。</li>
</ol>
<p>非对称加密的优势在于它提供了更高的安全性。即使在公共环境下传输公钥，也无法通过公钥轻松计算出私钥。这使得非对称加密在安全地实现身份验证、数字签名和加密通信等场景中发挥重要作用。</p>
<p><em><strong>相对的，什么是对称加密呢？</strong></em></p>
<p>对称加密是一种加密算法，它使用相同的密钥同时进行数据的加密和解密。这意味着在对称加密中，使用加密和解密操作的相同密钥。对称加密算法在加密和解密的过程中都使用相同的密钥，因此密钥的保管和分发变得至关重要。
我们了解的国密SM4就是采用的对称加密的方式实现的，源码工具如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * （分组密码算法）国密对称加密算法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public abstract class SM4Util {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	static {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Security.addProvider(new BouncyCastleProvider());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static final Charset ENCODING = StandardCharsets.UTF_8;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME = &quot;SM4&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 加密算法/分组加密模式/分组填充方式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME_ECB_PADDING = &quot;SM4/ECB/PKCS5Padding&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String ALGORITHM_NAME_CBC_PADDING = &quot;SM4/CBC/PKCS5Padding&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 128-32位16进制；256-64位16进制</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final int DEFAULT_KEY_SIZE = 128;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String DEFAULT_KEY = &quot;86C63180C2806ED1F47B859DE501215B&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static final String DEFAULT_IV = &quot;8F5CB6272B594B53AD1A2197361378DC&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Cipher generateCipherECB(String algorithmName, int mode, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = Cipher.getInstance(algorithmName, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.init(mode, new SecretKeySpec(key, ALGORITHM_NAME));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Cipher generateCipherCBC(String algorithmName, int mode, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = Cipher.getInstance(algorithmName, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cipher.init(mode, new SecretKeySpec(key, ALGORITHM_NAME), new IvParameterSpec(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String generateKey() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return HexUtil.byteToHex(generateKey(DEFAULT_KEY_SIZE));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] generateKey(int keySize) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        KeyGenerator kg = KeyGenerator.getInstance(ALGORITHM_NAME, BouncyCastleProvider.PROVIDER_NAME);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kg.init(keySize, new SecureRandom());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return kg.generateKey().getEncoded();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encryptECBPadding(byte[] data, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateCipherECB(ALGORITHM_NAME_ECB_PADDING, Cipher.ENCRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher.doFinal(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	protected static byte[] decryptECBPadding(byte[] encrypted, byte[] key) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    Cipher cipher = generateCipherECB(ALGORITHM_NAME_ECB_PADDING, Cipher.DECRYPT_MODE, key);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    return cipher.doFinal(encrypted);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected static byte[] encryptCBCPadding(byte[] data, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Cipher cipher = generateCipherCBC(ALGORITHM_NAME_CBC_PADDING, Cipher.ENCRYPT_MODE, key, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return cipher.doFinal(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	protected static byte[] decryptCBCPadding(byte[] encrypted, byte[] key, byte[] iv) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    Cipher cipher = generateCipherCBC(ALGORITHM_NAME_CBC_PADDING, Cipher.DECRYPT_MODE, key, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	    return cipher.doFinal(encrypted);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source.getBytes(ENCODING), hexKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherArray;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			cipherArray = encryptECBPadding(source, ByteUtils.fromHexString(hexKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return ByteUtils.toHexString(cipherArray);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return decrypt(encrypted, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return decryptToString(encrypted, DEFAULT_KEY);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return new String(decrypt(encrypted, hexKey), ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted, String hexKey) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return decryptECBPadding(ByteUtils.fromHexString(encrypted), ByteUtils.fromHexString(hexKey));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return encrypted.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(String source, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encrypt(source.getBytes(ENCODING), hexKey, iv);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String encrypt(byte[] source, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] cipherArray;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			cipherArray = encryptCBCPadding(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							source</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							, ByteUtils.fromHexString(hexKey)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">							, ByteUtils.fromHexString(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return ByteUtils.toHexString(cipherArray);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			throw new RuntimeException(&quot;数据加密失败&quot;, e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static String decryptToString(String encrypted, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return new String(decrypt(encrypted, hexKey, iv), ENCODING);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static byte[] decrypt(String encrypted, String hexKey, String iv) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			if (StringUtils.isBlank(encrypted)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				return new byte[] {};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			return decryptCBCPadding(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				 	ByteUtils.fromHexString(encrypted)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">					, ByteUtils.fromHexString(hexKey)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">					, ByteUtils.fromHexString(iv));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		} catch (Exception e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			log.error(e.getMessage(), e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		return encrypted.getBytes(StandardCharsets.UTF_8);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em><strong>相信你也一定听过国密SM3算法，它是对称加密还是非对称加密呢？</strong></em>
其实SM3是一种密码杂凑算法，用于生成消息的哈希值，主要用于数据完整性验证、数字签名等场景，而不是进行加密和解密操作。所以它既不是对称加密也不是非对称加密，它常常与SM2与SM4组合一起使用，可以把它看成一个随机数。
<em>例如：</em>
系统数据存储加密应采用SM3+SM4的实现方式。
系统数据传输加密应采用SM2+SM3的实现方式。</p>
<p><strong>总结</strong>
在系统安全测试中，我们通过采用多层加密算法、合理的安全架构设计以及严格的数据安全措施，提高了系统在身份认证、授权、访问控制、审计和资产保护等方面的安全性。这有助于在互联网和新兴技术时代中更好地处理数据安全问题，特别适用于大型政府项目等对安全性要求较高的场景。数据安全相关的知识属于另一个领域了， 知识点真是深不可测，还需要平时多学习，积累更多的知识储备才行。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/安全">安全</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/data-encryption-in-security-testing">第三方测试-系统安全测试问题之数据加密</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-01T00:00:00.000Z">2024年3月1日</time> · <!-- -->阅读需 0 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于安全相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/secure">安全</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-xxl-job">xxl-job分布式调度实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-02-14T00:00:00.000Z">2024年2月14日</time> · <!-- -->阅读需 16 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>起因</strong>：<em>传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="#技术选型" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官方文档">官方文档<a href="#官方文档" class="hash-link" aria-label="官方文档的直接链接" title="官方文档的直接链接">​</a></h3>
<p>xxl-job：<a href="https://github.com/xuxueli/xxl-job" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job</a></p>
<p>elastic-job：<a href="https://shardingsphere.apache.org/elasticjob/" target="_blank" rel="noopener noreferrer">https://shardingsphere.apache.org/elasticjob/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job-与--elastic-job对比图">XXL-JOB 与  elastic-job对比图<a href="#xxl-job-与--elastic-job对比图" class="hash-link" aria-label="XXL-JOB 与  elastic-job对比图的直接链接" title="XXL-JOB 与  elastic-job对比图的直接链接">​</a></h3>
<table><thead><tr><th>对比项</th><th>XXL-JOB</th><th>elastic-job</th></tr></thead><tbody><tr><td>并行调度</td><td>调度系统多线程并行</td><td>任务分片的方式并行</td></tr><tr><td>弹性扩容</td><td>使用Quartz基于数据库分布式功能</td><td>通过zookeeper保证</td></tr><tr><td>高可用</td><td>通过DB锁保证</td><td>通过zookeeper保证</td></tr><tr><td>阻塞策略</td><td>单机串行/丢弃后续的调度/覆盖之前的调度</td><td>执行超过zookeeper的session timeout时间的话，会被清除，重新进行分片</td></tr><tr><td>动态分片策略</td><td>以执行器为维度进行分片、支持动态的扩容</td><td>平均分配/作业名hash分配/自定义策略</td></tr><tr><td>失败处理策略</td><td>失败告警/失败重试</td><td>执行完毕后主动获取未分配分片任务 服务器下线后主动寻找可以用的服务器执行任务</td></tr><tr><td>监控</td><td>支持</td><td>支持</td></tr><tr><td>日志</td><td>支持</td><td>支持</td></tr></tbody></table>
<ul>
<li>XXL-Job和Elastic-Job都具有广泛的用户基础和完善的技术文档，都可以满足定时任务的基本功能需求</li>
<li>xxl-job侧重在业务实现简单和管理方便，容易学习，失败与路由策略丰富, 推荐使用在用户基数相对较少，服务器的数量在一定的范围内的场景下使用</li>
<li>elastic-job关注的点在数据，添加了弹性扩容和数据分片的思路，更方便利用分布式服务器的资源, 但是学习难度较大，推荐在数据量庞大，服务器数量多的时候使用</li>
</ul>
<p><em>综合考虑，最后我们选择了xxl-job这一解决方法，下面是一个小demo，用于整合xxl-job到spring微服务项目中得以应用的最佳实践。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是xxl-job">什么是XXL-Job<a href="#什么是xxl-job" class="hash-link" aria-label="什么是XXL-Job的直接链接" title="什么是XXL-Job的直接链接">​</a></h3>
<ul>
<li>XXL-JOB<!-- -->
<ul>
<li>大众  点评的员工徐雪里在15年发布的分布式任务调度平台，是轻量级的分布式任务调度框架，目标是开发迅速、简单、清理、易扩展; 老版本是依赖quartz的定时任务触发，在v2.1.0版本开始 移除quartz依赖</li>
<li>官网地址：<a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener noreferrer">https://www.xuxueli.com/xxl-job/</a></li>
<li>GitHub地址：<a href="https://github.com/xuxueli/xxl-job/" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job/</a></li>
</ul>
</li>
<li>xxl-job的设计思想<!-- -->
<ul>
<li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li>
<li>将任务抽象成分散的JobHandler，交由“执行器”统一管理</li>
<li>“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li>
<li>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官网架构图">官网架构图<a href="#官网架构图" class="hash-link" aria-label="官网架构图的直接链接" title="官网架构图的直接链接">​</a></h3>
<ul>
<li>调度中心<!-- -->
<ul>
<li>负责管理调度的信息，按照调度的配置来发出调度请求</li>
<li>支持可视化、简单的动态管理调度信息，包括新建、删除、更新等，这些操作都会实时生效，同时也支持监控调度结果以及执行日志。</li>
</ul>
</li>
<li>执行器<!-- -->
<ul>
<li>负责接收请求并且执行任务的逻辑。任务模块专注于任务的执行操作等等，使得开发和维护更加的简单与高效</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://file.xdclass.net/note/2022/81-XXL-JOB/img/image-20220519181542821.png" alt="image-20220519181542821" class="img_ev3q"></p>
<ul>
<li>XXL-Job具有哪些特性<!-- -->
<ul>
<li>调度中心HA（中心式）：调度采用了中心式进行设计，“调度中心”支持集群部署，可保证调度中心HA</li>
<li>执行器HA（分布式）：任务分布式的执行，任务执行器支持集群部署，可保证任务执行HA</li>
<li>触发策略：有Cron触发、固定间隔触发、固定延时触发、API事件触发、人工触发、父子任务触发</li>
<li>路由策略：执行器在集群部署的时候提供了丰富的路由策略，如：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用LFU、最久未使用LRU、故障转移等等</li>
<li>故障转移：如果执行器集群的一台机器发生故障，会自动切换到一台正常的执行器发送任务调度</li>
<li>Rolling实时日志的监控：支持rolling方式查看输入的完整执行日志</li>
<li>脚本任务：支持GLUE模式开发和运行脚本任务，包括Shell、python、node.js、php等等类型脚本</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速部署">快速部署<a href="#快速部署" class="hash-link" aria-label="快速部署的直接链接" title="快速部署的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="流程图">流程图：<a href="#流程图" class="hash-link" aria-label="流程图：的直接链接" title="流程图：的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214195315186" src="/assets/images/image-20230214195315186-428690aea674f569b2ab260bae532441.png" width="838" height="707" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境">环境：<a href="#环境" class="hash-link" aria-label="环境：的直接链接" title="环境：的直接链接">​</a></h3>
<p>Maven3+、jdk1.8+、mysql5.7+</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载链接">下载链接：<a href="#下载链接" class="hash-link" aria-label="下载链接：的直接链接" title="下载链接：的直接链接">​</a></h3>
<p><a href="https://github.com/xuxueli/xxl-job.git" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job.git</a>  版本：2.3.0</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="运行数据库脚本">运行数据库脚本<a href="#运行数据库脚本" class="hash-link" aria-label="运行数据库脚本的直接链接" title="运行数据库脚本的直接链接">​</a></h3>
<p><code>/xxl-job/doc/db/tables_xxl_job.sql</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调度中心">调度中心<a href="#调度中心" class="hash-link" aria-label="调度中心的直接链接" title="调度中心的直接链接">​</a></h3>
<p><code>调度中心项目：xxl-job-admin</code> 修改该模块下的配置文件并启动server</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">### web</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server.port=8080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server.servlet.context-path=/xxl-job-admin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### xxl-job, datasource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.username=root</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.password=123456</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### xxl-job, access token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">xxl.job.accessToken=jiguanchen.space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ui界面">UI界面<a href="#ui界面" class="hash-link" aria-label="UI界面的直接链接" title="UI界面的直接链接">​</a></h3>
<ul>
<li>运行报表<!-- -->
<ul>
<li>以图形化来展示了整体的任务执行情况<!-- -->
<ul>
<li>任务数量：能够看到调度中心运行的任务数量</li>
<li>调度次数：调度中心所触发的调度次数</li>
<li>执行器数量：在整个调度中心中，在线的执行器数量有多少</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214195933783" src="/assets/images/image-20230214195933783-ffa529f61bf3bd47ceee76cee3a5f845.png" width="1920" height="991" class="img_ev3q"></p>
<ul>
<li>任务管理（配置执行任务）<!-- -->
<ul>
<li>示例执行器：所  用到的执行器</li>
<li>任务描述：概述该任务是做什么的</li>
<li>路由策略：<!-- -->
<ul>
<li>第一个：选择第一个机器</li>
<li>最后一个：选择最后一个机器</li>
<li>轮询：依次选择执行</li>
<li>随机：随机选择在线的机器</li>
<li>一致性HASH：每个任务按照Hash算法固定选择某一台机器，并且所有的任务均匀散列在不同的机器上</li>
<li>最不经常使用：使用频率最低的机器优先被使用</li>
<li>最近最久未使用：最久未使用的机器优先被选举</li>
<li>故障转移：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标的执行器并且会发起任务调度</li>
<li>忙碌转移：按照顺序来依次进行空闲检测，第一个空闲检测成功的机器会被选定为目标群机器，并且会发起任务调度</li>
<li>分片广播：广播触发对于集群中的所有机器执行任务，同时会系统会自动传递分片的参数</li>
</ul>
</li>
<li>Cron：执行规则</li>
<li>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等</li>
<li>JobHandler：定义执行器的名字</li>
<li>阻塞处理策略：<!-- -->
<ul>
<li>单机串行：新的调度任务在进入到执行器之后，该调度任务进入FIFO队列，并以串行的方式去进行</li>
<li>丢弃后续调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，本次的调度任务请求就会被丢弃掉，并且标记为失败</li>
<li>覆盖之前的调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，就会终止掉当前正在运行的调度任务，并且清空队列，运行新的调度任务。</li>
</ul>
</li>
<li>子任务ID：输入子任务的任务id，可填写多个</li>
<li>任务超时时间：添加任务超时的时候，单位s，设置时间大于0的时候就会生效</li>
<li>失败 重试次数：设置失败重试的次数，设置时间大于0的时候就会生效</li>
<li>负责人：填写该任务调度的负责人</li>
<li>报警邮件：出现报警，则发送邮件</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214200224214" src="/assets/images/image-20230214200224214-886206b0dd0a466984fc0206dfe6f442.png" width="1603" height="484" class="img_ev3q"></p>
<p>创建任务：</p>
<p><img decoding="async" loading="lazy" alt="image-20230214200338357" src="/assets/images/image-20230214200338357-198452a996e4e5e0853b5b555a1bdabd.png" width="1207" height="874" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后台服务整合xxl-job">后台服务整合xxl-job<a href="#后台服务整合xxl-job" class="hash-link" aria-label="后台服务整合xxl-job的直接链接" title="后台服务整合xxl-job的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="yml配置">yml配置<a href="#yml配置" class="hash-link" aria-label="yml配置的直接链接" title="yml配置的直接链接">​</a></h3>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#  xxl-job任务调度配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">addresses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin  </span><span class="token comment" style="color:rgb(98, 114, 164)">#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">accessToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> jiguanchen.space  </span><span class="token comment" style="color:rgb(98, 114, 164)">#执行器token，非空时启用 xxl-job, access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">executor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">appname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yygh</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">order  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器app名称,和控制台那边配置一样的名称，不然注册不上去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">6666</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">logpath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./data/logs/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job/executor  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器日志文件存储路径，需要对该路径拥有读写权限；为空则使用默认路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">logretentiondays</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 执行器日志保存天数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># [选填]执行器IP ：默认为空表示自动获取IP（即springboot容器的ip和端口，可以自动获取，也可以指定），</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># 多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># [选填]执行器注册：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加pom文件">添加pom文件<a href="#添加pom文件" class="hash-link" aria-label="添加pom文件的直接链接" title="添加pom文件的直接链接">​</a></h3>
<div class="language-pom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-pom codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;!-- xxl_job分布式调度 --&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &lt;version&gt;2.3.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加config配置类">添加config配置类<a href="#添加config配置类" class="hash-link" aria-label="添加config配置类的直接链接" title="添加config配置类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2023/2/14 15:46</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class XxlJobConfig {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.admin.addresses}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String adminAddresses;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.executor.appname}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String appName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.executor.ip}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String ip;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.executor.port}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int port;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.accessToken}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String accessToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.executor.logpath}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String logPath;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Value(&quot;${xxl.job.executor.logretentiondays}&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int logRetentionDays;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public XxlJobSpringExecutor xxlJobExecutor() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAppname(appName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setIp(ip);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setPort(port);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setLogPath(logPath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return xxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>添加hander处理器</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.handler;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2024/2/14 15:53</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MyJobHandler {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RabbitService rabbitService;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private OrderInfoMapper orderInfoMapper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 就诊提醒的handler方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param param  null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return  ReturnT&lt;String&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @XxlJob(value = &quot;demoJobHandler1&quot;,init = &quot;init&quot;,destroy = &quot;destroy&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public ReturnT&lt;String&gt; execute(String param){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;execute方法执行了 ====》 &quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取查询的时间</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        DateTime dateTime = new DateTime().plusDays(1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String dateString = dateTime.toString(&quot;yyyy-MM-dd&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Date date = new DateTime(dateString).toDate();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = new LambdaQueryWrapper&lt;OrderInfo&gt;(){{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            eq(OrderInfo::getReserveDate,date);  // 查询就诊日期</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ne(OrderInfo::getOrderStatus, OrderStatusEnum.CANCLE.getStatus());  // 查询没有取消的订单</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;OrderInfo&gt; orderInfoList = orderInfoMapper.selectList(queryWrapper);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for(OrderInfo orderInfo : orderInfoList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 短信提示</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            MsmVo msmVo = new MsmVo();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            msmVo.setPhone(orderInfo.getPatientPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 结合mq快速响应其他模块 发送消息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_MSM, MqConst.ROUTING_MSM_ITEM, msmVo);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return ReturnT.SUCCESS;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private void init(){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;MyJobHandler init &gt;&gt;&gt;&gt;&gt; &quot; + true);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String jobParam = XxlJobHelper.getJobParam();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;jobParam = &quot; + jobParam);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="效果图">效果图<a href="#效果图" class="hash-link" aria-label="效果图的直接链接" title="效果图的直接链接">​</a></h3>
<p>完成规则内的定时任务，到指定时间向就诊人发送消息</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201137647" src="/assets/images/image-20230214201137647-78853315d90bec43fb641d44f62ae203.png" width="1498" height="329" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20230214201148157" src="/assets/images/image-20230214201148157-e16f4946aad02ccb28495a972fde1805.png" width="1485" height="258" class="img_ev3q"></p>
<p>调度日志</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201947305" src="/assets/images/image-20230214201947305-25fa330099f9149f279b07395476a6ec.png" width="1601" height="807" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job集群部署和高可用案例配置">XXL-Job集群部署和高可用案例配置<a href="#xxl-job集群部署和高可用案例配置" class="hash-link" aria-label="XXL-Job集群部署和高可用案例配置的直接链接" title="XXL-Job集群部署和高可用案例配置的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群架构图">集群架构图<a href="#集群架构图" class="hash-link" aria-label="集群架构图的直接链接" title="集群架构图的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203111017" src="/assets/images/image-20230214203111017-a88e2f9bec270b41851edadd8e1016ee.png" width="1408" height="733" class="img_ev3q"></p>
<p>执行器配置调度中心集群</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">addresses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">8081/xxl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">job</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job处理海量数据-分片任务实操">XXL-Job处理海量数据-分片任务实操<a href="#xxl-job处理海量数据-分片任务实操" class="hash-link" aria-label="XXL-Job处理海量数据-分片任务实操的直接链接" title="XXL-Job处理海量数据-分片任务实操的直接链接">​</a></h2>
<p>我们的需求：</p>
<ul>
<li>有一个任务需要处理100W条数据，每条数据的业务逻辑处理要0.1s</li>
<li>对于普通任务来说，只有一个线程来处理 可能需要10万秒才能处理完，业务则严重受影响</li>
<li>案例：双十一大促，给1000万用户发营销短信</li>
</ul>
<p>解决思路：</p>
<ul>
<li>如果将100W数据均匀分给集群里的10台机器同时处理，</li>
<li>每台机器耗时，1万秒即可，耗时会大大缩短，也能充分利用集群资源</li>
<li>在xxl-job里，可以配置执行器集群有10个机器，那么分片总数是10，  分片序号0~9 分别对应那10台机器。</li>
<li>分片方式<!-- -->
<ul>
<li>id % 分片总数 余数是0 的，在第1个执行器上执行</li>
<li>id % 分片总数 余数是1 的，在第2个执行器上执行</li>
<li>id % 分片总数 余数是2 的，在第3个执行器上执行</li>
<li>...</li>
<li>id % 分片总数 余数是9 的，在第10个执行器上执行</li>
</ul>
</li>
</ul>
<p>其他解决方式</p>
<ul>
<li>也可以启动多个job，使用同个jobHandler,通过命令行参数控制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="选用分片广播的路由策略实操">选用分片广播的路由策略实操<a href="#选用分片广播的路由策略实操" class="hash-link" aria-label="选用分片广播的路由策略实操的直接链接" title="选用分片广播的路由策略实操的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203833637" src="/assets/images/image-20230214203833637-06704b31c35de3df3a903312bd7add3b.png" width="969" height="297" class="img_ev3q"></p>
<p>主要参数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 分片广播任务	    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 当前分片数，从0开始，即执行器的序号</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int shardIndex = XxlJobHelper.getShardIndex();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//总分片数，执行器集群总机器数量</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int shardTotal = XxlJobHelper.getShardTotal();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 业务逻辑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于Xxl-Job相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/xxl-job">Xxl-Job</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-optimization-jdbc-time-range-sharding-strategy">时间范围分表策略的实现与优化</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-07T00:00:00.000Z">2023年10月7日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>在处理大量数据时，如何高效地存储和查询是我们常面临的挑战。特别是在需要按时间进行统计、分析和展示的数据场景下，数据量往往随着时间的积累而迅速膨胀。为了应对这些挑战，<strong>分表技术</strong>成为了优化查询性能和管理大规模数据的关键手段。</p>
<p>在实际的开发过程中，针对具有时间维度的大数据表，我们通常会采用按时间进行分表的策略。本文将总结如何实现一个基于时间范围的分表策略，并通过具体的技术实现来展示这一策略在实际系统中的应用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分表技术概述">分表技术概述<a href="#分表技术概述" class="hash-link" aria-label="分表技术概述的直接链接" title="分表技术概述的直接链接">​</a></h2>
<p>分表技术是将一个大表拆分成多个小表，以此来提升查询性能和系统的扩展性。常见的分表策略有：</p>
<ul>
<li><strong>水平分表</strong>：根据某个字段（如用户ID、时间等）将数据分散到多个表中。</li>
<li><strong>垂直分表</strong>：将表中的不同字段拆分到多个表中。</li>
</ul>
<p>在水平分表中，时间字段（如年、月、日）是一个常见的分片维度。根据业务需求，数据会被拆分成多个按时间命名的表，查询时通过时间范围来确定要查询的具体分表。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基于时间范围的分表策略">基于时间范围的分表策略<a href="#基于时间范围的分表策略" class="hash-link" aria-label="基于时间范围的分表策略的直接链接" title="基于时间范围的分表策略的直接链接">​</a></h2>
<p>以某个数据表（比如&quot;电力消耗数据&quot;）为例，我们希望根据时间来进行分表，将每个月的数据存储到不同的表中。这种策略不仅可以帮助我们高效地管理大规模的数据，还能在查询时避免对整个表的全表扫描，从而提高性能。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-分表规则设计">1. 分表规则设计<a href="#1-分表规则设计" class="hash-link" aria-label="1. 分表规则设计的直接链接" title="1. 分表规则设计的直接链接">​</a></h3>
<p>假设我们的表名为 <code>electricity_usage_data</code>，我们决定根据月份进行分表。分表规则如下：</p>
<ul>
<li>按月进行分表，表名格式为 <code>electricity_usage_data_yyyyMM</code>，例如：<code>electricity_usage_data_202301</code>、<code>electricity_usage_data_202302</code> 等。</li>
<li>在查询时，依据时间字段（如查询某月的电力数据），动态选择涉及的分表。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-分片算法的实现">2. 分片算法的实现<a href="#2-分片算法的实现" class="hash-link" aria-label="2. 分片算法的实现的直接链接" title="2. 分片算法的实现的直接链接">​</a></h3>
<p>为了实现按时间范围的分表，我们需要实现一个分片算法，这个算法的主要作用是根据查询的时间范围，计算出需要访问的分表。通常，这个算法会根据一个起始时间和结束时间，确定哪些表需要被查询。</p>
<p>例如，假设查询的时间范围是从 <code>2023年01月</code> 到 <code>2023年03月</code>，那么分片算法会返回 <code>electricity_usage_data_202301</code>、<code>electricity_usage_data_202302</code> 和 <code>electricity_usage_data_202303</code> 这三个表。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-实现代码">3. 实现代码<a href="#3-实现代码" class="hash-link" aria-label="3. 实现代码的直接链接" title="3. 实现代码的直接链接">​</a></h3>
<p>下面是一个基于时间范围的分表算法实现示例。我们使用了Sharding-JDBC来实现这一分片策略，具体代码如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MonthRangeShardingAlgorithm implements RangeShardingAlgorithm&lt;String&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public Collection&lt;String&gt; doSharding(Collection&lt;String&gt; collection, RangeShardingValue&lt;String&gt; rangeShardingValue) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Collection&lt;String&gt; result = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; rangeList = getRangeList(rangeShardingValue);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (String tableName : rangeList) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (collection.contains(tableName.toLowerCase()) || collection.contains(tableName.toUpperCase())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                result.add(tableName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (result.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new UnsupportedOperationException(&quot;没有匹配到分片表&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private List&lt;String&gt; getRangeList(RangeShardingValue&lt;String&gt; rangeShardingValue) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;String&gt; rangeList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String logicTableName = rangeShardingValue.getLogicTableName();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        SimpleDateFormat format = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Range&lt;String&gt; valueRange = rangeShardingValue.getValueRange();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Object start = valueRange.lowerEndpoint();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Object end = valueRange.upperEndpoint();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Date startDate = format.parse(start.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Date endDate = format.parse(end.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            DateTime startDateTime = DateUtil.beginOfMonth(startDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            DateTime endDateTime = DateUtil.beginOfMonth(endDate);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            do {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                String time = DateUtil.format(startDateTime, &quot;yyyyMM&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                String tableName = logicTableName.concat(&quot;_&quot;).concat(time);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                rangeList.add(tableName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                startDateTime = DateUtil.offset(startDateTime, DateField.MONTH, 1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } while (startDateTime.compareTo(endDateTime) &lt;= 0);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (ParseException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return rangeList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-分表策略解析">4. 分表策略解析<a href="#4-分表策略解析" class="hash-link" aria-label="4. 分表策略解析的直接链接" title="4. 分表策略解析的直接链接">​</a></h3>
<ul>
<li><strong><code>doSharding</code>方法</strong>：该方法根据输入的时间范围，计算出涉及的所有分表。通过对比表名，筛选出实际需要查询的分表。</li>
<li><strong><code>getRangeList</code>方法</strong>：将查询的起始时间和结束时间进行处理，计算出涉及的所有月份，并生成对应的表名。</li>
<li><strong>时间格式化和处理</strong>：我们使用 <code>SimpleDateFormat</code> 和 <code>DateUtil</code> 进行时间的  格式化和月份的处理。通过 <code>DateUtil.beginOfMonth</code> 获取每个月的第一天，以便统一处理时间范围。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="优化与应用">优化与应用<a href="#优化与应用" class="hash-link" aria-label="优化与应用的直接链接" title="优化与应用的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-动态扩展性">1. 动态扩展性<a href="#1-动态扩展性" class="hash-link" aria-label="1. 动态扩展性的直接链接" title="1. 动态扩展性的直接链接">​</a></h3>
<p>该方案的优势在于其<strong>动态扩展性</strong>。随着数据量的不断增长，新的分表会根据时间自动创建，且查询时会根据实际的时间范围动态计算所需的表，避免了手动干预。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-负载均衡">2. 负载均衡<a href="#2-负载均衡" class="hash-link" aria-label="2. 负载均衡的直接链接" title="2. 负载均衡的直接链接">​</a></h3>
<p>通过将数据分散到多个表中，系统能够更好地进行负载均衡。当某一月份的数据量增大时，可以通过水平扩展（例如增加新的分表）来应对性能瓶颈，而无需对整个表进行迁移或改造。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-查询优化">3. 查询优化<a href="#3-查询优化" class="hash-link" aria-label="3. 查询优化的直接链接" title="3. 查询优化的直接链接">​</a></h3>
<p>按时间范围分表的最大优势在于查询效率的提升。当查询某一时间段的数据时，只需要访问相关的分表，而不是对整个数据表进行扫描，从而大大提升了查询速度。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>基于时间范围的分表策略在大数据量场景下尤其重要，尤其是在电力等需要  处理大量历史数据的行业。通过合理的分表设计，我们可以有效地提升系统性能，优化查询响应时间，确保系统的高可用性和扩展性。这个方案不仅适用于电力行业，也可以广泛应用于任何具有时间维度的大数据场景中。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于Sharding-JDBC相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/sharding-jdbc">Sharding-JDBC</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-logic-delete">MongoDB实现逻辑删除</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-28T00:00:00.000Z">2023年6月28日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>我们对<code>MongoDB</code>采用的逻辑删除的方案，与<code>MySQL</code>完全不同。 得益于<code>MongoDB</code>擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若<code>MySQL</code>采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。</em></p>
<p>举个小demo</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如果改变表字段">如果改变表字段：<a href="#如果改变表字段" class="hash-link" aria-label="如果改变表字段：的直接链接" title="如果改变表字段：的直接链接">​</a></h2>
<p>​		首先导入了 MongoDB 驱动，然后创建了一个 MongoDB 客户端（<code>MongoClient</code>），并连接到了本地的 MongoDB 服务器（&quot;mongodb://localhost:27017&quot;）。通过客户端获取了数据库 &quot;test&quot; 中的集合 &quot;collection&quot;。在逻辑删除代码中，首先通过 ObjectId 创建了一个 ObjectId 对象，其值为 &quot;5f36f47a06c5a722497f37b5&quot;。然后，通过调用 <code>updateOne</code> 方法对该文档进行了逻辑删除操作，即在该文档中添加/更新了一个 &quot;deleted&quot; 字段，该字段的值为 true。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.mongodb</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">mongodb-driver-sync</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">4.0.5</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Updates;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MongoDBLogicDeleteExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = MongoClients.create(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase(&quot;test&quot;).getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ObjectId id = new ObjectId(&quot;5f36f47a06c5a722497f37b5&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.updateOne(Filters.eq(&quot;_id&quot;, id), Updates.set(&quot;deleted&quot;, true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​		然后在查询代码中，通过调用 <code>find</code> 方法查询 &quot;deleted&quot; 字段不等于 true 的文档，即查询未被逻辑删除的文档。然后，将查询结果存入 <code>documents</code> 集合中。最后，通过循环打印出了查询结果中的每一个文档。最后，关闭了 MongoDB 客户端。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class MongoDBQueryExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = MongoClients.create(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase(&quot;test&quot;).getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.find(Filters.ne(&quot;deleted&quot;, true)).into(documents);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="不改变表字段">不改变表字段<a href="#不改变表字段" class="hash-link" aria-label="不改变表字段的直接链接" title="不改变表字段的直接链接">​</a></h2>
<p>如果不想添加字段，可以使用 MongoDB 的另一种实现逻辑删除的方法，即使用软删除。软删除的思想是将文档移动到另一个集合中，而不是真正删除文档。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.MongoClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.mongodb.client.MongoDatabase;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class LogicalDeletionExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoClient mongoClient = new MongoClient(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取数据库</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoDatabase database = mongoClient.getDatabase(&quot;test&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取原始集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; collection = database.getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 获取新集合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        MongoCollection&lt;Document&gt; deletedCollection = database.getCollection(&quot;deleted_collection&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ObjectId id = new ObjectId(&quot;5f36f47a06c5a722497f37b5&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Document deletedDocument = collection.find(new Document(&quot;_id&quot;, id)).first();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        deletedCollection.insertOne(deletedDocument);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.deleteOne(new Document(&quot;_id&quot;, id));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        collection.find().into(documents);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 关闭客户端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码通过将文档移动到新集合中，实现了 MongoDB 的逻辑删除，并且不添加字段。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于数据仓库相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/shujuku">数据库</a></li><li class="tag_QGVx"><a title="关于MongoDB的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/mongodb">MongoDB</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-easyexcel">实用框架EasyExcel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-20T00:00:00.000Z">2023年4月20日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1easyexcel介绍">1、EasyExcel介绍<a href="#1easyexcel介绍" class="hash-link" aria-label="1、EasyExcel介绍的直接链接" title="1、EasyExcel介绍的直接链接">​</a></h2>
<ul>
<li>Java领域解析、生成Excel比较有名的框架有Apache poi、jxl等。但他们都存在一个严重的问题就是非常的耗内存。如果你的系统并发量不大的话可能还行，但是一旦并发上来后一定会OOM或者JVM频繁的full gc。</li>
<li>EasyExcel是阿里巴巴开源的一个excel处理框架，<strong>以使用简单、节省内存著称</strong>。EasyExcel能大大减少占用内存的主要原因是在解析Excel时没有将文件数据一次性全部加载到内存中，而是从磁盘上一行行读取数据，逐个解析。</li>
<li>EasyExcel采用一行一行的解析模式，并将一行的解析结果以观察者的模式通知处理（AnalysisEventListener）</li>
</ul>
<p>文档地址：<a href="https://easyexcel.opensource.alibaba.com" target="_blank" rel="noopener noreferrer">https://easyexcel.opensource.alibaba.com</a></p>
<p>github地址：<a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/easyexcel</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2easyexcel写操作">2、EasyExcel写操作<a href="#2easyexcel写操作" class="hash-link" aria-label="2、EasyExcel写操作的直接链接" title="2、EasyExcel写操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21创建项目">2.1  、创建项目<a href="#21创建项目" class="hash-link" aria-label="2.1、创建项目的直接链接" title="2.1、创建项目的直接链接">​</a></h3>
<p><strong>pom中引入xml相关依赖</strong></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependencies</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">easyexcel</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependencies</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当引入该依赖之后，会发现在项目的依赖文件中同时多出了poi的类库。也就是说，EasyExcel是基于poi来进行实现的，间接地引入了如下依赖：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">poi-ooxml</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22创建实体类">2.2、创建实体类<a href="#22创建实体类" class="hash-link" aria-label="2.2、创建实体类的直接链接" title="2.2、创建实体类的直接链接">​</a></h3>
<p><strong>设置表头和添加的数据字段</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(&quot;学生编号&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(&quot;学生姓名&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>@ExcelProperty：用于设置Excel表头，其中index用户表头的编号，从0开始；value为表头对应的内容。</li>
<li>@DateTimeFormat：用于日期的格式化</li>
</ul>
<p>完成上述功能准备工作之后，我们就可以来生成一个Excel了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-实现写操作">2.3 、实现写操作<a href="#23-实现写操作" class="hash-link" aria-label="2.3 、实现写操作的直接链接" title="2.3 、实现写操作的直接链接">​</a></h3>
<p><strong>（1）创建方法循环设置要添加到Excel的数据</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">//循环设置要添加的数据，最终封装到list集合中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">private static List&lt;Stu&gt; data() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Stu data = new Stu();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data.setSno(i);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data.setSname(&quot;张三&quot;+i);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list.add(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return list;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>（2）实现最终的添加操作</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String fileName = &quot;E:\\11.xlsx&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 如果这里想使用03 则 传入excelType参数即可</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    EasyExcel.write(fileName, Stu.class).sheet(&quot;写入方法一&quot;).doWrite(data());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么我们如何解析Excel呢？接着看....</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3easyexcel读操作">3、EasyExcel读操作<a href="#3easyexcel读操作" class="hash-link" aria-label="3、EasyExcel读操作的直接链接" title="3、EasyExcel读操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31创建实体类">3.1、创建实体类<a href="#31创建实体类" class="hash-link" aria-label="3.1、创建实体类的直接链接" title="3.1、创建实体类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(value = &quot;学生编号&quot;,index = 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @ExcelProperty(value = &quot;学生姓名&quot;,index = 1)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先创建一个监听器ExcelListener，集成EasyExcel提供AnalysisEventListener类：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32创建读取操作监听器">3.2、创建读取操作监听器<a href="#32创建读取操作监听器" class="hash-link" aria-label="3.2、创建读取操作监听器的直接链接" title="3.2、创建读取操作监听器的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class ExcelListener extends AnalysisEventListener&lt;Stu&gt; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //创建list集合封装最终的数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //一行一行去读取excle内容</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void invoke(Stu user, AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;***&quot;+user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        list.add(user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //读取excel表头信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void invokeHeadMap(Map&lt;Integer, String&gt; headMap, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;表头信息：&quot;+headMap);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    //读取完成后执行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void doAfterAllAnalysed(AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        System.out.println(&quot;list = &quot; + list);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在该监听器中，通过重写AnalysisEventListener的方法来获得解析的数据、表头信息，以及解析完毕之后执行的操作信息。</p>
<p>同样写Excel一样，通过EasyExcel类的静态方法来执行读操作：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33调用方法实现读取">3.3、调用方法实现读取<a href="#33调用方法实现读取" class="hash-link" aria-label="3.3、调用方法实现读取的直接链接" title="3.3、调用方法实现读取的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    String fileName = &quot;E:\\11.xlsx&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // 这里 需要指定调用哪个class去读，然后读取第一个sheet 文件流会自动关闭</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    EasyExcel.read(fileName, Stu.class, new ExcelListener()).sheet().doRead();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的@DateTimeFormat注解可转换日期格式，还有其他类似功能的注解和自定义转换器。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于EasyExcel的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/easy-excel">EasyExcel</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-spring-security-microservices">spring-security整合微服务实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-15T00:00:00.000Z">2023年3月15日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>起因</strong>：<em>随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="#技术选型" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<table><thead><tr><th></th><th>Spring Security</th><th>Apache Shiro</th><th>Apache Knox</th><th>Keycloak</th><th>Stormpath</th></tr></thead><tbody><tr><td>概述</td><td>Spring Security 是一个非常流行的 Java 应用程序安全框架，提供了完整的身份验证、授权和会话管理功能。它具有良好的可扩展性和灵活性，能够与 Spring 生态系统中的其他框架和库无缝集成</td><td>Apache Shiro 是一个轻量级的安全框架，提供了身份验证、授权、加密和会话管理等功能。它易于使用和集成，能够与任何应用程序框架一起使用，支持多种数据源，如 LDAP、JDBC 和 Active Directory</td><td>Apache Knox 是一个开源网关，提供了 REST API 的认证、授权和审计功能。它可以保护 Hadoop 集群的 REST API，提供了单点登录和 OAuth2 支持</td><td>Keycloak 是一个开源的身份认证和访问管理解决方案，基于 OpenID Connect 和 OAuth2 协议。它提供了可扩展的身份验证和授权功能，包括单点登录、多因素身份验证和基于角色的访问控制等</td><td>Stormpath 是一个云身份认证和访问管理服务，提供了完整的身份验证、授权和用户管理功能。它可以与任何应用程序框架一起使用，包括 Java、Node.js 和 .NET</td></tr><tr><td>优点</td><td>完整的安全特性、与 Spring 框架无缝集成、丰富的插件和扩展、良好的文档和社区支持</td><td>括轻量级、易于使用和集成、支持多种数据源、优秀的文档</td><td>保护 Hadoop 集群的 REST API、支持单点登录和 OAuth2、易于配置和使用</td><td>可扩展的身份验证和授权功能、多种身份验证方式、基于角色的访问控制、易于使用和部署</td><td>云身份认证和访问管理服务、易于使用和集成、提供完整的身份验证、授权和用户管理功能</td></tr><tr><td>缺点</td><td>配置复杂、上手较难</td><td>与 Spring 框架的深度集成、不够完整的安全特性</td><td>仅适用于保护 Hadoop 集群的 REST API</td><td>配置复杂、性能较差</td><td>需要使用云服务、需要支付服务费用，成本高</td></tr><tr><td>适用场景</td><td>适用于基于 Spring 框架构建的应用程序</td><td>适用于不依赖于 Spring 框架的应用程序</td><td>适用于需要保护 Hadoop 集群的 REST API 的场景</td><td>适用于需要单独部署一个身份认证和访问管理系统的场景</td><td>适用于需要使用云身份认证和访问管理服务的场景。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结：<a href="#小结" class="hash-link" aria-label="小结：的直接链接" title="小结：的直接链接">​</a></h3>
<p>国内目前非常流行的就是Spring Security和Apache Shiro 。</p>
<p>Spring Security出现的时间较早，在springboot没火起来之前一直都是Shiro 的天下，但目前最能和spring全家桶整合起 来的就是Spring Security，Spring Security 是最为完整、可扩展和灵活的安全框架，而且与 Spring 框架的深度集成使得使用和配置变得简单方便。Spring Security 提供了全面的身份验证、授权和会话管理特性，并且可以轻松地扩展到支持自定义的安全策略和特性。而且社区也是十分活跃的。所以此篇文章主要从实践流程出发，实现与spring项目整合的快速搭建解决方案。</p>
<p>相对于 Shiro，在 SSM 中整合 Spring Security 都是比较麻烦的操作，所以，Spring Security 虽然功能比 Shiro 强大，但是使用反而没有 Shiro 多（Shiro 虽然功能没有Spring Security 多，但是对于大部分项目而言，Shiro 也够用了）。自从有了 Spring Boot 之后，Spring Boot 对于 Spring Security 提供了自动化配置方案，可以使用更少的配置来使用 Spring Security。</p>
<p>因此，一般来说，常见的安全管理技术栈的组合是这样的：
• SSM + Shiro
• Spring Boot/Spring Cloud + Spring Security</p>
<p>如果还想了解shiro这一框架，我也在github开源了一个小demo，用于整合SpringBoot与shiro，实现快速上手，仓库地址：<a href="https://github.com/Jachen99/rbac_shiro" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/rbac_shiro</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security简介">Spring Security简介<a href="#spring-security简介" class="hash-link" aria-label="Spring Security简介的直接链接" title="Spring Security简介的直接链接">​</a></h3>
<p>Spring 是非常流行和成功的 Java 应用开发框架，Spring Security 正是 Spring 家族中的成员。Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案。</p>
<p>正如你可能知道的关于安 全方面的两个核心功能是“<strong>认证</strong>”和“<strong>授权</strong>”，一般来说，Web 应用的安全性包括**用户认证（Authentication）和用户授权（Authorization）**两个部分，这两点也是 SpringSecurity 重要核心功能。</p>
<p>（1）用户认证指的是：验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程。</p>
<p><strong>通俗点说就是系统认为用户是否能登录</strong></p>
<p>（2）用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。</p>
<p><strong>通俗点讲就是系统判断用户是否有权限去做某些事情。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="历史">历史<a href="#历史" class="hash-link" aria-label="历史的直接链接" title="历史的直接链接">​</a></h3>
<p>“Spring Security 开始于 2003 年年底,““spring 的 acegi 安全系统”。 起因是 Spring开发者邮件列表中的一个问题,有人提问是否考虑提供一个基于 spring 的安全实现。</p>
<p>Spring Security 以“The Acegi Secutity System for Spring” 的名字始于 2013 年晚些时候。一个问题提交到 Spring 开发者的邮件列表，询问是否已经有考虑一个基于Spring 的安全性社区实现。那时候 Spring 的社区相对较小（相对现在）。实际上 Spring 自己在2013 年只是一个存在于 ScourseForge 的项目，这个问题的回答是一个值得研究的领域，虽然目前时间的缺乏组织了我们对它的探索。</p>
<p>考虑到这一点，一个简单的安全实现建成但是并没有发布。几  周后，Spring 社区的其他成员询问了安全性，这次这个代码被发送给他们。其他几个请求也跟随而来。到 2014 年一月大约有 20 万人使用了这个代码。这些创业者的人提出一个 SourceForge 项目加入是为了，这是在 2004 三月正式成立。</p>
<p>在早些时候，这个项目没有任何自己的验证模块，身份验证过程依赖于容器管理的安全性和 Acegi 安全性。而不是专注于授权。开始的时候这很适合，但是越来越多的用户请求额外的容器支持。容器特定的认证领域接口的基本限制变得清晰。还有一个相关的问题增加新的容器的路径，这是最终用户的困惑和错误配置的常见问题。</p>
<p>Acegi 安全特定的认证服务介绍。大约一年后，Acegi 安全正式成为了 Spring 框架的子项目。1.0.0 最终版本是出版于 2006 -在超过两年半的大量生产的软件项目和数以百计的改进和积极利用社区的贡献。</p>
<p>Acegi 安全 2007 年底正式成为了 Spring 组合项目，更名为&quot;Spring Security&quot;。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="流程介绍">流程介绍<a href="#流程介绍" class="hash-link" aria-label="流程介绍的直接链接" title="流程介绍的直接链接">​</a></h2>
<p>要对Web资源进行保护，最好的办法莫过于Filter
要想对方法调用进行保护，最好的办法莫过于<a href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">AOP</a>。</p>
<p>Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。</p>
<p><img decoding="async" loading="lazy" src="https://img-blog.csdnimg.cn/20201231155747261.png" alt="img" class="img_ev3q"></p>
<p>如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。经过一系列拦截最终访问到我们的API。</p>
<p>这里面我们只需要重点关注两个过滤器即可：<code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<code>FilterSecurityInterceptor</code>负责权限授权。</p>
<p>说明：<strong>Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速实践">快速实践<a href="#快速实践" class="hash-link" aria-label="快速实践的直接链接" title="快速实践的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="搭建权限框架基本骨架">搭建权限框架基本骨架<a href="#搭建权限框架基本骨架" class="hash-link" aria-label="搭建权限框架基本骨架的直接链接" title="搭建权限框架基本骨架的直接链接">​</a></h3>
<p>1、给spring-security创建单独的公共模块</p>
<p>2、导入相关jar包，如果是maven工程，直接引入</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">&lt;!-- Spring Security依赖 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">spring-boot-starter-security</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：依赖包（spring-boot-starter-security）导入后，Spring Security就默认提供了许多功能将整个应用给保护了起来：</p>
<ul>
<li>要求经过身份验证的用户才能与应用程序进行交互</li>
<li>创建好了默认登录表单</li>
<li>生成用户名为<code>user</code>的随机密码并打印在控制台上</li>
<li><code>CSRF</code>攻击防护、<code>Session Fixation</code>攻击防护</li>
</ul>
<p>3、在需要使用权限框架的模块导入依赖</p>
<p>这里以医院预约挂号系统的order模块为例，仓库地址：<a href="https://github.com/Jachen99/yygh_parent" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/yygh_parent</a></p>
<p>导入依赖到service-order模块</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">space.jachen</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">groupId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">spring-security</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">artifactId</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">1.0.1</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">version</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">dependency</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4、启动该order模块，会发现控制台显示Using generated security password</p>
<p><img decoding="async" loading="lazy" alt="image-20230216104643176" src="/assets/images/image-20230216104643176-f4f96f5b1dc242b1cd0a8cbec3971064.png" width="1054" height="248" class="img_ev3q"></p>
<p>说明该模块已经被spring security保护。</p>
<p>5、此时我们通过浏览器去访问该模块下的api路径，会进入框架自带的登录页面：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216112805097" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWQAAACjCAIAAAAy4/PPAAAZL0lEQVR4nO3de3gU533o8d87l53dnd3Zm3ZXWt0FEkjcwZi7wfEFEztxbezYjnNqOyVx/LhPmpzTJmmaPs1pkrZ+0hwnJ23SNHFxk9g5DmlqE0PAGF9ABmzuF4EAgVbS6rIrae/Xubzv+QOSAKbPTihkwfv7PA9/gEajd8Xsd9+ZnZkl8XgcEEKoHK7SA0AI3RgwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFThEoP4EaQj544HQ6Ppn7zd84TaJja2ljjkQEAgAKkP/v0FwbE2Z//9IOruoIVG2c5jBaGwuH+0cyMBTf7rECuwU8YHzjdPzQuBprndTRc/dWjisJYmJCNbHnlpe0HBn7zd2K1OdyBpjX3rb1t6Wy3BQBoNBobllLZglbBYZaVGTy06YV/fz0szdUav7ii1sJf5VwwQ3/rjc0vbdnbuuCWeV948uquHFUcxsIEvZhJTSZKZMbS1cta7Ewvne3Zv7f3yI/XFwzyyQdXTrsGL9HXhGB3BYKhYI7rDNq4azFoQvyBQKg2WB+qvwZrRxWGsTDL6grMuPX+x5b7mKGNnJ2rP/tP2471dL/d/cAt08gNUgtbTfuq+z49K5VvanPz1+BoFeGEBYs/1Nq1BOy+q792VGkYi98b4cX69vmtXdPIwVOZxCBl7P2v0pQa6UQik8upmg6cYLXJisvltIkAAFTL5nKZTK5YVHVKOV6QHYrH5ZQsAgAYup5NJzO5XEnVKXCi1aG4XF6HBQCAqslkOpP9zTrtssfns/LkcnMEmstk05lMoVgyKOMFwRsIOawib6gCoaIk5TWQJAAAqpeymUwqnStqBi+IiturpRMltSS73f4aHzW0THQwXiS+QA1hNJ1MF0o6J4iKx+d2WIXL9IYVKa9RZqd5AAUAMrGhRF6zKy67VUolkrlCifCC0+VxOWVJ5K/qfwu65jAWV4RRYAyA8OQyL9DU0NPx0Z//+4+7DxwajqWI1Tmlc/6aex/6yLKpPAEoRHds+fVrb+8/3R9J5oqC3Tn/5js++dgDXS0BjhnpiaGXf/bijv2HB6IpDUT/1IVrH3n80VuagdF8rO8XL728Y8/BSCzJSa7WmfMfXvfk0laPTbx0DFo+0b311c3bd54KR3IlJiueh774zXvnNyrJky/+6w9+eaT06Neef7QDRI4mR0//6j/+c8vO/YOTeYevYeWHH1Df+eU7vadX/Y8n/+qpj5eyide++cT3D5I//tz/qtHGNm56+3h/VFACt937+KceWB502y/NFDU2/nz9v7y4ecmtq//v1/8SgO358Ve/t+1M110fv2uO75cbNu3rCVOre/mdD37ykdUd9d4bZEKGzsNYXJFiNBkbYSA75BD3vp2QieH+55758qajxQ/dfdd90+qTkZ7uXe+t//5Aa+cPujxEnDxx9PSwtb7r/iUrSTHbu3Pju2/9wtnS9ic1d9bp/Qe2/PNzrxybtuy2j390lsJlRxNUJjoANfTJv/7C3x5I2W9ecvtHp4fiZ4+/vnXr3zx9+gc//LuulrqLR8De+cn312/cwWqn3fvwY40Be2xoyCFZGbv0QVB1/Ec/ev6VN47UNrbdt3a2TLQT7/xwYCCVv2Q5Rrf+v39rbOuctXhlS8vga1ve3vyTby1a2HqLq91q5unOjMPdWwuRUMvsxW3t0zdv3Lpz4/NtU2ob/uhWGWtxQ8FYmFXKxAeP7t6uylTL7962ufvQqYaumbf+0Ycv3QtQE6On33mzL3vL03/zxMoOv8NC9SU+r/fvn9vyjZ/s/+Gn57jcMx9bN5vnJcnCA9VKq6c++dQ/7jg+uGpFVuEmzh49QjnLh9c+tKwtIAvMoMDxFi2X7N/0zZ6R2NpPffHe2xe7JcHIzZzdrH/u2e3bTsb9wdqA7YJBMHj31NhYsnjr3YvW3nePLHC6phGrcm4f6EIDb/2s5/jxxlkLnvjMUzc3KRywwr23f/UrXx89PXLRcozZZ65+8OGPttfIpdTYXOfQN14O7zmd6JrCGhwmnu4M7HXT7nzsU4uavKCXFrqHv7Ghp+fMcCRJp3nwNJ8bCcbCLDU9vu9X6/u28YxRA/jGWUvvWfvA8q66SxYrpkYHerqT2cLJNzZ8e59k4QkAnYiNaQVt5K0T6uMzwekjqZHI8JmRsehoLDI23BfPFTLjyWwmb28ONXUtZXt2/MePvh9duvzm+bNbG4Ju2ZKJ5be9tD9XUPe8vvHsgR08ATBKhdSIYainRzLZohGwXfD/SGDxgin7z/S/9+Y2C6XLFi+YPm2aTyQ8B8ZFI2WHd/QlJ/IzV81ZNK3BLXEA4FLkjhp/7yWxINycGTNaG+vcEmdIdMZN84VfDYzFC4WSAQ4T2w/hGlu7ZrU3eWw8o1rnzQudm84ksqV0wQCMxQ0FY2GWaHe1LVi1uMkOQFz+0LSumS31AY9NAKAXLqYXc7nJIUKIolgsFp4HAsAH6xqDdVMtloAkcr0Hd2/69RvhaFp2u3nJYrfVcBwPJZXpuqQEF9z5yGMZZe+h4zt//Yv9u3fMvGnlHauWhUS9P1I0ACSBswg8AABvd/in3vahqY0hl1245OWd3HTb3Y9z8vZdRw7vfvPogd3tM+bdff/9Mxq81osWYyOxYqHI/E77uVIAABDeTrhLpyCE+JyiU+IAgPC8RfEAIapODfq+HZvLIsQpix7bucOZxKK4eV7QDWoYtMw3ousMxsIsq6d27uqPP7m8zJuCvChJTh8vJOasfuiu9hrn744+coRYZSu39dWXN++LzVu15oE75jkVp9uWOPjue+dODqXE4qntWPdkw7ITvYf2vfPaazt/vWFEBekza6bXeHkuRVesue+WedOlC95GEB0+l+3S12droOO2jwZnLVxxaP/e19/e+eqGH48ZDX/5+MrGCxdiIFkJz7NsScvpTBYIADCqJg299L4H9d+cABC4FmeLoj80nAdeZZISqJ+6kAete1e/TgWHw6E4nU7Z5rBLwTo3z+tnxlIpOdQ+Z35HW1Ot21oaOV4s6ee+V82nY5GhdAnaps+675F1a5YsZPHh4bNHrDbbLXe0SBbhTGRSBdHhcCpOp8NulwTitXPSpTMLCI+OT+aoO9j4oTX3fGbdI8DY0e29k5MXH7gkpKvT73SIfT3HjpyNJlOpVDIxOtDTFxsv/mF+U+hGgzOLq4yzB+u6bu1UXj269dnvZg7Pnt7mtnG59ERRo4/+6ec9xOKUbcKxnt2vvCjGumgmvnVvXzJXAjcAQCrSs2X9d0ZDt0+fPlWbGOzu6S3ava6aJsnpvvmJL/l3fWXbC8+N9R5eMKdDtvLZxHjk5P6nvvyPDXUXX43C6Pf++QcGb104a6pDKJ44epQXhPpF7bJiu3ik5Ka1D7WfjG7f3/2tr4+vWDRbNEoHuvdkEqmL91YQOg9jcdWR+rbOr3/3W+uf++m+o/s37O/mRVsg1DB38VIJgAC37uF7BfjPPcf2vhDu7Zi79GvPfP6vnvyzMAAA2F013lDzq9s3b92Y4yRbbUPrx9Y9cv/dq4ATeFfHs//7sy9seHXPoSMvHt7NWe2+uqY5MxeLku39A5jf5tr6Vvf6d18zmOj1hVbf89ATjy9vCsgwcdFyYs2MdY896rS/3H3o1C9fDje0zfjw018Zeum78UM9PIdTTnQpEo/HKz2G656amYgnUyrv9AYClzn+zwBoODxUIna/z+V1SACMGlp8Mp7N5TXdAMKJFkl2OHxeNwegFbLJVCqdK1DgbbIjGPREBiIqsfu9LpfE8pnkRDKvGQZwnGS1KS6X03HueAJQNZ9IpTPZvKoZwHGCKDlku9ftEoRLT4VMxCcymWxJ0xjjRNEiOxxejyLwPNNyqWQynmeuYINXAkJAK2bTqXQqV9ApSJLd5VX+/kt/sfNA5MF1T3/+idVU19LR8GSB1NTWOh0ODgCYrhcz4eFJyVPnU+x28ZI9IBaLjSdTabssN4TqACAdHUzkVLvb5/Oee+eDUTUdGUswyeVxuxQJk3QjwVhUMaan8jrP8Q6bCIzqar5nz9a/+85P4vbpTz396fuXtFV6fOj6grsh1Yux/OubNo+lNa/LLnAsGx/ftWN7htmWrlwxpwMvG0WXwlhUMUaS0XD3nmMlTec4TjVAUQKLbl/5ibtumuKTKj04dN3B3ZBqxrKJiaHI4Oh4vKSBxaG0tk6r9zvxelB0WRgLhJApeDgaIWQKxgIhZAoe4CxDpzBRFFKqyF2Tu1aiGwZjTCBUEfUam1F+6Q8ijEUZkYxYBKnOJQhX+17Y6MbCgCULNF4gGAt0eb0Jy7JWocmNpUDEa+P6J6v3KYPHLMoo6oQyLAUCABB5Yn/fHU+rR/U+coTQ7wVjgRAyBWOBEDIFY4EQMgVjgRAyBWNxJdRcWlfP39fWoCyWKpq91TVCNyyMxZUYPbbnzJnwuT6kM7n128/kirphGLquG7/Jhq7rum5QxoAxRg1KDV0//8fQdYNSBsAY03Vd13XKGABQxnSD6rquG+zc2ig9d798Ro3frg6hyqjeM0yuupHBwWg8Jbu9rW2NvK4f6TmhG3zblGa/lWaT40kDRuOSn09aBJIoaIJS09rSwGnaiWO9RUZDLS21PncymQ1H00Z+0uJt9ahjyVzeHahrqQ8YmjYZPj6YIY5QS6PfJeMV5KgScGZxlajhcI7zt0ypcdsz6fS+17dPaW2bFeJPDMYi48nhociJlHPGlJpoX29/Rqxrbc6kku8eH2dAlM72rq6WI8eHwiOpiVj05MBo55Tm07u3hHNiU617LBo7Hs3n0rHd+ZqpHe0TPQcHBkbKDwahawBnFlcJ75P0wcGI2tnoMwr5YyNZcrqPpwWVeDmDiKIQaPTYJM7Q1KBXUWTFJsSGJyahlR872jcmCGOxfF1ItTBesLltNqvbyDXVyE6fKI7n4+OpAOkzMs7ek/GsbrgM3BFBlYGxuBKyS46pRqKguUVDy4/Vh2oE3tLRXJ8cGRyOFOx+v8CLwVCtVRBCFrtcGteynOwQgFIAsAkg8jyjxChkMoMTqjM0xcVHhnPAGHA88DwBsHAgi0S0iAbhdEpBEqxOX33AHvK63B5HpR89qlK4G3Il3A3NHNVGo+PRicloLL50ht9iJHJ5w253SALhZXtno8MghCOEGCWrTeIESQQAAlbZwQsCAEgWXrZZeM6i1Dg5QnmLZLUIFoFzWEVCiM3h5HgegJME3i7bLTWNpXgGgBgGp/Hv+zR0hP4gcGZxJQRHQ0eTNZ5MpwuiXNvV5uRAdTKaius2d01treJsWrm0f2AsQWltMChJlkBjqwpACNc8c67TLQNAIFRn9+iy12YbGEpxctf0Vr/bxvOypBiEF9rmLnA5bQBCU1ODZgh2m7y0RU9l05xcIwp4K11UGXgPzjJe7nPcOlVs8VR6HOg6oBoQSRgePl3pgVQG7oYghEzBWCCETMFYIIRMwVgghEzBWJTBc0AIngeFAAAoBb2KrxjEt07LqLEaRZUraDzBG3FWvazKsiXqr9YzXTAWZcwPFE8lYTBFRAFnYVWNMqbruktQKz2QisHzLMpgAAY9tx+CUwvECIDAVemeCM4syrhg46jSTQShc3BqjRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKCOdTnMcJwj4i0LAGAMAm81W6YFUBj4Hysjlcn6/v2q3D3QhSmmhUKj0KCoGY1Ge1Wp1OPCe2ggopZRSVq0fC4fHLBBCpmAsEEKmYCwQQqZgLBBCpmAsEEKmYCyue9RgWkHF22mgSsNYXAmjmCvkc7lCIV8o5kv6tf1hWiE7fGoUgF7bH4NQGXiexZXI9h04EFMFxW2UNOIMrZzdRCllDDiOEEIYY5QyAOA4DoCef1eecIxRnuPOnwZICAAwBhyBi74XgFIGjHHcuQUYqAU9M54CCAHwFXzMqOphLK5QTW2oqX1qYWxkV/cRY1bTyZOn8yW1rq6+PujNZbMnz4QZwPSOdi09ORqL61any18bHxqb0dUIqWiKs8oeL82rI2nWXiv1nurLF0vBYG1jnT9fKPUOZyAX7ZjaxhWTw9EJVVMdOP9D1wHcDK8Qx3O8wBhn5HmZkPFQKNTZrPRHxg6dHB7rPdgwtbXTwwCMo0NppoRCXiWvFiZ69qglrfdE/1vvhSPRZDrVP1w03tv0iuF0tXc0Rc707zs6kEkl9+490NLcJPPF4wMTmjNU51OGRvKVfrgIYSyuVHJ87OiR3uHJ4pJFXXpKHQgP95wZG8+UCjqRrFzkeO+E4RR54rCwyOhYkhCfLEwN8eOaEWEeVipF+85mxibaFHowJgUVp9Pu9LulQnKCAqdKNQ7ZziUjkmwP+BRF8bR4pUo/XIQwFldKkORgsLatqb6pVhk6fEDjrAGvS6IGI4In2OJ3iCeP9GTyWnNLfXuIj44NR4uWus7ppyOjotfTFJQy46MTSd5vAQF0xoABUEIYJwDhQXICEKCGphsGZQalRfUaH0NFyASMxZXgLFaXx1Mb9HvdLgDQwQi4LVaB5ySLQCCRzEk1IavIAS0V8gWH0+m1CZomir72bKS/3itNa3TaRaLZA6IoLmyxjMXjE/HJeJb6grU8TxS7QAiAJ0QL+WhsMp5MxAq8BT+2BFUafshQGaOjo42NjU6n88J/VJNRVbBLslMkAEABsn1nJgyLgxdsNk7nCxOTJU5U6pr9/Hh0PJXJOxWlMVQLjA2cDfvramWLEc9oReIIuUUAONMfLpZUv98f8HnyJW1wotBe5+Q5kh6PTSRSRBQCXrvmCiqY9kqjlKbT6aq96hRjUcZlY4GqU5XHAl+rEEKmYCwQQqZgLBBCpmAsEEKmYCzKIATfskTnMcaq9ugm4LUhZYmiaBiGYRiVHgiqPE3TVFW1WCyVHkhl4FunZRiGUSgUCCE8j9d8VjVKqWEYHMfJslzpsVQGzizK4Hm+ajcOdAnGWDXvlmIsyqvm7QNdqMq3BDzAiRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKO/YOL8rIkwWuCq+LACBxLOuGmNhSK+xV+l2gLEooy/BfXev9Y2wOFmo6hNykMSzaT76mfnFh2eolR5LZeBuSBk/PSq9GRawFKhkkBMT/Is91fuxDBiLMo6O84kS/pYQAIBGIVWq3pcNfBqUwRh+fjlCABgLhJBJGAuEkCkYC4SQKRgLhJApGAsEAMBzoFjBSq5kg+A58FiBq953CaoFxqJKcRwIHIgciDzwHDis8InFsEQC2++5HkKgxgmfXQJu6zUZJ7p+4Bmc1UiywD2L4XNd4BBA5GDHEfjyPnCIYLmi2YHAgSziy84HH8ai6hACPjt8dR78w3Y4NgkcQKoI2QI8vwfyRSj+nmtjDGJpeHY3JErXZLTo+oGxqEYCByEZaBEGJiGpAgC47fCJZbD+bcgVYWEzrJ4KCgeaAS4HPPMmjGbh4VkQlMHrAIGHs32wYRDi5+pAQFHgK0vhq29AYzMsVYCjEPIBT+EX78GRLBTwE1c+KHDyWHUYg2QRfnoGVs+Gx2bBQj+4BHBYYc0csFvAE4CPzYWZDojnwSnDn8wHnw14DpY3w8faIVsAg8DnVkDDBZ+O4JThiXnglKC1Hu7phCVeSKrgD8KXFoCrSj+O54MJY1GNMkX4623w9gSs7IIvLYeldb/70rzpUM/g53vgmXfgmd1QYudPdicMtp2Cf+iGb++CmiC47Jdfs5aHjT3wf3bB9/bBimngxFh8gGAsqhKFYhKe3wGffQ0GRHhqye++Ms0JpQSMTQADoAC/3YcolSBdAAZQZEAJcP/FhjMxDOPDYGhQSIFgvcIjpuj6hLGoOgTALsIiBWw8DMfgRBSMC45cjRQhWAdtdUA4sNvBRgCf7+gcPMBZfQi4ZHjmERB0KAFYdHj50O++uH03rLgT/udH4JE0OOxQInjNLToPY1F1GIOJLPzZq2AhQAAKKoxmIK7Cn/8MxnOgGfCdt+DnTiAMPAr87EEAAM2Ab797/mr9fA7WvgBHY79dHcTGYc1PYTQL2YNwRIMEAGVwdhI+sgHCuco9TnS1YSyqkarD3qFL//HwIAAAR8DQIZ0HEKBeAS0NqgqUwdnU+cV0HboHLvrGfAneDgMAFOJwviEMcirsjFzLx4D+4DAW6CKEwOpOaJIBBPAr8KNdMJav9JjQ9QFjgS7CGOwOw7ALCIN0AXaPAN7THJ2DsUAXoQxOxOBErPySqNrgW6cIIVMwFmWQ838QqnYYizLavVSx4F47AgAQOHCI1bsxYCzKeLCztKhed1urdxNB51h4aHUbH2nXKj2QiiHxeLzSY7je7RkWfnVaHM1iWKuaVYDFIf2ONq3OQSs9lsrAWCCETMFXS4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCn/HzFPDRfNstOFAAAAAElFTkSuQmCC" width="356" height="163" class="img_ev3q"></p>
<p>默认用户名为user，密码为控制台输出的随机密码，认证成功后才可以登录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现用户认证功能">实现用户认证功能<a href="#实现用户认证功能" class="hash-link" aria-label="实现用户认证功能的直接链接" title="实现用户认证功能的直接链接">​</a></h3>
<p><em>目前，我们已经实现了自带的登录页面的访问，用户名和密码都来自于内存。那么要访问来自于mysql、redis甚至的用户名、密码怎么办呢？</em></p>
<ul>
<li>加密器PasswordEncoder</li>
<li>用户对象UserDetails</li>
<li>业务对象UserDetailsService</li>
</ul>
<p>功能1：自带登录页面，访问真正的数据库，需要做什么？</p>
<p>1、访问基于内存的用户名和密码使用的是InMeoryUserDetailsManager（实现了UserDetailsServer），我们需要自定义UserDetailsServer的实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.order.security;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.user.PatientFeignClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:35</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class UserDetailsServiceImpl implements UserDetailsService {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private PatientFeignClient userInfoFeignClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public UserDetails loadUserByUsername(String phone) throws UsernameNotFoundException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        LoginVo login = userInfoFeignClient.loginSecurity(phone);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if(login == null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new UsernameNotFoundException(&quot;用户名不存在！&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 这里不比较密码 ，后面通过PasswordEncoder比较</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 返回数据、暂时不做授权</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Collection&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new CustomUser(login,authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、访问数据库的方法loadUserByUsername，返回值为Userdetails，它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，所以我们还需要自定义UserDetails实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.Getter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import lombok.Setter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.userdetails.User;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 访问数据库的方法loadUserByUsername，返回值为Userdetails，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 所以我们还需要自定义UserDetails实现类。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:31</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Setter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class CustomUser extends User {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 我们自己的用户实体对象，要调取用户信息时直接获取这个实体对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private LoginVo loginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param loginVo  从数据库中查询的用户信息</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param authorities  从数据库中查询的权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public CustomUser(LoginVo loginVo,Collection&lt;? extends GrantedAuthority&gt; authorities) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        super(loginVo.getPhone(), loginVo.getCode(), authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.loginVo = loginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>现在数据都有了，我们需要进行密码的比较。</em></p>
<p>3、使用PasswordEncoder接口，但是不同的数据库采用的加密算法不同，这里可以使用security自带的PasswordEncoder实现类，如果不合适，就自定义一下PasswordEncoder的实现类即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.crypto.password.PasswordEncoder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 自定义密码组件 密码处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 此项目不需要md5加密处理</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 不需要开发者自己调用此类，SpringSecurity流程中进行密码比较时会自动调用。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:25</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Component  // 必须添加到IOC ,SpringSecurity才可以使用</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class CustomPasswordEncoder implements PasswordEncoder {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private StringRedisTemplate stringRedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 如果需要加密进行加 密操作后返回，这里不需要处理，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 因为本项目没有对用户密码进行加密，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 采用的是手机号+验证码的方式进行登录</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 验证码存在redis中，为了方便演示，特定此条验证码永不过期，当作密码使用，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param rawPassword  明文  用户输入的密码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return  密文</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public String encode(CharSequence rawPassword) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return rawPassword.toString();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param rawPassword  用户输入的密码  即4位验证码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param encodedPassword  从redis中查询出来的验证码</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public boolean matches(CharSequence rawPassword, String encodedPassword) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 写死</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        encodedPassword = stringRedisTemplate.opsForValue().get(&quot;13243922402&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return encodedPassword.equals(encode(encodedPassword));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先来看看整个认证的流程图：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216133620298" src="/assets/images/image-20230216133620298-5f63300eb8e0aa01307e67ad37ce956b.png" width="1067" height="650" class="img_ev3q"></p>
<p><em>现在，虽然已经实现了对真实数据库的访问，但是还是使用自带的登录页面，那么怎么才能通过前端项目的真实的用户登录页面访问呢？</em></p>
<p>登录成功后，每次访问其他资源都要判断一下token是否正确,如果正确才能访问，如果不正确返回异常信息。</p>
<p>4、自定义用户认证接口（过滤器1）</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 不用加Component注解 不需要加入IOC  过滤器由tomcat进行管理 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:45</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.AuthenticationManager;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.Authentication;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.AuthenticationException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 登录过滤器，继承UsernamePasswordAuthenticationFilter，对用户名密码进行登录校验</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class TokenLoginFilter extends UsernamePasswordAuthenticationFilter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public TokenLoginFilter(AuthenticationManager authenticationManager,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            RedisTemplate redisTemplate ) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //设置认证管理器</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.setAuthenticationManager(authenticationManager);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //设置登录的地址和请求方式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.setRequiresAuthenticationRequestMatcher(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new AntPathRequestMatcher(&quot;/yygh/user/loginSecurity&quot;, &quot;POST&quot;));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录认证</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 走这个登录认证流程 不走原先的登录接口了</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param req</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param res</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws AuthenticationException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public Authentication attemptAuthentication(HttpServletRequest req, HttpServletResponse res)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throws AuthenticationException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 获取用户名的方法  简单封装方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            LoginVo loginVo = new ObjectMapper().readValue(req.getInputStream(), LoginVo.class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String pwd = (String) redisTemplate.opsForValue().get(loginVo.getPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 将用户名和密码封装到Authentication</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Authentication authenticationToken =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    new UsernamePasswordAuthenticationToken(loginVo.getPhone(), pwd);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // 调取getAuthenticationManager认证</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return this.getAuthenticationManager().authenticate(authenticationToken);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录成功 认证成功调用的方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param chain</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param auth</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,Authentication auth) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 1、通过Authentication获取认证的对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        CustomUser customUser = (CustomUser) auth.getPrincipal();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 2、通过JwtHelper生成token</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String token = JwtHelper.createToken(Long.parseLong(customUser.getLoginVo().getOpenid()), customUser.getLoginVo().getPhone());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 3、获取用户的权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Collection&lt;GrantedAuthority&gt; authorities = customUser.getAuthorities();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 4、将权限保存到Redis中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // redisTemplate.boundValueOps(customUser.getUsername()).set(authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 5、保存登录日志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // loginLogService.recordLoginLog(customUser.getUsername(), IpUtil.getIpAddress(request),1,&quot;登录成功&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 创建一个Map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        map.put(&quot;token&quot;, token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 6、通过ResponseUtil工具类响应到前端</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ResponseUtil.out(response, JsonData.ok(map));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 登录失败</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (e.getCause() instanceof RuntimeException){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null,204,e.getMessage()));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response,JsonData.build(null, ResultCodeEnum.LOGIN_MOBLE_ERROR));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 如果想在里面加入@Autowired  则需要添加配置类</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.config.http.SessionCreationPolicy;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.security.filter.TokenLoginFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 22:24</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@EnableWebSecurity //@EnableWebSecurity是开启SpringSecurity的默认行为</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@EnableGlobalMethodSecurity(prePostEnabled = true)//开启注解功能，默认禁用注解</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void configure(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // 这是配置的关键，决定哪些 接口开启防护，哪些接口绕过防护</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //关闭csrf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .csrf().disable()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 开启跨域以便前端调用接口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .cors().and()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .authorizeRequests()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .antMatchers(&quot;/yygh/user/login&quot;).permitAll()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 这里意思是其它所有接口需要认证才能访问</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .anyRequest().authenticated()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .and()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                // 这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//                .addFilterBefore(new TokenAuthenticationFilter(redisTemplate), UsernamePasswordAuthenticationFilter.class)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                .addFilter(new TokenLoginFilter(authenticationManager(), redisTemplate));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //禁用session</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 配置哪些请求不拦截</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * 排除swagger相关请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @param web</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public void configure(WebSecurity web) throws Exception {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        web.ignoring().antMatchers(&quot;/favicon.ico&quot;,&quot;/swagger-resources/**&quot;, &quot;/webjars/**&quot;, &quot;/v2/**&quot;, &quot;/swagger-ui.html/**&quot;, &quot;/doc.html&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>5、配置用户认证 （过滤器2）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * @date 2022/12/23 23:04</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.security.core.context.SecurityContextHolder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.util.StringUtils;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.springframework.web.filter.OncePerRequestFilter;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * 认证解析token过滤器</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class TokenAuthenticationFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public TokenAuthenticationFilter(RedisTemplate redisTemplate) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger.info(&quot;认证解析token过滤器的url:&quot;+request.getRequestURI());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        //如果是登录接口，直接放行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if(&quot;/yygh/user/login&quot;.equals(request.getRequestURI())) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UsernamePasswordAuthenticationToken authentication = getAuthentication(request);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if(null != authentication) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            //放行请求</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null, ResultCodeEnum.PERMISSION));//209  没有权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private UsernamePasswordAuthenticationToken getAuthentication(HttpServletRequest request) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // token置于header里</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String token = request.getHeader(&quot;token&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        logger.info(&quot;token:&quot;+token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (!StringUtils.isEmpty(token)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String username = JwtHelper.getUserName(token);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            logger.info(&quot;username:&quot;+username);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (!StringUtils.isEmpty(username)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //从Redis中获取权限</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Collection&lt;GrantedAuthority&gt; authorities = (Collection&lt;GrantedAuthority&gt;) redisTemplate.boundValueOps(username).get();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return new UsernamePasswordAuthenticationToken(username, null, authorities);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //返回一个认证对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //return new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在就可以通过swagger测试登录了。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于Spring Security的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/sentinel/spring-security">Spring Security</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-management-system">SQL优化积累笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-02T00:00:00.000Z">2023年3月2日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去</em>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="or与union的执行效率比较">or与union的执行效率比较<a href="#or与union的执行效率比较" class="hash-link" aria-label="or与union的执行效率比较的直接链接" title="or与union的执行效率比较的直接链接">​</a></h2>
<p>stackoverflow链接: <a href="https://leetcode.cn/link/?target=https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or%EF%BC%89" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or）</a></p>
<p>当SQL语句有多个or语句时，可以考虑使用union或者union all代替来提高速度。使用or的SQL语句往往无法进行优化，导致速度变慢。但这不是固定的，有时候使用or速度会更快些。具体情况还要经过测试为准。如果加索引的话，也可能实现速度优化。</p>
<p>实验表格如下,实际数据有2,000,000条，从里面返回大约最多1000行左右的数据。</p>
<table><thead><tr><th>X</th><th>Y</th><th>Inline</th><th>CDP</th><th>T</th></tr></thead><tbody><tr><td>12002400</td><td>5801000</td><td>300</td><td>300</td><td>3400</td></tr><tr><td>12002408</td><td>5801005</td><td>300</td><td>301</td><td>3402</td></tr><tr><td>12002416</td><td>5801010</td><td>300</td><td>302</td><td>3404</td></tr><tr><td>12002424</td><td>5801015</td><td>300</td><td>303</td><td>3406</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>or语句（部分节选）</p>
<p>SELECT * FROM tablename where (cdp= 300 and inline=301) or (cdp= 301 and inline=301) or (cdp= 302 and inline=301) or (cdp= 303 and inline=301) or (cdp= 304 and inline=301) or (cdp= 305 and inline=301) or (cdp= 306 and inline=301) or (cdp= 307 and inline=301)</p>
<p>union all语句（部分节选）</p>
<p>SELECT * FROM tablename where (inline= 300 and cdp=300) union all SELECT * FROM tablename where (inline= 301 and cdp=300) union all SELECT * FROM tablename where (inline= 302 and cdp=300) union all SELECT * FROM tablename where (inline= 303 and cdp=300)
返回不规则的900条数据，前者用了60多秒，后者用了8秒左右。</p>
<p>总结：</p>
<ol>
<li>Union：对两个结果集进行并集操作，不包括重复行，同时进行默认规则的排序； 即：去重+排序</li>
<li>Union All：对两个结果集进行并集操作，包括重复行，不进行排序； 即：不去重+不排序</li>
<li>对于单列来说，用or是没有任何问题的，但是or涉及到多个列的时候，每次select只能选取一个index，如果选择了area，population就需要进行table-scan，即全部扫描一遍，但是使用union就可以解决这个问题，分别使用area和population上面的index进行查询。 但是这里还会有一个问题就是，UNION会对结果进行排序去重，可能会降低一些performance(这有可能是方法一比方法二快的原因），所以最佳的选择应该是两种方法都进行尝试比较。</li>
</ol>
<p>2023/02/09</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shell脚本批量插入mock数据">shell脚本批量插入mock数据<a href="#shell脚本批量插入mock数据" class="hash-link" aria-label="shell脚本批量插入mock数据的直接链接" title="shell脚本批量插入mock数据的直接链接">​</a></h2>
<p>shell脚本</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo &quot;请输入字段servnumber的值：&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">read serber</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo &quot;请输入创建sql语句的数量：&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">read number</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># char=`head /dev/urandom | tr -dc 0-9 | head -c 11`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">for (( i=0;i&lt;$number;i++ ))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pass=`head /dev/urandom | tr -dc a-z | head -c 8`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        let serber=serber+1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        echo &quot;insert into test(id,username,servnumber,password,createtime) values(&#x27;$i&#x27;,&#x27;user${i}&#x27;,&#x27;${serber}&#x27;,&#x27;$pass&#x27;,now());&quot; &gt;&gt;sql1.txt</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>尽量避免使用select *from ，尽量精确到想要的结果字段。
尽量避免条件使用or。
记得加上limit 限制行数，避免数据量过大消耗性能。
使用模糊查询时，%放在前面是会使索引失效。
要小心条件字段类型的转换。</p>
<p>2023/02/11</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="线上调优-慢查询日志配置">线上调优-慢查询日志配置<a href="#线上调优-慢查询日志配置" class="hash-link" aria-label="线上调优-慢查询日志配置的直接链接" title="线上调优-慢查询日志配置的直接链接">​</a></h2>
<p>最好 nginxi访问日志，流量重放在测试环境中；迫不得已再线上调</p>
<ul>
<li>第一步：查看是否已经开启了慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show variables like &#x27;slow%&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Variable_name       | Value                                |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_launch_time    | 2                                    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_query_log      | OFF                                  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| slow_query_log_file | /data/mydata/jachen-public-slow.log |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------+--------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set global slow_query_log = on ;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">日志路径也可以自定义：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">set global slow_query_log_file = &#x27;路径&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看慢查询的时间临界值</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">show variables like &#x27;%long%&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：设置慢查询的时间标准</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set long_query_time=0.4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>注意：假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">永久生效的设置方法：修改配置文件 vi /etc/my.cnf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slow_query_log = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">long_query_time = 0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">slow_query_log_file =/usr/local/mysql/mysql_slow.log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">最后重新连接才能生效，不必重启服务器！</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>执行耗时sql：</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM emp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM emp WHERE deptid &gt; 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询慢查询记录数：</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHOW</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">STATUS</span><span class="token plain"> </span><span class="token operator">LIKE</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;%Slow_queries%&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询日志：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim /var/lib/mysql/bogon-slow.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>mysqldumpslow分析工具：</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。退出mysql命令行，执行以下命令：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">-- 查看mysqldumpslow的帮助信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token comment" style="color:rgb(98, 114, 164)">--help</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 工作常用参考</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 1.得到返回记录集最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s r </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 2.得到访问次数最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s c </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 3.得到按照时间排序的前10条里面含有左连接的查询语句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s t </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">g </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;left join&quot;</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 4.另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldumpslow </span><span class="token operator">-</span><span class="token plain">s r </span><span class="token operator">-</span><span class="token plain">t </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain">var</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">mysql</span><span class="token operator">/</span><span class="token plain">bogon</span><span class="token operator">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log </span><span class="token operator">|</span><span class="token plain"> more</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>-a: 将数字抽象成N，字符串抽象成S</p>
</li>
<li>
<p>-s: 是表示按照何种方式排序</p>
</li>
<li>
<ul>
<li>c: 访问次数<!-- -->
<ul>
<li>l: 锁定时间</li>
<li>r: 返回记录</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>t: 查询时间</li>
<li>al:平均锁定时间</li>
<li>ar:平均返回记录数</li>
<li>at:平均查询时间</li>
</ul>
</li>
<li>
<p>-t: 即为返回前面多少条的数据</p>
</li>
<li>
<p>-g: 后边搭配一个正则匹配模式，大小写不敏感的</p>
</li>
</ul>
<p>2023/02/15</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sql语句执行过程解析">sql语句执行过程解析<a href="#sql语句执行过程解析" class="hash-link" aria-label="sql语句执行过程解析的直接链接" title="sql语句执行过程解析的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20230223160243626" src="/assets/images/image-20230223160243626-852c258d2994473f82bad8ae86bcd5df.png" width="1081" height="132" class="img_ev3q"></p>
<p>介绍如何开启性能详情</p>
<ul>
<li>第一步：查看性能详情是否开启</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show variables like &#x27;%profiling%&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Variable_name          | Value |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| have_profiling         | YES   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| profiling              | OFF   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| profiling_history_size | 15    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------------------+-------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启性能记录功能</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">set profiling = on ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看性能的记录</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show profiles;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Query_ID | Duration   | Query                                             |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        1 | 0.00177775 | show variables like &#x27;%profiling%&#x27;                 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        2 | 0.00037900 | select * from test where id=&#x27;087878&#x27;              |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        3 | 0.34618025 | select * from test where servnumber=&#x27;1367008787&#x27;  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|        4 | 0.31986825 | select * from test where servnumber=&#x27;13670087879&#x27; |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：查看语句的执行性能详情</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; show profile for query 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Status               | Duration |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| starting             | 0.000100 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| checking permissions | 0.000010 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Opening tables       | 0.000023 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| init                 | 0.000045 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| System lock          | 0.000015 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| optimizing           | 0.000016 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| statistics           | 0.000028 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| preparing            | 0.000020 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| executing            | 0.000006 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Sending data         | 0.319489 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| end                  | 0.000037 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| query end            | 0.000012 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| closing tables       | 0.000012 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| freeing items        | 0.000040 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| cleaning up          | 0.000017 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>性能线程的详细解释官方文档链接</em>：<a href="https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html</a></p>
<p>2023/02/16</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="设计表的null值问题">设计表的NULL值问题<a href="#设计表的null值问题" class="hash-link" aria-label="设计表的NULL值问题的直接链接" title="设计表的NULL值问题的直接链接">​</a></h2>
<p>1、字段不添加null  都是not null，默认值</p>
<p><img decoding="async" loading="lazy" alt="image-20230222093720407" src="/assets/images/image-20230222093720407-7ffbef4dda48f5ec8896c86307b97bf1.png" width="960" height="93" class="img_ev3q"></p>
<p>2、把字段都设置为not null ，添加特殊字段，把数据存储j为JSON格式  </p>
<p>2023/02/18</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关联查询优化">关联查询优化<a href="#关联查询优化" class="hash-link" aria-label="关联查询优化的直接链接" title="关联查询优化的直接链接">​</a></h2>
<p>1、保证被驱动表的JOIN字段已经创建了索引
2、需要JOIN 的字段，数据类型保持绝对一致。
3、LEFT JOIN 时，选择小表作为驱动表，大表作为被驱动表 。减少外层循环的次数。
4、INNER JOIN 时，MySQL会自动将小结果集的表选为驱动表 。选择相信MySQL优化策略。
5、能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)
6、不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。
7、衍生表建不了索引</p>
<p>2023/02/19</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="子查询优化">子查询优化<a href="#子查询优化" class="hash-link" aria-label="子查询优化的直接链接" title="子查询优化的直接链接">​</a></h2>
<p>使用连接（JOIN）查询来替代子查询。**连接查询不需要建立临时表 ，其速度比子查询 要快 ，如果查询中使用索引的话，性能就会更好.
例如：尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
<p>2023/02/22</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据库表设计">数据库表设计<a href="#数据库表设计" class="hash-link" aria-label="数据库表设计的直接链接" title="数据库表设计的直接链接">​</a></h2>
<ul>
<li>字段长度：能使用int就不要使用varchar、char，能用varchar(16)就不要使用varchar(256)</li>
<li>字段选择：固定长度的类型最好使用char,能使用tinyinti就不要使用int</li>
<li>默认值：最好给每个字段个默认值，最好不能为null,即not null default</li>
<li>适当索引：为每个表创建合理的索引，如唯一索引组合索引的场景以及普通索引的场景</li>
</ul>
<p>2023/02/28</p>
<hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于数据仓库相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/shujuku">数据库</a></li><li class="tag_QGVx"><a title="关于MySQL的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/mysql">MySQL</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/mysql-CachesBuffers-reason">深入探究mysql8.x去掉CachesBuffers原因</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-02-20T00:00:00.000Z">2023年2月20日</time> · <!-- -->阅读需 10 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>我们通常理解的mysql5.7过渡到8.0是由于查询缓存很鸡肋，要保证每次查询都是相同的sql查询语句，命中率自然会很低。但是真的只是因为这个原因吗？那么我要是在高并发下请求同一sql的场景这显然也是存在的，那为什么还要去掉这层缓存呢？</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="官方描述">官方描述<a href="#官方描述" class="hash-link" aria-label="官方描述的直接链接" title="官方描述的直接链接">​</a></h2>
<p>MySQL 8.0 在缓存方面也进行了一些改变，以下是一些主要变化：</p>
<ol>
<li>自适应哈希索引：MySQL 8.0 引入了自适应哈希索引，用于在内存中缓存查询结果。这种索引可以根据查询的频率和模式自动调整大小，从而提高查询性能。</li>
<li>持久化内存引擎：MySQL 8.0 引入了 InnoDB 持久化内存引擎，这是一种将数据存储在内存中的引擎。与传统的内存引擎不同，持久化内存引擎可以将数据持久化到磁盘上，以避免数据丢失。</li>
<li>更好的查询缓存：MySQL 8.0 引入了更好的查询缓存机制，用于缓存查询结果。与之前的版本不同，MySQL 8.0 不再使用全局查询缓存，而是改为使用基于查询语句的缓存。</li>
<li>更好的内存管理：MySQL 8.0 改进了内存管理，使得内存使用更加高效。这包括改进了内存分配器、提供了更好的内存监控和警告功能等。</li>
</ol>
<p>其中第三点提到了 MySQL 8.0 引入了更好的查询缓存机制，用于缓存查询结果，这与之前的版本不同，MySQL 8.0 不再使用全局查询缓存，而是改为使用基于查询语句的缓存。这里我们具体展开来看看这个变化。</p>
<p>在之前的 MySQL 版本中，查询缓存是一种可用于缓存 SELECT 语句的结果集的机制。这个机制通过在内存 中缓存查询结果集，以便在以后执行相同的查询时可以直接从缓存中读取结果集，而无需执行查询。这种机制可以大大提高查询性能，特别是在有大量重复查询的情况下。</p>
<p>然而，MySQL 8.0 中的查询缓存与之前版本不同，它不再使用全局查询缓存，而是改为使用基于查询语句的缓存。具体来说，每个查询都会被单独缓存，并且只有相同的查询（包括查询语句和参数）才能从缓存中获取结果集。这种机制可以避免之前版本中遇到的一些问题，比如全局查询缓存锁和内存分配问题。</p>
<p>另外，MySQL 8.0 还支持对查询缓存进行更细粒度的控制，包括可以对某些查询禁用查询缓存，可以在查询语句中指定查询结果集是否需要被缓存等。</p>
<p>虽然 MySQL 8.0 引入了基于查询语句的缓存机制，但是需要注意的是，查询缓存并不总是对性能有益。对于一些查询频率低、数据更新频繁的情况，缓存可能会浪费内存，而不是提高性能。因此，需要根据具体情况来评估是否使用查询缓存。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="探究去掉查询缓存的原因">探究去掉查询缓存的原因<a href="#探究去掉查询缓存的原因" class="hash-link" aria-label="探究去掉查询缓存的原因的直接链接" title="探究去掉查询缓存的原因的直接链接">​</a></h2>
<p>我们先来看看mysql5.7服务端获取客户端请求的基本流程，查询缓存是在解析与优化模块的开始位置，也就意味着它是以全局查询缓存存在的，那么这样有什么弊端呢？它能否保证高并发写的读写一致呢？</p>
<p><img decoding="async" loading="lazy" alt="image-20230220191808225" src="/assets/images/image-20230220191808225-16977303370541-e4f464f4dacbee7a54fc6a8bfd0161ac.png" width="1597" height="1155" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="管理策略层面 的缺失">管理策略层面的缺失<a href="#管理策略层面的缺失" class="hash-link" aria-label="管理策略层面的缺失的直接链接" title="管理策略层面的缺失的直接链接">​</a></h3>
<p>在高并发下查询同一个sql语句select *from user where id = 1;那么存在查询缓存的确可以提高查询的效率，这是我们普遍认为的正常情况。但是在不正常的情况下是会出大问题的，如果我们已经在内存中的数据在磁盘中进行了update修改，我们就必须要使我们缓存中的数据更新，保证数据的一致性，<strong>但是在mysql5.7中，对内存是没有管理策略的，内存中数据的生效、失效、过期都没有进行标记</strong>。那么如果不能保证缓存数据的一致性就会查到脏数据，如果我们是在对数据一致性要求不高的场景下的程序，那么使用查询缓存是不影响的，总不能正在玩着游戏，你停机游戏对数据进行更新？</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="底层有完善的缓存机制">底层有完善的缓存机制<a href="#底层有完善的缓存机制" class="hash-link" aria-label="底层有完善的缓存机制的直接链接" title="底层有完善的缓存机制的直接链接">​</a></h3>
<p>我们的排序，大数据量的查找，order by ，join操作等，join是左表去匹配右表，左表拿出一行数据到右表一一对比，这个比的过程是绝对不会从磁盘中一一拿出来比的，它底层会把数据加载到内存的缓冲区<strong>buffer</strong>中，再进行比较。</p>
<p>处理连接的瓶颈中并发连接数会有限制，比如500个线程，虽然它从缓存内存中取很快，但是对于select语句，只要做好优化，比如创建好索引，在磁盘中取也是不慢的，而且mysql底层的磁盘是有机的组合的，并且在高频的访问中，它也会有读buffer，甚至还存在写buffer，如果读buffer中的数据没有被修改，它每次也是在内存中 读的，也不会在磁盘中读，所以就没必要再加查询缓存了。</p>
<p><img decoding="async" loading="lazy" alt="image-20230220200748912" src="/assets/images/image-20230220200748912-16977303462983-d6a6d16affe653b8e9f493d7d75b6282.png" width="1115" height="815" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查询缓存容量小存在瓶颈且命中率也很低">查询缓存容量小，存在瓶颈，且命中率也很低<a href="#查询缓存容量小存在瓶颈且命中率也很低" class="hash-link" aria-label="查询缓存容量小，存在瓶颈，且命中率也很低的直接链接" title="查询缓存容量小，存在瓶颈，且命中率也很低的直接链接">​</a></h3>
<p>这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等 。只有相同的SQL语句才会命中查询缓存。两个查询请求在任何字符上的不同（例如：空格、注释、大小写），都会导致缓存不会命中。在两条查询之间 有 INSERT 、 UPDATE 、 DELETE 、 TRUNCATE TABLE 、 ALTER TABLE 、 DROP TABLE 或 DROP DATABASE 语句也会导致缓存失效，所以在MySQL 8之后就抛弃了这个功能。</p>
<p>如果一张表中有8000万条数据，查询缓存显然就会力不从心，如果只存热点数据呢？即便是使用lru算法，我们也无法确定已经存在mysql的缓存数据，即便我们缓存了10w条数据，但是我们不知道是8000w条中的哪一个，就会发生缓存穿透，无法命中。加缓存集群更是无从谈起，所以mysql8.0就直接废弃了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="替代方案">替代方案<a href="#替代方案" class="hash-link" aria-label="替代方案的直接链接" title="替代方案的直接链接">​</a></h2>
<p>应用层组织缓存，最简单的是使用redis,ehcached等</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的 直接链接" title="总结的直接链接">​</a></h2>
<p>缓存的意义在于快速查询提升系统性能，可以灵活控制缓存的一致性
8.0之前让DBA一直禁用的mysql缓存的限制：</p>
<ol>
<li>MySQL基本没有手段灵活的管理缓存失效和生效，尤其对于频繁更新的表；</li>
<li>SQL必须完全一致才会导致cache命中；</li>
<li>为了节省内存空间，太大的result set不会被cache(query_cache_limit)；</li>
<li>MySQL缓存在分库分表环境下是不起作用的；</li>
<li>执行SQL里有触发器，自定义函数时，MySQL缓存也是不起作用的；</li>
<li>在表的结构或数据发生改变时，基于该表相关cache.立即全部失效。</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于MySQL的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/mysql">MySQL</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/3"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">随笔</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weibo.com/u/5489560765" target="_blank" rel="noopener noreferrer" class="footer__link-item">我的微博<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.csdn.net/m0_46464597?type=blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">CSDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">我的博客</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/friends">友链</a></li><li class="footer__item"><a href="https://github.com/Jachen99" target="_blank" rel="noopener noreferrer" class="footer__link-item">follow me on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
                <img src="/img/logo.svg" alt="Logo" style="height: 38px; vertical-align: middle;">
                    © 2025 jachen99.github.io, Inc. Built with 
                <a href="https://docusaurus.io/" target="_blank" style="text-decoration: none;">Docusaurus</a>.
                <a href="https://notbyai.fyi/cn/" target="_blank">
                    <img src="/img/noai.svg" alt="No AI" style="height: 50px; vertical-align: middle; float: right;">
                </a>
            </div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.1">
<title data-rh="true">Blog | 软件一班季同学的世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jachen99.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jachen99.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jachen99.github.io/blog"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 软件一班季同学的世界"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jachen99.github.io/blog"><link data-rh="true" rel="alternate" href="https://jachen99.github.io/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://jachen99.github.io/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://jachen99.github.io/blog","mainEntityOfPage":"https://jachen99.github.io/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-introduction-of-zero-copy-technology","mainEntityOfPage":"https://jachen99.github.io/blog/product-introduction-of-zero-copy-technology","url":"https://jachen99.github.io/blog/product-introduction-of-zero-copy-technology","headline":"探究零拷贝技术","name":"探究零拷贝技术","description":"背景：RocketMQ是阿里团队研发并开源的消息中间件，它延续了kafka的很多优点，例如高性能，为了研究RocketMQ究竟是如何做到高性能的呢？零拷贝技术就是一个重要的原因。","datePublished":"2024-10-10T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-nginx-reload","mainEntityOfPage":"https://jachen99.github.io/blog/product-nginx-reload","url":"https://jachen99.github.io/blog/product-nginx-reload","headline":"探究Nginx优雅reload的细节","name":"探究Nginx优雅reload的细节","description":"背景：我们知道在Ngnix的conf配置文件之后,不能kill掉matser重新启动Ngnix服务器，而是需要执行 nginx -s reload命令，在 不停止服务始终在处理新的请求的同时把 nginx 的配置文件平滑的把旧的 nginx.conf 配置更新为新的 nginx.conf 配置。那么这是为什么呢？","datePublished":"2024-10-02T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel","mainEntityOfPage":"https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel","url":"https://jachen99.github.io/blog/advanced-data-processing-with-easyexcel","headline":"EasyExcel中的数据第一行获取问题及解决方案详解","name":"EasyExcel中的数据第一行获取问题及解决方案详解","description":"EasyExcel中的数据第一行获取问题及解决方案详解","datePublished":"2024-07-09T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-xxl-job","mainEntityOfPage":"https://jachen99.github.io/blog/product-xxl-job","url":"https://jachen99.github.io/blog/product-xxl-job","headline":"xxl-job分布式调度实践","name":"xxl-job分布式调度实践","description":"起因：传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。","datePublished":"2024-02-14T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-market-forecasting-system","mainEntityOfPage":"https://jachen99.github.io/blog/product-market-forecasting-system","url":"https://jachen99.github.io/blog/product-market-forecasting-system","headline":"售电市场智能分析预测系统","name":"售电市场智能分析预测系统","description":"该系统针对售电市场智能分析需求，支持行业分类和售电数据分析。","datePublished":"2023-10-12T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-logic-delete","mainEntityOfPage":"https://jachen99.github.io/blog/product-logic-delete","url":"https://jachen99.github.io/blog/product-logic-delete","headline":"MongoDB实现逻辑删除","name":"MongoDB实现逻辑删除","description":"背景：我们对MongoDB采用的逻辑删除的方案，与MySQL完全不同。 得益于MongoDB擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若MySQL采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。","datePublished":"2023-06-28T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-easyexcel","mainEntityOfPage":"https://jachen99.github.io/blog/product-easyexcel","url":"https://jachen99.github.io/blog/product-easyexcel","headline":"实用框架EasyExcel","name":"实用框架EasyExcel","description":"背景：EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等","datePublished":"2023-04-20T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-system-forecasting-electricity-demand","mainEntityOfPage":"https://jachen99.github.io/blog/product-system-forecasting-electricity-demand","url":"https://jachen99.github.io/blog/product-system-forecasting-electricity-demand","headline":"海量用户用电需求分析预测系统","name":"海量用户用电需求分析预测系统","description":"该系统旨在分析和预测海量用户的用电需求，支持多维度的市场跟踪、电量预警和报表生成。","datePublished":"2023-04-06T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-spring-security-microservices","mainEntityOfPage":"https://jachen99.github.io/blog/product-spring-security-microservices","url":"https://jachen99.github.io/blog/product-spring-security-microservices","headline":"spring-security整合微服务实践","name":"spring-security整合微服务实践","description":"起因：随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。","datePublished":"2023-03-15T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://jachen99.github.io/blog/product-management-system","mainEntityOfPage":"https://jachen99.github.io/blog/product-management-system","url":"https://jachen99.github.io/blog/product-management-system","headline":"SQL优化积累笔记","name":"SQL优化积累笔记","description":"背景：因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去。","datePublished":"2023-03-02T00:00:00.000Z","author":{"@type":"Person","name":"季冠臣","description":"后端研发工程师","url":"https://github.com/jachen99","image":"https://github.com/jachen99.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="软件一班季同学的世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="软件一班季同学的世界 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8766fa05.css">
<script src="/assets/js/runtime~main.b6c35c6e.js" defer="defer"></script>
<script src="/assets/js/main.3f61464f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">我的空间</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/category/tutorial---basics">日记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a><a href="https://github.com/Jachen99/Jachen99.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/product-introduction-of-zero-copy-technology">探究零拷贝技术</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/product-nginx-reload">探究Nginx优雅reload的细节</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/advanced-data-processing-with-easyexcel">EasyExcel中的数据第一行获取问题及解决方案详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/product-xxl-job">xxl-job分布式调度实践</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/product-market-forecasting-system">售电市场智能分析预测系统</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-introduction-of-zero-copy-technology">探究零拷贝技术</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-10-10T00:00:00.000Z">2024年10月10日</time> · <!-- -->阅读需 3 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>RocketMQ是阿里团队研发并开源的消息中间件，它延续了kafka的很多优点，例如高性能，为了研究RocketMQ究竟是如何做到高性能的呢？零拷贝技术就是一个重要的原因。</em></p>
<p>参考文章 <a href="https://github.com/0voice/linux_kernel_wiki/blob/main/%E6%96%87%E7%AB%A0/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%EF%BC%8C%E5%BD%BB%E5%BA%95%E4%BA%86%E8%A7%A3%EF%BC%8C%E9%9B%B6%E6%8B%B7%E8%B4%9DZero-Copy%E6%8A%80%E6%9C%AF.md" target="_blank" rel="noopener noreferrer">https://github.com/0voice/linux_kernel_wiki/blob/main/%E6%96%87%E7%AB%A0/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%EF%BC%8C%E5%BD%BB%E5%BA%95%E4%BA%86%E8%A7%A3%EF%BC%8C%E9%9B%B6%E6%8B%B7%E8%B4%9DZero-Copy%E6%8A%80%E6%9C%AF.md</a></p>
<p>高效原因</p>
<ul>
<li>
<p>CommitLog顺序写, 存储了MessagBody、message key、tag等信息</p>
</li>
<li>
<p>ConsumeQueue随机读 + 操作系统的PageCache + 零拷贝技术ZeroCopy</p>
<ul>
<li>
<p>零拷贝技术</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read(file, tmp_buf, len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(socket, tmp_buf, len);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>例子：将一个File读取并发送出去（Linux有两个上下文，内核态，用户态）</p>
<ul>
<li>File文件的经历了4次copy<!-- -->
<ul>
<li>调用read,将文件拷贝到了kernel内核态</li>
<li>CPU控制 kernel态的数据copy到用户态</li>
<li>调用write时，user态下的内容会copy到内核态的socket的buffer中</li>
<li>最后将内核态socket buffer的数据copy到网卡设备中传送</li>
</ul>
</li>
<li>缺点：增加了上下文切换、浪费了2次无效拷贝(即步骤2和3)</li>
</ul>
</li>
<li>
<p>ZeroCopy：</p>
<ul>
<li>请求kernel直接把disk的data传输给socket，而不是通过应用程序传输。Zero copy大大提高了应用程序的性能，减少不必要的内核缓冲区跟用户缓冲区间的拷贝，从而减少CPU的开销和减少了kernel和user模式的上下文切换，达到性能的提升</li>
<li>对应零拷贝技术有mmap及sendfile<!-- -->
<ul>
<li>mmap:小文件传输快<!-- -->
<ul>
<li>RocketMQ 选择这种方式，mmap+write 方式，小块数据传输，效果会比 sendfile 更好</li>
</ul>
</li>
<li>sendfile:大文件传输比mmap快</li>
</ul>
</li>
<li>Java中的TransferTo()实现了Zero-Copy</li>
<li>应用：Kafka、Netty、RocketMQ等都采用了零拷贝技术</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>原始的拷贝技术：</p>
<p><img decoding="async" loading="lazy" alt="image-20230128234721451" src="/assets/images/image-20230128234721451-dd4af67b7a2fa7c9784cf766e100dfae.png" width="805" height="562" class="img_ev3q"></p>
<p>零拷贝技术：</p>
<p><img decoding="async" loading="lazy" alt="image-20230128234745085" src="/assets/images/image-20230128234745085-207f8aae1e516506317e609e36e7f1d5.png" width="761" height="492" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于RocketMQ的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/rocketmq">RocketMQ</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-nginx-reload">探究Nginx优雅reload的细节</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-10-02T00:00:00.000Z">2024年10月2日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>我们知道在Ngnix的conf配置文件之后,不能kill掉matser重新启动Ngnix服务器，而是需要执行 nginx -s reload命令，在 不停止服务始终在处理新的请求的同时把 nginx 的配置文件平滑的把旧的 nginx.conf 配置更新为新的 nginx.conf 配置。那么这是为什么呢？</em></p>
<p>这样一个功能对于 nginx 非常有必要，但是有时候我们会发现在执行 <code>nginx -s reload</code> 命令后，worker 子进程的数量会变多了，这是因为老的配置运行的 worker 进程长时间没有退出，当使用 stream 做四层反向代理的时候，可能这种场景会更多。</p>
<p>那么下面我们通过分析 nginx 的 reload 流程，来探究下 nginx 到底做了些什么？所谓优雅的退出和立即退出有什么区别？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reload流程">reload流程<a href="#reload流程" class="hash-link" aria-label="reload流程的直接链接" title="reload流程的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20230129234025673" src="/assets/images/image-20230129234025673-408e9591c6b983445a857dc17ae854f4.png" width="867" height="594" class="img_ev3q"></p>
<p>第一步在修改好 nginx 的配置文件 nginx.conf 后，向 master 进程发送 HUP 信号，这实际上和我们在命令行执行 <code>nginx -s reload</code> 命令效果是一样的。</p>
<p>那么 master 进程在收到 HUP 信号以后，会在第二步检查我们的配置文件语法是否正确，也就是说我们并不一定非要在 nginx -s reload 前执行 nginx -t 检验下语法是否正确，因为在第二步 nginx 的 master 进程一定会执行这个步骤。</p>
<p>在 nginx 的配置语法全部正确以后，master 进程会打开新的监听端口，为什么要在 master 进程中打开新的监听端口？因为我们可能在 nginx.conf 中会引入新的例如 443 或者之前我们没有打开的的监听端口，而所有 worker 进程是 master 进程 的子进程，子进程会继承父进程所有已经打开的端口，这是 linux 操作系统定义的，所以第三步，我们 master 进程打开了可能引入的新的监听端口。</p>
<p>接下来 mster 进程会用新的 nginx.conf 配置文件来启动新的 worker 子进程，那么老的 worker 子进程会怎么样呢？</p>
<p>我们会在第五步在启动新的 worker 子进程以后，由 master 进程再向老 worker 子进程发送 QUIT 信号，QUIT 信号和 TERM，INT 信号是不一样的，QUIT 信号是请优雅地关闭子进程，这时候需要关注顺序，因为 nginx 需要保证平滑，所以要先启动新的 worker 子进程，再向老的 worker 子进程发送 QUIT 信号。</p>
<p>那么老的 master 子进程收到 QUIT 信号后，首先关闭监听句柄，也就是说这个时候新的连接只会到新的 worker 子进程，所以虽然他们之间有时间差，但是时间是非常快速的，那么关闭监听句柄后，处理完当前连接后就结束进程。</p>
<p>下面看 reload 不停机载入新配置的图示。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reload-不停机载入新配置">reload 不停机载入新配置<a href="#reload-不停机载入新配置" class="hash-link" aria-label="reload 不停机载入新配置的直接链接" title="reload 不停机载入新配置的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="1356806-20191216111255642-526956790" src="/assets/images/1356806-20191216111255642-526956790-c3d6cf140a54e7b57d0e02248be04cb7.png" width="2016" height="1020" class="img_ev3q"></p>
<p>master 进程上原先有四个绿色的 worker 子进程，它们使用了老的配置，当我们更改了 nginx.conf 配置文件后，向 master 发送 SIGHUP 信号或者执行 reload 命令， 然后 master 会用新的配置文件启动四个新的黄色 worker 子进程，此时是四个老的绿色 worker 子进程和四个新的黄色的 worker 子进程是并存的。那么老的 worker 子进程在正常的情况下会在处理已经建立好的连接上的请求之后关闭这个连接，哪怕这个连接是 keeplive 请求也会正常关闭。</p>
<p>但是异常情况，如果有一些请求出现问题，客户端长时间无法处理，那么就会导致这个请求长时间停留在这个 worker 子进程当中，那么这个 worker 子进程会长时间存在，因为新的连接已经跑在黄色的 worker 子进程中，所以影响并不会很大，唯一会影响的就是绿色的 worker 子进程会长时间存在，但也只影响已存在的连接，不会影响新的连接。</p>
<p>我们有什么办法处理呢？在新版本中提供了一个新的配置 worker_shutdown_timeout，也就是说最长等待多长时间，这样 master 进程启动新的黄色 worker 进程之后，如果老的 worker 进程一直没有退出，时间到了之后会强制把老的 worker 进程退出掉。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>本文主要讲解了 Nginx 平滑升级新的配置文件的流程，在我们了解了优雅关闭 worker 子进程和启动新配置的 worker 子进程流程间的关系后，我们可以更好地处理罕见的异常场景。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于Nginx的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/nginx">Nginx</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/advanced-data-processing-with-easyexcel">EasyExcel中的数据第一行获取问题及解决方案详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-07-09T00:00:00.000Z">2024年7月9日</time> · <!-- -->阅读需 8  分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="easyexcel中的数据第一行获取问题及解决方案详解">EasyExcel中的数据第一行获取问题及解决方案详解<a href="#easyexcel中的数据第一行获取问题及解决方案详解" class="hash-link" aria-label="EasyExcel中的数据第一行获取问题及解决方案详解的直接链接" title="EasyExcel中的数据第一行获取问题及解决方案详解的直接链接">​</a></h2>
<p>在Java开发中，处理Excel文件是一个常见的需求。EasyExcel作为一个流行的Excel操作库，提供了方便而高效的API来读写Excel文件。然而，有时会遇到数据第一行被误读为表头的问题，特别是在Excel文件的第一行不是标准表头而是实际数据时，这一问题显得尤为突出。本文将详细讨论这一问题的根本原因，并提供一种有效的解决方案。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-easyexcel简介">1. EasyExcel简介<a href="#1-easyexcel简介" class="hash-link" aria-label="1. EasyExcel简介的直接链接" title="1. EasyExcel简介的直接链接">​</a></h3>
<p>EasyExcel是阿里巴巴开源的一款Java操作Excel的工具库，它提供了强大的功能，支持大数据量的读写操作，并且提供了丰富的样式和格式处理功能，适用于各种场景下的Excel文件处理需求。你可以访问 EasyExcel 的官方 GitHub 页面获取更多的资料和下载： <a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/easyexcel</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-问题描述">2. 问题描述<a href="#2-问题描述" class="hash-link" aria-label="2. 问题描述的直接链接" title="2. 问题描述的直接链接">​</a></h3>
<p>在使用EasyExcel读取Excel文件时，经常会出现第一行数据被错误地识别为表头的情况。这一问题的根本原因在于EasyExcel在某些情况下无法正确识别Excel文件中数据行和表头行的区分，特别是当Excel文件结构比较复杂或者存在特定格式时，EasyExcel的默认解析逻辑可能会出现偏差。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-解决方案详解">3. 解决方案详解<a href="#3-解决方案详解" class="hash-link" aria-label="3. 解决方案详解的直接链接" title="3. 解决方案详解的直接链接">​</a></h3>
<p>为了解决数据第一行获取问题，我们可以采取以下步骤来调整和优化EasyExcel的读取操作，确保能够正确获取实际数据行而非表头行：</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="方案1手动指定数据起始行">方案1：手动指定数据起始行<a href="#方案1手动指定数据起始行" class="hash-link" aria-label="方案1：手动指定数据起始行的直接链接" title="方案1：手动指定数据起始行的直接链接">​</a></h5>
<p>在读取Excel文件时，手动指定数据的起始行，而不依赖EasyExcel的自动识别。这可以通过设置<code>headRowNumber</code>来实现，明确告知EasyExcel从第几行开始读取数据。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ExcelReaderBuilder readBuilder = EasyExcel.read(inputStream, ExcelData.class, new ExcelDataListener())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .sheet().headRowNumber(2) // 指定从第3行开始读取数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .doRead();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述代码中，通过<code>headRowNumber(2)</code>指定从第3行开始读取数据，避免将第一行误读为表头。</p>
<p><strong>数据处理逻辑中排除表头行</strong></p>
<p>在实际数据处理逻辑中，可以通过逻辑判断排除表头行，确保只处理实际的数据行。例如，在<code>invoke</code>方法中可以添加逻辑判断：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void invoke(ExcelData data, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context.readRowHolder().getRowIndex() &gt; 0) { // 跳过表头行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理实际数据逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过<code>context.readRowHolder().getRowIndex() &gt; 0</code>判断当前行索引大于0时才处理数据，跳过表头行的处理。</p>
<p><strong>使用后处理器进行二次处理</strong></p>
<p>EasyExcel提供了后处理器（Handler）机制，在数据读取完成后可以进行二次处理。可以在<code>doAfterAllAnalysed</code>方法中对数据进行进一步处理或过滤，确保最终数据的准确性和完整性。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void doAfterAllAnalysed(AnalysisContext context) { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 数据处理完成后的逻辑 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processData(dataList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title=" 复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述代码中，可以在<code>doAfterAllAnalysed</code>方法中调用<code>processData</code>方法，对数据进行进一步的处理或者存储操作。</p>
<p><strong>示例代码</strong></p>
<p>以下是一个完整的示例代码，展示了如何使用EasyExcel读取Excel文件并处理数据，同时避免数据第一行被误读为表头的问题：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.excel.EasyExcel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.excel.context.AnalysisContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.excel.event.AnalysisEventListener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.excel.read.builder.ExcelReaderBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.FileInputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.InputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExcelReaderExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String fileName = &quot;path/to/your/excel/file.xlsx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InputStream inputStream = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputStream = new FileInputStream(fileName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExcelReaderBuilder readBuilder = EasyExcel.read(inputStream, ExcelData.class, new ExcelDataListener());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readBuilder.sheet().headRowNumber(2); // 指定从第3行开始读取数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readBuilder.doRead();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (inputStream != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inputStream.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class ExcelDataListener extends AnalysisEventListener&lt;ExcelData&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private List&lt;ExcelData&gt; dataList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void invoke(ExcelData data, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (context.readRowHolder().getRowIndex() &gt; 0) { // 跳过表头行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 处理实际数据逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataList.add(data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void doAfterAllAnalysed(AnalysisContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 数据处理完成后的逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processData(dataList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void processData(List&lt;ExcelData&gt; dataList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理  数据的具体逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ExcelData data : dataList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println(data.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class ExcelData {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Excel中的数据字段对应的Java属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String column1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String column2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略getter和setter方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="方案2第一行数据读在表头单独处理">方案2：第一行数据读在表头单独处理<a href="#方案2第一行数据读在表头单独处理" class="hash-link" aria-label="方案2：第一行数据读在表头单独处理的直接链接" title="方案2：第一行数据读在表头单独处理的直接链接">​</a></h5>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SneakyThrows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public byte[] exportExcel(List&lt;String&gt; sheet1Ids, List&lt;String&gt; sheet2Ids, List&lt;String&gt; sheet3Ids, String startDate, String endDate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 读取模版</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         InputStream inputStream = templateFileService.getTemplateInputStreamByPath(dataComparisonFileResource.getPath())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelWriter excelWriter = EasyExcel.write(outputStream)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .withTemplate(inputStream)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .autoCloseStream(true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .registerWriteHandler(new CustomSheet1CellWriteHandler())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写入表1 数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;LfDispatchDataComparisonGridOperationVo&gt; sheet1Data = getGridOperationData(sheet1Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.writerSheet1(excelWriter, sheet1Data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写入表2 数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;LfDispatchDataComparisonGwEnergyVo&gt; sheet2Data = getGwEnergyData(sheet2Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.writerSheet2(excelWriter, sheet2Data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写入表3 数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;LfDispatchDataComparisonNewEnergyOperationVo&gt; sheet3Data = getNewEnergyOperationData(sheet3Ids, startDate, endDate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.writerSheet3(excelWriter, sheet3Data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 生成excel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        excelWriter.finish();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 确保所有内容都写入输出流中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = outputStream.toByteArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 自定义sheet1的cell  样式 用于标记 负荷占比、电量占比 大于1的单元格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static class CustomSheet1CellWriteHandler implements WorkbookWriteHandler, CellWriteHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 处理第一行数据 (easyExcel工具的bug 会将第一行数据读在表头)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context 上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCellDispose(CellWriteHandlerContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.getRowIndex() == 2 &amp;&amp; (context.getColumnIndex() == 14 || context.getColumnIndex() == 15)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理第第一个sheet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Sheet sheet = context.getRow().getSheet().getWorkbook().getSheetAt(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Row row = sheet.getRow(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Cell cell14 = row.getCell(14);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Cell cell15 = row.getCell(15);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 应用红色样式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applyRedStyleToCells(cell14, cell15);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 处理除了第一行以外的其他数据行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context 上下文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterWorkbookDispose(WorkbookWriteHandlerContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Workbook workbook = context.getWriteWorkbookHolder().getWorkbook();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 只处理 sheet1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Sheet sheet = workbook.getSheetAt(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applyRedStyleToSheet(sheet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 按列标记红色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sheet 工作表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void applyRedStyleToSheet(Sheet sheet) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Row row : sheet) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applyRedStyleToCells(row.getCell(14), row.getCell(15));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 对指定的单元格应用红色字体样式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param cells 需要应用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">红色样式的单元格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void applyRedStyleToCells(Cell... cells) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Cell cell : cells) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cell != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Workbook workbook = cell.getSheet().getWorkbook();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                CellStyle redStyle = workbook.createCellStyle();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Font redFont = workbook.createFont();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                redFont.setColor(IndexedColors.RED.getIndex());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                redStyle.setFont(redFont);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cell.setCellStyle(redStyle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-结论">5. 结论<a href="#5-结论" class="hash-link" aria-label="5. 结论的直接链接" title="5. 结论的直接链接">​</a></h3>
<p>我总结：建议不再使用EasyExcel工具。</p>
<hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于EasyExcel的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/easy-excel">EasyExcel</a></li><li class="tag_QGVx"><a title="关于数据处理相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/data-processing">数据处理</a></li><li class="tag_QGVx"><a title="关于软件开发过程中的Bug" class="tag_zVej tagRegular_sFm0" href="/blog/tags/my-bug">我的Bug</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-xxl-job">xxl-job分布式调度实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-02-14T00:00:00.000Z">2024年2月14日</time> · <!-- -->阅读需 16 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>起因</strong>：<em>传统的定时任务Timer、Quartz等存在很多缺陷，不支持集群、不支持统计、没有管理的平台、也没有报警、监控等等。因此我们要使用分布式的调度系统，去填补这一系列缺陷，之前我们的系统用到了rabbitMQ消息队列去用于分布式任务调度、事件驱动等场景。通过RabbitMQ，任务调度系统可以将任务分发到多个节点，并获取任务执行结果。但是它也有弊端，就是没有一个完整的任务调度平台，不能很好的对任务执行情况进行监控和管理，所以最后选择了XXL-Job去升级医院系统的定时给就诊人发送消息等功能。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="#技术选型" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官方文档">官方文档<a href="#官方文档" class="hash-link" aria-label="官方文档的直接链接" title="官方文档的直接链接">​</a></h3>
<p>xxl-job：<a href="https://github.com/xuxueli/xxl-job" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job</a></p>
<p>elastic-job：<a href="https://shardingsphere.apache.org/elasticjob/" target="_blank" rel="noopener noreferrer">https://shardingsphere.apache.org/elasticjob/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job-与--elastic-job对比图">XXL-JOB 与  elastic-job对比图<a href="#xxl-job-与--elastic-job对比图" class="hash-link" aria-label="XXL-JOB 与  elastic-job对比图的直接链接" title="XXL-JOB 与  elastic-job对比图的直接链接">​</a></h3>
<table><thead><tr><th>对比项</th><th>XXL-JOB</th><th>elastic-job</th></tr></thead><tbody><tr><td>并行调度</td><td>调度系统多线程并行</td><td>任务分片的方式并行</td></tr><tr><td>弹性扩容</td><td>使用Quartz基于数据库分布式功能</td><td>通过zookeeper保证</td></tr><tr><td>高可用</td><td>通过DB锁保证</td><td>通过zookeeper保证</td></tr><tr><td>阻塞策略</td><td>单机串行/丢弃后续的调度/覆盖之前的调度</td><td>执行超过zookeeper的session timeout时间的话，会被清除，重新进行分片</td></tr><tr><td>动态分片策略</td><td>以执行器为维度进行分片、支持动态的扩容</td><td>平均分配/作业名hash分配/自定义策略</td></tr><tr><td>失败处理策略</td><td>失败告警/失败重试</td><td>执行完毕后主动获取未分配分片任务 服务器下线后主动寻找可以用的服务器执行任务</td></tr><tr><td>监控</td><td>支持</td><td>支持</td></tr><tr><td>日志</td><td>支持</td><td>支持</td></tr></tbody></table>
<ul>
<li>XXL-Job和Elastic-Job都具有广泛的用户基础和完善的技术文档，都可以满足定时任务的基本功能需求</li>
<li>xxl-job侧重在业务实现简单和管理方便，容易学习，失败与路由策略丰富, 推荐使用在用户基数相对较少，服务器的数量在一定的范围内的场景下使用</li>
<li>elastic-job关注的点在数据，添加了弹性扩容和数据分片的思路，更方便利用分布式服务器的资源, 但是学习难度较大，推荐在数据量庞大，服务器数量多的时候使用</li>
</ul>
<p><em>综合考虑，最后我们选择了xxl-job这一解决方法，下面是一个小demo，用于整合xxl-job到spring微服务项目中得以应用的最佳实践。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是xxl-job">什么是XXL-Job<a href="#什么是xxl-job" class="hash-link" aria-label="什么是XXL-Job的直接链接" title="什么是XXL-Job的直接链接">​</a></h3>
<ul>
<li>XXL-JOB<!-- -->
<ul>
<li>大众  点评的员工徐雪里在15年发布的分布式任务调度平台，是轻量级的分布式任务调度框架，目标是开发迅速、简单、清理、易扩展; 老版本是依赖quartz的定时任务触发，在v2.1.0版本开始 移除quartz依赖</li>
<li>官网地址：<a href="https://www.xuxueli.com/xxl-job/" target="_blank" rel="noopener noreferrer">https://www.xuxueli.com/xxl-job/</a></li>
<li>GitHub地址：<a href="https://github.com/xuxueli/xxl-job/" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job/</a></li>
</ul>
</li>
<li>xxl-job的设计思想<!-- -->
<ul>
<li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li>
<li>将任务抽象成分散的JobHandler，交由“执行器”统一管理</li>
<li>“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li>
<li>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="官网架构图">官网架构图<a href="#官网架构图" class="hash-link" aria-label="官网架构图的直接链接" title="官网架构图的直接链接">​</a></h3>
<ul>
<li>调度中心<!-- -->
<ul>
<li>负责管理调度的信息，按照调度的配置来发出调度请求</li>
<li>支持可视化、简单的动态管理调度信息，包括新建、删除、更新等，这些操作都会实时生效，同时也支持监控调度结果以及执行日志。</li>
</ul>
</li>
<li>执行器<!-- -->
<ul>
<li>负责接收请求并且执行任务的逻辑。任务模块专注于任务的执行操作等等，使得开发和维护更加的简单与高效</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://file.xdclass.net/note/2022/81-XXL-JOB/img/image-20220519181542821.png" alt="image-20220519181542821" class="img_ev3q"></p>
<ul>
<li>XXL-Job具有哪些特性<!-- -->
<ul>
<li>调度中心HA（中心式）：调度采用了中心式进行设计，“调度中心”支持集群部署，可保证调度中心HA</li>
<li>执行器HA（分布式）：任务分布式的执行，任务执行器支持集群部署，可保证任务执行HA</li>
<li>触发策略：有Cron触发、固定间隔触发、固定延时触发、API事件触发、人工触发、父子任务触发</li>
<li>路由策略：执行器在集群部署的时候提供了丰富的路由策略，如：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用LFU、最久未使用LRU、故障转移等等</li>
<li>故障转移：如果执行器集群的一台机器发生故障，会自动切换到一台正常的执行器发送任务调度</li>
<li>Rolling实时日志的监控：支持rolling方式查看输入的完整执行日志</li>
<li>脚本任务：支持GLUE模式开发和运行脚本任务，包括Shell、python、node.js、php等等类型脚本</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速部署">快速部署<a href="#快速部署" class="hash-link" aria-label="快速部署的直接链接" title="快速部署的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="流程图">流程图：<a href="#流程图" class="hash-link" aria-label="流程图：的直接链接" title="流程图：的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214195315186" src="/assets/images/image-20230214195315186-428690aea674f569b2ab260bae532441.png" width="838" height="707" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境">环境：<a href="#环境" class="hash-link" aria-label="环境：的直接链接" title="环境：的直接链接">​</a></h3>
<p>Maven3+、jdk1.8+、mysql5.7+</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载链接">下载链接：<a href="#下载链接" class="hash-link" aria-label="下载链接：的直接链接" title="下载链接：的直接链接">​</a></h3>
<p><a href="https://github.com/xuxueli/xxl-job.git" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job.git</a>  版本：2.3.0</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="运行数据库脚本">运行数据库脚本<a href="#运行数据库脚本" class="hash-link" aria-label="运行数据库脚本的直接链接" title="运行数据库脚本的直接链接">​</a></h3>
<p><code>/xxl-job/doc/db/tables_xxl_job.sql</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调度中心">调度中心<a href="#调度中心" class="hash-link" aria-label="调度中心的直接链接" title="调度中心的直接链接">​</a></h3>
<p><code>调度中心项目：xxl-job-admin</code> 修改该模块下的配置文件并启动server</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.port=8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.servlet.context-path=/xxl-job-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### xxl-job, datasource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.username=root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.password=123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### xxl-job, access token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xxl.job.accessToken=jiguanchen.space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ui界面">UI界面<a href="#ui界面" class="hash-link" aria-label="UI界面的直接链接" title="UI界面的直接链接">​</a></h3>
<ul>
<li>运行报表<!-- -->
<ul>
<li>以图形化来展示了整体的任务执行情况<!-- -->
<ul>
<li>任务数量：能够看到调度中心运行的任务数量</li>
<li>调度次数：调度中心所触发的调度次数</li>
<li>执行器数量：在整个调度中心中，在线的执行器数量有多少</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214195933783" src="/assets/images/image-20230214195933783-ffa529f61bf3bd47ceee76cee3a5f845.png" width="1920" height="991" class="img_ev3q"></p>
<ul>
<li>任务管理（配置执行任务）<!-- -->
<ul>
<li>示例执行器：所  用到的执行器</li>
<li>任务描述：概述该任务是做什么的</li>
<li>路由策略：<!-- -->
<ul>
<li>第一个：选择第一个机器</li>
<li>最后一个：选择最后一个机器</li>
<li>轮询：依次选择执行</li>
<li>随机：随机选择在线的机器</li>
<li>一致性HASH：每个任务按照Hash算法固定选择某一台机器，并且所有的任务均匀散列在不同的机器上</li>
<li>最不经常使用：使用频率最低的机器优先被使用</li>
<li>最近最久未使用：最久未使用的机器优先被选举</li>
<li>故障转移：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标的执行器并且会发起任务调度</li>
<li>忙碌转移：按照顺序来依次进行空闲检测，第一个空闲检测成功的机器会被选定为目标群机器，并且会发起任务调度</li>
<li>分片广播：广播触发对于集群中的所有机器执行任务，同时会系统会自动传递分片的参数</li>
</ul>
</li>
<li>Cron：执行规则</li>
<li>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等</li>
<li>JobHandler：定义执行器的名字</li>
<li>阻塞处理策略：<!-- -->
<ul>
<li>单机串行：新的调度任务在进入到执行器之后，该调度任务进入FIFO队列，并以串行的方式去进行</li>
<li>丢弃后续调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，本次的调度任务请求就会被丢弃掉，并且标记为失败</li>
<li>覆盖之前的调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，就会终止掉当前正在运行的调度任务，并且清空队列，运行新的调度任务。</li>
</ul>
</li>
<li>子任务ID：输入子任务的任务id，可填写多个</li>
<li>任务超时时间：添加任务超时的时候，单位s，设置时间大于0的时候就会生效</li>
<li>失败 重试次数：设置失败重试的次数，设置时间大于0的时候就会生效</li>
<li>负责人：填写该任务调度的负责人</li>
<li>报警邮件：出现报警，则发送邮件</li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20230214200224214" src="/assets/images/image-20230214200224214-886206b0dd0a466984fc0206dfe6f442.png" width="1603" height="484" class="img_ev3q"></p>
<p>创建任务：</p>
<p><img decoding="async" loading="lazy" alt="image-20230214200338357" src="/assets/images/image-20230214200338357-198452a996e4e5e0853b5b555a1bdabd.png" width="1207" height="874" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="后台服务整合xxl-job">后台服务整合xxl-job<a href="#后台服务整合xxl-job" class="hash-link" aria-label="后台服务整合xxl-job的直接链接" title="后台服务整合xxl-job的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="yml配置">yml配置<a href="#yml配置" class="hash-link" aria-label="yml配置的直接链接" title="yml配置的直接链接">​</a></h3>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#  xxl-job任务调度配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">xxl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin  </span><span class="token comment" style="color:#999988;font-style:italic">#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">accessToken</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jiguanchen.space  </span><span class="token comment" style="color:#999988;font-style:italic">#执行器token，非空时启用 xxl-job, access token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">appname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yygh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">order  </span><span class="token comment" style="color:#999988;font-style:italic"># 执行器app名称,和控制台那边配置一样的名称，不然注册不上去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6666</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 执行器的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">logpath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./data/logs/xxl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job/executor  </span><span class="token comment" style="color:#999988;font-style:italic"># 执行器日志文件存储路径，需要对该路径拥有读写权限；为空则使用默认路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">logretentiondays</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 执行器日志保存天数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># [选填]执行器IP ：默认为空表示自动获取IP（即springboot容器的ip和端口，可以自动获取，也可以指定），</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ip</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># [选填]执行器注册：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      address</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加pom文件">添加pom文件<a href="#添加pom文件" class="hash-link" aria-label="添加pom文件的直接链接" title="添加pom文件的直接链接">​</a></h3>
<div class="language-pom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-pom codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- xxl_job分布式调度 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.3.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加config配置类">添加config配置类<a href="#添加config配置类" class="hash-link" aria-label="添加config配置类的直接链接" title="添加config配置类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.order.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2023/2/14 15:46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class XxlJobConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.admin.addresses}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String adminAddresses;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.executor.appname}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String appName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.executor.ip}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String ip;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.executor.port}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.accessToken}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.executor.logpath}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String logPath;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${xxl.job.executor.logretentiondays}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int logRetentionDays;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public XxlJobSpringExecutor xxlJobExecutor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setAppname(appName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setIp(ip);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setPort(port);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setLogPath(logPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return xxlJobSpringExecutor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>添加hander处理器</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.order.handler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2024/2/14 15:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyJobHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RabbitService rabbitService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderInfoMapper orderInfoMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 就诊提醒的handler方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param param  null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return  ReturnT&lt;String&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @XxlJob(value = &quot;demoJobHandler1&quot;,init = &quot;init&quot;,destroy = &quot;destroy&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ReturnT&lt;String&gt; execute(String param){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;execute方法执行了 ====》 &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取查询的时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DateTime dateTime = new DateTime().plusDays(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String dateString = dateTime.toString(&quot;yyyy-MM-dd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date date = new DateTime(dateString).toDate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = new LambdaQueryWrapper&lt;OrderInfo&gt;(){{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eq(OrderInfo::getReserveDate,date);  // 查询就诊日期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ne(OrderInfo::getOrderStatus, OrderStatusEnum.CANCLE.getStatus());  // 查询没有取消的订单</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;OrderInfo&gt; orderInfoList = orderInfoMapper.selectList(queryWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(OrderInfo orderInfo : orderInfoList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 短信提示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MsmVo msmVo = new MsmVo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msmVo.setPhone(orderInfo.getPatientPhone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 结合mq快速响应其他模块 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rabbitService.sendMessage(MqConst.EXCHANGE_DIRECT_MSM, MqConst.ROUTING_MSM_ITEM, msmVo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ReturnT.SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void init(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;MyJobHandler init &gt;&gt;&gt;&gt;&gt; &quot; + true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String jobParam = XxlJobHelper.getJobParam();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;jobParam = &quot; + jobParam);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="效果图">效果图<a href="#效果图" class="hash-link" aria-label="效果图的直接链接" title="效果图的直接链接">​</a></h3>
<p>完成规则内的定时任务，到指定时间向就诊人发送消息</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201137647" src="/assets/images/image-20230214201137647-78853315d90bec43fb641d44f62ae203.png" width="1498" height="329" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="image-20230214201148157" src="/assets/images/image-20230214201148157-e16f4946aad02ccb28495a972fde1805.png" width="1485" height="258" class="img_ev3q"></p>
<p>调度日志</p>
<p><img decoding="async" loading="lazy" alt="image-20230214201947305" src="/assets/images/image-20230214201947305-25fa330099f9149f279b07395476a6ec.png" width="1601" height="807" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job集群部署和高可用案例配置">XXL-Job集群部署和高可用案例配置<a href="#xxl-job集群部署和高可用案例配置" class="hash-link" aria-label="XXL-Job集群部署和高可用案例配置的直接链接" title="XXL-Job集群部署和高可用案例配置的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群架构图">集群架构图<a href="#集群架构图" class="hash-link" aria-label="集群架构图的直接链接" title="集群架构图的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203111017" src="/assets/images/image-20230214203111017-a88e2f9bec270b41851edadd8e1016ee.png" width="1408" height="733" class="img_ev3q"></p>
<p>执行器配置调度中心集群</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#调度中心部署地址,多个配置逗号分隔 &quot;http://address01,http://address02&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">xxl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">job</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8080/xxl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8081/xxl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="xxl-job处理海量数据-分片任务实操">XXL-Job处理海量数据-分片任务实操<a href="#xxl-job处理海量数据-分片任务实操" class="hash-link" aria-label="XXL-Job处理海量数据-分片任务实操的直接链接" title="XXL-Job处理海量数据-分片任务实操的直接链接">​</a></h2>
<p>我们的需求：</p>
<ul>
<li>有一个任务需要处理100W条数据，每条数据的业务逻辑处理要0.1s</li>
<li>对于普通任务来说，只有一个线程来处理 可能需要10万秒才能处理完，业务则严重受影响</li>
<li>案例：双十一大促，给1000万用户发营销短信</li>
</ul>
<p>解决思路：</p>
<ul>
<li>如果将100W数据均匀分给集群里的10台机器同时处理，</li>
<li>每台机器耗时，1万秒即可，耗时会大大缩短，也能 充分利用集群资源</li>
<li>在xxl-job里，可以配置执行器集群有10个机器，那么分片总数是10，分片序号0~9 分别对应那10台机器。</li>
<li>分片方式<!-- -->
<ul>
<li>id % 分片总数 余数是0 的，在第1个执行器上执行</li>
<li>id % 分片总数 余数是1 的，在第2个执行器上执行</li>
<li>id % 分片总数 余数是2 的，在第3个执行器上执行</li>
<li>...</li>
<li>id % 分片总数 余数是9 的，在第10个执行器上执行</li>
</ul>
</li>
</ul>
<p>其他解决方式</p>
<ul>
<li>也可以启动多个job，使用同个jobHandler,通过命令行参数控制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="选用分片广播的路由策略实操">选用分片广播的路由策略实操<a href="#选用分片广播的路由策略实操" class="hash-link" aria-label="选用分片广播的路由策略实操的直接链接" title="选用分片广播的路由策略实操的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20230214203833637" src="/assets/images/image-20230214203833637-06704b31c35de3df3a903312bd7add3b.png" width="969" height="297" class="img_ev3q"></p>
<p>主要参数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 分片广播任务	    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 当前分片数，从0开始，即执行器的序号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int shardIndex = XxlJobHelper.getShardIndex();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//总分片数，执行器集  群总机器数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int shardTotal = XxlJobHelper.getShardTotal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 业务逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/xxl-job">xxl-job</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-market-forecasting-system">售电市场智能分析预测系统</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-12T00:00:00.000Z">2023年10月12日</time> · <!-- -->阅读需 3 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端 研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>该系统针对售电市场智能分析需求，支持行业分类和售电数据分析。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-行业分类">1. 行业分类<a href="#1-行业分类" class="hash-link" aria-label="1. 行业分类的直接链接" title="1. 行业分类的直接链接">​</a></h2>
<ul>
<li>三产+居民</li>
<li>十二大+居民</li>
<li>133行业</li>
<li>631行业<!-- -->
<ul>
<li>用户角度：高耗能、重点支柱行业、细分行业（133）</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-数据来源">2. 数据来源<a href="#2-数据来源" class="hash-link" aria-label="2. 数据来源的直接链接" title="2. 数据来源的直接链接">​</a></h2>
<ul>
<li>营销1.0、营销2.0 数据</li>
<li>新增：大一报表</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-用户来源">3. 用户来源<a href="#3-用户来源" class="hash-link" aria-label="3. 用户来源的直接链接" title="3. 用户来源的直接链接">​</a></h2>
<ul>
<li>高压用户、低压台区用户（工业园区、学校）</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-售电类别">4. 售电类别<a href="#4-售电类别" class="hash-link" aria-label="4. 售电类别的直接链接" title="4. 售电类别的直接链接">​</a></h2>
<ul>
<li>全集售电价格类别信息表 <code>lf_ctrl_price</code></li>
<li>售电价格类别信息表 <code>lf_fc_sell_type</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-口径统计数据来源方式">5. 口径（统计数据来源方式）<a href="#5-口径统计数据来源方式" class="hash-link" aria-label="5. 口径（统计数据来源方式）的直接链接" title="5. 口径（统计数据来源方式）的直接链接">​</a></h2>
<ul>
<li>购售同期后口径 00</li>
<li>购售同期前口径</li>
<li>发展部</li>
<li>大一报表</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-气象数据">6. 气象数据<a href="#6-气象数据" class="hash-link" aria-label="6. 气象数据的直接链接" title="6. 气象数据的直接链接">​</a></h2>
<ul>
<li>来源：气象网，用于分析和预测</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-调度">7. 调度<a href="#7-调度" class="hash-link" aria-label="7. 调度的直接链接" title="7. 调度的直接链接">​</a></h2>
<ul>
<li>支持用电量预测和发电量调度，满足用电和负荷预测需求</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-电量和负荷">8. 电量和负荷<a href="#8-电量和负荷" class="hash-link" aria-label="8. 电量和负荷的直接链接" title="8. 电量和负荷的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="负荷">负荷<a href="#负荷" class="hash-link" aria-label="负荷的直接链接" title="负荷的直接链接">​</a></h3>
<ul>
<li>瞬时值</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="电量">电量<a href="#电量" class="hash-link" aria-label="电量的直接链接" title="电量的直接链接">​</a></h3>
<ul>
<li>累加值</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="计算指标">计算指标<a href="#计算指标" class="hash-link" aria-label="计算指标的直接链接" title="计算指标的直接链接">​</a></h3>
<ul>
<li>负荷率：平均负荷/最高负荷</li>
<li>峰谷差：最高负荷-最低负荷</li>
<li>峰谷差率：峰谷差/最高负荷</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-外部经济数据">9. 外部经济数据<a href="#9-外部经济数据" class="hash-link" aria-label="9. 外部经济数据的直接链接" title="9. 外部经济数据的直接链接">​</a></h2>
<ul>
<li>通过接入外部数据，支持多维度的数据分析和预测</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-电量分析周期">10. 电量分析周期<a href="#10-电量分析周期" class="hash-link" aria-label="10. 电量分析周期的直接链接" title="10. 电量分析周期的直接链接">​</a></h2>
<ul>
<li>支持日、周、月、季、年等多周期的电量预测和分析</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-业扩类型">11. 业扩类型<a href="#11-业扩类型" class="hash-link" aria-label="11. 业扩类型的直接链接" title="11. 业扩类型的直接链接">​</a></h2>
<ul>
<li>新增、增容、减容、暂停、销户、减容恢复、暂停恢复等</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-代理工商业">12. 代理工商业<a href="#12-代理工商业" class="hash-link" aria-label="12. 代理工商业的直接链接" title="12. 代理工商业的直接链接">​</a></h2>
<ul>
<li>支持代理业务数据的分析与预测</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-用户群体">13. 用户群体<a href="#13-用户群体" class="hash-link" aria-label="13. 用户群体的直接链接" title="13. 用户群体的直接链接">​</a></h2>
<ul>
<li>提供行业和区域用户的细分数据，便于分析和预测</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="14-区域调度">14. 区域调度<a href="#14-区域调度" class="hash-link" aria-label="14. 区域调度的直接链接" title="14. 区域调度的直接链接">​</a></h2>
<ul>
<li>通过区域调度和负荷预测优化用电量管理</li>
</ul>
<hr>
<p>通过这些功能模块，本系统能够在售电市场中提供精细化分析与预测，满足多维度的数据应用需求。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于电力行业相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/dianli-industry">电力行业</a></li><li class="tag_QGVx"><a title="数据分析与预测相关的内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/forecasting">预测</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-logic-delete">MongoDB实现逻辑删除</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-28T00:00:00.000Z">2023年6月28日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>我们对<code>MongoDB</code>采用的逻辑删除的方案，与<code>MySQL</code>完全不同。 得益于<code>MongoDB</code>擅长储存非结构化数据的优点，即使业务数据结构发生，也不会影响原来的数据，还能保证业务表查询效率。 若<code>MySQL</code>采用此方案，则有业务数据库表结构变动导致数据迁移失败的风险，甚至影响正常业务流程。 综合考虑，关系型数据库适合通过“删除标记”实现逻辑删除，非关系型数据库更适合将“已删除”的数据迁移至回收表中。</em></p>
<p>举个小demo</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如果改变表字段">如果改变表字段：<a href="#如果改变表字段" class="hash-link" aria-label="如果改变表字段：的直接链接" title="如果改变表字段：的直接链接">​</a></h2>
<p>​		首先导入了 MongoDB 驱动，然后创建了一个 MongoDB 客户端（<code>MongoClient</code>），并连接到了本地的 MongoDB 服务器（&quot;mongodb://localhost:27017&quot;）。通过客户端获取了数据库 &quot;test&quot; 中的集合 &quot;collection&quot;。在逻辑删除代码中，首先通过 ObjectId 创建了一个 ObjectId 对象，其值为 &quot;5f36f47a06c5a722497f37b5&quot;。然后，通过调用 <code>updateOne</code> 方法对该文档进行了逻辑删除操作，即在该文档中添加/更新了一个 &quot;deleted&quot; 字段，该字段的值为 true。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.mongodb</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">mongodb-driver-sync</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">4.0.5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.model.Updates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MongoDBLogicDeleteExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoClient mongoClient = MongoClients.create(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase(&quot;test&quot;).getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjectId id = new ObjectId(&quot;5f36f47a06c5a722497f37b5&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        collection.updateOne(Filters.eq(&quot;_id&quot;, id), Updates.set(&quot;deleted&quot;, true));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>​		然后在查询代码中，通过调用 <code>find</code> 方法查询 &quot;deleted&quot; 字段不等于 true 的文档，即查询未被逻辑删除的文档。然后，将查询结果存入 <code>documents</code> 集合中。最后，通过循环打印出了查询结果中的每一个文档。最后，关闭了 MongoDB 客户端。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoClients;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.model.Filters;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MongoDBQueryExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoClient mongoClient = MongoClients.create(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取数据库和集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoCollection&lt;Document&gt; collection = mongoClient.getDatabase(&quot;test&quot;).getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        collection.find(Filters.ne(&quot;deleted&quot;, true)).into(documents);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭 MongoDB 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="不改变表字段">不改变表字段<a href="#不改变表字段" class="hash-link" aria-label="不改变表字段的直接链接" title="不改变表字段的直接链接">​</a></h2>
<p>如果不想添  加字段，可以使用 MongoDB 的另一种实现逻辑删除的方法，即使用软删除。软删除的思想是将文档移动到另一个集合中，而不是真正删除文档。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.MongoClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoCollection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mongodb.client.MongoDatabase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.bson.Document;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.bson.types.ObjectId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class LogicalDeletionExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建 MongoDB 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoClient mongoClient = new MongoClient(&quot;mongodb://localhost:27017&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoDatabase database = mongoClient.getDatabase(&quot;test&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取原始集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoCollection&lt;Document&gt; collection = database.getCollection(&quot;collection&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取新集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MongoCollection&lt;Document&gt; deletedCollection = database.getCollection(&quot;deleted_collection&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 逻辑删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ObjectId id = new ObjectId(&quot;5f36f47a06c5a722497f37b5&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Document deletedDocument = collection.find(new Document(&quot;_id&quot;, id)).first();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deletedCollection.insertOne(deletedDocument);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        collection.deleteOne(new Document(&quot;_id&quot;, id));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Document&gt; documents = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        collection.find().into(documents);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 打印结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Document document : documents) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(document);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mongoClient.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码通过将文档移动到新集合中，实现了 MongoDB 的逻辑删除，并且不添加字段。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于数据仓库相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/shujuku">数据库</a></li><li class="tag_QGVx"><a title="关于MongoDB的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/mongodb">MongoDB</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-easyexcel">实用框架EasyExcel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-20T00:00:00.000Z">2023年4月20日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。它有许许多多的应用场景 例如 数据导入：减轻录入工作量 ；数据导出：统计信息归档 ； 数据传输：异构系统之间数据传输等等</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1easyexcel介绍">1、EasyExcel介绍<a href="#1easyexcel介绍" class="hash-link" aria-label="1、EasyExcel介绍的直接链接" title="1、EasyExcel介绍的直接链接">​</a></h2>
<ul>
<li>Java领域解析、生成Excel比较有名的框架有Apache poi、jxl等。但他们都存在一个严重的问题就是非常的耗内存。如果你的系统并发量不大的话可能还行，但是一旦并发上来后一定会OOM或者JVM频繁的full gc。</li>
<li>EasyExcel是阿里巴巴开源的一个excel处理框架，<strong>以使用简单、节省内存著称</strong>。EasyExcel能大大减少占用内存的主要原因是在解析Excel时没有将文件数据一次性全部加载到内存中，而是从磁盘上一行行读取数据，逐个解析。</li>
<li>EasyExcel采用一行一行的解析模式，并将一行的解析结果以观察者的模式通知处理（AnalysisEventListener）</li>
</ul>
<p>文档地址：<a href="https://easyexcel.opensource.alibaba.com" target="_blank" rel="noopener noreferrer">https://easyexcel.opensource.alibaba.com</a></p>
<p>github地址：<a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/easyexcel</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2easyexcel写操作">2、EasyExcel写操作<a href="#2easyexcel写操作" class="hash-link" aria-label="2、EasyExcel写操作的直接链接" title="2、EasyExcel写操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21创建项目">2.1  、创建项目<a href="#21创建项目" class="hash-link" aria-label="2.1、创建项目的直接链接" title="2.1、创建项目的直接链接">​</a></h3>
<p><strong>pom中引入xml相关依赖</strong></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.alibaba</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">easyexcel</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当引入该依赖之后，会发现在项目的依赖文件中同时多出了poi的类库。也就是说，EasyExcel是基于poi来进行实现的，间接地引入了如下依赖：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">poi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.poi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">poi-ooxml</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22创建实体类">2.2、创建实体类<a href="#22创建实体类" class="hash-link" aria-label="2.2、创建实体类的直接链接" title="2.2、创建实体类的直接链接">​</a></h3>
<p><strong>设置表头和添加的数据字段</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ExcelProperty(&quot;学生编号&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ExcelProperty(&quot;学生姓名&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>@ExcelProperty：用于设置Excel表头，其中index用户表头的编号，从0开始；value为表头对应的内容。</li>
<li>@DateTimeFormat：用于日期的格式化</li>
</ul>
<p>完成上述功能准备工作之后，我们就可以来生成一个Excel了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-实现写操作">2.3 、实现写操作<a href="#23-实现写操作" class="hash-link" aria-label="2.3 、实现写操作的直接链接" title="2.3 、实现写操作的直接链接">​</a></h3>
<p><strong>（1）创建方法循环设置要添加到Excel的数据</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//循环设置要添加的数据，最终封装到list集合中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static List&lt;Stu&gt; data() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Stu data = new Stu();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data.setSno(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data.setSname(&quot;张三&quot;+i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        list.add(data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>（2）实现最终的添加操作</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = &quot;E:\\11.xlsx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果这里想使用03 则 传入excelType参数即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EasyExcel.write(fileName, Stu.class).sheet(&quot;写入方法一&quot;).doWrite(data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么我们如何解析Excel呢？接着看....</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3easyexcel读操作">3、EasyExcel读操作<a href="#3easyexcel读操作" class="hash-link" aria-label="3、EasyExcel读操作的直接链接" title="3、EasyExcel读操作的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31创建实体类">3.1、创建实体类<a href="#31创建实体类" class="hash-link" aria-label="3.1、创建实体类的直接链接" title="3.1、创建实体类的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Stu {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ExcelProperty(value = &quot;学生编号&quot;,index = 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int sno;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置表头名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置列对应的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ExcelProperty(value = &quot;学生姓名&quot;,index = 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String sname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先创建一个监听器ExcelListener，集成EasyExcel提供AnalysisEventListener类：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32创建读取操作监听器">3.2、创建读取操作监听器<a href="#32创建读取操作监听器" class="hash-link" aria-label="3.2、创建读取操作监听器的直接链接" title="3.2、创建读取操作监听器的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ExcelListener extends AnalysisEventListener&lt;Stu&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建list集合封装最终的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Stu&gt; list = new ArrayList&lt;Stu&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //一行一行去读取excle内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void invoke(Stu user, AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;***&quot;+user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        list.add(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //读取excel表头信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void invokeHeadMap(Map&lt;Integer, String&gt; headMap, AnalysisContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;表头信息：&quot;+headMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //读取完成后执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doAfterAllAnalysed(AnalysisContext analysisContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;list = &quot; + list);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在该监听器中，通过重写AnalysisEventListener的方法来获得解析的数据、表头信息，以及解析完毕之后执行的操作信息。</p>
<p>同样写Excel一样，通过EasyExcel类的静态方法来执行读操作：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33调用方法实现读取">3.3、调用方法实现读取<a href="#33调用方法实现读取" class="hash-link" aria-label="3.3、调用方法实现读取的直接链接" title="3.3、调用方法实现读取的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String fileName = &quot;E:\\11.xlsx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里 需要指定调用哪个class去读，然后读取第一个sheet 文件流会自动关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EasyExcel.read(fileName, Stu.class, new ExcelListener()).sheet().doRead();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面提到的@DateTimeFormat注解可转换日期格式，还有其他 类似功能的注解和自定义转换器。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于EasyExcel的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/easy-excel">EasyExcel</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-system-forecasting-electricity-demand">海量用户用电需求分析预测系统</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-06T00:00:00.000Z">2023年4月6日</time> · <!-- -->阅读需 3 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>该系统旨在分析和预测海量用户的用电需求，支持多维度的市场跟踪、电量预警和报表生成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-背景意义">1. 背景意义<a href="#1-背景意义" class="hash-link" aria-label="1. 背景意义的直接链接" title="1. 背景意义的直接链接">​</a></h2>
<p>通过该系统，可以全面分析用户的用电需求，提升供电部门的服务效率和精准度。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-理论研究目标">2. 理论研究目标<a href="#2-理论研究目标" class="hash-link" aria-label="2. 理论研究目标的直接链接" title="2. 理论研究目标的直接链接">​</a></h2>
<p>研究并建立科学、准确的用户用电需求分析模型，满足不同行业和用户的预测需求。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-总体建设目标">3. 总体建设目标<a href="#3-总体建设目标" class="hash-link" aria-label="3. 总体建设目标的直接链接" title="3. 总体建设目标的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据中心">数据中心<a href="#数据中心" class="hash-link" aria-label="数据中心的直接链接" title="数据中心的直接链接">​</a></h3>
<ul>
<li>市场跟踪与分析</li>
<li>电量及负荷预测</li>
<li>电量预警</li>
<li>报表报告</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-总体建设方案">4. 总体建设方案<a href="#4-总体建设方案" class="hash-link" aria-label="4. 总体建设方案的直接链接" title="4. 总体建设方案的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础数据内因外因分析">基础数据（内因、外因分析）<a href="#基础数据内因外因分析" class="hash-link" aria-label="基础数据（内因、外因分析）的直接链接" title="基础数据（内因、外因分析）  的直接链接">​</a></h3>
<ul>
<li>行业电量</li>
<li>大用户信息</li>
<li>电厂信息</li>
<li>业扩报装信息</li>
<li>气象信息</li>
<li>经济信息</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="影响因素智能跟踪">影响因素（智能跟踪）<a href="#影响因素智能跟踪" class="hash-link" aria-label="影响因素（智能跟踪）的直接链接" title="影响因素（智能跟踪）的直接链接">​</a></h3>
<ul>
<li>跟踪气象因素</li>
<li>跟踪用户因素</li>
<li>跟踪经济因素</li>
<li>跟踪行业因素</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分析内容">分析内容<a href="#分析内容" class="hash-link" aria-label="分析内容的直接链接" title="分析内容的直接链接">​</a></h3>
<ul>
<li>基于气象经济</li>
<li>基于相似用户</li>
<li>基于业扩容量</li>
<li>基于主导行业</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="协调单位协调预测">协调单位（协调预测）<a href="#协调单位协调预测" class="hash-link" aria-label="协调单位（协调预测）的直接链接" title="协调单位（协调预测）的直接链接">​</a></h3>
<ul>
<li>省地协调</li>
<li>部门协调</li>
<li>时间协调</li>
<li>口径协调</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="预警预警体系">预警（预警体系）<a href="#预警预警体系" class="hash-link" aria-label="预警（预警体系）的直接链接" title="预警（预警体系）的直接链接">​</a></h3>
<ul>
<li>预警指标筛选</li>
<li>预警体系建立</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="全覆盖全时域电量跟踪分析预警系统平台建设">全覆盖全时域电量跟踪分析预警系统平台建设<a href="#全覆盖全时域电量跟踪分析预警系统平台建设" class="hash-link" aria-label="全覆盖全时域电量跟踪分析预警系统平台建设的直接链接" title="全覆盖全时域电量跟踪分析预警系统平台 建设的直接链接">​</a></h3>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据处理功能">数据处理功能<a href="#数据处理功能" class="hash-link" aria-label="数据处理功能的直接链接" title="数据处理功能的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据处理">数据处理<a href="#数据处理" class="hash-link" aria-label="数据处理的直接链接" title="数据处理的直接链接">​</a></h3>
<ul>
<li>提供海量异常数据辨识与修正</li>
<li>基于 BI 的可视化数据分析<!-- -->
<ul>
<li>精细化的跟踪分析与数据钻取</li>
<li>量化气象影响与分析</li>
<li>量化经济影响</li>
<li>业扩用电特性研究与提炼</li>
<li>智能化负荷预测算法</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="智能负荷预测方法库管理">智能负荷预测方法库管理<a href="#智能负荷预测方法库管理" class="hash-link" aria-label="智能负荷预测方法库管理的直接链接" title="智能负荷预测方法库管理的直接链接">​</a></h3>
<ul>
<li>集中预测：支持一键预测</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="多时空尺度的预测结果协调">多时空尺度的预测结果协调<a href="#多时空尺度的预测结果协调" class="hash-link" aria-label="多时空尺度的预测结果协调的直接链接" title="多时空尺度的预测结果协调的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="时间尺度">时间尺度<a href="#时间尺度" class="hash-link" aria-label="时间尺度的直接链接" title="时间尺度的直接链接">​</a></h3>
<ul>
<li>年、月、周、日</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="空间尺度">空间尺度<a href="#空间尺度" class="hash-link" aria-label="空间尺度的直接链接" title="空间尺度的直接链接">​</a></h3>
<ul>
<li>全省、地市</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="  口径">口径<a href="#口径" class="hash-link" aria-label="口径的直接链接" title="口径的直接链接">​</a></h3>
<ul>
<li>用电量、售电量、供电量</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="完善的预警体系">完善的预警体系<a href="#完善的预警体系" class="hash-link" aria-label="完善的预警体系的直接链接" title="完善的预警体系的直接链接">​</a></h2>
<ul>
<li>基于内因、外因、跟踪和预测的预警分析</li>
<li>提供计划完成率预警、逆势发展预警、先行指标预警、趋势预警等</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="实用化的报表">实用化的报表<a href="#实用化的报表" class="hash-link" aria-label="实用化的报表的直接链接" title="实用化的报表的直接链接">​</a></h2>
<ul>
<li>支持高效、精准的报告生成，助力业务决策</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="微服务技术架构">微服务技术架构<a href="#微服务技术架构" class="hash-link" aria-label="微服务技术架构的直接链接" title="微服务技术架构的直接链接">​</a></h2>
<ul>
<li>提供稳定、可扩展的微服务架构，确保系统的灵活性和扩展性</li>
</ul>
<hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于电力行业相关的话题" class="tag_zVej tagRegular_sFm0" href="/blog/tags/dianli-industry">电力行业</a></li><li class="tag_QGVx"><a title="数据分析与预测相关的内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/forecasting">预测</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-spring-security-microservices">spring-security整合微服务实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-15T00:00:00.000Z">2023年3月15日</time> · <!-- -->阅读需 23 分 钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>起因</strong>：<em>随着越来越多的业务转移到互联网上，安全性已经成为任何一个应用程序开发的重要考虑因素。而在 Java 应用程序开发中，Spring Security 是一个非常流行的安全框架，可以提供可靠的身份验证、授权和会话管理等安全特性。无论是开发 Web 应用程序、RESTful 服务、单页应用程序或者其他类型的应用程序，都可以使用 Spring Security 来保护应用程序的安全性。同时，Spring Security 还具有非常好的可扩展性，可以与 Spring 生态系统中的其他框架和库进行无缝集成，使开发人员能够构建出复杂的、高度可定制的安全解决方案。因此，使用 Spring Security 是保障应用程序安全的不二选择。</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="技术选型">技术选型<a href="#技术选型" class="hash-link" aria-label="技术选型的直接链接" title="技术选型的直接链接">​</a></h2>
<table><thead><tr><th></th><th>Spring Security</th><th>Apache Shiro</th><th>Apache Knox</th><th>Keycloak</th><th>Stormpath</th></tr></thead><tbody><tr><td>概述</td><td>Spring Security 是一个非常流行的 Java 应用程序安全框架，提供了完整的身份验证、授权和会话管理功能。它具有良好的可扩展性和灵活性，能够与 Spring 生态系统中的其他框架和库无缝集成</td><td>Apache Shiro 是一个轻量级的安全框架，提供了身份验证、授权、加密和会话管理等功能。它易于使用和集成，能够与任何应用程序框架一起使用，支持多种数据源，如 LDAP、JDBC 和 Active Directory</td><td>Apache Knox 是一个开源网关，提供了 REST API 的认证、授权和审计功能。它可以保护 Hadoop 集群的 REST API，提供了单点登录和 OAuth2 支持</td><td>Keycloak 是一个开源的身份认证和访问管理解决方案，基于 OpenID Connect 和 OAuth2 协议。它提供了可扩展的身份验证和授权功能，包括单点登录、多因素身份验证和基于角色的访问控制等</td><td>Stormpath 是一个云身份认证和访问管理服务，提供了完整的身份验证、授权和用户管理功能。它可以与任何应用程序框架一起使用，包括 Java、Node.js 和 .NET</td></tr><tr><td>优点</td><td>完整的安全特性、与 Spring 框架无缝集成、丰富的插件和扩展、良好的文档和社区支持</td><td>括轻量级、易于使用和集成、支持多种数据源、优秀的文档</td><td>保护 Hadoop 集群的 REST API、支持单点登录和 OAuth2、易于配置和使用</td><td>可扩展的身份验证和授权功能、多种身份验证方式、基于角色的访问控制、易于使用和部署</td><td>云身份认证和访问管理服务、易于使用和集成、提供完整的身份验证、授权和用户管理功能</td></tr><tr><td>缺点</td><td>配置复杂、上手较难</td><td>与 Spring 框架的深度集成、不够完整的安全特性</td><td>仅适用于保护 Hadoop 集群的 REST API</td><td>配置复杂、性能较差</td><td>需要使用云服务、需要支付服务费用，成本高</td></tr><tr><td>适用场景</td><td>适用于基于 Spring 框架构建的应用程序</td><td>适用于不依赖于 Spring 框架的应用程序</td><td>适用于需要保护 Hadoop 集群的 REST API 的场景</td><td>适用于需要单独部署一个身份认证和访问管理系统的场景</td><td>适用于需要使用云身份认证和访问管理服务的场景。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结：<a href="#小结" class="hash-link" aria-label="小结：的直接链接" title="小结：的直接链接">​</a></h3>
<p>国内目前非常流行的就是Spring Security和Apache Shiro 。</p>
<p>Spring Security出现的时间较早，在springboot没火起来之前一直都是Shiro 的天下，但目前最能和spring全家桶整合起 来的就是Spring Security，Spring Security 是最为完整、可扩展和灵活的安全框架，而且与 Spring 框架的深度集成使得使用和配置变得简单方便。Spring Security 提供了全面的身份验证、授权和会话管理特性，并且可以轻松地扩展到支持自定义的安全策略和特性。而且社区也是十分活跃的。所以此篇文章主要从实践流程出发，实现与spring项目整合的快速搭建解决方案。</p>
<p>相对于 Shiro，在 SSM 中整合 Spring Security 都是比较麻烦的操作，所以，Spring Security 虽然功能比 Shiro 强大，但是使用反而没有 Shiro 多（Shiro 虽然功能没有Spring Security 多，但是对于大部分项目而言，Shiro 也够用了）。自从有了 Spring Boot 之后，Spring Boot 对于 Spring Security 提供了自动化配置方案，可以使用更少的配置来使用 Spring Security。</p>
<p>因此，一般来说，常见的安全管理技术栈的组合是这样的：
• SSM + Shiro
• Spring Boot/Spring Cloud + Spring Security</p>
<p>如果还想了解shiro这一框架，我也在github开源了一个小demo，用于整合SpringBoot与shiro，实现快速上手，仓库地址：<a href="https://github.com/Jachen99/rbac_shiro" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/rbac_shiro</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a href="#介绍" class="hash-link" aria-label="介绍的直接链接" title="介绍的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security简介">Spring Security简介<a href="#spring-security简介" class="hash-link" aria-label="Spring Security简介的直接链接" title="Spring Security简介的直接链接">​</a></h3>
<p>Spring 是非常流行和成功的 Java 应用开发框架，Spring Security 正是 Spring 家族中的成员。Spring Security 基于 Spring 框架，提供了一套 Web 应用安全性的完整解决方案。</p>
<p>正如你可能知道的关于  安全方面的两个核心功能是“<strong>认证</strong>”和“<strong>授权</strong>”，一般来说，Web 应用的安全性包括**用户认证（Authentication）和用户授权（Authorization）**两个部分，这两点也是 SpringSecurity 重要核心功能。</p>
<p>（1）用户认证指的是：验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码，系统通过校验用户名和密码来完成认证过程。</p>
<p><strong>通俗点说就是系统认为用户是否能登录</strong></p>
<p>（2）用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。</p>
<p><strong>通俗点讲就是系统判断用户是否有权限去做某些事情。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="历史">历史<a href="#历史" class="hash-link" aria-label="历史的直接链接" title="历史的直接链接">​</a></h3>
<p>“Spring Security 开始于 2003 年年底,““spring 的 acegi 安全系统”。 起因是 Spring开发者邮件列表中的一个问题,有人提问是否考虑提供一个基于 spring 的安全实现。</p>
<p>Spring Security 以“The Acegi Secutity System for Spring” 的名字始于 2013 年晚些时候。一个问题提交到 Spring 开发者的邮件列表，询问是否已经有考虑一个基于Spring 的安全性社区实现。那时候 Spring 的社区相对较小（相对现在）。实际上 Spring 自己在2013 年只是一个存在于 ScourseForge 的项目，这个问题的回答是一个值得研究的领域，虽然目前时间的缺乏组织了我们对它的探索。</p>
<p>考虑到这一点，一个简单的安全实现建成但是并没有发布。  几周后，Spring 社区的其他成员询问了安全性，这次这个代码被发送给他们。其他几个请求也跟随而来。到 2014 年一月大约有 20 万人使用了这个代码。这些创业者的人提出一个 SourceForge 项目加入是为了，这是在 2004 三月正式成立。</p>
<p>在早些时候，这个项目没有任何自己的验证模块，身份验证过程依赖于容器管理的安全性和 Acegi 安全性。而不是专注于授权。开始的时候这很适合，但是越来越多的用户请求额外的容器支持。容器特定的认证领域接口的基本限制变得清晰。还有一个相关的问题增加新的容器的路径，这是最终用户的困惑和错误配置的常见问题。</p>
<p>Acegi 安全特定的认证服务介绍。大约一年后，Acegi 安全正式成为了 Spring 框架的子项目。1.0.0 最终版本是出版于 2006 -在超过两年半的大量生产的软件项目和数以百计的改进和积极利用社区的贡献。</p>
<p>Acegi 安全 2007 年底正式成为了 Spring 组合项目，更名为&quot;Spring Security&quot;。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="流程介绍">流程介绍<a href="#流程介绍" class="hash-link" aria-label="流程介绍的直接链接" title="流程介绍的直接链接">​</a></h2>
<p>要对Web资源进行保护，最好的办法莫过于Filter
要想对方法调用进行保护，最好的办法莫过于<a href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">AOP</a>。</p>
<p>Spring Security进行认证和鉴权的时候,就是利用的一系列的Filter来进行拦截的。</p>
<p><img decoding="async" loading="lazy" src="https://img-blog.csdnimg.cn/20201231155747261.png" alt="img" class="img_ev3q"></p>
<p>如图所示，一个请求想要访问到API就会从左到右经过蓝线框里的过滤器，其中<strong>绿色部分是负责认证的过滤器，蓝色部分是负责异常处理，橙色部分则是负责授权</strong>。经过一系列拦截最终访问到我们的API。</p>
<p>这里面我们只需要重点关注两个过滤器即可：<code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<code>FilterSecurityInterceptor</code>负责权限授权。</p>
<p>说明：<strong>Spring Security的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security</strong>！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速实践">快速实践<a href="#快速实践" class="hash-link" aria-label="快速实践的直接链接" title="快速实践的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="搭建权限框架基本骨架">搭建权限框架基本骨架<a href="#搭建权限框架基本骨架" class="hash-link" aria-label="搭建权限框架基本骨架的直接链接" title="搭建权限框架基本骨架的直接链接">​</a></h3>
<p>1、给spring-security创建单独的公共模块</p>
<p>2、导入相关jar包，如果是maven工程，直接引入</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Spring Security依赖 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-boot-starter-security</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：依赖包（spring-boot-starter-security）导入后，Spring Security就默认提供了许多功能将整个应用给保护了起来：</p>
<ul>
<li>要求经过身份验证的用户才能与应用程序进行交互</li>
<li>创建好了默认登录表单</li>
<li>生成用户名为<code>user</code>的随机密码并打印在控制台上</li>
<li><code>CSRF</code>攻击防护、<code>Session Fixation</code>攻击防护</li>
</ul>
<p>3、在需要使用权限框架的模块导入依赖</p>
<p>这里以医院预约挂号系统的order模块为例，仓库地址：<a href="https://github.com/Jachen99/yygh_parent" target="_blank" rel="noopener noreferrer">https://github.com/Jachen99/yygh_parent</a></p>
<p>导入依赖到service-order模块</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">space.jachen</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-security</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.0.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4、启动该order模块，会发现控制台显示Using generated security password</p>
<p><img decoding="async" loading="lazy" alt="image-20230216104643176" src="/assets/images/image-20230216104643176-f4f96f5b1dc242b1cd0a8cbec3971064.png" width="1054" height="248" class="img_ev3q"></p>
<p>说明该模块已经被spring security保护。</p>
<p>5、此时我们通过浏览器去访问该模块下的api路径，会进入框架自带的登录页面：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216112805097" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWQAAACjCAIAAAAy4/PPAAAZL0lEQVR4nO3de3gU533o8d87l53dnd3Zm3ZXWt0FEkjcwZi7wfEFEztxbezYjnNqOyVx/LhPmpzTJmmaPs1pkrZ+0hwnJ23SNHFxk9g5DmlqE0PAGF9ABmzuF4EAgVbS6rIrae/Xubzv+QOSAKbPTihkwfv7PA9/gEajd8Xsd9+ZnZkl8XgcEEKoHK7SA0AI3RgwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFTMBYIIVMwFgghUzAWCCFThEoP4EaQj544HQ6Ppn7zd84TaJja2ljjkQEAgAKkP/v0FwbE2Z//9IOruoIVG2c5jBaGwuH+0cyMBTf7rECuwU8YHzjdPzQuBprndTRc/dWjisJYmJCNbHnlpe0HBn7zd2K1OdyBpjX3rb1t6Wy3BQBoNBobllLZglbBYZaVGTy06YV/fz0szdUav7ii1sJf5VwwQ3/rjc0vbdnbuuCWeV948uquHFUcxsIEvZhJTSZKZMbS1cta7Ewvne3Zv7f3yI/XFwzyyQdXTrsGL9HXhGB3BYKhYI7rDNq4azFoQvyBQKg2WB+qvwZrRxWGsTDL6grMuPX+x5b7mKGNnJ2rP/tP2471dL/d/cAt08gNUgtbTfuq+z49K5VvanPz1+BoFeGEBYs/1Nq1BOy+q792VGkYi98b4cX69vmtXdPIwVOZxCBl7P2v0pQa6UQik8upmg6cYLXJisvltIkAAFTL5nKZTK5YVHVKOV6QHYrH5ZQsAgAYup5NJzO5XEnVKXCi1aG4XF6HBQCAqslkOpP9zTrtssfns/LkcnMEmstk05lMoVgyKOMFwRsIOawib6gCoaIk5TWQJAAAqpeymUwqnStqBi+IiturpRMltSS73f4aHzW0THQwXiS+QA1hNJ1MF0o6J4iKx+d2WIXL9IYVKa9RZqd5AAUAMrGhRF6zKy67VUolkrlCifCC0+VxOWVJ5K/qfwu65jAWV4RRYAyA8OQyL9DU0NPx0Z//+4+7DxwajqWI1Tmlc/6aex/6yLKpPAEoRHds+fVrb+8/3R9J5oqC3Tn/5js++dgDXS0BjhnpiaGXf/bijv2HB6IpDUT/1IVrH3n80VuagdF8rO8XL728Y8/BSCzJSa7WmfMfXvfk0laPTbx0DFo+0b311c3bd54KR3IlJiueh774zXvnNyrJky/+6w9+eaT06Neef7QDRI4mR0//6j/+c8vO/YOTeYevYeWHH1Df+eU7vadX/Y8n/+qpj5eyide++cT3D5I//tz/qtHGNm56+3h/VFACt937+KceWB502y/NFDU2/nz9v7y4ecmtq//v1/8SgO358Ve/t+1M110fv2uO75cbNu3rCVOre/mdD37ykdUd9d4bZEKGzsNYXJFiNBkbYSA75BD3vp2QieH+55758qajxQ/dfdd90+qTkZ7uXe+t//5Aa+cPujxEnDxx9PSwtb7r/iUrSTHbu3Pju2/9wtnS9ic1d9bp/Qe2/PNzrxybtuy2j390lsJlRxNUJjoANfTJv/7C3x5I2W9ecvtHp4fiZ4+/vnXr3zx9+gc//LuulrqLR8De+cn312/cwWqn3fvwY40Be2xoyCFZGbv0QVB1/Ec/ev6VN47UNrbdt3a2TLQT7/xwYCCVv2Q5Rrf+v39rbOuctXhlS8vga1ve3vyTby1a2HqLq91q5unOjMPdWwuRUMvsxW3t0zdv3Lpz4/NtU2ob/uhWGWtxQ8FYmFXKxAeP7t6uylTL7962ufvQqYaumbf+0Ycv3QtQE6On33mzL3vL03/zxMoOv8NC9SU+r/fvn9vyjZ/s/+Gn57jcMx9bN5vnJcnCA9VKq6c++dQ/7jg+uGpFVuEmzh49QjnLh9c+tKwtIAvMoMDxFi2X7N/0zZ6R2NpPffHe2xe7JcHIzZzdrH/u2e3bTsb9wdqA7YJBMHj31NhYsnjr3YvW3nePLHC6phGrcm4f6EIDb/2s5/jxxlkLnvjMUzc3KRywwr23f/UrXx89PXLRcozZZ65+8OGPttfIpdTYXOfQN14O7zmd6JrCGhwmnu4M7HXT7nzsU4uavKCXFrqHv7Ghp+fMcCRJp3nwNJ8bCcbCLDU9vu9X6/u28YxRA/jGWUvvWfvA8q66SxYrpkYHerqT2cLJNzZ8e59k4QkAnYiNaQVt5K0T6uMzwekjqZHI8JmRsehoLDI23BfPFTLjyWwmb28ONXUtZXt2/MePvh9duvzm+bNbG4Ju2ZKJ5be9tD9XUPe8vvHsgR08ATBKhdSIYainRzLZohGwXfD/SGDxgin7z/S/9+Y2C6XLFi+YPm2aTyQ8B8ZFI2WHd/QlJ/IzV81ZNK3BLXEA4FLkjhp/7yWxINycGTNaG+vcEmdIdMZN84VfDYzFC4WSAQ4T2w/hGlu7ZrU3eWw8o1rnzQudm84ksqV0wQCMxQ0FY2GWaHe1LVi1uMkOQFz+0LSumS31AY9NAKAXLqYXc7nJIUKIolgsFp4HAsAH6xqDdVMtloAkcr0Hd2/69RvhaFp2u3nJYrfVcBwPJZXpuqQEF9z5yGMZZe+h4zt//Yv9u3fMvGnlHauWhUS9P1I0ACSBswg8AABvd/in3vahqY0hl1245OWd3HTb3Y9z8vZdRw7vfvPogd3tM+bdff/9Mxq81osWYyOxYqHI/E77uVIAABDeTrhLpyCE+JyiU+IAgPC8RfEAIapODfq+HZvLIsQpix7bucOZxKK4eV7QDWoYtMw3ousMxsIsq6d27uqPP7m8zJuCvChJTh8vJOasfuiu9hrn744+coRYZSu39dWXN++LzVu15oE75jkVp9uWOPjue+dODqXE4qntWPdkw7ITvYf2vfPaazt/vWFEBekza6bXeHkuRVesue+WedOlC95GEB0+l+3S12droOO2jwZnLVxxaP/e19/e+eqGH48ZDX/5+MrGCxdiIFkJz7NsScvpTBYIADCqJg299L4H9d+cABC4FmeLoj80nAdeZZISqJ+6kAete1e/TgWHw6E4nU7Z5rBLwTo3z+tnxlIpOdQ+Z35HW1Ot21oaOV4s6ee+V82nY5GhdAnaps+675F1a5YsZPHh4bNHrDbbLXe0SBbhTGRSBdHhcCpOp8NulwTitXPSpTMLCI+OT+aoO9j4oTX3fGbdI8DY0e29k5MXH7gkpKvT73SIfT3HjpyNJlOpVDIxOtDTFxsv/mF+U+hGgzOLq4yzB+u6bu1UXj269dnvZg7Pnt7mtnG59ERRo4/+6ec9xOKUbcKxnt2vvCjGumgmvnVvXzJXAjcAQCrSs2X9d0ZDt0+fPlWbGOzu6S3ava6aJsnpvvmJL/l3fWXbC8+N9R5eMKdDtvLZxHjk5P6nvvyPDXUXX43C6Pf++QcGb104a6pDKJ44epQXhPpF7bJiu3ik5Ka1D7WfjG7f3/2tr4+vWDRbNEoHuvdkEqmL91YQOg9jcdWR+rbOr3/3W+uf++m+o/s37O/mRVsg1DB38VIJgAC37uF7BfjPPcf2vhDu7Zi79GvPfP6vnvyzMAAA2F013lDzq9s3b92Y4yRbbUPrx9Y9cv/dq4ATeFfHs//7sy9seHXPoSMvHt7NWe2+uqY5MxeLku39A5jf5tr6Vvf6d18zmOj1hVbf89ATjy9vCsgwcdFyYs2MdY896rS/3H3o1C9fDje0zfjw018Zeum78UM9PIdTTnQpEo/HKz2G656amYgnUyrv9AYClzn+zwBoODxUIna/z+V1SACMGlp8Mp7N5TXdAMKJFkl2OHxeNwegFbLJVCqdK1DgbbIjGPREBiIqsfu9LpfE8pnkRDKvGQZwnGS1KS6X03HueAJQNZ9IpTPZvKoZwHGCKDlku9ftEoRLT4VMxCcymWxJ0xjjRNEiOxxejyLwPNNyqWQynmeuYINXAkJAK2bTqXQqV9ApSJLd5VX+/kt/sfNA5MF1T3/+idVU19LR8GSB1NTWOh0ODgCYrhcz4eFJyVPnU+x28ZI9IBaLjSdTabssN4TqACAdHUzkVLvb5/Oee+eDUTUdGUswyeVxuxQJk3QjwVhUMaan8jrP8Q6bCIzqar5nz9a/+85P4vbpTz396fuXtFV6fOj6grsh1Yux/OubNo+lNa/LLnAsGx/ftWN7htmWrlwxpwMvG0WXwlhUMUaS0XD3nmMlTec4TjVAUQKLbl/5ibtumuKTKj04dN3B3ZBqxrKJiaHI4Oh4vKSBxaG0tk6r9zvxelB0WRgLhJApeDgaIWQKxgIhZAoe4CxDpzBRFFKqyF2Tu1aiGwZjTCBUEfUam1F+6Q8ijEUZkYxYBKnOJQhX+17Y6MbCgCULNF4gGAt0eb0Jy7JWocmNpUDEa+P6J6v3KYPHLMoo6oQyLAUCABB5Yn/fHU+rR/U+coTQ7wVjgRAyBWOBEDIFY4EQMgVjgRAyBWNxJdRcWlfP39fWoCyWKpq91TVCNyyMxZUYPbbnzJnwuT6kM7n128/kirphGLquG7/Jhq7rum5QxoAxRg1KDV0//8fQdYNSBsAY03Vd13XKGABQxnSD6rquG+zc2ig9d798Ro3frg6hyqjeM0yuupHBwWg8Jbu9rW2NvK4f6TmhG3zblGa/lWaT40kDRuOSn09aBJIoaIJS09rSwGnaiWO9RUZDLS21PncymQ1H00Z+0uJt9ahjyVzeHahrqQ8YmjYZPj6YIY5QS6PfJeMV5KgScGZxlajhcI7zt0ypcdsz6fS+17dPaW2bFeJPDMYi48nhociJlHPGlJpoX29/Rqxrbc6kku8eH2dAlM72rq6WI8eHwiOpiVj05MBo55Tm07u3hHNiU617LBo7Hs3n0rHd+ZqpHe0TPQcHBkbKDwahawBnFlcJ75P0wcGI2tnoMwr5YyNZcrqPpwWVeDmDiKIQaPTYJM7Q1KBXUWTFJsSGJyahlR872jcmCGOxfF1ItTBesLltNqvbyDXVyE6fKI7n4+OpAOkzMs7ek/GsbrgM3BFBlYGxuBKyS46pRqKguUVDy4/Vh2oE3tLRXJ8cGRyOFOx+v8CLwVCtVRBCFrtcGteynOwQgFIAsAkg8jyjxChkMoMTqjM0xcVHhnPAGHA88DwBsHAgi0S0iAbhdEpBEqxOX33AHvK63B5HpR89qlK4G3Il3A3NHNVGo+PRicloLL50ht9iJHJ5w253SALhZXtno8MghCOEGCWrTeIESQQAAlbZwQsCAEgWXrZZeM6i1Dg5QnmLZLUIFoFzWEVCiM3h5HgegJME3i7bLTWNpXgGgBgGp/Hv+zR0hP4gcGZxJQRHQ0eTNZ5MpwuiXNvV5uRAdTKaius2d01treJsWrm0f2AsQWltMChJlkBjqwpACNc8c67TLQNAIFRn9+iy12YbGEpxctf0Vr/bxvOypBiEF9rmLnA5bQBCU1ODZgh2m7y0RU9l05xcIwp4K11UGXgPzjJe7nPcOlVs8VR6HOg6oBoQSRgePl3pgVQG7oYghEzBWCCETMFYIIRMwVgghEzBWJTBc0AIngeFAAAoBb2KrxjEt07LqLEaRZUraDzBG3FWvazKsiXqr9YzXTAWZcwPFE8lYTBFRAFnYVWNMqbruktQKz2QisHzLMpgAAY9tx+CUwvECIDAVemeCM4syrhg46jSTQShc3BqjRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKCOdTnMcJwj4i0LAGAMAm81W6YFUBj4Hysjlcn6/v2q3D3QhSmmhUKj0KCoGY1Ge1Wp1OPCe2ggopZRSVq0fC4fHLBBCpmAsEEKmYCwQQqZgLBBCpmAsEEKmYCyue9RgWkHF22mgSsNYXAmjmCvkc7lCIV8o5kv6tf1hWiE7fGoUgF7bH4NQGXiexZXI9h04EFMFxW2UNOIMrZzdRCllDDiOEEIYY5QyAOA4DoCef1eecIxRnuPOnwZICAAwBhyBi74XgFIGjHHcuQUYqAU9M54CCAHwFXzMqOphLK5QTW2oqX1qYWxkV/cRY1bTyZOn8yW1rq6+PujNZbMnz4QZwPSOdi09ORqL61any18bHxqb0dUIqWiKs8oeL82rI2nWXiv1nurLF0vBYG1jnT9fKPUOZyAX7ZjaxhWTw9EJVVMdOP9D1wHcDK8Qx3O8wBhn5HmZkPFQKNTZrPRHxg6dHB7rPdgwtbXTwwCMo0NppoRCXiWvFiZ69qglrfdE/1vvhSPRZDrVP1w03tv0iuF0tXc0Rc707zs6kEkl9+490NLcJPPF4wMTmjNU51OGRvKVfrgIYSyuVHJ87OiR3uHJ4pJFXXpKHQgP95wZG8+UCjqRrFzkeO+E4RR54rCwyOhYkhCfLEwN8eOaEWEeVipF+85mxibaFHowJgUVp9Pu9LulQnKCAqdKNQ7ZziUjkmwP+BRF8bR4pUo/XIQwFldKkORgsLatqb6pVhk6fEDjrAGvS6IGI4In2OJ3iCeP9GTyWnNLfXuIj44NR4uWus7ppyOjotfTFJQy46MTSd5vAQF0xoABUEIYJwDhQXICEKCGphsGZQalRfUaH0NFyASMxZXgLFaXx1Mb9HvdLgDQwQi4LVaB5ySLQCCRzEk1IavIAS0V8gWH0+m1CZomir72bKS/3itNa3TaRaLZA6IoLmyxjMXjE/HJeJb6grU8TxS7QAiAJ0QL+WhsMp5MxAq8BT+2BFUafshQGaOjo42NjU6n88J/VJNRVbBLslMkAEABsn1nJgyLgxdsNk7nCxOTJU5U6pr9/Hh0PJXJOxWlMVQLjA2cDfvramWLEc9oReIIuUUAONMfLpZUv98f8HnyJW1wotBe5+Q5kh6PTSRSRBQCXrvmCiqY9kqjlKbT6aq96hRjUcZlY4GqU5XHAl+rEEKmYCwQQqZgLBBCpmAsEEKmYCzKIATfskTnMcaq9ugm4LUhZYmiaBiGYRiVHgiqPE3TVFW1WCyVHkhl4FunZRiGUSgUCCE8j9d8VjVKqWEYHMfJslzpsVQGzizK4Hm+ajcOdAnGWDXvlmIsyqvm7QNdqMq3BDzAiRAyBWOBEDIFY4EQMgVjgRAyBWOBEDIFY4EQMgVjgRAyBc+zKO/YOL8rIkwWuCq+LACBxLOuGmNhSK+xV+l2gLEooy/BfXev9Y2wOFmo6hNykMSzaT76mfnFh2eolR5LZeBuSBk/PSq9GRawFKhkkBMT/Is91fuxDBiLMo6O84kS/pYQAIBGIVWq3pcNfBqUwRh+fjlCABgLhJBJGAuEkCkYC4SQKRgLhJApGAsEAMBzoFjBSq5kg+A58FiBq953CaoFxqJKcRwIHIgciDzwHDis8InFsEQC2++5HkKgxgmfXQJu6zUZJ7p+4Bmc1UiywD2L4XNd4BBA5GDHEfjyPnCIYLmi2YHAgSziy84HH8ai6hACPjt8dR78w3Y4NgkcQKoI2QI8vwfyRSj+nmtjDGJpeHY3JErXZLTo+oGxqEYCByEZaBEGJiGpAgC47fCJZbD+bcgVYWEzrJ4KCgeaAS4HPPMmjGbh4VkQlMHrAIGHs32wYRDi5+pAQFHgK0vhq29AYzMsVYCjEPIBT+EX78GRLBTwE1c+KHDyWHUYg2QRfnoGVs+Gx2bBQj+4BHBYYc0csFvAE4CPzYWZDojnwSnDn8wHnw14DpY3w8faIVsAg8DnVkDDBZ+O4JThiXnglKC1Hu7phCVeSKrgD8KXFoCrSj+O54MJY1GNMkX4623w9gSs7IIvLYeldb/70rzpUM/g53vgmXfgmd1QYudPdicMtp2Cf+iGb++CmiC47Jdfs5aHjT3wf3bB9/bBimngxFh8gGAsqhKFYhKe3wGffQ0GRHhqye++Ms0JpQSMTQADoAC/3YcolSBdAAZQZEAJcP/FhjMxDOPDYGhQSIFgvcIjpuj6hLGoOgTALsIiBWw8DMfgRBSMC45cjRQhWAdtdUA4sNvBRgCf7+gcPMBZfQi4ZHjmERB0KAFYdHj50O++uH03rLgT/udH4JE0OOxQInjNLToPY1F1GIOJLPzZq2AhQAAKKoxmIK7Cn/8MxnOgGfCdt+DnTiAMPAr87EEAAM2Ab797/mr9fA7WvgBHY79dHcTGYc1PYTQL2YNwRIMEAGVwdhI+sgHCuco9TnS1YSyqkarD3qFL//HwIAAAR8DQIZ0HEKBeAS0NqgqUwdnU+cV0HboHLvrGfAneDgMAFOJwviEMcirsjFzLx4D+4DAW6CKEwOpOaJIBBPAr8KNdMJav9JjQ9QFjgS7CGOwOw7ALCIN0AXaPAN7THJ2DsUAXoQxOxOBErPySqNrgW6cIIVMwFmWQ838QqnYYizLavVSx4F47AgAQOHCI1bsxYCzKeLCztKhed1urdxNB51h4aHUbH2nXKj2QiiHxeLzSY7je7RkWfnVaHM1iWKuaVYDFIf2ONq3OQSs9lsrAWCCETMFXS4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCkYC4SQKRgLhJApGAuEkCn/HzFPDRfNstOFAAAAAElFTkSuQmCC" width="356" height="163" class="img_ev3q"></p>
<p>默认用户名为user，密码为控制台输出的随机密码，认证成功后才可以登录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现用户认证功能">实现用户认证功能<a href="#实现用户认证功能" class="hash-link" aria-label="实现用户认证功能的直接链接" title="实现用户认证功能的直接链接">​</a></h3>
<p><em>目前，我们已经实现了自带的登录页面的访问，用户名和密码都来自于内存。那么要访问来自于mysql、redis甚至的用户名、密码怎么办呢？</em></p>
<ul>
<li>加密器PasswordEncoder</li>
<li>用户对象UserDetails</li>
<li>业务对象UserDetailsService</li>
</ul>
<p>功能1：自带登录页面，访问真正的数据库，需要做什么？</p>
<p>1、访问基于内存的用户名和密码使用的是InMeoryUserDetailsManager（实现了UserDetailsServer），我们需要自定义UserDetailsServer的实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.order.security;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.user.PatientFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 22:35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class UserDetailsServiceImpl implements UserDetailsService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private PatientFeignClient userInfoFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public UserDetails loadUserByUsername(String phone) throws UsernameNotFoundException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoginVo login = userInfoFeignClient.loginSecurity(phone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(login == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new UsernameNotFoundException(&quot;用户名不存在！&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里不比较密码 ，后面通过PasswordEncoder比较</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回数据、暂时不做授权</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new CustomUser(login,authorities);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、访问数据库的方法loadUserByUsername，返回值为Userdetails，它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，所以我们还需要自定义UserDetails实现类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Getter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Setter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 访问数据库的方法loadUserByUsername，返回值为Userdetails，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 它封装了从数据库中返回的用户信息，但是和我们数据库表不一致，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 所以我们还需要自定义UserDetails实现类。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 22:31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Getter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Setter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomUser extends User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 我们自己的用户实体对象，要调取用户信息时直接获取这个实体对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LoginVo loginVo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param loginVo  从数据库中查询的用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authorities  从数据库中查询的权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CustomUser(LoginVo loginVo,Collection&lt;? extends GrantedAuthority&gt; authorities) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(loginVo.getPhone(), loginVo.getCode(), authorities);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.loginVo = loginVo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>现在数据都有了，我们需要进行密码的比较。</em></p>
<p>3、使用PasswordEncoder接口，但是不同的数据库采用的加密算法不同，这里可以使用security自带的PasswordEncoder实现类，如果不合适，就自定义一下PasswordEncoder的实现类即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.security.custom;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.redis.core.StringRedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.crypto.password.PasswordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 自定义密码组件 密码处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 此项目不需要md5加密处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 不需要开发者自己调用此类，SpringSecurity流程中进行密码比较时会自动调用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 22:25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component  // 必须添加到IOC ,SpringSecurity才可以使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomPasswordEncoder implements PasswordEncoder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StringRedisTemplate stringRedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 如果需要加密进行加 密操作后返回，这里不需要处理，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 因为本项目没有对用户密码进行加密，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 采用的是手机号+验证码的方式进行登录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 验证码存在redis中，为了方便演示，特定此条验证码永不过期，当作密码使用，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param rawPassword  明文  用户输入的密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return  密文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String encode(CharSequence rawPassword) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return rawPassword.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param rawPassword  用户输入的密码  即4位验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param encodedPassword  从redis中查询出来的验证码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(CharSequence rawPassword, String encodedPassword) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写死</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encodedPassword = stringRedisTemplate.opsForValue().get(&quot;13243922402&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return encodedPassword.equals(encode(encodedPassword));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先来看看整个认证的流程图：</p>
<p><img decoding="async" loading="lazy" alt="image-20230216133620298" src="/assets/images/image-20230216133620298-5f63300eb8e0aa01307e67ad37ce956b.png" width="1067" height="650" class="img_ev3q"></p>
<p><em>现在，虽然已经实现了对真实数据库的访问，但是还是使用自带的登录页面，那么怎么才能通过前端项目的真实的用户登录页面访问呢？</em></p>
<p>登录成功后，每次访问其他资源都要判断一下token是否正确,如果正确才能访问，如果不正确返回异常信息。</p>
<p>4、自定义用户认证接口（过滤器1）</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 不用加Component注解 不需要加入IOC  过滤器由tomcat进行管理 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 22:45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.AuthenticationManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.Authentication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.AuthenticationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.security.custom.CustomUser;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.vo.user.LoginVo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 登录过滤器，继承UsernamePasswordAuthenticationFilter，对用户名密码进行登录校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TokenLoginFilter extends UsernamePasswordAuthenticationFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TokenLoginFilter(AuthenticationManager authenticationManager,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            RedisTemplate redisTemplate ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //设置认证管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAuthenticationManager(authenticationManager);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //设置登录的地址和请求方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setRequiresAuthenticationRequestMatcher(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new AntPathRequestMatcher(&quot;/yygh/user/loginSecurity&quot;, &quot;POST&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 登录认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 走这个登录认证流程 不走原先的登录接口了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param req</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws AuthenticationException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Authentication attemptAuthentication(HttpServletRequest req, HttpServletResponse res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws AuthenticationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取用户名的方法  简单封装方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LoginVo loginVo = new ObjectMapper().readValue(req.getInputStream(), LoginVo.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String pwd = (String) redisTemplate.opsForValue().get(loginVo.getPhone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将用户名和密码封装到Authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Authentication authenticationToken =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new UsernamePasswordAuthenticationToken(loginVo.getPhone(), pwd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 调取getAuthenticationManager认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getAuthenticationManager().authenticate(authenticationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 登录成功 认证成功调用的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param chain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,Authentication auth) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1、通过Authentication获取认证的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CustomUser customUser = (CustomUser) auth.getPrincipal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2、通过JwtHelper生成token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String token = JwtHelper.createToken(Long.parseLong(customUser.getLoginVo().getOpenid()), customUser.getLoginVo().getPhone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3、获取用户的权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Collection&lt;GrantedAuthority&gt; authorities = customUser.getAuthorities();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4、将权限保存到Redis中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // redisTemplate.boundValueOps(customUser.getUsername()).set(authorities);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5、保存登录日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // loginLogService.recordLoginLog(customUser.getUsername(), IpUtil.getIpAddress(request),1,&quot;登录成功&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建一个Map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        map.put(&quot;token&quot;, token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 6、通过ResponseUtil工具类响应到前端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResponseUtil.out(response, JsonData.ok(map));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 登录失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws IOException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws ServletException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (e.getCause() instanceof RuntimeException){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null,204,e.getMessage()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ResponseUtil.out(response,JsonData.build(null, ResultCodeEnum.LOGIN_MOBLE_ERROR));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 如果想在里面加入@Autowired  则需要添加配置类</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.http.SessionCreationPolicy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.security.filter.TokenLoginFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 22:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableWebSecurity //@EnableWebSecurity是开启SpringSecurity的默认行为</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableGlobalMethodSecurity(prePostEnabled = true)//开启注解功能，默认禁用注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这是配置的关键，决定哪些 接口开启防护，哪些接口绕过防护</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //关闭csrf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .csrf().disable()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 开启跨域以便前端调用接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .cors().and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .authorizeRequests()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 指定某些接口不需要通过验证即可访问。登陆接口肯定是不需要认证的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .antMatchers(&quot;/yygh/user/login&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 这里意思是其它所有接口需要认证才能访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .anyRequest().authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //TokenAuthenticationFilter放到UsernamePasswordAuthenticationFilter的前面，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 这样做就是为了除了登录的时候去查询数据库外，其他时候都用token进行认证。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                .addFilterBefore(new TokenAuthenticationFilter(redisTemplate), UsernamePasswordAuthenticationFilter.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .addFilter(new TokenLoginFilter(authenticationManager(), redisTemplate));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //禁用session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 配置哪些请求不拦截</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 排除swagger相关请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void configure(WebSecurity web) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        web.ignoring().antMatchers(&quot;/favicon.ico&quot;,&quot;/swagger-resources/**&quot;, &quot;/webjars/**&quot;, &quot;/v2/**&quot;, &quot;/swagger-ui.html/**&quot;, &quot;/doc.html&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>5、配置用户认证 （过滤器2）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package space.jachen.yygh.security.filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author JaChen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2022/12/23 23:04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.redis.core.RedisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.context.SecurityContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.StringUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.filter.OncePerRequestFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.result.JsonData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.result.ResultCodeEnum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.utils.JwtHelper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import space.jachen.yygh.common.utils.ResponseUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.annotation.Resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 认证解析token过滤器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TokenAuthenticationFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RedisTemplate redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TokenAuthenticationFilter(RedisTemplate redisTemplate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.redisTemplate = redisTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;认证解析token过滤器的url:&quot;+request.getRequestURI());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //如果是登录接口，直接放行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(&quot;/yygh/user/login&quot;.equals(request.getRequestURI())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UsernamePasswordAuthenticationToken authentication = getAuthentication(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(null != authentication) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //放行请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            chain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ResponseUtil.out(response, JsonData.build(null, ResultCodeEnum.PERMISSION));//209  没有权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private UsernamePasswordAuthenticationToken getAuthentication(HttpServletRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // token置于header里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String token = request.getHeader(&quot;token&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;token:&quot;+token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(token)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String username = JwtHelper.getUserName(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;username:&quot;+username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!StringUtils.isEmpty(username)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //从Redis中获取权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collection&lt;GrantedAuthority&gt; authorities = (Collection&lt;GrantedAuthority&gt;) redisTemplate.boundValueOps(username).get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new UsernamePasswordAuthenticationToken(username, null, authorities);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //返回一个认证对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //return new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在就可以通过swagger测试登录了。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="关于Spring Security的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/sentinel/spring-security">Spring Security</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/product-management-system">SQL优化积累笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-02T00:00:00.000Z">2023年3月2日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/jiguanchen"><img class="avatar__photo authorImage_XqGP" src="https://github.com/jachen99.png" alt="季冠臣"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/jiguanchen"><span class="authorName_yefp">季冠臣</span></a></div><small class="authorTitle_nd0D" title="后端研发工程师">后端研发工程师</small><div class="authorSocials_rSDt"><a href="https://github.com/jachen99" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg viewBox="0 0 256 250" width="1em" height="1em" class="authorSocialLink_owbf githubSvg_Uu4N" xmlns="http://www.w3.org/2000/svg" style="--dark:#000;--light:#fff" preserveAspectRatio="xMidYMid"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p><strong>背景</strong>：<em>因为日常工作和学习中难免会与数据库打交道，其中如何快速的从庞大的数据库中精准的查找到我们想要的信息一直是很热的话题，所以写下此篇笔记，亦在不断地积累有关数据库查询优化方面的经验，从而能高效的使数据传递给外界，给用户更好的体验，这篇文章会一直更新下去</em>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="or与union的执行效率比较">or与union的执行效率比较<a href="#or与union的执行效率比较" class="hash-link" aria-label="or与union的执行效率比较的直接链接" title="or与union的执行效率比较的直接链接">​</a></h2>
<p>stackoverflow链接: <a href="https://leetcode.cn/link/?target=https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or%EF%BC%89" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/13750475/sql-performance-union-vs-or）</a></p>
<p>当SQL语句有多个or语句时，可以考虑使用union或者union all代替来提高速度。使用or的SQL语句往往无法进行优化，导致速度变慢。但这不是固定的，有时候使用or速度会更快些。具体情况还要经过测试为准。如果加索引的话，也可能实现速度优化。</p>
<p>实验表格如下,实际数据有2,000,000条，从里面返回大约最多1000行左右的数据。</p>
<table><thead><tr><th>X</th><th>Y</th><th>Inline</th><th>CDP</th><th>T</th></tr></thead><tbody><tr><td>12002400</td><td>5801000</td><td>300</td><td>300</td><td>3400</td></tr><tr><td>12002408</td><td>5801005</td><td>300</td><td>301</td><td>3402</td></tr><tr><td>12002416</td><td>5801010</td><td>300</td><td>302</td><td>3404</td></tr><tr><td>12002424</td><td>5801015</td><td>300</td><td>303</td><td>3406</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>or语句（部分节选）</p>
<p>SELECT * FROM tablename where (cdp= 300 and inline=301) or (cdp= 301 and inline=301) or (cdp= 302 and inline=301) or (cdp= 303 and inline=301) or (cdp= 304 and inline=301) or (cdp= 305 and inline=301) or (cdp= 306 and inline=301) or (cdp= 307 and inline=301)</p>
<p>union all语句（部分节选）</p>
<p>SELECT * FROM tablename where (inline= 300 and cdp=300) union all SELECT * FROM tablename where (inline= 301 and cdp=300) union all SELECT * FROM tablename where (inline= 302 and cdp=300) union all SELECT * FROM tablename where (inline= 303 and cdp=300)
返回不规则的900条数据，前者用了60多秒，后者用了8秒左右。</p>
<p>总结：</p>
<ol>
<li>Union：对两个结果集进行并集操作，不包括重复行，同时进行默认规则的排序； 即：去重+排序</li>
<li>Union All：对两个结果集进行并集操作，包括重复行，不进行排序； 即：不去重+不排序</li>
<li>对于单列来说，用or是没有任何问题的，但是or涉及到多个列的时候，每次select只能选取一个index，如果选择了area，population就需要进行table-scan，即全部扫描一遍，但是使用union就可以解决这个问题，分别使用area和population上面的index进行查询。 但是这里还会有一个问题就是，UNION会对结果进行排序去重，可能会降低一些performance(这有可能是方法一比方法二快的原因），所以最佳的选择应该是两种方法都进行尝试比较。</li>
</ol>
<p>2023/02/09</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shell脚本批量插入mock数据">shell脚本批量插入mock数据<a href="#shell脚本批量插入mock数据" class="hash-link" aria-label="shell脚本批量插入mock数据的直接链接" title="shell脚本批量插入mock数据的直接链接">​</a></h2>
<p>shell脚本</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;请输入字段servnumber的值：&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read serber</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;请输入创建sql语句的数量：&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># char=`head /dev/urandom | tr -dc 0-9 | head -c 11`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (( i=0;i&lt;$number;i++ ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pass=`head /dev/urandom | tr -dc a-z | head -c 8`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let serber=serber+1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;insert into test(id,username,servnumber,password,createtime) values(&#x27;$i&#x27;,&#x27;user${i}&#x27;,&#x27;${serber}&#x27;,&#x27;$pass&#x27;,now());&quot; &gt;&gt;sql1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>尽量避免使用select *from ，尽量精确到想要的结果字段。
尽量避免条件使用or。
记得加上limit 限制行数，避免数据量过大消耗性能。
使用模糊查询时，%放在前面是会使索引失效。
要小心条件字段类型的转换。</p>
<p>2023/02/11</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="线上调优-慢查询日志配置">线上调优-慢查询日志配置<a href="#线上调优-慢查询日志配置" class="hash-link" aria-label="线上调优-慢查询日志配置的直接链接" title="线上调优-慢查询日志配置的直接链接">​</a></h2>
<p>最好 nginxi访问日志，流量重放在测试环境中；迫不得已再线上调</p>
<ul>
<li>第一步：查看是否已经开启了慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show variables like &#x27;slow%&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Variable_name       | Value                                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------------+--------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| slow_launch_time    | 2                                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| slow_query_log      | OFF                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| slow_query_log_file | /data/mydata/jachen-public-slow.log |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------------+--------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启慢查询日志</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set global slow_query_log = on ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">日志路径也可以自定义：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set global slow_query_log_file = &#x27;路径&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看慢查询的时间临界值</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">show variables like &#x27;%long%&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：设置慢查询的时间标准</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set long_query_time=0.4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>注意：假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">永久生效的设置方法：修改配置文件 vi /etc/my.cnf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slow_query_log = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long_query_time = 0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slow_query_log_file =/usr/local/mysql/mysql_slow.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">最后重新连接才能生效，不必重启服务器！</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>执行耗时sql：</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM emp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM emp WHERE deptid &gt; 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询慢查询记录数：</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SHOW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">STATUS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;%Slow_queries%&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查询日志：</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vim /var/lib/mysql/bogon-slow.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>mysqldumpslow分析工具：</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。退出mysql命令行，执行以下命令：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 查看mysqldumpslow的帮助信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysqldumpslow </span><span class="token comment" style="color:#999988;font-style:italic">--help</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 工 作常用参考</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 1.得到返回记录集最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysqldumpslow </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s r </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mysql</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bogon</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 2.得到访问次数最多的10个SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysqldumpslow </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s c </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mysql</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bogon</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 3.得到按照时间排序的前10条里面含有左连接的查询语句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysqldumpslow </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s t </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">g </span><span class="token string" style="color:#e3116c">&quot;left join&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mysql</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bogon</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 4.另外建议  在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysqldumpslow </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">s r </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mysql</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bogon</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> more</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>-a: 将数字抽象成N，字符串抽象成S</p>
</li>
<li>
<p>-s: 是表示按照何种方式排序</p>
</li>
<li>
<ul>
<li>c: 访问次数<!-- -->
<ul>
<li>l: 锁定时间</li>
<li>r: 返回记录</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>t: 查询时间</li>
<li>al:平均锁定时间</li>
<li>ar:平均返回记录数</li>
<li>at:平均查询时间</li>
</ul>
</li>
<li>
<p>-t: 即为返回前面多少条的数据</p>
</li>
<li>
<p>-g: 后边搭配一个正则匹配模式，大小写不敏感的</p>
</li>
</ul>
<p>2023/02/15</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sql语句执行过程解析">sql语句执行过程解析<a href="#sql语句执行过程解析" class="hash-link" aria-label="sql语句执行过程解析的直接链接" title="sql语句执行过程解析的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20230223160243626" src="/assets/images/image-20230223160243626-852c258d2994473f82bad8ae86bcd5df.png" width="1081" height="132" class="img_ev3q"></p>
<p>介绍如何开启性能详情</p>
<ul>
<li>第一步：查看性能详情是否开启</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show variables like &#x27;%profiling%&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Variable_name          | Value |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| have_profiling         | YES   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| profiling              | OFF   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| profiling_history_size | 15    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------+-------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第二步：开启性能记录功能</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set profiling = on ;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第三步：查看性能的记录</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show profiles;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Query_ID | Duration   | Query                                             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        1 | 0.00177775 | show variables like &#x27;%profiling%&#x27;                 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        2 | 0.00037900 | select * from test where id=&#x27;087878&#x27;              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        3 | 0.34618025 | select * from test where servnumber=&#x27;1367008787&#x27;  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        4 | 0.31986825 | select * from test where servnumber=&#x27;13670087879&#x27; |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+------------+---------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>第四步：查看语句的执行性能详情</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show profile for query 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Status               | Duration |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| starting             | 0.000100 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| checking permissions | 0.000010 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Opening tables       | 0.000023 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| init                 | 0.000045 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| System lock          | 0.000015 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| optimizing           | 0.000016 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| statistics           | 0.000028 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| preparing            | 0.000020 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| executing            | 0.000006 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Sending data         | 0.319489 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| end                  | 0.000037 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| query end            | 0.000012 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| closing tables       | 0.000012 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| freeing items        | 0.000040 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| cleaning up          | 0.000017 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>性能线程的详细解释官方文档链接</em>：<a href="https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/general-thread-states.html</a></p>
<p>2023/02/16</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="设计表的null值问题">设计表的NULL值问题<a href="#设计表的null值问题" class="hash-link" aria-label="设计表的NULL值问题的直接链接" title="设计表的NULL值问题的直接链接">​</a></h2>
<p>1、字段不添加null  都是not null，默认值</p>
<p><img decoding="async" loading="lazy" alt="image-20230222093720407" src="/assets/images/image-20230222093720407-7ffbef4dda48f5ec8896c86307b97bf1.png" width="960" height="93" class="img_ev3q"></p>
<p>2、把字段都设置为not null ，添加特殊字段，把数据存储j为JSON格式  </p>
<p>2023/02/18</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关联查询优化">关联查询优化<a href="#关联查询优化" class="hash-link" aria-label="关联查询优化的直接链接" title="关联查询优化的直接链接">​</a></h2>
<p>1、保证被驱动表的JOIN字段已经创建了索引
2、需要JOIN 的字段，数据类型保持绝对一致。
3、LEFT JOIN 时，选择小表作为驱动表，大表作为被驱动表 。减少外层循环的次数。
4、INNER JOIN 时，MySQL会自动将小结果集的表选为驱动表 。选择相信MySQL优化策略。
5、能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)
6、不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。
7、衍生表建不了索引</p>
<p>2023/02/19</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="子查询优化">子查询优化<a href="#子查询优化" class="hash-link" aria-label="子查询优化的直接链接" title="子查询优化的直接链接">​</a></h2>
<p>使用连接（JOIN）查询来替代子查询。**连接查询不需要建立临时表 ，其速度比子查询 要快 ，如果查询中使用索引的话，性能就会更好.
例如：尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
<p>2023/02/22</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据库表设计">数据库表设计<a href="#数据库表设计" class="hash-link" aria-label="数据库表设计的直接链接" title="数据库表设计的直接链接">​</a></h2>
<ul>
<li>字段长度：能使用int就不要使用varchar、char，能用varchar(16)就不要使用varchar(256)</li>
<li>字段选择：固定长度的类型最好使用char,能使用tinyinti就不要使用int</li>
<li>默认值：最好给每个字段个默认值，最好不能为null,即not null default</li>
<li>适当索引：为每个表创建合理的索引，如唯一索引组合索引的场景以及普通索引的场景</li>
</ul>
<p>2023/02/28</p>
<hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/数据库">数据库</a></li><li class="tag_QGVx"><a title="关于MySQL的相关内容" class="tag_zVej tagRegular_sFm0" href="/blog/tags/mysql">MySQL</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">我的日记</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weibo.com/u/5489560765" target="_blank" rel="noopener noreferrer" class="footer__link-item">我的微博<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.csdn.net/m0_46464597?type=blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">CSDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">我的博客</a></li><li class="footer__item"><a href="https://github.com/Jachen99/Jachen99.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with jiguanchen/blog-boilerplate.</div></div></div></footer></div>
</body>
</html>